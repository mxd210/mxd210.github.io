<!-- REPLACE WHOLE FILE: /store/noi-bat.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <title>Sản phẩm nổi bật | MXD210</title>
  <meta name="description"
        content="Những sản phẩm đang nổi bật trên MXD210: hoặc là deal tốt, hoặc là thật sự hữu ích ngoài công trình và trong đời sống."/>
  <link rel="canonical" href="https://mxd210.github.io/store/noi-bat.html"/>
  <meta name="robots" content="index,follow"/>

  <!-- OPEN GRAPH -->
  <meta property="og:title" content="Sản phẩm nổi bật | MXD210"/>
  <meta property="og:description"
        content="Điểm lại các sản phẩm nổi bật trên MXD210 – deal ngon hoặc hữu ích thật sự cho anh em."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://mxd210.github.io/store/noi-bat.html"/>

  <link rel="stylesheet" href="/assets/site.css"/>

  <!-- Analytics trước affiliate -->
  <script defer src="/assets/analytics.js"></script>
  <script defer src="/assets/mxd-affiliate.js"></script>
  <!-- KHÔNG dùng mxd-store.v2.js nữa, render inline theo chuẩn mới -->
</head>
<body data-nav="store">
<header class="site-header">
  <div class="container">
    <a href="/" class="logo">
      <span class="logo-main">MXD210</span>
      <span class="logo-sub">Xây dựng &amp; Affiliate</span>
    </a>

    <nav class="main-nav">
      <ul>
        <li><a href="/" data-nav="home">Trang chủ</a></li>
        <li><a href="/store.html" data-nav="store">Cửa hàng</a></li>
        <li><a href="/blog-xay-dung.html" data-nav="blog-xd">Góc xây dựng</a></li>
        <li><a href="/mxd-aff-academy.html" data-nav="aff-academy">Góc Affiliate</a></li>
        <li><a href="/contact.html" data-nav="contact">Liên hệ</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="page-main">
  <section class="category-hero">
    <div class="container">
      <h1>Sản phẩm nổi bật trên MXD210</h1>
      <p>
        Những món đang được chú ý nhiều hơn bình thường: hoặc là deal tốt, hoặc là hữu ích
        thực sự ngoài công trình và trong đời sống.
      </p>
    </div>
  </section>

  <section class="category-products container"
           data-mxd-category-page
           data-category="noi-bat"
           data-limit="600"
           data-featured-first="true"
           data-featured-only="true">
    <div class="category-toolbar">
      <div class="category-info">
        <strong>Nổi bật</strong>
        <span data-category-count></span>
      </div>
    </div>

    <div class="product-grid"></div>
    <p class="muted" data-category-empty style="display:none">
      Chưa có sản phẩm nổi bật phù hợp trong kho hiện tại.
    </p>
  </section>
</main>

<footer class="site-footer">
  <div class="container">
    <p>© MXD210 – Điểm lại những món đáng xem nhất trong từng giai đoạn.</p>
  </div>
</footer>

<!-- MXD-CATEGORY-LOADER v2025-12-04b — loader dùng chung + hỗ trợ featured-only -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.querySelector('[data-mxd-category-page]');
  if (!section) return;

  const grid     = section.querySelector('.product-grid');
  const countEl  = section.querySelector('[data-category-count]');
  const emptyEl  = section.querySelector('[data-category-empty]');
  const catSlug  = (section.getAttribute('data-category') || '').toString();
  const limitRaw = parseInt(section.getAttribute('data-limit') || '', 10);
  const limit    = Number.isFinite(limitRaw) ? limitRaw : 600;
  const featuredFirst = (section.getAttribute('data-featured-first') || '').toString() === 'true';
  const featuredOnly  = (section.getAttribute('data-featured-only')  || '').toString() === 'true';

  if (!grid) return;

  const fmtPrice = n =>
    Number.isFinite(+n) ? new Intl.NumberFormat('vi-VN').format(+n) + '₫' : '';

  const escapeHTML = str => String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const escapeAttr = str => escapeHTML(str).replace(/`/g, '&#96;');

  const normalizeOrigin = raw => {
    let u = (raw || '').toString().trim();
    if (!u) return '';
    if (u.startsWith('//')) u = 'https:' + u;
    if (!/^https?:\/\//i.test(u)) {
      u = 'https://' + u.replace(/^\/+/, '');
    }
    return u;
  };

  const detectMerchant = url => {
    try {
      if (!url) return '';
      const u = new URL(url.startsWith('http') ? url : 'https://' + url);
      const host = u.hostname.toLowerCase();
      if (host.includes('shopee'))    return 'shopee';
      if (host.includes('lazada'))    return 'lazada';
      if (host.includes('tiki'))      return 'tiki';
      if (host.includes('tiktok'))    return 'tiktok';
      if (host.includes('mediamart')) return 'mediamart';
      return '';
    } catch {
      return '';
    }
  };

  const merchantLabelFor = m => {
    switch (m) {
      case 'shopee':    return 'Shopee';
      case 'lazada':    return 'Lazada';
      case 'tiki':      return 'Tiki';
      case 'tiktok':    return 'TikTok Shop';
      case 'mediamart': return 'MediaMart';
      default:          return '';
    }
  };

  const getTime = val => {
    if (!val) return 0;
    const t = new Date(val).getTime();
    return Number.isFinite(t) ? t : 0;
  };

  const getPrice = p => {
    const v = p.price ?? p.price_vnd ?? p.price_vnd_int;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };

  const matchesCategory = (p, slug) => {
    if (!slug) return true;
    const cat = (p.category || '').toString().toLowerCase().trim();
    if (cat === slug) return true;
    // Nếu sau này có many-category, vẫn match được
    if (cat.split(/[,\s]+/).includes(slug)) return true;
    return false;
  };

  const renderCard = p => {
    const name      = escapeHTML(p.name || '');
    const sku       = escapeAttr(p.sku || '');
    const shortDesc = escapeHTML(
      (p.short_desc || p.description || p.name || '').toString().trim()
    );
    const priceVal  = getPrice(p);
    const priceText = priceVal != null ? escapeHTML(fmtPrice(priceVal)) : '';

    const originRaw = (p.origin || p.origin_url || '').toString().trim();
    const origin    = normalizeOrigin(originRaw) || '#';

    const merchantRaw   = (p.merchant || detectMerchant(origin)).toString().toLowerCase();
    const merchantLabel = merchantLabelFor(merchantRaw);

    const imgSrc = escapeAttr(
      p.image || `/assets/img/products/${encodeURIComponent(p.sku || 'placeholder')}.webp`
    );
    const detailHref = `/g.html?sku=${encodeURIComponent(p.sku || '')}`;

    let btnText = 'Mua ngay';
    if (merchantLabel) {
      btnText = (merchantRaw === 'mediamart'
        ? 'Mua ngay tại '
        : 'Mua ngay trên '
      ) + merchantLabel;
    }

    return `
      <article class="product-card" data-sku="${sku}">
        <a href="${detailHref}">
          <div class="thumb">
            <img src="${imgSrc}"
                 alt="${name}"
                 loading="lazy"
                 onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp';">
            <div class="product-hover">
              <p>${shortDesc}</p>
            </div>
          </div>
        </a>
        <div class="body">
          <div class="product-title title">
            <a href="${detailHref}">${name}</a>
          </div>
          <div class="price">${priceText}</div>
          <div class="actions">
            <a class="buy btn-buy"
               href="${escapeAttr(origin)}"
               data-merchant="${escapeAttr(merchantRaw)}"
               data-sku="${sku}"
               data-origin-url="${escapeAttr(origin)}">
              ${btnText}
            </a>
          </div>
        </div>
      </article>
    `;
  };

  // Skeleton đơn giản
  grid.innerHTML = Array.from({ length: 6 }).map(() => `
    <article class="product-card">
      <div class="thumb">
        <div class="skeleton" style="width:100%;height:200px;border-radius:12px"></div>
      </div>
      <div class="body">
        <div class="skeleton" style="height:18px;margin-bottom:8px"></div>
        <div class="skeleton" style="height:16px;width:40%;margin-bottom:8px"></div>
        <div class="skeleton" style="height:32px;width:60%;border-radius:999px"></div>
      </div>
    </article>
  `).join('');

  if (emptyEl) emptyEl.style.display = 'none';

  fetch('/assets/data/affiliates.json', { cache: 'no-store' })
    .then(r => r.ok ? r.json() : [])
    .then(all => {
      let arr = Array.isArray(all) ? all : (all.items || []);
      if (!arr.length) {
        grid.innerHTML = '';
        if (emptyEl) emptyEl.style.display = 'block';
        if (countEl) countEl.textContent = '';
        return;
      }

      arr = arr.filter(p => {
        if (!p) return false;
        const status = (p.status || 'active').toString().toLowerCase();
        if (['archived', 'hidden', 'draft'].includes(status)) return false;

        // Trang nổi bật: nếu featuredOnly=true thì chỉ nhận sản phẩm có p.featured truthy
        if (featuredOnly && !p.featured) return false;

        // Khi featuredOnly, bỏ qua lọc theo slug để lấy toàn kho
        const useSlug = featuredOnly ? '' : catSlug;
        if (!matchesCategory(p, useSlug)) return false;

        return true;
      });

      if (!arr.length) {
        grid.innerHTML = '';
        if (emptyEl) emptyEl.style.display = 'block';
        if (countEl) countEl.textContent = '0 sản phẩm';
        return;
      }

      // Sắp xếp: featured trước (nếu không featuredOnly), rồi updated_at mới → cũ
      arr.sort((a, b) => {
        if (featuredFirst && !featuredOnly) {
          const fa = a.featured ? 1 : 0;
          const fb = b.featured ? 1 : 0;
          if (fb !== fa) return fb - fa;
        }
        const ta = getTime(a.updated_at);
        const tb = getTime(b.updated_at);
        return tb - ta;
      });

      const list = arr.slice(0, limit);

      grid.innerHTML = list.map(renderCard).join('');
      if (countEl) countEl.textContent = list.length + ' sản phẩm';

      // Cho affiliate scan để sinh deeplink isclix
      if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function') {
        try {
          window.mxdAffiliate.scan(grid);
        } catch (e) {
          console.error('mxdAffiliate.scan error (noi-bat):', e);
        }
      }
    })
    .catch(err => {
      console.error('MXD category noi-bat error:', err);
      grid.innerHTML = '';
      if (emptyEl) emptyEl.style.display = 'block';
      if (countEl) countEl.textContent = '';
    });
});
</script>
</body>
</html>
