<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Sản phẩm nổi bật — MXD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/assets/site.css" rel="stylesheet">
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:32px 16px}
    h1{text-align:center;margin:0 0 8px}
    .muted{color:#666;text-align:center;margin:0 0 20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:24px}
    .card{border:1px solid #eaeaea;border-radius:16px;background:#fff;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .card img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f7f7f7}
    .card .body{padding:12px}
    .name{font-size:16px;line-height:1.35;margin:0 0 6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.7em}
    .price{font-weight:800;margin:4px 0 10px;color:#e11d48}
    .buy{display:inline-block;width:100%;text-align:center;padding:10px 12px;border-radius:12px;font-weight:800;color:#fff;background:#1746ff;text-decoration:none}
    .buy[data-merchant="shopee"]{background:#ee4d2d}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Sản phẩm nổi bật</h1>
    <p class="muted">Danh sách tự động từ dữ liệu chuẩn.</p>
    <div id="grid" class="grid" aria-live="polite"></div>
    <p id="empty" class="muted" style="display:none">Chưa có sản phẩm nổi bật.</p>
  </main>

  <script>
    const money = n => Number.isFinite(+n) ? new Intl.NumberFormat('vi-VN').format(+n) + '₫' : '';
    const esc = s => String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    const pickUrl = p => p.deeplink || p.origin_url || p.origin || p.url || p.link || '#';
    const pickImg = (p) => p.image || (p.sku ? `/assets/img/products/${String(p.sku).toLowerCase()}.webp` : '/assets/img/products/placeholder.webp');
    const isLive = (p) => p && (p.status !== false); // thiếu status thì coi như true

    async function loadFirst(paths){
      for (const path of paths){
        try{
          const r = await fetch(path, { cache:'no-store' });
          if (!r.ok) continue;
          const data = await r.json();
          const arr = Array.isArray(data) ? data : (data.items || []);
          if (arr.length) return arr;
          // nếu file có mà rỗng, vẫn thử file tiếp
        }catch(e){}
      }
      return [];
    }

    (async function init(){
      const all = await loadFirst(['/assets/data/affiliates.json','/products.json']);
      const list = all.filter(isLive).filter(p => p.featured === true);
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');

      if (!list.length){ empty.style.display='block'; return; }

      grid.innerHTML = list.map(p=>{
        const name = p.name || p.sku || 'Sản phẩm';
        const img  = pickImg(p);
        const href = pickUrl(p);
        const price = Number.isFinite(+p.price) ? `<div class="price">${money(+p.price)}</div>` : '';
        const merchant = (p.merchant||'').toLowerCase();
        return `
          <article class="card">
            <a href="${href}" target="_blank" rel="nofollow sponsored noopener">
              <img loading="lazy" decoding="async" src="${esc(img)}" alt="${esc(name)}"
                   onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'">
            </a>
            <div class="body">
              <h3 class="name"><a href="${href}" target="_blank" rel="nofollow noopener">${esc(name)}</a></h3>
              ${price}
              <a class="buy" data-merchant="${merchant}" href="${href}" target="_blank" rel="nofollow sponsored noopener">Mua ngay</a>
            </div>
          </article>`;
      }).join('');
      if (window.mxdAffiliate?.scan) window.mxdAffiliate.scan();
    })();
  </script>
</body>
</html>
