<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>

  <title>Cửa hàng MXD – Sản phẩm chọn lọc</title>
  <meta name="description" content="Các sản phẩm xây dựng được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền.">
  <link rel="canonical" href="https://mxd210.github.io/store.html">
  <meta name="robots" content="index,follow">

  <!-- OG -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cửa hàng MXD – Sản phẩm chọn lọc">
  <meta property="og:description" content="Các sản phẩm xây dựng được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền.">
  <meta property="og:url" content="https://mxd210.github.io/store.html">
  <meta property="og:image" content="https://mxd210.github.io/assets/img/og/store.webp">
  <meta property="og:locale" content="vi_VN">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cửa hàng MXD – Sản phẩm chọn lọc">
  <meta name="twitter:description" content="Các sản phẩm xây dựng được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền.">
  <meta name="twitter:image" content="https://mxd210.github.io/assets/img/og/store.webp">

  <!-- VERIFY -->
  <meta name="google-site-verification" content="84L0tRVs_wNPAyXii38-OaeGi8TyJdMlkZXVIHcnj0o">

  <!-- Preload dữ liệu CHUẨN -->
  <link rel="preload" as="fetch" href="/assets/data/affiliates.json" type="application/json" crossorigin>
  <link rel="stylesheet" href="/assets/site.css">

  <style>
    :root{
      --bg:#fff; --text:#111; --muted:#666; --border:#eaeaea;
      --card:#fff; --brand:#0a84ff; --brand-contrast:#fff;
      --hover:#111; --radius:16px; --gap:24px; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1215; --text:#e8e8e8; --muted:#a2a2a2; --border:#262b31; --card:#14181d; --shadow:0 10px 28px rgba(0,0,0,.35); }
    }
    .nav-link{ padding:8px 10px; border-radius:10px; color:var(--text); text-decoration:none; }
    .nav-link:hover{ background:rgba(23,70,255,.08) }
    .nav-link[aria-current="page"]{ background:#eef4ff; color:#1746ff }
    @media (max-width:480px){ .nav-link{ padding:8px } }

    /* QUICK-NAV (chặn chấm đầu dòng tuyệt đối) */
    .quick-nav{display:flex;gap:12px;flex-wrap:wrap;padding:8px 0;margin:12px 0; list-style:none; padding-left:0}
    .quick-nav li{list-style:none;margin:0;padding:0}
    .quick-nav li::marker{content:''}
    .qnav-item{
      display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);
      border-radius:12px;background:var(--card);box-shadow:var(--shadow);color:var(--text);
      text-decoration:none
    }
    .qnav-item:hover{background:rgba(23,70,255,.06)}
    .quick-nav img{width:28px;height:28px;border-radius:8px}

    /* GRID & CARD */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--gap);margin:16px 0}
    .card{border:1px solid var(--border);border-radius:var(--radius);background:var(--card);overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow);transition:transform .15s;height:100%}
    .card:hover{transform:translateY(-2px)}
    .card img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f7f7f7;height:auto}
    .card .body{padding:12px}

    .name,.title,.product-title{
      font-size:16px;line-height:1.35;margin:0 0 6px;color:var(--text);
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.7em;
    }
    .price{font-weight:800;margin:4px 0 10px}
    .buy{display:inline-block;width:100%;text-align:center;padding:10px 12px;border-radius:12px;font-weight:800;text-decoration:none;color:#fff;border:1px solid transparent;margin-top:auto}
    .buy:focus-visible{outline:2px solid #0000ff55;outline-offset:2px}
    .buy:active{transform:translateY(1px)}
    .buy{ background:#1746ff; border-color:#1746ff }
    .buy[data-merchant="shopee"]{ background:#ee4d2d; border-color:#ee4d2d }
    .buy[data-merchant="lazada"]{ background:#0f146d; border-color:#0f146d }
    .buy[data-merchant="tiki"]{ background:#1a94ff; border-color:#1a94ff }
    .buy[data-merchant="tiktok"]{ background:#111; border-color:#111 }
    .buy:hover{ filter:brightness(1.05) }

    .skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg, rgba(0,0,0,0.06) 25%, rgba(0,0,0,0.12) 37%, rgba(0,0,0,0.06) 63%)}
    .skeleton::after{content:'';position:absolute;inset:0;animation:shimmer 1.4s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* Floating contacts (backup) */
    .floating-contacts{position:fixed;right:12px;bottom:calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:12px;z-index:40;pointer-events:none}
    .floating-contacts a,.floating-contacts button{pointer-events:auto;width:52px;height:52px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.18)}
    body.has-fixed-cta .floating-contacts{ bottom:112px }

    /* TAG CLOUD (SEO-buddy) */
    .tag-cloud{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .tag-chip{border:1px solid var(--border);background:var(--card);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .tag-chip:hover{background:rgba(23,70,255,.06)}
    .tag-count{opacity:.6;margin-left:4px}
    .filter-info{display:inline-flex;gap:8px;align-items:center;border:1px dashed var(--border);padding:8px 10px;border-radius:10px;margin-top:8px}
    .filter-info b{color:#1746ff}
  </style>

  <!-- SUB -->
  <meta name="at:sub1" content="">
  <meta name="at:sub2" content="">
  <meta name="at:sub3" content="store">
  <meta name="at:sub4" content="mxd210">

  <!-- GA4 trước Affiliate -->
  <script defer src="/assets/analytics.js?v=2025-11-08-s1"></script>
  <script defer src="/assets/mxd-affiliate.js?v=2025-11-08-s1"></script>
  <script defer src="/assets/js/render-products.js?v=2025-11-08-s1"></script>
  <script defer src="/assets/js/floating-contact.js?v=2025-09-26-1"></script>

  <!-- JSON-LD placeholder: sẽ được tiêm động từ affiliates.json -->
  <!-- MXD-ANCHOR: LD-ITEMLIST -->
  <script type="application/ld+json" id="ld-itemlist">{}</script>
</head>
<body>
  <header style="position:sticky;top:0;z-index:50;background:var(--bg);backdrop-filter:blur(6px)">
    <div class="container" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:12px 16px;border-bottom:1px solid var(--border)">
      <a href="/" class="brand" style="font-weight:900;font-size:18px;color:var(--text);text-decoration:none">MXD</a>
      <nav class="site-nav" style="display:flex;gap:10px;margin-left:auto;flex-wrap:wrap">
        <a href="/" class="nav-link">Trang chủ</a>
        <a href="/store.html" class="nav-link" aria-current="page">Cửa hàng</a>
        <a href="/blog/" class="nav-link">Tin tức</a>
        <a href="/tu-van.html" class="nav-link">Tư vấn</a>
        <a href="/lien-he.html" class="nav-link">Liên hệ</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- QUICK-NAV -->
    <section aria-label="Danh mục nhanh">
      <ul class="quick-nav" id="quick-nav">
        <li>
          <a href="/store/noi-bat.html" class="qnav-item">
            <img src="/assets/img/categories/noi-bat.webp" alt="Sản phẩm nổi bật — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Sản phẩm nổi bật
          </a>
        </li>
        <li>
          <a href="/store/may-moc-xay-dung.html" class="qnav-item">
            <img src="/assets/img/categories/may-moc-xay-dung.webp" alt="Máy móc xây dựng — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Máy móc xây dựng
          </a>
        </li>
        <li>
          <a href="/store/thoi-trang.html" class="qnav-item">
            <img src="/assets/img/categories/thoi-trang.webp" alt="Thời trang — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Thời trang
          </a>
        </li>
        <li>
          <a href="/store/my-pham.html" class="qnav-item">
            <img src="/assets/img/categories/my-pham.webp" alt="Mỹ phẩm — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Mỹ phẩm
          </a>
        </li>
        <!-- NEW: Đồ gia dụng -->
        <li>
          <a href="/store/do-gia-dung.html" class="qnav-item">
            <img src="/assets/img/categories/do-gia-dung.webp" alt="Đồ gia dụng — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Đồ gia dụng
          </a>
        </li>
        <!-- NEW: Đồ điện tử -->
        <li>
          <a href="/store/do-dien-tu.html" class="qnav-item">
            <img src="/assets/img/categories/do-dien-tu.webp" alt="Đồ điện tử — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Đồ điện tử
          </a>
        </li>
      </ul>

      <!-- MXD-ANCHOR: TAG-CLOUD -->
      <div class="filter-info" id="filter-info" hidden>Đang lọc theo thẻ: <b></b></div>
      <div class="tag-cloud" id="tag-cloud" aria-label="Thẻ phổ biến"></div>
    </section>

    <!-- MTE deals mount point -->
    <!-- MTE:DEALS-BLOCK -->

    <!-- Danh sách sản phẩm -->
    <!-- MTE:AB-CARD -->
    <div id="product-list" class="grid" aria-live="polite"></div>
    <p id="empty" class="muted" style="display:none">Chưa có sản phẩm. Hãy thêm <code>/assets/data/affiliates.json</code> hoặc <code>/products.json</code>.</p>
    <noscript>Trang cần JavaScript để hiển thị danh sách sản phẩm.</noscript>
  </main>

  <footer>
    <div class="container">
      © MXD · <a href="/chinh-sach/bao-mat.html">Bảo mật</a> · <a href="/chinh-sach/doi-tra.html">Đổi trả</a> · <a href="/chinh-sach/bao-hanh.html">Bảo hành</a>
    </div>
  </footer>

  <!-- Render (ưu tiên renderer MXD, có fallback an toàn) -->
  <script>
    // === HOOK HẬU-RENDER: đổi nhãn CTA theo sàn + chạy affiliate rewriter ===
    function runPostRenderHook(){
      try { labelCTA(document); } catch(_){}
      try {
        if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function') {
          window.mxdAffiliate.scan();
        }
      } catch(_){}
    }

    window.addEventListener('DOMContentLoaded', async () => {
      const qs = new URLSearchParams(location.search);
      const lim = qs.has('limit') ? Number(qs.get('limit')) : undefined;
      const limit = Number.isFinite(lim) ? lim : undefined;

      if (window.MXD?.renderProducts) {
        try {
          MXD.renderProducts('#product-list', limit);
          // Bảo đảm nút “Mua Shopee/Lazada/…” và isclix luôn hoạt động khi dùng renderer ngoài
          setTimeout(runPostRenderHook, 0);
        } catch(e){
          console.warn('[MXD] renderProducts error, using fallback', e);
          await fallbackRender(limit);
        }
      } else {
        await fallbackRender(limit);
      }

      // DEDUPE floating contacts nếu script ngoài có inject trùng
      const fcs = document.querySelectorAll('#floating-contacts,.floating-contacts,.fc');
      if (fcs.length > 1) fcs.forEach((el,i)=> i>0 && el.remove());
    });

    async function fallbackRender(limit){
      const wrap = document.querySelector('#product-list');
      const empty = document.getElementById('empty');
      wrap.innerHTML = Array.from({length:6}).map(()=>`
        <article class="card">
          <div class="skeleton" style="height:200px"></div>
          <div class="body">
            <div class="skeleton" style="height:18px"></div>
            <div class="skeleton" style="height:16px;width:40%;margin-top:8px"></div>
          </div>
        </article>
      `).join('');

      // Nguồn dữ liệu: CHUẨN -> Fallback 1 -> Fallback 2
      const sources = ['/assets/data/affiliates.json','/affiliates.json','/products.json'];
      let raw = null;
      for (const u of sources){
        try{
          const r = await fetch(u, { cache:'no-store' });
          if (r.ok){ raw = await r.json(); break; }
        }catch{}
      }
      const arr = Array.isArray(raw) ? raw : (raw?.items || raw || []);
      if (!Array.isArray(arr) || !arr.length){ empty.style.display='block'; wrap.innerHTML=''; return; }

      const LIMIT = Number.isFinite(limit) ? limit : 40;
      const fmt = n => isFinite(+n) ? new Intl.NumberFormat('vi-VN').format(+n)+'₫' : '';
      const esc = s => String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

      wrap.innerHTML = arr.slice(0, LIMIT).map(p=>{
        const sku = (p.sku||'').toLowerCase();
        const name = p.name || sku || 'Sản phẩm';
        const origin = p.origin_url || p.origin || p.url || p.link || '#';
        const merchant = (p.merchant||'').toLowerCase();
        const priceAttr = (p.price!=null && p.price!=='') ? `data-price="${p.price}"` : '';
        const priceHtml = (p.price!=null && p.price!=='') ? `<div class="price" data-price="${p.price}">${fmt(p.price)}</div>` : '';
        return `
          <article class="card" data-sku="${esc(sku)}">
            <!-- meta link cho Affiliate rewriter -->
            <a class="product-meta sr-only"
               href="${esc(origin)}" data-merchant="${esc(merchant)}"
               data-sku="${esc(sku)}" data-img="/assets/img/products/${esc(sku)}.webp"
               ${priceAttr}>${esc(name)}</a>

            <a href="/g.html?sku=${encodeURIComponent(sku)}" aria-label="Xem chi tiết ${esc(name)}">
              <img loading="lazy" decoding="async"
                   src="/assets/img/products/${esc(sku)}.webp"
                   alt="${esc(name)}"
                   onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'">
            </a>
            <div class="body">
              <h3 class="name"><a href="/g.html?sku=${encodeURIComponent(sku)}">${esc(name)}</a></h3>
              ${priceHtml}
              <div class="actions">
                <a class="buy" href="${esc(origin)}" data-merchant="${esc(merchant)}" target="_blank" rel="nofollow sponsored noopener">Mua ngay</a>
              </div>
            </div>
          </article>`;
      }).join('');

      // Gắn label CTA theo sàn + chạy rewriter nếu có
      labelCTA(document);
      if (window.mxdAffiliate?.scan) window.mxdAffiliate.scan();
    }

    function labelCTA(root=document){
      const LABELS = {shopee:'Mua Shopee', lazada:'Mua Lazada', tiki:'Mua Tiki', tiktok:'Mua TikTok'};
      root.querySelectorAll('a.buy[data-merchant]').forEach(a=>{
        const m=(a.dataset.merchant||'').toLowerCase();
        a.textContent = LABELS[m] || 'Mua ngay';
      });
    }
  </script>

  <!-- Tiêm JSON-LD ItemList + dựng Tag Cloud từ affiliates.json -->
  <script>
    (async function(){
      try{
        // Tải dữ liệu CHUẨN rồi fallback
        async function load(){
          const ss = ['/assets/data/affiliates.json','/affiliates.json'];
          for (const u of ss) { try { const r = await fetch(u,{cache:'no-store'}); if(r.ok) return r.json(); } catch{} }
          return [];
        }
        const data = await load();
        const items = Array.isArray(data) ? data : (data.items || []);
        const valid = items.filter(x => x && x.status !== false);

        // === JSON-LD ItemList (Top 12) ===
        const top = valid.slice(0, 12);
        const makeAbs = (p) => { try{ return new URL(p, location.origin).href; }catch{ return p; } };
        const ld = {
          "@context":"https://schema.org",
          "@type":"ItemList",
          "itemListElement": top.map((p,i)=>({
            "@type":"ListItem",
            "position": i+1,
            "url": `${location.origin}/g.html?sku=${encodeURIComponent(p.sku||'')}`,
            "item":{
              "@type":"Product",
              "name": p.name || p.sku || "Sản phẩm",
              "sku": p.sku || undefined,
              "image": p.image ? makeAbs(p.image) : makeAbs(`/assets/img/products/${(p.sku||'').toLowerCase()}.webp`),
              "brand": p.brand ? {"@type":"Brand","name": p.brand} : undefined,
              "category": p.category || (Array.isArray(p.categories) ? p.categories.join(', ') : undefined),
              "offers": (p.price ? {
                "@type":"Offer","priceCurrency":"VND","price": String(p.price),
                "availability":"https://schema.org/InStock",
                "url": `${location.origin}/g.html?sku=${encodeURIComponent(p.sku||'')}`
              } : undefined)
            }
          }))
        };
        const holder = document.getElementById('ld-itemlist');
        if(holder) holder.textContent = JSON.stringify(ld);

        // === Tag Cloud (Top 20) ===
        const cloud = document.getElementById('tag-cloud');
        const info = document.getElementById('filter-info');
        const counts = new Map();
        for(const p of valid){
          const arr = Array.isArray(p.tags) ? p.tags : [];
          for(const t of arr){
            const k = String(t||'').trim().toLowerCase();
            if(!k) continue;
            counts.set(k, (counts.get(k)||0)+1);
          }
        }
        const tags = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);
        if(cloud && tags.length){
          cloud.innerHTML = tags.map(([tag,c]) =>
            `<button class="tag-chip" data-tag="${tag}" aria-label="Lọc theo thẻ ${tag}">${tag}<span class="tag-count">${c}</span></button>`
          ).join('');
          cloud.addEventListener('click', (e)=>{
            const btn = e.target.closest('.tag-chip'); if(!btn) return;
            const t = btn.dataset.tag;
            const url = new URL(location.href);
            url.searchParams.set('tag', t);
            location.href = url.toString();
          });
        }
        const activeTag = new URL(location.href).searchParams.get('tag');
        if(activeTag && info){ info.hidden = false; info.querySelector('b').textContent = activeTag; }
      }catch(e){ /* im lặng để không ảnh hưởng render */ }
    })();
  </script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js?v=2025-11-08-s1');
    }
  </script>

  <!-- MTE tracking mount -->
  <!-- MTE:TRACKING -->
  <script defer src="/assets/mxd-buy.js?v=1"></script>
</body>
</html>
