<!-- REPLACE WHOLE FILE: /store.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>

  <title>Cửa hàng MXD – Sản phẩm chọn lọc</title>
  <meta name="description" content="Các sản phẩm được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền.">
  <link rel="canonical" href="https://mxd210.github.io/store.html">
  <meta name="robots" content="index,follow">

  <!-- OG -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cửa hàng MXD – Sản phẩm chọn lọc">
  <meta property="og:description" content="Các sản phẩm được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền.">
  <meta property="og:url" content="https://mxd210.github.io/store.html">
  <meta property="og:image" content="https://mxd210.github.io/assets/img/og/store.webp">

  <!-- VERIFY -->
  <meta name="google-site-verification" content="84L0tRVs_wNPAyXii38-OaeGi8TyJdMlkZXVIHcnj0o">

  <link rel="stylesheet" href="/assets/site.css">

  <style>
    :root{
      --bg:#fff; --text:#111; --muted:#666; --border:#eaeaea;
      --card:#fff; --brand:#0a84ff; --brand-contrast:#fff;
      --hover:#111; --radius:16px; --gap:24px; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1215; --text:#e8e8e8; --muted:#a2a2a2; --border:#262b31;
        --card:#14181d; --shadow:0 10px 28px rgba(0,0,0,.35);
      }
    }
    .nav-link{
      padding:8px 10px; border-radius:10px;
      color:var(--text); text-decoration:none;
    }
    .nav-link:hover{ background:rgba(23,70,255,.08) }
    .nav-link[aria-current="page"]{ background:#eef4ff; color:#1746ff }
    @media (max-width:480px){ .nav-link{ padding:8px } }

    /* QUICK-NAV */
    .quick-nav{
      display:flex;gap:12px;flex-wrap:wrap;
      padding:8px 0;margin:12px 0;
    }
    .quick-nav li{list-style:none}
    .qnav-item{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--border);
      border-radius:12px;background:var(--card);
      box-shadow:var(--shadow);color:var(--text);
      text-decoration:none;
    }
    .qnav-item:hover{background:rgba(23,70,255,.06)}
    .quick-nav img{width:28px;height:28px;border-radius:8px}

    /* GRID & CARD */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:var(--gap);
      margin:16px 0;
    }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--card);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow);
      transition:transform .15s;
      height:100%;
    }
    .card:hover{transform:translateY(-2px)}
    .card img{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      background:#f7f7f7;
      height:auto;
    }
    .card .body{padding:12px}

    .name,.title,.product-title{
      font-size:16px;line-height:1.35;margin:0 0 6px;color:var(--text);
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;min-height:2.7em;
    }
    .price{font-weight:800;margin:4px 0 10px}
    .buy{
      display:inline-block;width:100%;text-align:center;
      padding:10px 12px;border-radius:12px;
      font-weight:800;text-decoration:none;color:#fff;
      border:1px solid transparent;margin-top:auto;
      background:#1746ff;border-color:#1746ff;
    }
    .buy:focus-visible{outline:2px solid #0000ff55;outline-offset:2px}
    .buy:active{transform:translateY(1px)}
    .buy[data-merchant="shopee"]{ background:#ee4d2d; border-color:#ee4d2d }
    .buy[data-merchant="lazada"]{ background:#0f146d; border-color:#0f146d }
    .buy[data-merchant="tiki"]{ background:#1a94ff; border-color:#1a94ff }
    .buy[data-merchant="tiktok"]{ background:#111; border-color:#111 }
    .buy:hover{ filter:brightness(1.05) }

    .skeleton{
      position:relative;overflow:hidden;
      background:linear-gradient(90deg,
        rgba(0,0,0,0.06) 25%,
        rgba(0,0,0,0.12) 37%,
        rgba(0,0,0,0.06) 63%);
    }
    .skeleton::after{
      content:'';position:absolute;inset:0;
      animation:shimmer 1.4s infinite;
    }
    @keyframes shimmer{
      0%{transform:translateX(-100%)}
      100%{transform:translateX(100%)}
    }

    /* Floating contacts (backup) */
    .floating-contacts{
      position:fixed;right:12px;
      bottom:calc(16px + env(safe-area-inset-bottom));
      display:flex;flex-direction:column;gap:12px;
      z-index:40;pointer-events:none;
    }
    .floating-contacts a,.floating-contacts button{
      pointer-events:auto;width:52px;height:52px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:#111;color:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    body.has-fixed-cta .floating-contacts{ bottom:112px }
  </style>

  <!-- SUB -->
  <meta name="at:sub1" content="">
  <meta name="at:sub2" content="">
  <meta name="at:sub3" content="store">
  <meta name="at:sub4" content="mxd210">

  <!-- GA4 trước Affiliate -->
  <script defer src="/assets/analytics.js?v=2025-09-26-fb2"></script>
  <script defer src="/assets/mxd-affiliate.js?v=2025-09-26-fb2"></script>
  <!-- Không dùng render-products.js nữa -->
  <script defer src="/assets/js/floating-contact.js?v=2025-09-26-1"></script>
</head>
<body>
  <header style="position:sticky;top:0;z-index:50;background:var(--bg);backdrop-filter:blur(6px)">
    <div class="container" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:12px 16px;border-bottom:1px solid var(--border)">
      <a href="/" class="brand" style="font-weight:900;font-size:18px;color:var(--text);text-decoration:none">MXD</a>
      <nav class="site-nav" style="display:flex;gap:10px;margin-left:auto;flex-wrap:wrap">
        <a href="/" class="nav-link">Trang chủ</a>
        <a href="/store.html" class="nav-link" aria-current="page">Cửa hàng</a>
        <a href="/blog/" class="nav-link">Tin tức</a>
        <a href="/tu-van.html" class="nav-link">Tư vấn</a>
        <a href="/lien-he.html" class="nav-link">Liên hệ</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- QUICK-NAV -->
    <section aria-label="Danh mục nhanh">
      <ul class="quick-nav" id="quick-nav">
        <li>
          <a href="/store/noi-bat.html" class="qnav-item">
            <img src="/assets/img/categories/noi-bat.webp" alt="Sản phẩm nổi bật — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Sản phẩm nổi bật
          </a>
        </li>
        <li>
          <a href="/store/may-moc-xay-dung.html" class="qnav-item">
            <img src="/assets/img/categories/may-moc-xay-dung.webp" alt="Máy móc xây dựng — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Máy móc xây dựng
          </a>
        </li>
        <li>
          <a href="/store/thoi-trang.html" class="qnav-item">
            <img src="/assets/img/categories/thoi-trang.webp" alt="Thời trang — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Thời trang
          </a>
        </li>
        <li>
          <a href="/store/my-pham.html" class="qnav-item">
            <img src="/assets/img/categories/my-pham.webp" alt="Mỹ phẩm — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Mỹ phẩm
          </a>
        </li>
        <li>
          <a href="/store/do-gia-dung.html" class="qnav-item">
            <img src="/assets/img/categories/do-gia-dung.webp" alt="Đồ gia dụng — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Đồ gia dụng
          </a>
        </li>
        <li>
          <a href="/store/do-dien-tu.html" class="qnav-item">
            <img src="/assets/img/categories/do-dien-tu.webp" alt="Đồ điện tử — MXD" width="28" height="28"
                 onerror="this.src='/assets/img/categories/placeholder.webp'"> Đồ điện tử
          </a>
        </li>
      </ul>
    </section>

    <!-- MTE deals mount point -->
    <!-- MTE:DEALS-BLOCK -->

    <!-- Danh sách sản phẩm -->
    <!-- MTE:AB-CARD -->
    <div id="product-list" class="grid" aria-live="polite"></div>
    <p id="empty" class="muted" style="display:none">
      Chưa có sản phẩm. Hãy thêm <code>/assets/data/affiliates.json</code> hoặc <code>/products.json</code>.
    </p>
    <noscript>Trang cần JavaScript để hiển thị danh sách sản phẩm.</noscript>
  </main>

  <footer>
    <div class="container">
      © MXD · <a href="/chinh-sach/bao-mat.html">Bảo mật</a> · <a href="/chinh-sach/doi-tra.html">Đổi trả</a> · <a href="/chinh-sach/bao-hanh.html">Bảo hành</a>
    </div>
  </footer>

  <!-- Render sản phẩm từ affiliates.json – dùng origin_url, để mxd-affiliate.js sinh isclix -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const wrap  = document.getElementById('product-list');
      const empty = document.getElementById('empty');
      if (!wrap) return;

      const fmtPrice = n => Number.isFinite(+n)
        ? new Intl.NumberFormat('vi-VN').format(+n) + '₫'
        : '';

      const esc = s => String(s || '').replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
      ));

      const normalizeOrigin = raw => {
        let u = (raw || '').toString().trim();
        if (!u) return '';
        if (u.startsWith('//')) u = 'https:' + u;
        if (!/^https?:\/\//i.test(u)) {
          u = 'https://' + u.replace(/^\/+/, '');
        }
        return u;
      };

      const guessMerchant = (p, originUrl) => {
        let m = (p.merchant || '').toString().toLowerCase().trim();
        if (!m && originUrl) {
          if (/shopee\.vn/i.test(originUrl)) m = 'shopee';
          else if (/lazada\.vn/i.test(originUrl)) m = 'lazada';
          else if (/tiki\.vn/i.test(originUrl)) m = 'tiki';
          else if (/tiktok\.com/i.test(originUrl)) m = 'tiktok';
        }
        if (m === 'shopee-kol' || m === 'shopee_kol') m = 'shopee';
        return m;
      };

      // Lấy limit từ query (?limit=...) nếu có
      const qs   = new URLSearchParams(location.search);
      const limQ = Number.parseInt(qs.get('limit') || '', 10);
      const LIMIT = Number.isFinite(limQ) ? limQ : 1000;

      // Skeleton
      wrap.innerHTML = Array.from({length: 8}).map(() => `
        <article class="card">
          <div class="skeleton" style="height:200px"></div>
          <div class="body">
            <div class="skeleton" style="height:18px"></div>
            <div class="skeleton" style="height:16px;width:40%;margin-top:8px"></div>
          </div>
        </article>
      `).join('');
      if (empty) empty.style.display = 'none';

      fetch('/assets/data/affiliates.json', { cache: 'no-store' })
        .then(r => r.ok ? r.json() : [])
        .then(all => {
          const arr = Array.isArray(all) ? all : (all.items || []);
          if (!arr.length) {
            if (empty) empty.style.display = 'block';
            wrap.innerHTML = '';
            return;
          }

          const list = arr
            .slice()
            .reverse()                 // ưu tiên sản phẩm mới thêm
            .filter(p => p && p.status !== false);

          wrap.innerHTML = list.slice(0, LIMIT).map(p => {
            const rawSku  = (p.sku || '').toString();
            const skuSlug = rawSku.toLowerCase();
            const name    = p.name || rawSku || 'Sản phẩm';

            const originUrl = normalizeOrigin(
              p.origin_url || p.origin || p.url || p.link || ''
            );
            const merchant  = guessMerchant(p, originUrl);
            const baseHref  = originUrl || '#';

            const priceHtml = Number.isFinite(+p.price)
              ? `<div class="price" data-price="${p.price}">${fmtPrice(p.price)}</div>`
              : '';

            const detailHref = rawSku
              ? `/g.html?sku=${encodeURIComponent(rawSku)}`
              : '#';

            const originAttr = originUrl
              ? ` data-origin-url="${esc(originUrl)}"`
              : '';

            const imgSrc = p.image ||
              `/assets/img/products/${skuSlug || 'placeholder'}.webp`;

            return `
              <article class="card">
                <a class="sr-only"
                   href="${esc(baseHref)}"
                   data-merchant="${esc(merchant || '')}"
                   data-sku="${esc(rawSku)}"${originAttr}>
                  ${esc(name)}
                </a>

                <a href="${esc(detailHref)}" aria-label="Xem chi tiết ${esc(name)}">
                  <img loading="lazy" decoding="async"
                       src="${esc(imgSrc)}"
                       alt="${esc(name)}"
                       onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'">
                </a>
                <div class="body">
                  <h3 class="name">
                    <a href="${esc(detailHref)}">${esc(name)}</a>
                  </h3>
                  ${priceHtml}
                  <a class="buy"
                     href="${esc(baseHref)}"
                     data-merchant="${esc(merchant || '')}"
                     data-sku="${esc(rawSku)}"${originAttr}
                     target="_blank"
                     rel="nofollow sponsored noopener">
                    Mua ngay
                  </a>
                </div>
              </article>`;
          }).join('');

          // Gọi lại scan để sinh deeplink isclix
          if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function') {
            window.mxdAffiliate.scan(wrap);
          }
        })
        .catch(err => {
          if (typeof console !== 'undefined' && console.error) {
            console.error('MXD store render error', err);
          }
          if (empty) empty.style.display = 'block';
          wrap.innerHTML = '';
        });

      // DEDUPE floating contacts nếu bị inject nhiều lần
      const fcs = document.querySelectorAll('#floating-contacts,.floating-contacts,.fc');
      if (fcs.length > 1) fcs.forEach((el, i) => i > 0 && el.remove());
    });
  </script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js?v=2025-09-30-mlz1');
    }
  </script>

  <!-- MTE:TRACKING -->
</body>
</html>
