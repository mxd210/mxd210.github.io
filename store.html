<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>

  <title>Cửa hàng MXD – Sản phẩm chọn lọc</title>
  <meta name="description" content="Các sản phẩm xây dựng được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền."/>
  <link rel="canonical" href="https://mxd210.github.io/store.html"/>
  <meta name="robots" content="index,follow"/>

  <!-- OG -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Cửa hàng MXD – Sản phẩm chọn lọc"/>
  <meta property="og:description" content="Các sản phẩm xây dựng được chọn lọc từ MXD – đúng nhu cầu, đáng đồng tiền."/>
  <meta property="og:url" content="https://mxd210.github.io/store.html"/>
  <meta property="og:image" content="/assets/img/products/placeholder.webp"/>

  <!-- VERIFY (điền mã thật khi có) -->
  <meta name="google-site-verification" content="PASTE_GOOGLE_CODE">
  <meta name="msvalidate.01" content="PASTE_BING_CODE">

  <link rel="stylesheet" href="/assets/site.css"/>

  <style>
    /* ================== THEME CHUẨN MXD (có dark mode) ================== */
    :root{
      --bg:#ffffff; --text:#111111; --muted:#666666; --border:#eaeaea;
      --card:#ffffff; --brand:#0a84ff; --brand-contrast:#ffffff;
      --hover:#111111; --radius:16px; --gap:16px; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1215; --text:#e8e8e8; --muted:#a2a2a2; --border:#262b31;
        --card:#14181d; --hover:#e8e8e8; --shadow:0 10px 28px rgba(0,0,0,.35);
      }
    }

    /* ================== BASE ================== */
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }
    a{color:var(--brand); text-decoration:none}
    a:hover{opacity:.9}
    header,footer{padding:12px 16px; border-bottom:1px solid var(--border)}
    footer{border-bottom:none;border-top:1px solid var(--border); margin-top:24px}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-9999px}

    /* ================== GRID / CARD (tối ưu mobile) ================== */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:var(--gap);margin:16px 0}
    .card{
      border:1px solid var(--border); border-radius:var(--radius);
      background:var(--card); overflow:hidden; display:flex; flex-direction:column;
      box-shadow:var(--shadow); transition:transform .15s ease;
    }
    .card:hover{transform:translateY(-2px)}
    .card img{width:100%;aspect-ratio:4/3;object-fit:cover;background:#f7f7f7;height:auto}
    .card .body{padding:12px}
    .name{font-size:16px;line-height:1.35;margin:0 0 6px}
    .price{font-weight:800;margin:4px 0 10px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .buy{
      display:inline-block; border:1px solid var(--text); color:var(--text);
      border-radius:12px; padding:10px 12px; text-decoration:none; width:100%; text-align:center;
    }
    .buy:hover{background:var(--hover); color:#fff}
    .badge{
      display:inline-block; background:var(--brand); color:var(--brand-contrast);
      padding:4px 8px; font-size:12px; border-radius:999px; margin:8px 8px 0;
      align-self:flex-start;
    }

    /* ================== SKELETON ================== */
    .skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg, rgba(0,0,0,0.06) 25%, rgba(0,0,0,0.12) 37%, rgba(0,0,0,0.06) 63%)}
    .skeleton::after{content:'';position:absolute;inset:0;animation:shimmer 1.4s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* ================== FLOATING CONTACTS (thu nhỏ 44px) ================== */
    .fc{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:1000}
    .fab{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer}
    .fab svg{width:22px;height:22px}
    .fab-brand{background:var(--brand); border-color:var(--brand); color:var(--brand-contrast)}
    .fab:hover{filter:brightness(1.02)}
    .fab-top{display:none} /* hiện bằng JS khi cuộn xuống */

    @media (max-width:480px){
      .name{font-size:15px}
    }
  </style>

  <!-- Chuẩn MXD: GA4 trước, Affiliate sau (mỗi trang chỉ 1 lần) -->
  <script src="/assets/analytics.js" defer></script>
  <script src="/assets/mxd-affiliate.js" defer></script>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0">Cửa hàng MXD</h1>
      <nav class="muted" style="margin-top:6px">
        <a href="/store/may-cat.html">Máy cắt</a>
      </nav>
      <!-- ĐÃ XÓA đoạn p hướng dẫn nội bộ để tránh rối người dùng -->
    </div>
  </header>

  <main class="container">
    <div id="product-list" class="grid" aria-live="polite"></div>
    <p id="empty" class="muted" style="display:none">Chưa có sản phẩm. Hãy thêm <code>/assets/data/affiliates.json</code> hoặc <code>/products.json</code>.</p>
    <noscript>Trang cần JavaScript để hiển thị danh sách sản phẩm.</noscript>
  </main>

  <footer>
    <div class="container">
      © MXD · <a href="/chinh-sach/bao-mat.html">Bảo mật</a> · <a href="/chinh-sach/doi-tra.html">Đổi trả</a> · <a href="/chinh-sach/bao-hanh.html">Bảo hành</a>
    </div>
  </footer>

  <!-- FLOATING CONTACTS — MXD -->
  <div class="fc" id="floating-contacts" aria-label="Liên hệ nhanh">
    <!-- Zalo -->
    <a class="fab fab-brand" href="https://zalo.me/0338328898" target="_blank" rel="noopener nofollow"
       data-channel="zalo" aria-label="Chat Zalo 0338328898">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12.5a1.5 1.5 0 0 1-2.45 1.15l-2.77-2.31H5a2 2 0 0 1-2-2V5z"/></svg>
    </a>
    <!-- Facebook Page -->
    <a class="fab fab-brand" href="https://www.facebook.com/mxd6686" target="_blank" rel="noopener nofollow"
       data-channel="facebook" aria-label="Facebook MXD6686">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M13 3h4a1 1 0 0 1 1 1v3h-3a2 2 0 0 0-2 2v3h5l-1 4h-4v7h-4v-7H7v-4h2V9a5 5 0 0 1 5-5z"/></svg>
    </a>
    <!-- Gọi điện -->
    <a class="fab" href="tel:0338328898" data-channel="phone" aria-label="Gọi 0338328898">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6.6 10.8a15.1 15.1 0 0 0 6.6 6.6l2.2-2.2a1 1 0 0 1 1.1-.2c1.2.5 2.6.8 4 .8a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1C12.3 21 3 11.7 3 1a1 1 0 0 1 1-1h3.2a1 1 0 0 1 1 1c0 1.4.3 2.8.8 4a1 1 0 0 1-.2 1.1L6.6 10.8z"/></svg>
    </a>
    <!-- Lên đầu trang -->
    <button class="fab fab-top" id="toTop" aria-label="Lên đầu trang">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 14l5-5 5 5H7z"/></svg>
    </button>
  </div>

  <script>
    // Hiện nút "Lên đầu trang" + GA4 event
    (function(){
      const root = document.getElementById('floating-contacts');
      const toTop = document.getElementById('toTop');
      function toggleTop(){ if (!toTop) return; toTop.style.display = window.scrollY > 320 ? 'flex' : 'none'; }
      window.addEventListener('scroll', toggleTop, {passive:true});
      document.addEventListener('DOMContentLoaded', toggleTop);
      function track(channel){ if (window.gtag) gtag('event','contact_click',{channel,page:location.pathname}); }
      root?.querySelectorAll('[data-channel]').forEach(el=> el.addEventListener('click', ()=>track(el.dataset.channel), {passive:true}));
      toTop?.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); track('to_top'); });
    })();
  </script>

 <script>
  // ===== Store Loader (robust) — fallback khi parse fail hoặc list trống =====
  (async () => {
    const app  = document.getElementById('product-list');
    const empty = document.getElementById('empty');
    const PLACEHOLDER = '/assets/img/products/placeholder.webp';

    const fmtVND = n => {
      const x = Number(n);
      if (!isFinite(x)) return '';
      try { return new Intl.NumberFormat('vi-VN').format(x) + '₫'; }
      catch { return (x+'').replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '₫'; }
    };
    const guessMerchant = (u) => {
      try {
        const host = new URL(u, location.origin).hostname;
        if (host.includes('shopee')) return 'shopee';
        if (host.includes('lazada')) return 'lazada';
        if (host.includes('tiki')) return 'tiki';
        if (host.includes('tik') && host.includes('tok')) return 'tiktok';
      } catch {}
      return '';
    };

    function renderSkeleton() {
      app.innerHTML = Array.from({length:8}).map(()=>`
        <article class="card">
          <div class="skeleton" style="aspect-ratio:4/3"></div>
          <div class="body">
            <div class="skeleton" style="height:18px;width:70%"></div>
            <div class="skeleton" style="height:16px;width:40%;margin-top:8px"></div>
            <div class="skeleton" style="height:34px;width:120px;margin-top:12px;border-radius:10px"></div>
          </div>
        </article>
      `).join('');
    }

    function normalizeList(data){
      // chấp nhận: [] | {items:[]} | object-map | {affiliates:[]} | {products:[]}
      const arr = Array.isArray(data) ? data :
                  (data && typeof data === 'object') ?
                    (Array.isArray(data.items) ? data.items
                    : Array.isArray(data.affiliates) ? data.affiliates
                    : Array.isArray(data.products) ? data.products
                    : Object.values(data))
                  : [];
      return arr.map(x => {
        const sku   = x.sku || x.p_sku || x.id || '';
        const name  = x.name || x.title || sku;
        const price = (typeof x.price === 'number') ? x.price : Number(String(x.price||'').replace(/[^\d]/g,''));
        const image = x.image || x.img || `/assets/img/products/${sku}.webp`;
        // link / links / origin
        let link = x.link || x.url || x.origin || (Array.isArray(x.links) ? (typeof x.links[0]==='string' ? x.links[0] : (x.links[0]?.href || '')) : '');
        let links = [];
        if (Array.isArray(x.links)) {
          links = x.links.map(l => {
            if (typeof l === 'string') return {href:l, merchant:guessMerchant(l)};
            return {href:(l.href||''), merchant:(l.merchant || guessMerchant(l.href||''))};
          }).filter(l => l.href);
        }
        if (!links.length && link) links = [{href:link, merchant:guessMerchant(link)}];
        const merchant = x.merchant || (links[0]?.merchant || guessMerchant(link));
        return { sku, name, price, image, link, links, merchant };
      });
    }

    function renderCard(p){
      const first = (p.links && p.links[0]) ? p.links[0] : (p.link ? {href:p.link, merchant:p.merchant||guessMerchant(p.link)} : null);
      const imgSrc = p.image || `/assets/img/products/${p.sku}.webp`;
      return `
        <article class="card">
          <span class="badge">MXD chọn</span>

          <!-- meta link CHUẨN để affiliate.js scan -->
          <a class="product-meta sr-only"
             href="${first ? first.href : '#'}"
             data-merchant="${first ? (first.merchant||'') : ''}"
             data-sku="${p.sku}"
             data-img="${imgSrc}"
             data-price="${p.price||''}">${p.name}</a>

          <img loading="lazy" decoding="async" width="640" height="480"
               src="${imgSrc}" alt="${p.name}"
               onerror="this.onerror=null;this.src='${PLACEHOLDER}'">

          <div class="body">
            <h3 class="name">${p.name}</h3>
            ${p.price ? `<div class="price" data-price="${p.price}">${fmtVND(p.price)}</div>` : ''}
            <div class="actions">
              ${first ? `<a class="buy" href="${first.href}" data-merchant="${first.merchant||''}" target="_blank" rel="nofollow sponsored noopener">Mua ngay</a>` : ''}
            </div>
          </div>
        </article>
      `;
    }

    async function loadJSON(src){
      try {
        const res = await fetch(src, {cache:'no-store'});
        const text = await res.text();
        try {
          const data = JSON.parse(text);
          return { ok: res.ok, status: res.status, src, list: normalizeList(data) };
        } catch {
          return { ok: false, status: res.status, src, list: [] };
        }
      } catch {
        return { ok: false, status: 0, src, list: [] };
      }
    }

    renderSkeleton();

    // 1) ưu tiên affiliates.json  → nếu rỗng/parse-fail → 2) thử products.json
    const primary  = await loadJSON('/assets/data/affiliates.json');
    const fallback = (!primary.list.length) ? await loadJSON('/products.json') : null;
    const srcUsed  = (primary.list.length ? primary : fallback);

    if (!srcUsed || !srcUsed.list.length){
      empty.style.display = 'block';
      app.innerHTML = '';
    } else {
      empty.style.display = 'none';
      app.innerHTML = srcUsed.list.map(renderCard).join('');

      // JSON-LD ItemList
      const ld = {
        "@context":"https://schema.org","@type":"ItemList",
        "itemListElement": srcUsed.list.map((p,i)=>({"@type":"ListItem","position":i+1,"name":p.name,"url": `/g.html?sku=${p.sku}`}))
      };
      const s = document.createElement('script'); s.type='application/ld+json'; s.textContent = JSON.stringify(ld); document.head.appendChild(s);

      // Cho affiliate script xử lý rewrite + GA
      if (window.mxdAffiliate?.scan) window.mxdAffiliate.scan();
    }

    // Debug nhẹ trên store: thêm #debug để thấy nguồn + count
    if (location.hash === '#debug') {
      const box = document.createElement('pre');
      box.style = 'white-space:pre-wrap;padding:12px;border:1px dashed #ccc;background:#f9f9f9;margin:16px';
      box.textContent = [
        'STORE DEBUG',
        `primary: ${primary.src} (status ${primary.status}) count=${primary.list.length}`,
        `fallback: ${fallback ? fallback.src : '(skipped)'}${fallback ? ' (status '+fallback.status+') count='+fallback.list.length : ''}`,
        `used   : ${srcUsed ? srcUsed.src : '(none)'}`
      ].join('\n');
      document.body.prepend(box);
    }
  })();
</script>

  <!-- JS khác (nếu tách riêng) -->
  <script src="/assets/js/floating-contact.js" defer></script>
</body>
</html>
