<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>

  <title>MXD — Chi tiết sản phẩm</title>
  <meta name="description" content="Xem chi tiết sản phẩm được MXD chọn lọc: thông tin, giá, hình ảnh và ưu đãi.">
  <link rel="canonical" href="https://mxd210.github.io/g.html">
  <meta name="robots" content="index,follow">

  <!-- OG -->
  <meta property="og:type" content="product">
  <meta property="og:title" content="Chi tiết sản phẩm | MXD">
  <meta property="og:description" content="Thông tin sản phẩm, giá, ưu đãi, link mua qua Shopee/Lazada/Tiki/TikTok.">
  <meta property="og:url" content="https://mxd210.github.io/g.html">
  <meta property="og:image" content="https://mxd210.github.io/assets/img/products/placeholder.webp">
  <meta property="og:locale" content="vi_VN">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MXD — Chi tiết sản phẩm">
  <meta name="twitter:description" content="Xem chi tiết sản phẩm được MXD chọn lọc.">
  <meta name="twitter:image" content="https://mxd210.github.io/assets/img/products/placeholder.webp">

  <!-- SUB -->
  <meta name="at:sub1" content="">
  <meta name="at:sub2" content="">
  <meta name="at:sub3" content="product">
  <meta name="at:sub4" content="mxd210">

  <!-- Styles (giữ nguyên layout cũ) -->
  <link rel="stylesheet" href="/assets/site.css"/>

  <!-- GA4 trước Affiliate -->
  <script defer src="/assets/analytics.js"></script>
  <script defer src="/assets/mxd-affiliate.js"></script>
</head>
<body>
  <header class="site-head">
    <div class="container" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:12px 16px;border-bottom:1px solid var(--line,#e5e7eb)">
      <a href="/" class="brand" style="font-weight:900;font-size:18px;color:var(--ink,#111);text-decoration:none">MXD</a>
      <nav class="site-nav" style="display:flex;gap:10px;margin-left:auto;flex-wrap:wrap">
        <a href="/" class="nav-link">Trang chủ</a>
        <a href="/store.html" class="nav-link">Cửa hàng</a>
        <a href="/blog/" class="nav-link">Tin tức</a>
        <a href="/tu-van.html" class="nav-link">Tư vấn</a>
        <a href="/lien-he.html" class="nav-link">Liên hệ</a>
      </nav>
    </div>
  </header>

  <main class="container product-page">
    <nav class="breadcrumb"><a href="/">Trang chủ</a> › <a href="/store.html">Cửa hàng</a> › Chi tiết</nav>

    <article id="product" class="product" data-sku="" data-merchant="" data-origin="" data-img="">
      <div class="gallery">
        <img id="p-img" src="/assets/img/products/placeholder.webp" alt="Ảnh sản phẩm" loading="lazy"
             onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'"/>
      </div>

      <div class="info">
        <h1 id="p-name" class="product-title">Sản phẩm</h1>
        <div class="price-wrap">
          <div id="p-price" class="price"></div>
          <div id="p-old" class="price-old"></div>
        </div>

        <div class="meta">
          <div id="p-brand" class="brand muted"></div>
          <div id="p-tags" class="tags muted"></div>
        </div>

        <div class="actions">
          <!-- CTA hiển thị — href sẽ được chuẩn hoá về origin_url, sau đó rewriter chuyển thành deeplink -->
          <a id="p-buy" class="buy-btn" href="#" target="_blank" rel="nofollow sponsored noopener" data-merchant="">Mua ngay</a>
        </div>

        <section id="p-desc" class="desc"></section>
      </div>
    </article>

    <section class="product-related">
      <h2>Sản phẩm liên quan</h2>
      <div id="related" class="product-grid"></div>
    </section>
  </main>

  <footer class="page-foot">© MXD · <a href="/chinh-sach/bao-mat.html">Bảo mật</a> · <a href="/chinh-sach/doi-tra.html">Đổi trả</a> · <a href="/chinh-sach/bao-hanh.html">Bảo hành</a></footer>

  <!-- JSON-LD holder (nếu trang có tiêm) -->
  <script type="application/ld+json" id="ld-product">{}</script>

  <script>
  (function(){
    const esc = s => String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const fmt = n => (n!=null && isFinite(+n)) ? new Intl.NumberFormat('vi-VN').format(+n)+'₫' : '';
    const qs = new URLSearchParams(location.search);
    const sku = (qs.get('sku')||'').trim().toLowerCase();

    const $ = sel => document.querySelector(sel);
    const el = {
      root: $('#product'),
      img:  $('#p-img'),
      name: $('#p-name'),
      price:$('#p-price'),
      old:  $('#p-old'),
      brand:$('#p-brand'),
      tags: $('#p-tags'),
      buy:  $('#p-buy'),
      desc: $('#p-desc'),
      related: $('#related'),
    };

    function setText(node, text){ if (node) node.textContent = text||''; }

    function buildRelated(items){
      const top = items.filter(x=>x && x.sku && x.sku.toLowerCase()!==sku).slice(0,12);
      const html = top.map(p=>{
        const img = p.image || `/assets/img/products/${(p.sku||'').toLowerCase()}.webp`;
        return `
        <article class="product-card" data-sku="${esc(p.sku||'')}">
          <a class="thumb" href="/g.html?sku=${encodeURIComponent(p.sku||'')}">
            <img loading="lazy" src="${esc(img)}" alt="${esc(p.name||p.sku||'Sản phẩm')} — MXD"
                 onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'">
          </a>
          <h3 class="name"><a href="/g.html?sku=${encodeURIComponent(p.sku||'')}">${esc(p.name||p.sku||'Sản phẩm')}</a></h3>
          ${p.price!=null?`<div class="price">${fmt(p.price)}</div>`:''}
          <div class="actions">
            <a class="buy" href="${esc(p.origin_url||p.url||'#')}" data-merchant="${esc((p.merchant||'').toLowerCase())}"
               target="_blank" rel="nofollow sponsored noopener">Mua ngay</a>
          </div>
        </article>`;
      }).join('');
      el.related.innerHTML = html;
      // Dán nhãn CTA + chạy rewriter cho khối related (sau khi render)
      try{ labelCTA(document); }catch(_){}
      try{ if (window.mxdAffiliate && typeof window.mxdAffiliate.scan==='function'){ window.mxdAffiliate.scan(); } }catch(_){}
    }

    async function loadData(){
      const sources = ['/assets/data/affiliates.json','/affiliates.json','/products.json'];
      for (const u of sources){
        try{
          const r = await fetch(u, { cache:'no-store' });
          if (!r.ok) continue;
          const j = await r.json();
          const arr = Array.isArray(j)? j : (j?.items || []);
          if (Array.isArray(arr) && arr.length) return arr;
        }catch(_){}
      }
      return [];
    }

    function findItem(arr){
      const s = sku;
      if (!s) return null;
      // match theo sku (ưu tiên), fallback theo name slug
      const strip = (v)=> String(v||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
      const bySku = arr.find(p => (p.sku||'').toLowerCase()===s);
      if (bySku) return bySku;
      const bySlug = arr.find(p => strip(p.name||'')===s);
      return bySlug || null;
    }

    function fill(p){
      if (!p){ setText(el.name,'Sản phẩm không tìm thấy'); return; }
      const img = p.image || `/assets/img/products/${(p.sku||'').toLowerCase()}.webp`;
      el.img.src = img;
      setText(el.name, p.name || p.sku || 'Sản phẩm');
      el.price.innerHTML = p.price!=null ? fmt(p.price) : '';
      const op = p.old_price ?? p.price_old ?? p.list_price ?? p.msrp ?? p.regular_price ?? null;
      el.old.innerHTML = (op && p.price && (+op>+p.price)) ? fmt(op) : '';
      setText(el.brand, p.brand ? 'Thương hiệu: '+p.brand : '');
      if (Array.isArray(p.tags) && p.tags.length){
        el.tags.innerHTML = 'Thẻ: ' + p.tags.map(t=>`<span class="tag">${esc(t)}</span>`).join(' ');
      } else el.tags.innerHTML = '';

      // Mô tả
      el.desc.innerHTML = (p.long_desc || p.short_desc || '').toString();

      // Thuộc tính cho context
      const merch = String(p.merchant||'').toLowerCase();
      const origin = p.origin_url || p.origin || p.url || p.link || '#';
      document.getElementById('product').setAttribute('data-sku', (p.sku||'').toLowerCase());
      document.getElementById('product').setAttribute('data-merchant', merch);
      document.getElementById('product').setAttribute('data-origin', origin);
      document.getElementById('product').setAttribute('data-img', img);

      // Chuẩn hoá CTA hiển thị (href = origin_url, rewriter sẽ đổi thành isclix)
      el.buy.setAttribute('href', origin);
      el.buy.setAttribute('data-merchant', merch);
      el.buy.setAttribute('target','_blank');
      el.buy.setAttribute('rel','nofollow sponsored noopener');

      // Dán nhãn + rewrite
      try{ labelCTA(document); }catch(_){}
      try{ if (window.mxdAffiliate && typeof window.mxdAffiliate.scan==='function'){ window.mxdAffiliate.scan(); } }catch(_){}
    }

    (async function run(){
      const arr = await loadData();
      const item = findItem(arr);
      fill(item);
      if (arr.length) buildRelated(arr);
    })();
  })();
  </script>
  <!-- Khối dưới đây là phần BỔ SUNG an toàn: đảm bảo có meta-link ẩn và hook hậu-render -->
  <!-- MXD-POST-RENDER HOOK + META-LINK ENFORCER (safe, no-layout-change) -->
  <script>
  (function(){
    // Utilities
    function norm(v){ return String(v||'').trim(); }
    function isHttp(u){ return /^https?:\/\//i.test(u||''); }

    // Thử nhận diện ngữ cảnh sản phẩm từ các nguồn hiện có trên trang
    function detectContext(){
      var sku='', merchant='', origin='', price=null, img='';

      // 1) Từ phần tử có data-*
      var root = document.querySelector('[data-sku]') || document.body;
      if (root){
        sku = norm(root.getAttribute('data-sku')||'');
        merchant = norm(root.getAttribute('data-merchant')||'');
        origin = norm(root.getAttribute('data-origin')||'');
        img = norm(root.getAttribute('data-img')||'');
      }

      // 2) Từ anchor meta có sẵn (nếu có)
      var meta = document.querySelector('.product-meta');
      if (meta){
        if (!origin) origin = norm(meta.getAttribute('href')||'');
        if (!merchant) merchant = norm(meta.getAttribute('data-merchant')||'');
        if (!sku) sku = norm(meta.getAttribute('data-sku')||'');
        if (!img) img = norm(meta.getAttribute('data-img')||'');
        if (meta.hasAttribute('data-price')) price = meta.getAttribute('data-price');
      }

      // 3) Từ JSON nhúng (nếu trang có ld-product)
      try{
        var ld = document.getElementById('ld-product');
        if (ld){
          var j = JSON.parse(ld.textContent||'{}');
          if (!sku) sku = norm(j.sku||'');
          if (!merchant) merchant = norm((j.merchant||'').toLowerCase());
          if (!origin) origin = norm(j.origin_url || j.url || '');
          if (!img) img = norm(j.image || '');
          if (j.price!=null) price = j.price;
        }
      }catch(_){}

      // 4) Fallback từ chính CTA đang hiển thị
      var cta = document.querySelector('.buy, .buy-btn, a[data-role="buy"]');
      if (cta){
        var href = norm(cta.getAttribute('href')||'');
        var m = norm(cta.getAttribute('data-merchant')||'');
        if (!origin) origin = href;
        if (!merchant) merchant = m;
      }
      return { sku, merchant: merchant.toLowerCase(), origin_url: origin, price, img };
    }

    // Bảo đảm có <a class="product-meta"> ẩn để rewriter đọc dữ liệu
    function ensureMetaLink(ctx){
      var holder = document.querySelector('.product-meta');
      if (!holder){
        holder = document.createElement('a');
        holder.className = 'product-meta';
        holder.style.position = 'absolute';
        holder.style.left = '-9999px';
        holder.style.width = '1px';
        holder.style.height = '1px';
        document.body.appendChild(holder);
      }
      if (ctx.origin_url) holder.setAttribute('href', ctx.origin_url);
      if (ctx.merchant) holder.setAttribute('data-merchant', ctx.merchant);
      if (ctx.sku) holder.setAttribute('data-sku', ctx.sku);
      if (ctx.img) holder.setAttribute('data-img', ctx.img);
      if (ctx.price!=null) holder.setAttribute('data-price', ctx.price);
    }

    // Đổi nhãn CTA theo sàn
    function labelCTA(root){
      var LABELS = {shopee:'Mua Shopee', lazada:'Mua Lazada', tiki:'Mua Tiki', tiktok:'Mua TikTok'};
      root.querySelectorAll('a.buy, a.buy-btn, a[data-role="buy"]').forEach(function(a){
        var m=(a.getAttribute('data-merchant')||'').toLowerCase();
        if (LABELS[m]) a.textContent = LABELS[m];
      });
    }

    function run(){
      var ctx = detectContext();
      ensureMetaLink(ctx);

      // Chuẩn hoá CTA hiển thị: để href = origin_url, rewriter sẽ convert sang isclix
      var cta = document.querySelector('.buy, .buy-btn, a[data-role="buy"]');
      if (cta){
        if (isHttp(ctx.origin_url)) cta.setAttribute('href', ctx.origin_url);
        if (ctx.merchant) cta.setAttribute('data-merchant', ctx.merchant);
        if (!cta.hasAttribute('rel')) cta.setAttribute('rel','nofollow sponsored noopener');
        if (!cta.hasAttribute('target')) cta.setAttribute('target','_blank');
      }

      // Đổi nhãn + chạy rewriter
      try{ labelCTA(document); }catch(_){}
      try{
        if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function'){
          window.mxdAffiliate.scan();
        }
      }catch(_){}
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', run);
    } else {
      setTimeout(run, 0);
    }
  })();
  </script>
  <!-- (tuỳ chọn) SW -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js?v=2025-11-08-g1');
    }
  </script>

  <!-- Anchor meta ẩn (nếu trang đã có sẵn thì script sẽ tái sử dụng) -->
  <a class="product-meta" href="#" data-merchant="" data-sku="" data-img="" style="position:absolute;left:-9999px;width:1px;height:1px"></a>

</body>
</html>
