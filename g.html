<script>
(function(){
  const PAGE = location.pathname.endsWith('/store.html') ? 'store'
              : location.pathname.endsWith('/g.html')    ? 'g'
              : 'index';

  // Vùng card để quan sát theo từng trang
  const SELECTORS = PAGE === 'g'
    ? ['main .card']                                       // 1 card
    : ['#product-list .card', '#updated-list .card', '.mte-deals .card']; // lưới

  const seen = new WeakSet();

  function skuFromCard(card){
    const meta = card.querySelector('.product-meta,[data-sku]');
    if (meta && meta.getAttribute('data-sku')) return meta.getAttribute('data-sku');
    const link = card.querySelector('a[href*="g.html?sku="]');
    if (link){
      try { return new URL(link.href, location.origin).searchParams.get('sku') || ''; }
      catch(_){}
    }
    return '';
  }

  function send(type, payload){
    const url = '/log'; // Tap 2 sẽ triển khai endpoint này trong Worker MTE
    const data = JSON.stringify({ type, page: PAGE, ts: Date.now(), ...payload });
    try {
      if (navigator.sendBeacon){
        const b = new Blob([data], { type: 'application/json' });
        navigator.sendBeacon(url, b);
        return;
      }
    } catch(_) {}
    fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: data, keepalive: true })
      .catch(()=>{});
  }

  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if (e.isIntersecting && e.intersectionRatio > 0.35 && !seen.has(e.target)){
        seen.add(e.target);
        const sku  = skuFromCard(e.target);
        const slot = e.target.getAttribute('data-slot') || '';
        send('imp', { sku, slot });
      }
    });
  }, { root: null, threshold: [0, 0.35, 0.66, 1] });

  function mount(){
    let idx = 0;
    SELECTORS.forEach(sel=>{
      document.querySelectorAll(sel).forEach(card=>{
        if (!card.getAttribute('data-slot')) card.setAttribute('data-slot', String(++idx));
        io.observe(card);
      });
    });
  }

  // Click tracking (capture sớm)
  document.addEventListener('click', function(ev){
    const a = ev.target.closest && ev.target.closest('a');
    if (!a) return;
    const card = ev.target.closest('.card');
    const sku  = card ? skuFromCard(card) : (()=>{
      try { return new URL(a.href, location.origin).searchParams.get('sku') || ''; } catch(_) { return ''; }
    })();
    const slot = card ? (card.getAttribute('data-slot') || '') : '';
    const merchant = a.getAttribute('data-merchant') || '';
    send('clk', { sku, slot, merchant, href: a.href });
  }, { capture: true, passive: true });

  window.addEventListener('DOMContentLoaded', mount);
})();
</script>
