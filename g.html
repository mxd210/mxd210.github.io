<!-- REPLACE WHOLE FILE: /g.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>

  <title>Chi tiết sản phẩm | MXD</title>
  <meta name="description" content="Chi tiết sản phẩm được MXD chọn lọc – xem thông tin, giá tham khảo và mua qua các sàn TMĐT.">
  <link rel="canonical" href="https://mxd210.github.io/g.html">
  <meta name="robots" content="index,follow"/>

  <!-- OG fallback (sẽ được JS cập nhật lại theo từng sản phẩm nếu cần) -->
  <meta property="og:type" content="product"/>
  <meta property="og:title" content="Chi tiết sản phẩm | MXD"/>
  <meta property="og:description" content="Sản phẩm do MXD chọn lọc, dễ mua, dễ so sánh."/>
  <meta property="og:url" content="https://mxd210.github.io/g.html"/>
  <meta property="og:image" content="https://mxd210.github.io/assets/img/og/home.webp"/>

  <link rel="stylesheet" href="/assets/site.css"/>

  <!-- GA4 trước affiliate -->
  <script defer src="/assets/analytics.js"></script>
  <script defer src="/assets/mxd-affiliate.js"></script>

  <style>
    :root{
      --brand:#ff6a00;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:#111;background:#fff}
    header{position:sticky;top:0;z-index:50;background:#fff;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:1180px;margin:0 auto;padding:0 16px}
    .site-header-inner{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      padding:12px 16px;
    }
    .brand{font-weight:900;font-size:20px;color:#111;text-decoration:none}
    .site-nav{display:flex;gap:10px;margin-left:auto;flex-wrap:wrap}
    .nav-link{padding:8px 10px;border-radius:10px;text-decoration:none;color:#111;font-size:14px}
    .nav-link:hover{background:rgba(255,106,0,.08)}
    .nav-link[aria-current="page"]{background:#fff4ec;color:#b24900}

    main{padding:16px 0 32px}
    .breadcrumbs{
      font-size:13px;color:var(--muted);margin:8px 0 12px;
    }
    .breadcrumbs a{color:var(--muted);text-decoration:none}
    .breadcrumbs a:hover{text-decoration:underline}

    .product-page{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.4fr);
      gap:24px;
      align-items:flex-start;
    }
    @media(max-width:840px){
      .product-page{grid-template-columns:1fr}
    }

    .product-media img{
      width:100%;
      border-radius:16px;
      border:1px solid var(--border);
      background:#f3f4f6;
      object-fit:cover;
    }

    .product-meta h1{
      font-size:22px;
      margin:0 0 8px;
      line-height:1.4;
    }
    .price{
      font-size:22px;
      font-weight:800;
      color:#b91c1c;
      margin:8px 0 10px;
    }
    .meta-line{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .meta-line strong{color:#111}
    .tags{
      margin:8px 0 12px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:#374151;
    }

    .buy-area{
      margin:16px 0 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn-buy{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 16px;
      border-radius:999px;
      border:none;
      text-decoration:none;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
    }
    .btn-buy[data-merchant="shopee"]{background:#ee4d2d}
    .btn-buy[data-merchant="lazada"]{background:#0f146d}
    .btn-buy[data-merchant="tiki"]{background:#1a94ff}
    .btn-buy[data-merchant="tiktok"]{background:#000}
    .btn-buy:hover{filter:brightness(1.05)}

    .btn-secondary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:#111;
      font-size:13px;
      text-decoration:none;
    }

    .desc-block{
      margin-top:12px;
      font-size:14px;
      line-height:1.6;
    }

    .section-title{
      font-size:18px;
      font-weight:700;
      margin:24px 0 12px;
    }

    .related-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
      gap:16px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      text-decoration:none;
      color:#111;
      font-size:13px;
    }
    .card img{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      background:#f3f4f6;
    }
    .card-body{padding:8px 10px}
    .card-title{
      margin:0 0 6px;
      font-size:13px;
      line-height:1.4;
      max-height:2.8em;
      overflow:hidden;
    }
    .card-price{
      font-weight:700;
      color:#b91c1c;
      font-size:13px;
    }

    .muted{color:var(--muted);font-size:13px}
    footer{
      border-top:1px solid var(--border);
      padding:12px 16px;
      font-size:13px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="container site-header-inner">
      <a href="/" class="brand">MXD</a>
      <nav class="site-nav">
        <a href="/" class="nav-link">Trang chủ</a>
        <a href="/store.html" class="nav-link">Cửa hàng</a>
        <a href="/blog/" class="nav-link">Tin tức</a>
        <a href="/tu-van.html" class="nav-link">Tư vấn</a>
        <a href="/cong-cu/" class="nav-link">Công cụ</a>
        <a href="/lien-he.html" class="nav-link">Liên hệ</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <a href="/">Trang chủ</a> › <a href="/store.html">Cửa hàng</a> › <span>Chi tiết</span>
    </nav>

    <div id="product-wrap">
      <p class="muted">Đang tải dữ liệu sản phẩm…</p>
    </div>

    <section id="related-section" style="display:none">
      <h2 class="section-title">Sản phẩm liên quan</h2>
      <div id="related-list" class="related-grid"></div>
    </section>
  </main>

  <footer>
    <div class="container">
      © MXD · <a href="/chinh-sach/bao-mat.html">Bảo mật</a> ·
      <a href="/chinh-sach/doi-tra.html">Đổi trả</a> ·
      <a href="/chinh-sach/bao-hanh.html">Bảo hành</a>
    </div>
  </footer>

  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const sku = (params.get('sku') || '').toLowerCase().trim();

      const wrap = document.getElementById('product-wrap');
      const relatedSection = document.getElementById('related-section');
      const relatedList = document.getElementById('related-list');

      if (!sku) {
        wrap.innerHTML = '<p class="muted">Thiếu tham số <code>sku</code>. Vui lòng quay lại cửa hàng.</p>';
        return;
      }

      const money = n => Number.isFinite(+n)
        ? new Intl.NumberFormat('vi-VN').format(+n) + '₫'
        : '';

      function esc(s){
        return String(s || '').replace(/[&<>"']/g, c => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c]));
      }

      fetch('/assets/data/affiliates.json', { cache: 'no-store' })
        .then(r => r.ok ? r.json() : [])
        .then(all => {
          const arr = Array.isArray(all) ? all : (all.items || []);
          if (!arr.length) {
            wrap.innerHTML = '<p class="muted">Chưa có dữ liệu sản phẩm.</p>';
            return;
          }

          const product = arr.find(p => (p.sku || '').toLowerCase() === sku);
          if (!product) {
            wrap.innerHTML = '<p class="muted">Không tìm thấy sản phẩm với SKU <code>'+esc(sku)+'</code>.</p>';
            return;
          }

          const name = product.name || product.sku || 'Sản phẩm';
          const priceHtml = Number.isFinite(+product.price)
            ? '<div class="price">'+ money(+product.price) +'</div>' : '';
          const img = product.image || ('/assets/img/products/'+ sku +'.webp');
          const brand = product.brand || '';
          const category = product.category || '';
          const merchant = (product.merchant || '').toLowerCase();
          const tags = Array.isArray(product.tags) ? product.tags : [];
          const shortDesc = product.short_desc || '';
          const fullSeoDesc = product.seo_description || shortDesc || '';

          // Ưu tiên deeplink, fallback origin
          let buyUrl = product.deeplink || product.origin || product.origin_url || '';
          if (!buyUrl) buyUrl = '#';

          // Cập nhật <title> + meta description theo sản phẩm
          const seoTitle = product.seo_title || (name + ' | MXD');
          document.title = seoTitle;

          const metaDesc = document.querySelector('meta[name="description"]');
          if (metaDesc) metaDesc.setAttribute('content', fullSeoDesc || 'Sản phẩm do MXD chọn lọc.');
          const ogTitle = document.querySelector('meta[property="og:title"]');
          if (ogTitle) ogTitle.setAttribute('content', seoTitle);
          const ogDesc = document.querySelector('meta[property="og:description"]');
          if (ogDesc) ogDesc.setAttribute('content', fullSeoDesc || 'Sản phẩm do MXD chọn lọc.');
          const ogImage = document.querySelector('meta[property="og:image"]');
          if (ogImage) ogImage.setAttribute('content', new URL(img, location.origin).href);
          const ogUrl = document.querySelector('meta[property="og:url"]');
          if (ogUrl) ogUrl.setAttribute('content', location.href);

          // Render chi tiết sản phẩm
          let merchantLabel = 'Mua ngay';
          if (merchant === 'shopee') merchantLabel = 'Mua trên Shopee';
          else if (merchant === 'lazada') merchantLabel = 'Mua trên Lazada';
          else if (merchant === 'tiki') merchantLabel = 'Mua trên Tiki';
          else if (merchant === 'tiktok') merchantLabel = 'Mua trên TikTok Shop';

          wrap.innerHTML = `
            <div class="product-page">
              <div class="product-media">
                <img loading="lazy" decoding="async"
                     src="${esc(img)}"
                     alt="${esc(name)}"
                     onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'">
              </div>
              <article class="product-meta">
                <h1>${esc(name)}</h1>
                ${priceHtml}
                ${brand ? `<div class="meta-line"><strong>Thương hiệu:</strong> ${esc(brand)}</div>` : ''}
                ${category ? `<div class="meta-line"><strong>Danh mục:</strong> ${esc(category)}</div>` : ''}
                ${merchant ? `<div class="meta-line"><strong>Sàn:</strong> ${esc(merchant)}</div>` : ''}
                
                <div class="buy-area">
                  <a class="btn-buy"
                     id="buyBtn"
                     href="${esc(buyUrl)}"
                     data-merchant="${esc(merchant)}"
                     target="_blank"
                     rel="nofollow sponsored noopener">
                    ${merchantLabel}
                  </a>
                  <a class="btn-secondary" href="/store.html">← Về cửa hàng</a>
                </div>

                ${tags.length ? `
                  <div class="tags">
                    ${tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('')}
                  </div>
                ` : ''}

                ${shortDesc ? `
                  <div class="desc-block">
                    <strong>Mô tả ngắn:</strong><br>
                    ${esc(shortDesc)}
                  </div>
                ` : ''}
              </article>
            </div>
          `;

          // Render sản phẩm liên quan (cùng category hoặc cùng merchant)
          const related = arr.filter(p =>
            p !== product &&
            p.status !== 'hidden' &&
            (
              (category && p.category === category) ||
              ((p.merchant || '').toLowerCase() === merchant)
            )
          ).slice(0, 8);

          if (related.length) {
            relatedSection.style.display = '';
            relatedList.innerHTML = related.map(p => {
              const rSku = (p.sku || '').toLowerCase();
              const rName = p.name || rSku || 'Sản phẩm';
              const rImg = p.image || ('/assets/img/products/'+ rSku +'.webp');
              const rPrice = Number.isFinite(+p.price) ? money(+p.price) : '';
              return `
                <a class="card" href="/g.html?sku=${encodeURIComponent(rSku)}">
                  <img loading="lazy" decoding="async"
                       src="${esc(rImg)}"
                       alt="${esc(rName)}"
                       onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp'">
                  <div class="card-body">
                    <div class="card-title">${esc(rName)}</div>
                    ${rPrice ? `<div class="card-price">${rPrice}</div>` : ''}
                  </div>
                </a>
              `;
            }).join('');
          }

          // Cho mxdAffiliate xử lý deeplink (nếu chỉ có origin)
          if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function') {
            window.mxdAffiliate.scan();
          }
        })
        .catch(err => {
          console.error(err);
          wrap.innerHTML = '<p class="muted">Lỗi tải dữ liệu sản phẩm. Vui lòng thử lại sau.</p>';
        });
    })();
  </script>
</body>
</html>
