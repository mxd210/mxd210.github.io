<!-- REPLACE WHOLE FILE: /g.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <title>Chi tiết sản phẩm | MXD210</title>
  <meta name="description" content="Chi tiết sản phẩm được MXD210 chọn lọc từ các sàn thương mại điện tử.">
  <!-- canonical sẽ được JS cập nhật theo SKU -->
  <link rel="canonical" href="https://mxd210.github.io/g.html"/>

  <meta name="robots" content="index,follow"/>

  <!-- OPEN GRAPH (JS sẽ cập nhật lại theo sản phẩm) -->
  <meta property="og:title" content="Chi tiết sản phẩm | MXD210"/>
  <meta property="og:description" content="Xem chi tiết sản phẩm được MXD210 chọn lọc."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://mxd210.github.io/g.html"/>
  <meta property="og:image" content="https://mxd210.github.io/assets/img/logo-1200x630.webp"/>

  <link rel="stylesheet" href="/assets/site.css"/>

  <!-- Google Analytics 4 -->
  <script defer src="/assets/analytics.js"></script>
  <!-- Affiliate rewrite (bắt buộc sau GA4) -->
  <script defer src="/assets/mxd-affiliate.js"></script>

  <!-- JSON-LD sẽ được JS fill -->
  <script type="application/ld+json" id="product-jsonld"></script>
</head>
<body data-nav="store">
<header class="site-header">
  <div class="container">
    <a href="/" class="logo">
      <span class="logo-main">MXD210</span>
      <span class="logo-sub">Xây dựng &amp; Affiliate</span>
    </a>
    <nav class="main-nav">
      <ul>
        <li><a href="/" data-nav="home">Trang chủ</a></li>
        <li><a href="/store.html" data-nav="store">Cửa hàng</a></li>
        <li><a href="/blog-xay-dung.html" data-nav="blog-xd">Góc xây dựng</a></li>
        <li><a href="/mxd-aff-academy.html" data-nav="aff-academy">Góc Affiliate</a></li>
        <li><a href="/contact.html" data-nav="contact">Liên hệ</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="page-main">
  <!-- KHỐI CHI TIẾT SẢN PHẨM -->
  <section class="product-detail container" data-mxd-product-page>
    <div class="product-detail-grid">
      <div class="product-media">
        <img id="product-image"
             src="/assets/img/products/placeholder.webp"
             alt="Đang tải sản phẩm"
             loading="lazy"
             onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp';">
      </div>

      <div class="product-info">
        <h1 id="product-name">Đang tải sản phẩm…</h1>

        <p class="product-price" id="product-price"></p>

        <div class="product-short" id="product-short"></div>

        <div class="product-meta">
          <span id="product-merchant"></span>
          <span id="product-brand"></span>
          <span id="product-updated"></span>
        </div>

        <div class="product-actions">
          <a id="product-buy"
             class="buy btn-buy"
             href="#"
             data-merchant=""
             data-sku="">
            Mua ngay tại sàn
          </a>
        </div>
      </div>
    </div>

    <div class="product-error" id="product-error" hidden>
      <p>Không tìm thấy sản phẩm hoặc thiếu mã <code>sku</code>. Vui lòng quay lại cửa hàng và thử lại.</p>
      <p><a href="/store.html">← Quay lại cửa hàng MXD210</a></p>
    </div>
  </section>

  <!-- KHỐI SẢN PHẨM LIÊN QUAN -->
  <section class="container related-section">
    <header class="section-header">
      <h2>Sản phẩm liên quan</h2>
    </header>
    <div class="product-grid" id="related-grid">
      <!-- JS render card, cùng chuẩn với các trang mục -->
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container">
    <p>© MXD210 – Gợi ý sản phẩm gần với nhu cầu thực tế của anh em ngoài công trình và trong gia đình.</p>
  </div>
</footer>

<script>
// ================== MXD PRODUCT DETAIL v2 ==================

document.addEventListener('DOMContentLoaded', () => {
  initMXDProductPage().catch(err => {
    console.error('MXD g.html error:', err);
  });
});

async function initMXDProductPage() {
  const root = document.querySelector('[data-mxd-product-page]');
  if (!root) return;

  const params = new URLSearchParams(window.location.search);
  const sku = (params.get('sku') || '').trim();

  if (!sku) {
    renderNotFound('Thiếu mã sản phẩm (sku).');
    return;
  }

  const res = await fetch('/assets/data/affiliates.json', { cache: 'no-store' });
  if (!res.ok) {
    renderNotFound('Không tải được dữ liệu sản phẩm.');
    return;
  }

  let data;
  try {
    data = await res.json();
  } catch (e) {
    console.error('AFF parse error:', e);
    renderNotFound('Dữ liệu sản phẩm không hợp lệ.');
    return;
  }
  if (!Array.isArray(data)) data = [];

  // tìm sản phẩm theo sku
  const product = data.find(p => String(p.sku || '') === sku);
  if (!product) {
    renderNotFound('Không tìm thấy sản phẩm với mã: ' + sku);
    return;
  }

  renderProductDetail(product);
  updateHeadMeta(product);
  updateProductJsonLd(product);

  renderRelatedProducts(data, product);
}

function renderNotFound(msg) {
  const detailGrid = document.querySelector('.product-detail-grid');
  const errorBox = document.getElementById('product-error');
  if (detailGrid) detailGrid.style.display = 'none';
  if (errorBox) {
    errorBox.hidden = false;
    errorBox.querySelector('p').firstChild.nodeValue = msg + ' ';
  }

  const related = document.getElementById('related-grid');
  if (related) related.innerHTML = '';
}

function renderProductDetail(p) {
  const name = p.name || '';
  const priceValue = getPrice(p);
  const priceText = priceValue != null ? formatVND(priceValue) : '';
  const shortDesc = (p.short_desc || p.description || '').toString().trim();
  const sku = p.sku || '';
  const brand = (p.brand || '').toString().trim();
  const updated = (p.updated_at || '').toString().trim();
  const originRaw = (p.origin || p.origin_url || '').toString().trim();
  const origin = originRaw || '#';

  const merchant = (p.merchant || detectMerchant(origin)).toString().toLowerCase();
  const merchantLabel = merchantLabelFor(merchant);

  const imgSrc = p.image || `/assets/img/products/${encodeURIComponent(sku || 'placeholder')}.webp`;

  const imgEl = document.getElementById('product-image');
  const nameEl = document.getElementById('product-name');
  const priceEl = document.getElementById('product-price');
  const shortEl = document.getElementById('product-short');
  const merchantEl = document.getElementById('product-merchant');
  const brandEl = document.getElementById('product-brand');
  const updatedEl = document.getElementById('product-updated');
  const buyEl = document.getElementById('product-buy');

  if (imgEl) {
    imgEl.src = imgSrc;
    imgEl.alt = name || 'Sản phẩm';
  }
  if (nameEl) nameEl.textContent = name || 'Sản phẩm không tên';
  if (priceEl) priceEl.textContent = priceText ? priceText : '';
  if (shortEl) {
    shortEl.textContent = shortDesc || 'Đang cập nhật mô tả chi tiết cho sản phẩm này.';
  }
  if (merchantEl) {
    merchantEl.textContent = merchantLabel ? `Mua trên: ${merchantLabel}` : '';
  }
  if (brandEl && brand) {
    brandEl.textContent = `• Thương hiệu: ${brand}`;
  }
  if (updatedEl && updated) {
    const d = new Date(updated);
    if (!isNaN(d.getTime())) {
      const formatted = d.toLocaleDateString('vi-VN');
      updatedEl.textContent = `• Cập nhật: ${formatted}`;
    }
  }

  if (buyEl) {
    buyEl.href = escapeAttr(origin);
    buyEl.dataset.merchant = merchant;
    buyEl.dataset.sku = sku;
    if (merchantLabel) {
      buyEl.textContent = `Mua ngay trên ${merchantLabel}`;
    } else {
      buyEl.textContent = 'Mua ngay tại sàn';
    }
  }
}

// ========== HEAD META & JSON-LD ==========

function updateHeadMeta(p) {
  const params = new URLSearchParams(window.location.search);
  const sku = (p.sku || params.get('sku') || '').toString();
  const origin = window.location.origin || 'https://mxd210.github.io';
  const canonical = `${origin}/g.html?sku=${encodeURIComponent(sku)}`;

  // title
  document.title = `${p.name || 'Chi tiết sản phẩm'} | MXD210`;

  // meta description
  const desc = buildDescription(p);
  let metaDesc = document.querySelector('meta[name="description"]');
  if (metaDesc) {
    metaDesc.setAttribute('content', desc);
  }

  // canonical
  let linkCanon = document.querySelector('link[rel="canonical"]');
  if (!linkCanon) {
    linkCanon = document.createElement('link');
    linkCanon.rel = 'canonical';
    document.head.appendChild(linkCanon);
  }
  linkCanon.href = canonical;

  // OG
  const ogTitle = document.querySelector('meta[property="og:title"]');
  if (ogTitle) ogTitle.setAttribute('content', `${p.name || ''} | MXD210`);

  const ogDesc = document.querySelector('meta[property="og:description"]');
  if (ogDesc) ogDesc.setAttribute('content', desc);

  const ogUrl = document.querySelector('meta[property="og:url"]');
  if (ogUrl) ogUrl.setAttribute('content', canonical);

  const ogImg = document.querySelector('meta[property="og:image"]');
  const imgSrc = p.image || `/assets/img/products/${encodeURIComponent(p.sku || 'placeholder')}.webp`;
  if (ogImg) ogImg.setAttribute('content', absUrl(imgSrc));
}

function updateProductJsonLd(p) {
  const params = new URLSearchParams(window.location.search);
  const sku = (p.sku || params.get('sku') || '').toString();
  const origin = window.location.origin || 'https://mxd210.github.io';
  const canonical = `${origin}/g.html?sku=${encodeURIComponent(sku)}`;

  const priceValue = getPrice(p);
  const imgSrc = p.image || `/assets/img/products/${encodeURIComponent(p.sku || 'placeholder')}.webp`;
  const shortDesc = (p.short_desc || p.description || p.name || '').toString().trim();

  const json = {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": p.name || "",
    "image": [absUrl(imgSrc)],
    "description": shortDesc,
    "sku": p.sku || "",
    "brand": p.brand ? { "@type": "Brand", "name": p.brand } : undefined,
    "offers": {
      "@type": "Offer",
      "priceCurrency": "VND",
      "price": priceValue != null ? String(priceValue) : "",
      "url": canonical,
      "availability": "https://schema.org/InStock"
    }
  };
  // xoá key undefined cho gọn
  if (!json.brand) delete json.brand;

  const el = document.getElementById('product-jsonld');
  if (el) {
    el.textContent = JSON.stringify(json, null, 2);
  }
}

// ========== RELATED PRODUCTS ==========

function renderRelatedProducts(allProducts, current) {
  const grid = document.getElementById('related-grid');
  if (!grid) return;

  const currentSku = (current.sku || '').toString();
  const category = (current.category || '').toString();

  let list = allProducts.filter(p => {
    const status = (p.status || 'active').toString().toLowerCase();
    if (['archived', 'hidden', 'draft'].includes(status)) return false;
    if (String(p.sku || '') === currentSku) return false;
    return (p.category || '') === category;
  });

  // fallback: nếu cùng category quá ít, mở rộng nhẹ
  if (list.length < 4) {
    const extra = allProducts.filter(p => {
      const status = (p.status || 'active').toString().toLowerCase();
      if (['archived', 'hidden', 'draft'].includes(status)) return false;
      if (String(p.sku || '') === currentSku) return false;
      if ((p.category || '') === category) return false; // tránh trùng
      return true;
    });
    list = list.concat(extra).slice(0, 8);
  }

  // sort: featured trước, sau đó updated_at mới trước
  list.sort((a, b) => {
    const fa = a.featured ? 1 : 0;
    const fb = b.featured ? 1 : 0;
    if (fb !== fa) return fb - fa;
    const ta = getTime(a.updated_at);
    const tb = getTime(b.updated_at);
    return tb - ta;
  });

  const limit = 8;
  if (list.length > limit) list = list.slice(0, limit);

  if (list.length === 0) {
    grid.innerHTML = '<p>Chưa có sản phẩm liên quan để gợi ý.</p>';
    return;
  }

  grid.innerHTML = list.map(renderRelatedCard).join('');
}

function renderRelatedCard(p) {
  const name = escapeHTML(p.name || '');
  const sku = escapeHTML(p.sku || '');
  const originRaw = (p.origin || p.origin_url || '').toString().trim();
  const origin = originRaw || '#';
  const imgSrc = p.image || `/assets/img/products/${encodeURIComponent(p.sku || 'placeholder')}.webp`;
  const shortDesc = escapeHTML(
    (p.short_desc || p.description || p.name || '').toString().trim()
  );
  const priceValue = getPrice(p);
  const priceText = priceValue != null ? escapeHTML(formatVND(priceValue)) : '';
  const merchantRaw = (p.merchant || detectMerchant(origin)).toString().toLowerCase();
  const detailHref = `/g.html?sku=${encodeURIComponent(p.sku || '')}`;

  return `
  <article class="product-card" data-sku="${sku}">
    <a href="${detailHref}">
      <div class="thumb">
        <img src="${imgSrc}"
             alt="${name}"
             loading="lazy"
             onerror="this.onerror=null;this.src='/assets/img/products/placeholder.webp';">
        <div class="product-hover">
          <p>${shortDesc}</p>
        </div>
      </div>
    </a>
    <div class="body">
      <div class="product-title title">
        <a href="${detailHref}">${name}</a>
      </div>
      <div class="price">${priceText}</div>
      <div class="actions">
        <a class="buy btn-buy"
           href="${escapeAttr(origin)}"
           data-merchant="${escapeAttr(merchantRaw)}"
           data-sku="${sku}">
          Mua ngay
        </a>
      </div>
    </div>
  </article>
  `;
}

// ========== HELPERS ==========
function getTime(val) {
  if (!val) return 0;
  const t = new Date(val).getTime();
  return Number.isFinite(t) ? t : 0;
}

function getPrice(p) {
  const v = p.price ?? p.price_vnd ?? p.price_vnd_int;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function formatVND(value) {
  return Number(value).toLocaleString('vi-VN') + '₫';
}

function escapeHTML(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function escapeAttr(str) {
  return escapeHTML(str).replace(/`/g, '&#96;');
}

function detectMerchant(url) {
  try {
    if (!url) return '';
    const u = new URL(url.startsWith('http') ? url : 'https://' + url);
    const host = u.hostname.toLowerCase();
    if (host.includes('shopee')) return 'shopee';
    if (host.includes('lazada')) return 'lazada';
    if (host.includes('tiki')) return 'tiki';
    if (host.includes('tiktok')) return 'tiktok';
    return '';
  } catch {
    return '';
  }
}

function merchantLabelFor(m) {
  switch (m) {
    case 'shopee': return 'Shopee';
    case 'lazada': return 'Lazada';
    case 'tiki':   return 'Tiki';
    case 'tiktok': return 'TikTok Shop';
    default:       return '';
  }
}

function absUrl(path) {
  if (!path) return '';
  if (/^https?:\/\//i.test(path)) return path;
  const origin = window.location.origin || 'https://mxd210.github.io';
  return origin.replace(/\/+$/, '') + '/' + String(path).replace(/^\/+/, '');
}

function buildDescription(p) {
  const base = (p.short_desc || p.description || p.name || '').toString().trim();
  if (base) return base;
  const brand = (p.brand || '').toString().trim();
  if (brand) return `${p.name || 'Sản phẩm'} của ${brand}, được MXD210 chọn lọc từ các sàn thương mại điện tử.`;
  return `${p.name || 'Sản phẩm'} được MXD210 chọn lọc từ các sàn thương mại điện tử.`;
}
</script>
</body>
</html>
