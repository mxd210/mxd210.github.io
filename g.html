<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MXD – Sản phẩm</title>
  <meta name="description" content="Chi tiết sản phẩm MXD."/>
  <link id="canonical" rel="canonical" href="https://mxd210.github.io/g.html"/>

  <!-- OG defaults (sẽ cập nhật động theo SKU) -->
  <meta property="og:type" content="product"/>
  <meta property="og:title" content="MXD – Sản phẩm"/>
  <meta property="og:description" content="Chi tiết sản phẩm MXD."/>
  <meta property="og:url" content="https://mxd210.github.io/g.html"/>
  <meta property="og:image" content="/assets/img/products/placeholder.webp"/>

  <link rel="stylesheet" href="/assets/site.css"/>
  <style>
    :root{--gap:16px;--radius:18px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#111}
    header,footer{padding:12px 16px;border-bottom:1px solid #eee}
    footer{border-bottom:none;border-top:1px solid #eee;margin-top:24px}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);align-items:start}
    .imgbox{border:1px solid #eee;border-radius:var(--radius);overflow:hidden;background:#fff}
    .imgbox img{width:100%;height:auto;display:block;background:#f7f7f7}
    .meta h1{margin:0 0 8px;font-size:24px;line-height:1.25}
    .price{font-weight:800;font-size:22px;margin:4px 0 12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .buy{display:inline-block;border:1px solid #111;border-radius:14px;padding:10px 14px;text-decoration:none}
    .buy:hover{background:#111;color:#fff}
    .muted{color:#666}
    .crumb{margin:6px 0 12px}
    .crumb a{color:#06c;text-decoration:none}
    .sr-only{position:absolute;left:-9999px}
    @media (max-width: 820px){ .wrap{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="crumb"><a href="/">Trang chủ</a> › <a href="/store.html">Cửa hàng</a> › <span id="crumb-name">Sản phẩm</span></div>
    </div>
  </header>

  <main class="container" id="app" aria-live="polite">
    <div class="wrap" id="skeleton">
      <div class="imgbox"><img src="/assets/img/products/placeholder.webp" alt="Đang tải..."></div>
      <div class="meta">
        <h1>Đang tải…</h1>
        <div class="price muted">—</div>
        <p class="muted">Đang nạp dữ liệu sản phẩm…</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">© MXD</div>
  </footer>

  <!-- GA4 luôn trước affiliate -->
  <script src="/assets/analytics.js" defer></script>
  <script src="/assets/mxd-affiliate.js" defer></script>

  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const sku = (params.get('sku') || '').trim();
    const app = document.getElementById('app');
    const placeholder = '/assets/img/products/placeholder.webp';

    if (!sku) {
      location.replace('/store.html');
      return;
    }

    const fmtVND = n => {
      const x = Number(n);
      if (!isFinite(x)) return '';
      try { return new Intl.NumberFormat('vi-VN').format(x) + '₫'; }
      catch { return (x+'').replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '₫'; }
    };

    function setHead(p){
      const title = `${p.name} | MXD`;
      document.title = title;
      const desc = `Thông tin & nơi mua: ${p.name}. Giá tham khảo ${p.price ? fmtVND(p.price) : '—'}.`;
      const url = `https://mxd210.github.io/g.html?sku=${encodeURIComponent(p.sku)}`;
      const img = `/assets/img/products/${p.sku}.webp`;

      // canonical
      const can = document.getElementById('canonical');
      can.setAttribute('href', url);

      // OG
      const set = (sel, val) => {
        let m = document.querySelector(sel);
        if (!m) { m = document.createElement('meta'); 
          if (sel.includes('property')) m.setAttribute('property', sel.match(/\\[\"'](.+?)\\\"\\]/) ? '' : 'og:title'); // fallback
        }
        if (sel.includes('property="og:title"')) m.setAttribute('property','og:title');
        if (sel.includes('property="og:description"')) m.setAttribute('property','og:description');
        if (sel.includes('property="og:url"')) m.setAttribute('property','og:url');
        if (sel.includes('property="og:image"')) m.setAttribute('property','og:image');
        if (sel.includes('property="og:type"')) m.setAttribute('property','og:type');
        m.content = val;
        document.head.appendChild(m);
      };
      set('meta[property="og:type"]','product');
      set('meta[property="og:title"]', title);
      set('meta[property="og:description"]', desc);
      set('meta[property="og:url"]', url);
      set('meta[property="og:image"]', img);

      // meta description
      let md = document.querySelector('meta[name="description"]');
      if (!md) { md = document.createElement('meta'); md.setAttribute('name','description'); document.head.appendChild(md); }
      md.setAttribute('content', desc);

      // JSON-LD Product
      const ld = {
        "@context":"https://schema.org","@type":"Product",
        "name": p.name,
        "sku": p.sku,
        "image": [img],
        "url": url,
        "offers": (p.price ? [{
          "@type":"Offer","priceCurrency":"VND","price": String(p.price),
          "url": (p.links?.[0]?.href || p.origin || url),
          "availability":"https://schema.org/InStock"
        }] : undefined)
      };
      const s = document.createElement('script');
      s.type = 'application/ld+json';
      s.textContent = JSON.stringify(ld);
      document.head.appendChild(s);
    }

    function render(p){
      const buys = (Array.isArray(p.links) && p.links.length ? p.links
                   : (p.origin ? [{merchant:p.merchant||'origin', href:p.origin}] : []));
      const buyBtns = buys.map(l =>
        `<a class="buy" href="${l.href}" data-merchant="${l.merchant||''}" target="_blank" rel="nofollow sponsored noopener">Mua ngay</a>`
      ).join('');

      app.innerHTML = `
        <!-- meta link chuẩn MXD đặt TRƯỚC nút mua -->
        <a class="product-meta sr-only"
           href="${p.origin||'#'}"
           data-merchant="${p.merchant||''}"
           data-sku="${p.sku}"
           data-img="/assets/img/products/${p.sku}.webp"
           data-price="${p.price||''}">${p.name}</a>

        <div class="wrap">
          <div class="imgbox">
            <img loading="eager" decoding="async" width="800" height="800"
                 src="/assets/img/products/${p.sku}.webp"
                 alt="${p.name}"
                 onerror="this.onerror=null;this.src='${placeholder}'">
          </div>
          <div class="meta">
            <h1 id="pname">${p.name}</h1>
            <div class="price" data-price="${p.price||''}">${p.price?fmtVND(p.price):''}</div>
            <div class="actions">${buyBtns}</div>
            ${p.origin ? `<p class="muted">Nguồn gốc: <a href="${p.origin}" target="_blank" rel="nofollow noopener">${(new URL(p.origin)).hostname}</a></p>` : ''}
          </div>
        </div>
      `;
      document.getElementById('crumb-name').textContent = p.name;

      // Cho affiliate script xử lý rewrite + GA
      if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function') {
        window.mxdAffiliate.scan();
      }
    }

    fetch('/assets/data/affiliates.json')
      .then(r => r.json())
      .then(list => {
        const p = Array.isArray(list) ? list.find(x => x.sku === sku) : null;
        if (!p) {
          app.innerHTML = `
            <p>Không tìm thấy sản phẩm với SKU <b>${sku}</b>.</p>
            <p><a href="/store.html">Quay lại cửa hàng</a></p>
          `;
          return;
        }
        setHead(p);
        render(p);
      })
      .catch(err => {
        console.error('affiliates.json error', err);
        app.innerHTML = `
          <p>Không tải được dữ liệu sản phẩm. Vui lòng thử lại.</p>
          <p><a href="/store.html">Quay lại cửa hàng</a></p>
        `;
      });
  })();
  </script>
</body>
</html>
