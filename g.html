<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <title>Sản phẩm | MXD</title>
  <meta id="desc" name="description" content="Trang sản phẩm MXD. Vui lòng bật JavaScript để xem đầy đủ thông tin và liên kết mua.">

  <!-- Canonical động theo SKU -->
  <link id="can" rel="canonical" href="https://mxd210.github.io/g.html">
  <meta id="robots" name="robots" content="index,follow">

  <!-- OG cơ bản (sẽ được cập nhật bằng JS) -->
  <meta property="og:type" content="product">
  <meta id="og-title" property="og:title" content="Sản phẩm | MXD">
  <meta id="og-desc" property="og:description" content="Trang sản phẩm MXD.">
  <meta id="og-image" property="og:image" content="https://mxd210.github.io/assets/img/logo.webp">
  <meta id="og-url" property="og:url" content="https://mxd210.github.io/g.html">

  <!-- Chuẩn MXD: GA4 trước, Affiliate sau -->
  <script src="/assets/analytics.js" defer></script>
  <script src="/assets/mxd-affiliate.js" defer></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#111;background:#fff}
    header,footer{padding:12px 16px;border-bottom:1px solid #eee}
    footer{border-top:1px solid #eee;border-bottom:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    .card img{width:100%;height:auto;border:1px solid #eee;border-radius:12px}
    .price{font-size:1.25rem;font-weight:700;margin:8px 0}
    .buybox a.buy{display:inline-block;margin-right:8px;margin-bottom:8px;padding:10px 14px;border-radius:10px;border:1px solid #111;text-decoration:none}
    .muted{color:#666}
    @media (max-width:768px){.card{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="wrap">
    <a href="/" aria-label="Trang chủ MXD">← MXD</a>
  </header>

  <main class="wrap" id="app">
    <p class="muted">Đang tải sản phẩm…</p>
  </main>

  <footer class="wrap">
    <small class="muted">© MXD</small>
  </footer>

  <noscript>
    <p>Trang sản phẩm MXD. Vui lòng bật JavaScript để xem đầy đủ thông tin và liên kết mua.</p>
  </noscript>

  <script>
    // --- helpers ---
    const params = new URL(location.href).searchParams;
    const skuParam = (params.get('sku') || '').trim();
    document.getElementById('can').href = `https://mxd210.github.io/g.html?sku=${encodeURIComponent(skuParam)}`;
    document.getElementById('og-url').setAttribute('content', `https://mxd210.github.io/g.html?sku=${encodeURIComponent(skuParam)}`);

    const norm = s => (s||'').toString().trim().toLowerCase();

    function getMerchant(u){
      try{
        const h = new URL(u).hostname;
        if (h.includes('shopee')) return 'shopee';
        if (h.includes('lazada')) return 'lazada';
        if (h.includes('tiki'))   return 'tiki';
        if (h.includes('tiktok')) return 'tiktok';
      }catch(e){}
      return 'merchant';
    }

    function injectProductLD(p){
      const data = {
        "@context":"https://schema.org",
        "@type":"Product",
        "name": p.name,
        "sku": p.sku,
        "image": [p.image],
        "offers": {
          "@type":"Offer",
          "priceCurrency":"VND",
          "price": String(p.price || ""),
          "availability":"https://schema.org/InStock",
          "url": p.link
        }
      };
      const s = document.createElement('script');
      s.type = 'application/ld+json';
      s.textContent = JSON.stringify(data);
      document.head.appendChild(s);
    }

    function setMeta(title, desc, img){
      document.title = `${title} | MXD`;
      document.getElementById('desc').setAttribute('content', desc);
      document.getElementById('og-title').setAttribute('content', `${title} | MXD`);
      document.getElementById('og-desc').setAttribute('content', desc);
      document.getElementById('og-image').setAttribute('content', img);
    }

    function renderNotFound(){
      document.getElementById('robots').setAttribute('content','noindex,nofollow');
      document.getElementById('app').innerHTML = `
        <h1>Không tìm thấy sản phẩm</h1>
        <p class="muted">SKU: <code>${skuParam || '(trống)'}</code> không khớp dữ liệu.</p>
        <p><a href="/store.html">← Về Cửa hàng</a></p>
      `;
    }

    // --- main ---
    (async () => {
      if(!skuParam){ renderNotFound(); return; }

      try{
        // 1) Tải dữ liệu với fallback
        let res = await fetch('/assets/data/affiliates.json', {cache:'no-store'});
        if (!res.ok) res = await fetch('/products.json', {cache:'no-store'});

        const raw = await res.text();
        let list;
        try { list = JSON.parse(raw); }
        catch(e){ console.error('JSON parse error', e); list = []; }

        // 2) Chuẩn hoá về mảng
        if (!Array.isArray(list)) {
          if (list && typeof list === 'object') {
            list = Array.isArray(list.items) ? list.items : Object.values(list);
          } else {
            list = [];
          }
        }

        // 3) Tìm theo SKU: chấp nhận sku | p_sku | id (case-insensitive)
        const p = list.find(x => [x.sku, x.p_sku, x.id].map(norm).includes(norm(skuParam)));
        if(!p){ renderNotFound(); return; }

        // 4) Lấy SKU thực, chuẩn hoá giá & link & ảnh
        const skuReal = p.sku || p.p_sku || p.id;
        const priceNum = typeof p.price === 'number' ? p.price : Number(String(p.price||'').replace(/[^\d]/g,''));
        const link = p.link || p.url || (Array.isArray(p.links) ? p.links[0] : '');
        const image = p.image || `/assets/img/products/${skuReal}.webp`;
        const priceText = priceNum ? new Intl.NumberFormat('vi-VN').format(priceNum) + ' đ' : 'Liên hệ';

        // 5) Meta/OG + Product JSON-LD
        setMeta(p.name, `Sản phẩm ${p.name} – giá tham khảo ${priceText}.`, `https://mxd210.github.io${image}`);
        injectProductLD({ name:p.name, sku:skuReal, price:priceNum, image:`https://mxd210.github.io${image}`, link:link });

        // 6) Buy box (1 hoặc nhiều nơi bán)
        let buyBox = '';
        if (Array.isArray(p.links) && p.links.length){
          buyBox = p.links.map((u,i)=>{
            const m = getMerchant(u);
            return `<a class="buy" href="${u}" data-merchant="${m}" data-sub1="g_sku" data-sub2="${skuReal}" data-sub3="product" data-sub4="mxd" rel="nofollow noopener">Mua ${i+1} (${m})</a>`;
          }).join('');
        } else if (link){
          const m = getMerchant(link);
          buyBox = `<a class="buy" href="${link}" data-merchant="${m}" data-sub1="g_sku" data-sub2="${skuReal}" data-sub3="product" data-sub4="mxd" rel="nofollow noopener">Mua ngay</a>`;
        } else {
          buyBox = `<span class="muted">Chưa có link mua</span>`;
        }

        // 7) Render
        document.getElementById('app').innerHTML = `
          <article class="card">
            <div>
              <img id="pimg" src="${image}" alt="${p.name}" loading="eager" decoding="async">
            </div>
            <div>
              <h1>${p.name}</h1>
              <div class="price">${priceText}</div>
              <div class="buybox">${buyBox}</div>
              <p class="muted">SKU: <code>${skuReal}</code></p>
              <p><a href="/store.html">← Về Cửa hàng</a></p>
            </div>
          </article>
        `;

        // 8) Kích hoạt affiliate scanner nếu có
        if (window.mxdAffiliate && typeof window.mxdAffiliate.scan === 'function') {
          window.mxdAffiliate.scan();
        }
      }catch(err){
        console.error(err);
        renderNotFound();
      }
    })();
  </script>

  <!-- Nút nổi MXD (Zalo/Facebook/Gọi + Back-to-top) -->
  <script src="/assets/js/floating-contact.js" defer></script>
</body>
</html>
