<!doctype html>
<meta charset="utf-8">
<title>Đang chuyển hướng…</title>
<meta name="robots" content="noindex,nofollow">
<meta http-equiv="refresh" content="2;url=/" id="meta-refresh">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;max-width:720px;margin:auto}
  code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
  .muted{color:#64748b}
</style>

<h1>Đang chuyển bạn đến nơi bán…</h1>
<p class="muted">Nếu không được chuyển, <a id="fallback" href="/">bấm vào đây</a>.</p>
<pre id="log" class="muted"></pre>

<script>
(function log(){ const L=document.getElementById('log'); window._log=(...a)=>{L.textContent += a.join(' ') + '\n';}; })();

(async () => {
  const p  = new URL(location.href).searchParams;
  const sku = (p.get('sku')||'').trim().toLowerCase();
  const dl  = p.get('dl'); // deep link đã encode sẵn (tuỳ chọn)
  const fb  = document.getElementById('fallback');
  const mr  = document.getElementById('meta-refresh');

  _log('SKU =', sku || '(rỗng)');
  if (dl) {
    try {
      const deep = decodeURIComponent(dl);
      _log('Using direct deeplink from query:', deep);
      fb.href = deep;
      mr.content = '1;url=' + deep;
      setTimeout(()=>location.href = deep, 60);
      return;
    } catch(e){ _log('Decode dl error:', e.message); }
  }

  // tải JSON, tránh cache và xử lý BOM
  const url = '/assets/data/affiliates.json?ts=' + Date.now();
  _log('Fetch:', url);

  try {
    const res = await fetch(url, { cache: 'no-store' });
    _log('HTTP status =', res.status);
    const txt = await res.text();
    const clean = txt.replace(/^\uFEFF/, ''); // strip BOM nếu có
    const map = JSON.parse(clean);

    if (!sku || !map[sku]) {
      _log('Không tìm thấy SKU trong JSON.');
      mr.content = '2;url=/';
      fb.textContent = 'Link không tồn tại — về trang chủ';
      fb.href = '/';
      return;
    }

    const deep = map[sku].deeplink || '';
    _log('Deeplink =', deep);
    if (!/^https?:\/\/go\.isclix\.com\/deep_link/i.test(deep)) {
      _log('Deeplink không hợp lệ.');
      mr.content = '2;url=/';
      fb.textContent = 'Deeplink không hợp lệ — về trang chủ';
      fb.href = '/';
      return;
    }

    // cập nhật fallback + meta refresh rồi chuyển thẳng
    fb.href = deep;
    mr.content = '1;url=' + deep;
    setTimeout(()=>location.replace(deep), 50);
  } catch (e) {
    _log('Lỗi tải/parse JSON:', e.message);
    mr.content = '2;url=/';
    fb.textContent = 'Không tải được dữ liệu — về trang chủ';
    fb.href = '/';
  }
})();
</script>
