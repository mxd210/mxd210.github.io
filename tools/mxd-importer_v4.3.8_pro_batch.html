<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MXD Importer v4.3.8 ‚Äî PRO + Batch Images</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#0b0f14;--fg:#e8f0fb;--muted:#a7b4c2;--b:#152132;--accent:#7cc4ff;
      --ok:#34d399;--warn:#f59e0b;--err:#ef4444;
      --toast-bottom: 12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:16px 0 8px}
    h1{font-size:20px}
    h2{font-size:16px;color:#cfe5ff}
    a{color:#7cc4ff}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid #223348;border-radius:12px;padding:14px}
    label{display:block;font-weight:700;margin:8px 0 6px;color:#cfe5ff}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3b52;background:#0f1622;color:var(--fg)}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .small{font-size:12px;color:#a7b4c2}
    .btn{cursor:pointer;border:1px solid #2b3b52;background:#102235}
    .btn:hover{background:#132a43}
    .btn.primary{background:#0b3a5e;border-color:#0b3a5e}
    .btn.primary:hover{background:#0d4570}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3b55;color:#a4bee8}
    .ok{color:#34d399} .warn{color:#f59e0b} .err{color:#ef4444}
    .deeplink-box{border:2px dashed #2f4666;border-radius:12px;padding:10px;background:#0c1623}
    .deeplink-text{font-size:13px;font-weight:600}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,#0b0f14 60%,#0b0f1400);padding:12px;border-top:1px solid #1b2a3f;z-index:9}
    .drop{border:2px dashed #3a5270;border-radius:12px;padding:16px;text-align:center;background:#0c1623}
    .drop.dragover{border-color:#8ab9ff;background:#0f1e32}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #27405e}
    .toast{
      position:fixed;right:12px;bottom:var(--toast-bottom);
      display:none;max-width:520px;background:#122232;border:1px solid #2b425e;
      border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;
      z-index:99999;pointer-events:none
    }
    .toast.show{display:block}
    code.inline{background:#0e1622;border:1px solid #223449;border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;border:1px solid #2b3b52;border-radius:999px;padding:2px 8px;font-size:11px;color:#a4bee8}

    /* Batch queue */
    table.queue{width:100%;border-collapse:separate;border-spacing:0 8px}
    table.queue th, table.queue td{font-size:13px;vertical-align:middle}
    table.queue th{color:#cfe5ff;text-align:left;padding:6px 8px}
    table.queue td{background:#0d1826;border:1px solid #23364b;padding:6px 8px}
    table.queue td:first-child{border-radius:10px 0 0 10px}
    table.queue td:last-child{border-radius:0 10px 10px 0}
    .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid #27405e;background:#0a1320}
    .mini{display:flex;gap:6px;align-items:center}
    .w-auto{width:auto}
    .nowrap{white-space:nowrap}
    .btn.sm{padding:6px 10px;border-radius:8px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .status{font-size:12px}
    .muted{color:#8fa5bd}
  </style>
</head>
<body>
<div class="wrap">
  <h1>MXD Importer v4.3.8 <span class="pill">PRO</span> <span class="pill">+ Batch Images</span></h1>
  <div class="small">B·ªï sung h√†ng ƒë·ª£i ·∫£nh (batch) + ƒë·∫∑t t√™n theo SKU ho·∫∑c theo t√™n file n·∫øu SKU tr·ªëng. Kh√¥ng ph√° c√¥ng c·ª• c≈©.</div>

  <div class="card">
    <h2>1) C√†i ƒë·∫∑t (l∆∞u v√†o tr√¨nh duy·ªát)</h2>
    <div class="grid g2">
      <div>
        <label>Worker Base URL</label>
        <input id="workerUrl" placeholder="https://mxd210.mxd6686.workers.dev"/>
      </div>
      <div>
        <label>X-Key (header b·∫£o v·ªá Worker)</label>
        <input id="xKey" placeholder="V√≠ d·ª•: mxd210-secret-key"/>
      </div>
      <div>
        <label>Shopee template</label>
        <input id="tplShopee" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/>
      </div>
      <div>
        <label>Lazada template</label>
        <input id="tplLazada" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">üíæ L∆∞u c√†i ƒë·∫∑t</button>
      <button class="btn" id="btnLoadSettings">‚Üª T·∫£i l·∫°i</button>
      <button class="btn" id="btnClearSettings">üóë X√≥a c√†i ƒë·∫∑t</button>
      <span class="small" id="settingsStatus"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCheckWorker">Ki·ªÉm tra Worker</button>
      <button class="btn" id="btnCheckAuth">Ki·ªÉm tra X-Key</button>
      <button class="btn" id="btnCheckWrite">Ki·ªÉm tra quy·ªÅn commit</button>
      <span class="small" id="workerStatus"></span>
    </div>
  </div>

  <div class="grid g2">
    <div class="card">
      <h2>2) ·∫¢nh s·∫£n ph·∫©m (ƒë∆°n l·∫ª)</h2>
      <div id="drop" class="drop">K√©o <b>m·ªôt ho·∫∑c nhi·ªÅu</b> ·∫£nh v√†o ƒë√¢y ho·∫∑c ch·ªçn‚Ä¶</div>
      <input type="file" id="file" accept="image/*" multiple style="display:none"/>
      <div class="row" style="margin-top:10px">
        <label class="w-auto" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="cbUseFilename" checked style="width:auto"/>
          D√πng <b>t√™n file</b> n·∫øu <b>SKU tr·ªëng</b>
        </label>
        <div class="w-auto">
          <label class="small" style="margin:0 0 4px">Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFolder">
            <option value="/assets/img/products/">/assets/img/products/</option>
            <option value="/assets/img/categories/">/assets/img/categories/</option>
            <option value="/assets/img/og/">/assets/img/og/</option>
            <option value="/assets/img/brands/">/assets/img/brands/</option>
            <option value="custom">T·ª± nh·∫≠p‚Ä¶</option>
          </select>
        </div>
        <div id="defaultCustomWrap" class="w-auto" style="display:none;min-width:280px">
          <label class="small" style="margin:0 0 4px">ƒê∆∞·ªùng d·∫´n tu·ª≥ ch·ªânh (k·∫øt th√∫c b·∫±ng /)</label>
          <input id="defaultCustomPath" placeholder="/assets/img/blog/2025/"/>
        </div>
        <div class="w-auto">
          <label class="small" style="margin:0 0 4px">ƒê·ªãnh d·∫°ng xu·∫•t m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFmt">
            <option value="webp">webp</option>
            <option value="png">png</option>
          </select>
        </div>
      </div>

      <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
        <img id="thumb" alt="preview"/>
        <div class="small">
          <div><b>T√™n file ƒë·ªÅ xu·∫•t:</b> <code class="inline" id="imgName">-</code></div>
          <div><b>K√≠ch th∆∞·ªõc:</b> <span id="imgInfo">-</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSelectImg">Ch·ªçn ·∫£nh</button>
        <button class="btn" id="btnConvert">N√©n .webp</button>
        <button class="btn" id="btnSaveImg">T·∫£i ·∫£nh (.webp)</button>
        <button class="btn primary" id="btnUploadImg">Upload ·∫£nh ‚Üí /assets/img/products/&lt;sku&gt;.webp</button>
        <button class="btn" id="btnQueueCurrent">‚ûï Th√™m ·∫£nh hi·ªán t·∫°i v√†o h√†ng ƒë·ª£i</button>
      </div>
      <div class="small">Chu·∫©n: c·∫°nh d√†i ~1200px, WebP q=0.82. N√∫t ‚ûï s·∫Ω ƒë·∫©y ·∫£nh hi·ªán t·∫°i (ƒë√£ ƒë·∫∑t t√™n) v√†o H√ÄNG ƒê·ª¢I.</div>
    </div>

    <div class="card">
      <h2>3) Th√¥ng tin s·∫£n ph·∫©m</h2>
      <div class="grid">
        <div class="row">
          <div>
            <label>T√™n s·∫£n ph·∫©m</label>
            <input id="name" placeholder="V√≠ d·ª•: Dekton DK-AG950S"/>
          </div>
          <div>
            <label>SKU (b·∫Øt bu·ªôc cho publish; c√≥ th·ªÉ tr·ªëng khi ch·ªâ upload ·∫£nh)</label>
            <input id="sku" placeholder="dekton-dk-ag950s"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Gi√° (VND, kh√¥ng ch·∫•m)</label>
            <input id="price" type="number" placeholder="399000"/>
          </div>
          <div>
            <label>Merchant</label>
            <select id="merchant"><option value="shopee">shopee</option><option value="lazada">lazada</option></select>
          </div>
        </div>
        <div>
          <label>Link g·ªëc (origin)</label>
          <input id="origin" placeholder="https://shopee.vn/‚Ä¶"/>
        </div>
        <div class="row">
          <div>
            <label>·∫¢nh (ƒë∆∞·ªùng d·∫´n)</label>
            <input id="image" placeholder="/assets/img/products/dekton-dk-ag950s.webp"/>
          </div>
          <div>
            <label>Danh m·ª•c (category)</label>
            <input id="category" placeholder="may-khoan-duc-vit / may-cat / phu-kien-may"/>
          </div>
        </div>
        <div>
          <label>Th∆∞∆°ng hi·ªáu (brand)</label>
          <input id="brand" placeholder="dekton, bosch, makuta‚Ä¶"/>
        </div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;flex:unset">
            <input type="checkbox" id="featured" style="width:auto"/> N·ªïi b·∫≠t (featured)
          </label>
          <label style="display:flex;align-items:center;gap:8px;flex:unset">
            <input type="checkbox" id="status" checked style="width:auto"/> Hi·ªÉn th·ªã (status)
          </label>
          <button class="btn" id="btnAuto">ƒêi·ªÅn auto t·ª´ t√™n</button>
        </div>
        <div id="diag" class="small"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>2b) H√†ng ƒë·ª£i ·∫£nh (Batch)</h2>
    <div class="row">
      <button class="btn" id="btnConvertAll">Convert t·∫•t c·∫£</button>
      <button class="btn" id="btnDownloadAll">T·∫£i t·∫•t c·∫£</button>
      <button class="btn primary" id="btnUploadAll">Upload t·∫•t c·∫£</button>
      <button class="btn" id="btnClearQueue">Xo√° h√†ng ƒë·ª£i</button>
      <span class="small muted">Tip: th·∫£ <b>nhi·ªÅu ·∫£nh</b> v√†o v√πng tr√™n ƒë·ªÉ th√™m tr·ª±c ti·∫øp v√†o h√†ng ƒë·ª£i.</span>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table class="queue" id="queueTable">
        <thead>
          <tr>
            <th>·∫¢nh</th>
            <th>T√™n xu·∫•t</th>
            <th>Th∆∞ m·ª•c</th>
            <th>ƒê·ªãnh d·∫°ng</th>
            <th>ƒê∆∞·ªùng d·∫´n xu·∫•t</th>
            <th>K√≠ch th∆∞·ªõc</th>
            <th>Tr·∫°ng th√°i</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card deeplink-box">
    <h2>4) Deep-link (to, r√µ r√†ng, copy d·ªÖ)</h2>
    <div class="grid g2">
      <div>
        <label>Origin (ƒë√£ nh·∫≠p)</label>
        <textarea id="originOut" class="deeplink-text" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOrigin">Copy Origin</button>
          <button class="btn" id="openOrigin">M·ªü Origin</button>
        </div>
      </div>
      <div>
        <label>Affiliate deep-link</label>
        <textarea id="deeplink" class="deeplink-text" placeholder="T·ª± sinh t·ª´ template ho·∫∑c d√°n s·∫µn t·∫°i ƒë√¢y"></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnMakeDeeplink">T·∫°o t·ª´ template</button>
          <button class="btn" id="copyDeeplink">Copy Deep-link</button>
          <button class="btn" id="btnOpenDeeplink">M·ªü Deep-link</button>
          <span id="dlCheck" class="badge">‚Äì</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>5) JSON xu·∫•t b·∫£n</h2>
    <textarea id="jsonOut" rows="8" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">T·∫°o JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">T·∫£i affiliates.append.json</button>
    </div>
  </div>

  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish ‚Üí Store</button>
    <button class="btn" id="btnPublishFeatured">Publish ‚Üí N·ªïi b·∫≠t</button>
    <button class="btn" id="btnVerify">‚úÖ Ki·ªÉm tra tr√™n Store</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
const $ = s => document.querySelector(s);
const LS_KEY = 'MXD_IMPORTER_SETTINGS_V438';
const slugify = s => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                 .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
                 .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

const DEFAULT_TPL_SHOPEE =
  'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
const DEFAULT_TPL_LAZADA =
  'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';

function computeSubs(sku, merchant){
  const sub1 = sku || 'sku';
  const sub2 = (merchant||'merchant').toLowerCase();
  const sub3 = 'tool';
  const sub4 = 'mxd210';
  return {sub1, sub2, sub3, sub4};
}
function ensureSubsInUrl(u, subs){
  const has = k => new RegExp(`[?&]${k}=`,`i`).test(u);
  const qs = [];
  if(!has('sub1')) qs.push(`sub1=${encodeURIComponent(subs.sub1)}`);
  if(!has('sub2')) qs.push(`sub2=${encodeURIComponent(subs.sub2)}`);
  if(!has('sub3')) qs.push(`sub3=${encodeURIComponent(subs.sub3)}`);
  if(!has('sub4')) qs.push(`sub4=${encodeURIComponent(subs.sub4)}`);
  return qs.length ? (u + (u.includes('?') ? '&' : '?') + qs.join('&')) : u;
}
function cleanUrl(u){ return (u||'').trim().replace(/^["']+|["',]+$/g,''); }

function vn(s){
  return (s||'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
    .toLowerCase();
}
function normCategory(raw){
  const base = vn(raw).replace(/\s+/g,'-')
    .replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'');
  if (/^(may-?cat|maycat|may\s*cat|may-mai|mai-goc|may-cat-sat|may-cat-gach)$/.test(base)) return 'may-cat';
  if (/^(may-?khoan(-|_)?duc(-|_)?vit|may-khoan|khoan-duc-vit|khoan-bua|impact(-|_)?(driver|wrench)|sds(plus|max)?)$/.test(base)) return 'may-khoan-duc-vit';
  if (/^(phu-?kien|phu-?kien-?may|phu-kien-may)$/.test(base)) return 'phu-kien-may';
  return base;
}

window.CATEGORY_KEYWORDS = window.CATEGORY_KEYWORDS || {};
window.CATEGORY_KEYWORDS["may-cat"] = {
  include: [
    /\b(m√°y\s*)?c·∫Øt\b/i,
    /\bm√°y\s*c∆∞a\b/i,
    /\bc∆∞a\s*(ƒëƒ©a|b√†n|ki·∫øm|l·ªçng)\b/i,
    /\bcut[\s-]?off\b/i,
    /\bcircular(\s*saw)?\b/i,
    /\bjig\s*saw\b/i, /\bjigsaw\b/i,
    /\breciprocating\b/i, /\bsabre\b/i,
    /\bm√°y\s*c·∫Øt\s*(g·∫°ch|s·∫Øt|nh√¥m|ƒëa\s*nƒÉng)\b/i,
    /\bm[·∫£a]i\s*g[√≥o]c\b/i,
    /\bmay\s*cat\b/i
  ],
  exclude: [
    /\b(l∆∞·ª°i|blade|ƒëƒ©a|disc|ƒë√°\s*c·∫Øt|ph·ª•\s*ki·ªán|m≈©i)\b/i,
    /\b(pin|s·∫°c|ch·ªïi\s*than|than|ƒë·∫ø|v·ªè|collet|b·∫ßu\s*k·∫πp|adapter|ƒë√°\s*m√†i|gi·∫•y\s*nh√°m|guard|ch·ª•p\s*b·∫£o\s*v·ªá)\b/i
  ],
  set: { category: "may-cat" }
};
window.CATEGORY_KEYWORDS["may-khoan-duc-vit"] = {
  include: [
    /\bm√°y\s*khoan\b/i, /\bkhoan\s*b√∫a\b/i,
    /\bSDS[\s-]?(Plus|Max)\b/i,
    /\bimpact\s*(driver|wrench)\b/i,
    /\bb[·∫Øa]n\s*v[√≠i]t\b/i, /\bsi[·∫øe]t\s*bu\s*l[o√¥]ng\b/i
  ],
  exclude: [
    /\b(pin|s·∫°c|l∆∞·ª°i|ƒëƒ©a|m≈©i|ch√©n|ch·ªïi\s*than|than|ƒë·∫ø|v·ªè|collet|b·∫ßu\s*k·∫πp|adapter|ƒë√°\s*m√†i|gi·∫•y\s*nh√°m|guard|ch·ª•p\s*b·∫£o\s*v·ªá)\b/i
  ],
  set: { category: "may-khoan-duc-vit" }
};
window.CATEGORY_KEYWORDS["phu-kien-may"] = {
  include: [
    /\bpin\b/i, /\bs·∫°c\b/i,
    /\bl∆∞·ª°i\b/i, /\bƒëƒ©a\b/i, /\bblade\b/i, /\bdisc\b/i,
    /\bm≈©i\b/i, /\bm≈©i\s*khoan\b/i, /\bƒë·∫ßu\s*v√≠t\b/i, /\bƒë·∫ßu\s*kh·∫©u\b/i,
    /\bch√©n\b/i, /\bƒë√°\s*m√†i\b/i, /\bcup\s*wheel\b/i,
    /\bch·ªïi\s*than\b/i, /\bthan\b/i,
    /\bƒë·∫ø\b/i, /\bcollet\b/i, /\bb·∫ßu\s*k·∫πp\b/i, /\badapter\b/i,
    /\bgi·∫•y\s*nh√°m\b/i, /\bguard\b/i, /\bch·ª•p\s*b·∫£o\s*v·ªá\b/i
  ],
  exclude: [ /^(m√°y|th√¢n\s*m√°y|tool[\s-]?only|bare\s*tool)\b/i ],
  set: { category: "phu-kien-may" }
};
function autoCategory(text){
  const MAP = window.CATEGORY_KEYWORDS || {};
  for (const [slug, rule] of Object.entries(MAP)){
    const okInc = (rule.include||[]).some(rx => rx.test(text));
    const okExc = (rule.exclude||[]).some(rx => rx.test(text));
    if (okInc && !okExc) return slug;
  }
  return '';
}

const state = { workerOk:false, imgBlob:null, imgName:null, imgW:0, imgH:0 };
function toast(msg,cls=''){ const t=$("#toast"); t.innerHTML=msg; t.className='toast show '+cls; setTimeout(()=>t.className='toast',4500); }

function updateToastOffset(){
  const bar = document.querySelector('.sticky-actions');
  const bottom = bar ? (bar.offsetHeight + 16) : 12;
  document.documentElement.style.setProperty('--toast-bottom', bottom + 'px');
}
window.addEventListener('load', updateToastOffset);
window.addEventListener('resize', updateToastOffset);
if ('ResizeObserver' in window){
  new ResizeObserver(updateToastOffset).observe(document.querySelector('.sticky-actions'));
}

// Settings
function readSettings(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
function writeSettings(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
function uiToSettings(){
  return { workerUrl: $("#workerUrl").value.trim(), xKey: $("#xKey").value.trim(), tplShopee: $("#tplShopee").value.trim(), tplLazada: $("#tplLazada").value.trim() };
}
function settingsToUi(s){
  $("#workerUrl").value = s.workerUrl||'';
  $("#xKey").value = s.xKey||'';
  $("#tplShopee").value = s.tplShopee||'';
  $("#tplLazada").value = s.tplLazada||'';
}
function saveSettings(){ writeSettings(uiToSettings()); $("#settingsStatus").textContent="ƒê√£ l∆∞u."; toast("ƒê√£ l∆∞u c√†i ƒë·∫∑t.","ok"); }
function loadSettings(){
  const s = readSettings();
  settingsToUi(s);
  if(!$("#tplShopee").value) $("#tplShopee").value = DEFAULT_TPL_SHOPEE;
  if(!$("#tplLazada").value) $("#tplLazada").value = DEFAULT_TPL_LAZADA;
  $("#settingsStatus").textContent="ƒê√£ t·∫£i c√†i ƒë·∫∑t.";
}
$("#btnSaveSettings").onclick = saveSettings;
$("#btnLoadSettings").onclick = loadSettings;
$("#btnClearSettings").onclick = ()=>{ localStorage.removeItem(LS_KEY); settingsToUi({}); $("#settingsStatus").textContent="ƒê√£ x√≥a."; };
loadSettings();

function hdr(){ const s=readSettings(); const h={}; if(s.xKey) h['x-key']=s.xKey; h['content-type']='application/json'; return h; }
async function check(url){
  try{ const r = await fetch(url, {mode:"cors", headers: hdr()}); return {ok:r.ok, status:r.status, text: await r.text().catch(()=>'' )}; }catch(e){ return {ok:false, status:-1, text:String(e)}; }
}
$("#btnCheckWorker").onclick = async ()=>{
  const s=readSettings(); if(!s.workerUrl){ $("#workerStatus").textContent="Ch∆∞a c·∫•u h√¨nh Worker."; return; }
  const u = s.workerUrl.replace(/\/$/,'') + "/health";
  const r = await check(u);
  state.workerOk = r.ok;
  $("#workerStatus").textContent = r.ok ? "Worker OK (health "+r.status+")." : "Worker l·ªói ("+r.status+"). " + r.text.slice(0,120);
  toast(r.ok?"Worker OK":"Worker l·ªói "+r.status, r.ok?"ok":"err");
};
$("#btnCheckAuth").onclick = async ()=>{
  const s=readSettings(); if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const u = s.workerUrl.replace(/\/$/,'') + "/whoami";
  const r = await check(u);
  toast(r.ok?"X-Key h·ª£p l·ªá.":"X-Key kh√¥ng h·ª£p l·ªá ("+r.status+")", r.ok?"ok":"err");
};
$("#btnCheckWrite").onclick = async ()=>{
  const s=readSettings(); if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const u = s.workerUrl.replace(/\/$/,'') + "/can-write";
  const r = await check(u);
  toast(r.ok?"C√≥ quy·ªÅn commit.":"Kh√¥ng c√≥ quy·ªÅn ("+r.status+")", r.ok?"ok":"err");
};

$("#btnAuto").onclick = ()=>{
  const name=$("#name").value.trim();
  const skuNow=$("#sku").value.trim();
  if(name && !skuNow) $("#sku").value = slugify(name);
  if($("#sku").value && !$("#image").value) $("#image").value = `/assets/img/products/${$("#sku").value}.webp`;
  $("#originOut").value = cleanUrl($("#origin").value.trim());
  const g = autoCategory(`${name} ${$("#brand").value} ${$("#origin").value}`);
  if (g && !$("#category").value.trim()) $("#category").value = g;
  runDiag();
};
["name","sku","origin","image","merchant"].forEach(id=>$("#"+id).addEventListener('input', runDiag));

function runDiag(){
  const sku = $("#sku").value.trim();
  const img = $("#image").value.trim();
  const origin = cleanUrl($("#origin").value.trim());
  const merchant = $("#merchant").value;
  const msgs = [];
  if(!sku) msgs.push("‚Ä¢ Thi·∫øu SKU (b·∫Øt bu·ªôc cho publish).");
  if(img && !img.startsWith(`/assets/img/products/${sku||'...'}`)) msgs.push("‚Ä¢ ·∫¢nh n√™n l√† /assets/img/products/"+(sku||'&lt;sku&gt;')+".webp");
  if(origin && !/shopee\.vn|lazada\.vn/i.test(origin)) msgs.push("‚Ä¢ Origin kh√¥ng ph·∫£i Shopee/Lazada.");
  msgs.push("‚Ä¢ Merchant: "+merchant);
  $("#diag").innerHTML = msgs.length? msgs.map(x=>`<div>${x}</div>`).join("") : '<span class="ok">T·∫°m ·ªïn.</span>';
  $("#originOut").value = origin;
}

// Deep-link
function activeTplFor(merchant){
  const s = readSettings();
  const raw = (merchant==='shopee' ? (s.tplShopee||'') : (s.tplLazada||'')).trim();
  if(raw) return raw;
  return merchant==='shopee' ? DEFAULT_TPL_SHOPEE : DEFAULT_TPL_LAZADA;
}
function makeDeeplink(){
  const origin = cleanUrl($("#origin").value.trim());
  const sku = $("#sku").value.trim();
  const merchant = $("#merchant").value;
  if(!origin){ toast("Thi·∫øu Origin.","warn"); return; }
  const tpl = activeTplFor(merchant);
  const subs = computeSubs(sku, merchant);
  let link = tpl
    .replace(/\{url\}/g, encodeURIComponent(origin))
    .replace(/\{sku\}/g, sku||'sku')
    .replace(/\{sub1\}/g, subs.sub1)
    .replace(/\{sub2\}/g, subs.sub2)
    .replace(/\{sub3\}/g, subs.sub3)
    .replace(/\{sub4\}/g, subs.sub4);
  link = ensureSubsInUrl(link, subs);
  $("#deeplink").value = link;
  validateDeeplink();
}
$("#btnMakeDeeplink").onclick = makeDeeplink;
["origin","sku","merchant","tplShopee","tplLazada"].forEach(id=>{
  const el = $("#"+id);
  if(el) el.addEventListener('input', ()=>{ if($("#origin").value.trim()) makeDeeplink(); });
});
$("#deeplink").addEventListener('input', validateDeeplink);
function validateDeeplink(){
  const dl = $("#deeplink").value.trim();
  const badge = $("#dlCheck");
  if(!dl){ badge.textContent = "ch∆∞a c√≥ deeplink"; badge.className='badge'; return; }
  const okHost = /(^https?:\/\/)?([^/]*\.)?isclix\.com/i.test(dl);
  const hasUrl = /[?&]url=/.test(dl);
  const s1 = /[?&]sub1=/.test(dl), s2=/[?&]sub2=/.test(dl), s3=/[?&]sub3=/.test(dl), s4=/[?&]sub4=/.test(dl);
  if(okHost && hasUrl && s1 && s2 && s3 && s4){ badge.textContent="OK affiliate"; badge.className='badge'; return; }
  if(okHost && !hasUrl){ badge.textContent="isclix thi·∫øu url="; badge.className='badge'; return; }
  if(okHost){
    const missing = ['sub1','sub2','sub3','sub4'].filter(k=>!new RegExp(`[?&]${k}=`).test(dl));
    badge.textContent = "isclix thi·∫øu: "+missing.join(', ');
    badge.className='badge';
    return;
  }
  badge.textContent="KH√îNG qua affiliate"; badge.className='badge';
}

// IMAGE single + batch
const drop = $("#drop"), file=$("#file"), thumb=$("#thumb"), imgName=$("#imgName"), imgInfo=$("#imgInfo");
drop.addEventListener('click', ()=>file.click());
$("#btnSelectImg").onclick = ()=>file.click();
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
file.onchange = e=>handleFiles(e.target.files);

function baseNameWithoutExt(filename){
  const s = (filename||'').split('/').pop();
  const i = s.lastIndexOf('.');
  return (i>0? s.slice(0,i): s);
}
function decideNameFor(file){
  const sku = $("#sku").value.trim();
  const useFilename = $("#cbUseFilename").checked;
  if(sku) return slugify(sku);
  if(useFilename && file && file.name) return slugify(baseNameWithoutExt(file.name));
  const nm = $("#name").value.trim();
  if(nm) return slugify(nm);
  return 'mxd';
}
function ensureFolderBase(){
  const sel = $("#defaultFolder").value;
  if(sel === 'custom'){
    $("#defaultCustomWrap").style.display='block';
    let p = $("#defaultCustomPath").value.trim();
    if(!p) $("#defaultCustomPath").value = "/assets/img/";
  }else{
    $("#defaultCustomWrap").style.display='none';
  }
}
$("#defaultFolder").addEventListener('change', ensureFolderBase);
ensureFolderBase();

async function handleFiles(files){
  if(!files || !files.length) return;
  if(files.length === 1){
    await handleSingleFile(files[0]);
  }else{
    for(const f of files){ await queueAddRawFile(f); }
    toast(`ƒê√£ th√™m ${files.length} ·∫£nh v√†o h√†ng ƒë·ª£i.`,'ok');
  }
}
function handleSingleFile(f){
  return new Promise(res=>{
    if(!f) return res();
    const reader = new FileReader();
    reader.onload = ev=>{
      const img = new Image();
      img.onload = ()=>{
        const maxSide = 1200;
        const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
        const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
        const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        canvas.toBlob(blob=>{
          state.imgBlob = blob; state.imgW = w; state.imgH = h;
          const base = decideNameFor(f);
          state.imgName = `${base}.webp`;
          $("#image").value = `/assets/img/products/${base}.webp`;
          $("#imgPreview").style.display='flex'; thumb.src = URL.createObjectURL(blob);
          imgName.textContent = state.imgName; imgInfo.textContent = `${w}√ó${h}, ${(blob.size/1024).toFixed(1)} KB`;
          res();
        }, 'image/webp', 0.82);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(f);
  });
}

const queue = [];
let seq = 0;

async function queueAddRawFile(file){
  const name = decideNameFor(file);
  const fmt = $("#defaultFmt").value || 'webp';
  const folderSel = $("#defaultFolder").value;
  const folder = (folderSel==='custom') ? ($("#defaultCustomPath").value.trim()||'/assets/img/') : folderSel;
  const item = { id: (++seq), srcFile: file, name, fmt, folder, customPath: folderSel==='custom', outBlob:null, w:0, h:0, status:'pending' };
  queue.push(item);
  await queueProcess(item);
  renderQueue();
}
async function queueAddCurrent(){
  if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh xem tr∆∞·ªõc.","warn"); return; }
  const fmt = $("#defaultFmt").value || 'webp';
  const folderSel = $("#defaultFolder").value;
  const folder = (folderSel==='custom') ? ($("#defaultCustomPath").value.trim()||'/assets/img/') : folderSel;
  const base = (state.imgName||'mxd.webp').replace(/\.webp$/,'');
  const name = base.replace(/\.[a-z0-9]+$/i,''); 
  const item = { id:(++seq), srcFile:null, name, fmt, folder, customPath: folderSel==='custom', outBlob:state.imgBlob, w:state.imgW, h:state.imgH, status:'ready' };
  queue.push(item);
  renderQueue();
  toast("ƒê√£ th√™m v√†o h√†ng ƒë·ª£i.","ok");
}
$("#btnQueueCurrent").onclick = queueAddCurrent;

function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
async function queueProcess(item){
  if(item.outBlob && item.w && item.h){ item.status='ready'; return; }
  if(!item.srcFile){ item.status='error'; return; }
  item.status='processing';
  const dataUrl = await readFileAsDataURL(item.srcFile);
  const img = document.createElement('img');
  await new Promise(r=>{ img.onload=r; img.src=dataUrl; });
  const maxSide = 1200;
  const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
  const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  canvas.getContext('2d').drawImage(img,0,0,w,h);
  const mime = item.fmt==='png' ? 'image/png' : 'image/webp';
  const quality = item.fmt==='png' ? 1.0 : 0.82;
  item.outBlob = await new Promise(res=>canvas.toBlob(res, mime, quality));
  item.w = w; item.h = h;
  item.status = 'ready';
}

function pathFor(item){
  let base = item.folder||'/assets/img/';
  if(!/\/$/.test(base)) base += '/';
  const ext = '.' + (item.fmt || 'webp').toLowerCase();
  return base + item.name + ext;
}
function renderQueue(){
  const tbody = $("#queueBody");
  if(!queue.length){ tbody.innerHTML = '<tr><td colspan="8" class="muted">Ch∆∞a c√≥ g√¨ trong h√†ng ƒë·ª£i.</td></tr>'; return; }
  tbody.innerHTML = queue.map(it=>{
    const url = it.outBlob ? URL.createObjectURL(it.outBlob) : '';
    const status = it.status==='ready' ? 'S·∫µn s√†ng' : (it.status==='processing' ? 'ƒêang x·ª≠ l√Ω' : (it.status==='uploaded' ? 'ƒê√£ upload' : (it.status==='error' ? 'L·ªói' : 'Ch·ªù')));
    return `<tr data-id="${it.id}">
      <td><div class="mini">${ url ? `<img class="thumb" src="${url}" alt="thumb">` : '' }</div></td>
      <td><input class="name" value="${it.name}"/></td>
      <td>
        <select class="folder">
          <option value="/assets/img/products/" ${it.folder==="/assets/img/products/"?'selected':''}>/assets/img/products/</option>
          <option value="/assets/img/categories/" ${it.folder==="/assets/img/categories/"?'selected':''}>/assets/img/categories/</option>
          <option value="/assets/img/og/" ${it.folder==="/assets/img/og/"?'selected':''}>/assets/img/og/</option>
          <option value="/assets/img/brands/" ${it.folder==="/assets/img/brands/"?'selected':''}>/assets/img/brands/</option>
          <option value="custom" ${it.customPath?'selected':''}>T·ª± nh·∫≠p‚Ä¶</option>
        </select>
        <input class="customPath" placeholder="/assets/img/blog/2025/" style="margin-top:6px;display:${it.customPath?'block':'none'}" value="${it.customPath?it.folder:''}"/>
      </td>
      <td>
        <select class="fmt">
          <option value="webp" ${it.fmt==='webp'?'selected':''}>webp</option>
          <option value="png" ${it.fmt==='png'?'selected':''}>png</option>
        </select>
      </td>
      <td class="nowrap">${pathFor(it)}</td>
      <td>${it.w||'‚Äì'}√ó${it.h||'‚Äì'}<div class="small muted">${it.outBlob? (it.outBlob.size/1024|0)+' KB':''}</div></td>
      <td class="status">${status}</td>
      <td class="controls">
        <button class="btn sm do-convert">Convert</button>
        <button class="btn sm do-download">T·∫£i</button>
        <button class="btn sm do-upload">Upload</button>
        <button class="btn sm do-remove">Xo√°</button>
      </td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('tr').forEach(tr=>{
    const id = Number(tr.getAttribute('data-id'));
    const it = queue.find(x=>x.id===id);
    const nameInput = tr.querySelector('.name');
    const folderSel = tr.querySelector('.folder');
    const customInput = tr.querySelector('.customPath');
    const fmtSel = tr.querySelector('.fmt');
    const pathCell = tr.children[4];
    const statusEl = tr.querySelector('.status');

    nameInput.oninput = ()=>{ it.name = slugify(nameInput.value||'mxd'); pathCell.textContent = pathFor(it); };
    folderSel.onchange = ()=>{
      if(folderSel.value==='custom'){ it.customPath = true; customInput.style.display='block'; if(customInput.value.trim()==='') customInput.value='/assets/img/'; it.folder = customInput.value.trim(); }
      else { it.customPath=false; customInput.style.display='none'; it.folder = folderSel.value; }
      pathCell.textContent = pathFor(it);
    };
    customInput.oninput = ()=>{ it.folder = customInput.value.trim(); pathCell.textContent = pathFor(it); };
    fmtSel.onchange = async ()=>{ it.fmt = fmtSel.value; pathCell.textContent = pathFor(it); await queueProcess(it); statusEl.textContent='S·∫µn s√†ng'; renderQueue(); };

    tr.querySelector('.do-remove').onclick = ()=>{ const idx = queue.findIndex(x=>x.id===id); if(idx>=0){ queue.splice(idx,1); renderQueue(); } };
    tr.querySelector('.do-convert').onclick = async ()=>{ statusEl.textContent='ƒêang x·ª≠ l√Ω'; await queueProcess(it); statusEl.textContent='S·∫µn s√†ng'; renderQueue(); };
    tr.querySelector('.do-download').onclick = ()=>{
      if(!it.outBlob){ toast("Ch∆∞a convert.","warn"); return; }
      const a = document.createElement('a'); a.href = URL.createObjectURL(it.outBlob);
      const ext = '.'+(it.fmt||'webp'); a.download = it.name + ext; a.click();
    };
    tr.querySelector('.do-upload').onclick = ()=>uploadItem(it, statusEl);
  });
}

$("#btnClearQueue").onclick = ()=>{ queue.length=0; renderQueue(); };
$("#btnConvertAll").onclick = async ()=>{
  for(const it of queue){ await queueProcess(it); }
  toast("ƒê√£ convert t·∫•t c·∫£.","ok"); renderQueue();
};
$("#btnDownloadAll").onclick = ()=>{
  for(const it of queue){
    if(!it.outBlob) continue;
    const a = document.createElement('a'); a.href = URL.createObjectURL(it.outBlob);
    a.download = it.name + '.' + (it.fmt||'webp'); a.click();
  }
};
$("#btnUploadAll").onclick = async ()=>{
  const s = readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  for(const it of queue){
    const row = document.querySelector(`tr[data-id="${it.id}"] .status`);
    await uploadItem(it, row);
  }
  toast("Upload t·∫•t c·∫£ xong (xem tr·∫°ng th√°i t·ª´ng m·ª•c).","ok");
};

function blobToBase64(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }
async function uploadItem(it, statusEl){
  try{
    if(!it.outBlob){ statusEl.textContent='ƒêang x·ª≠ l√Ω'; await queueProcess(it); }
    const s = readSettings();
    if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    const base = s.workerUrl.replace(/\/$/,'');
    const path = pathFor(it);
    const b64 = await blobToBase64(it.outBlob);
    statusEl.textContent='Uploading‚Ä¶';
    const r = await fetch(base + "/upload-image", {
      method:"POST", mode:"cors", headers: hdr(),
      body: JSON.stringify({ sku: it.name, path, file: b64 })
    });
    if(!r.ok) throw new Error('HTTP '+r.status);
    statusEl.textContent='ƒê√£ upload';
    it.status='uploaded';
    const sku = $("#sku").value.trim();
    if(it.folder==='/assets/img/products/' && sku && it.name===slugify(sku)){
      $("#image").value = path;
    }
  }catch(e){
    statusEl.textContent='L·ªói upload';
    toast("Upload l·ªói: "+e.message, "err");
  }
}

// Legacy single controls
$("#btnConvert").onclick = ()=>{ if(!state.imgBlob){ toast("Ch∆∞a ch·ªçn ·∫£nh.","warn"); return; } toast("ƒê√£ n√©n .webp s·∫µn."); };
$("#btnSaveImg").onclick = ()=>{
  if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh.","warn"); return; }
  const a = document.createElement('a'); a.href = URL.createObjectURL(state.imgBlob); a.download = state.imgName || 'product.webp'; a.click();
};
$("#btnUploadImg").onclick = async ()=>{
  if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh.","warn"); return; }
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const base = s.workerUrl.replace(/\/$/,'');
  const sku = ($("#sku").value.trim() || 'mxd');
  const path = `/assets/img/products/${slugify(sku)}.webp`;
  const b64 = await blobToBase64(state.imgBlob);
  try{
    const r = await fetch(base + "/upload-image", {
      method:"POST", mode:"cors",
      headers: hdr(),
      body: JSON.stringify({ sku, path, file: b64 })
    });
    if(!r.ok) throw new Error(String(r.status));
    toast("ƒê√£ upload ·∫£nh l√™n repo.","ok");
  }catch(e){ toast("Upload ·∫£nh l·ªói: "+e.message, "err"); }
};

// Publish / Verify
$("#btnPublish").onclick = ()=>doPublish(false);
$("#btnPublishFeatured").onclick = ()=>doPublish(true);
async function doPublish(forceFeatured){
  const obj = buildJson();
  if(forceFeatured){ obj.featured = true; $("#featured").checked = true; $("#jsonOut").value = JSON.stringify([obj], null, 2); }
  if(!obj.sku){ toast("Thi·∫øu SKU.","err"); return; }
  if(!obj.origin){ toast("Thi·∫øu origin.","warn"); return; }
  if(!$("#deeplink").value.trim()){
    const maybe = activeTplFor($("#merchant").value);
    if(maybe){ makeDeeplink(); const dl = $("#deeplink").value.trim(); if(dl){ obj.deeplink = dl; $("#jsonOut").value = JSON.stringify([obj], null, 2); } }
  }
  const s = readSettings();
  if(s.workerUrl){
    try{
      const r = await fetch(s.workerUrl.replace(/\/$/,'') + "/publish", {
        method:"POST", mode:"cors", headers: hdr(), body: JSON.stringify(obj)
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      toast("Publish OK ‚Üí store"+(obj.featured?" + n·ªïi b·∫≠t":""),"ok");
      window.scrollTo({top:0,behavior:'smooth'});
      return;
    }catch(e){ toast("Publish l·ªói (s·∫Ω t·∫£i JSON ƒë·ªÉ commit tay): "+e.message,"err"); }
  }
  const blob = new Blob([JSON.stringify([obj],null,2)], {type:"application/json"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'affiliates.append.json'; a.click();
}
$("#btnVerify").onclick = async ()=>{
  const sku = $("#sku").value.trim();
  if(!sku){ toast("Ch∆∞a c√≥ SKU ƒë·ªÉ ki·ªÉm tra.","warn"); return; }
  try{
    const r = await fetch('/affiliates.json?_=' + Date.now(), {cache:'no-cache'});
    const arr = await r.json();
    const found = (Array.isArray(arr)?arr:(arr.items||[])).some(x => (String(x.sku||'').toLowerCase()) === sku.toLowerCase());
    toast(found ? "ƒê√É C√ì trong affiliates.json." : "CH∆ØA TH·∫§Y trong affiliates.json.", found ? "ok":"warn");
  }catch(e){
    toast("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c affiliates.json: "+e.message, "err");
  }
  const url = `/store.html?dev=1&sku=${encodeURIComponent(sku)}&v=${Date.now()}`;
  window.open(url, '_blank');
};

function buildJson(){
  if (!$("#category").value.trim()){
    const text = `${$("#name").value} ${$("#brand").value} ${$("#origin").value}`;
    const guess = autoCategory(text);
    if (guess) $("#category").value = guess;
  }
  $("#category").value = normCategory($("#category").value);
  const now = new Date().toISOString();
  const obj = {
    name: $("#name").value.trim(),
    price: Number($("#price").value||0),
    origin: cleanUrl($("#origin").value.trim()),
    merchant: $("#merchant").value,
    sku: $("#sku").value.trim(),
    image: $("#image").value.trim(),
    category: $("#category").value.trim(),
    brand: $("#brand").value.trim(),
    featured: $("#featured").checked,
    status: $("#status").checked,
    updated_at: now
  };
  const dl = $("#deeplink").value.trim();
  if(dl) obj.deeplink = dl;
  $("#jsonOut").value = JSON.stringify([obj], null, 2);
  return obj;
}
$("#btnToJson").onclick = buildJson;
$("#btnCopyJson").onclick = ()=>{ $("#jsonOut").select(); document.execCommand('copy'); toast("ƒê√£ copy JSON."); };
$("#btnDownloadJson").onclick = ()=>{
  if(!$("#jsonOut").value) buildJson();
  const blob = new Blob([$("#jsonOut").value], {type:"application/json"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'affiliates.append.json'; a.click();
};

$("#origin").addEventListener('input', ()=>$("#originOut").value=cleanUrl($("#origin").value));
runDiag();
</script>
</body>
</html>
