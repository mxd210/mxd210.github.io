<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MXD Importer v4.3.6 — PRO (Worker + Publish + Status)</title>
<meta name="robots" content="noindex,follow"/>
<style>
:root{
  --bg:#0b0f14;--fg:#e8f0fb;--muted:#a7b4c2;--b:#223043;--accent:#7cc4ff;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--card:#121821;--card2:#0f1520;
  --input:#121a28;--chip:#0b1220;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(11,15,20,.85));border-bottom:1px solid var(--b)}
header .wrap{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px}
h1{margin:0;font-size:18px}
.badge{padding:2px 8px;border:1px solid var(--b);border-radius:999px;background:#162132}
main{padding:14px;max-width:1440px;margin:auto;display:grid;grid-template-columns:420px 1fr;gap:14px}
.panel{background:var(--card);border:1px solid var(--b);border-radius:14px;overflow:hidden}
.panel h2{margin:0;padding:10px 12px;background:var(--card2);border-bottom:1px solid var(--b);font-size:15px}
.panel .body{padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stack{display:flex;flex-direction:column;gap:8px}
textarea,input,select{width:100%;background:var(--input);color:var(--fg);border:1px solid var(--b);border-radius:10px;padding:10px;outline:none}
textarea::placeholder,input::placeholder{color:#93a0af}
textarea:focus,input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,196,255,.2)}
.btn{display:inline-flex;align-items:center;gap:6px;background:#1a2330;border:1px solid var(--b);color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer;user-select:none}
.btn.primary{background:#12263f;border-color:#223a59}
.btn.ok{background:#0d2a1c;border-color:#144d2e;color:#b7f7cd}
.btn.warn{background:#3a2a08;border-color:#5f420c;color:#ffe1a3}
.btn[aria-busy="true"]{opacity:.6;pointer-events:none}
.btn[aria-pressed="true"]{outline:2px solid var(--accent)}
.btn.sm{padding:4px 6px;font-size:12px;border-radius:8px}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi span{background:var(--chip);border:1px solid var(--b);padding:6px 10px;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
th,td{border-bottom:1px solid var(--b);padding:6px 8px;vertical-align:top}
th{position:sticky;top:0;background:var(--card2);z-index:1}
th.sel,td.sel{width:36px}.w90{width:90px}.w120{width:120px}.w160{width:160px}.w360{width:360px}
.cell{display:flex;gap:6px;align-items:center}.cell input{flex:1 1 auto;min-width:0}
.out{min-height:120px;background:var(--chip);border:1px dashed var(--b);padding:8px;border-radius:10px;white-space:pre-wrap;word-break:break-word}
.toast{position:fixed;right:16px;bottom:16px;background:var(--chip);border:1px solid var(--b);padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:all .25s}
.toast.show{opacity:1;transform:translateY(0)}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>MXD Importer v4.3.6 — PRO</h1>
    <span class="badge">drop-in / 1 file</span>
    <span class="badge">GA4 trước Affiliate</span>
    <span id="cfgbadge" class="small" style="margin-left:auto">CFG: dùng mặc định</span>
  </div>
</header>

<main>
  <!-- 1) Dán dữ liệu + cấu hình -->
  <section class="panel">
    <h2>Nhập dữ liệu & cấu hình</h2>
    <div class="body stack">
      <label>Dán danh sách (mỗi dòng: <code>Tên | giá | link</code>, hoặc chỉ <code>link</code>)</label>
      <textarea id="txt" rows="12" placeholder="Máy ... | 990.000 | https://shopee.vn/..."></textarea>
      <div class="row">
        <button class="btn primary" id="btnParse">1) Parse</button>
        <button class="btn" id="btnSample">Dán ví dụ</button>
      </div>
      <div class="small">Dòng hiện có: <b id="lineCount">0</b></div>
      <hr style="border-color:#223043">
      <div class="row">
        <input id="tplShopee" type="url" placeholder="Template Shopee (dùng {url},{sub1..4})">
        <input id="tplLazada" type="url" placeholder="Template Lazada">
      </div>
      <div class="row">
        <input id="tplTiki" type="url" placeholder="Template Tiki">
        <input id="affId" type="text" placeholder="AFF_ID (tuỳ chọn)">
      </div>
      <div class="row">
        <input id="sub1" type="text" placeholder="sub1 = mxd210">
        <input id="sub2" type="text" placeholder="sub2 = để trống (auto=SKU)">
      </div>
      <div class="row">
        <input id="sub3" type="text" placeholder="sub3 = store">
        <input id="sub4" type="text" placeholder="sub4 = oneatweb/chiến dịch">
      </div>
      <div class="row">
        <button class="btn" id="btnSaveCfg">Lưu cấu hình</button>
        <button class="btn warn" id="btnClearCfg">Xoá cấu hình</button>
      </div>
    </div>
  </section>

  <!-- 2) Bảng dữ liệu -->
  <section class="panel">
    <h2>2) Bảng dữ liệu</h2>
    <div class="body">
      <div class="kpi" id="kpi"></div>
      <div style="overflow:auto;max-height:46dvh">
        <table id="tbl">
          <thead><tr>
            <th class="sel"><input type="checkbox" id="selAll"></th>
            <th>#</th><th class="w160">Tên</th><th class="w90">Giá</th><th class="w120">Merchant</th>
            <th class="w120">SKU</th><th class="w160">Ảnh</th>
            <th class="w360">Link gốc</th><th>Deep link</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small">Mẹo: sửa nhanh bằng Tab/Enter. SKU lowercase-kebab. Chọn dòng (checkbox) để đẩy SELECT.</div>
    </div>
  </section>

  <!-- 3) Health & JSON -->
  <section class="panel">
    <h2>3) Health-check & Xuất JSON</h2>
    <div class="body stack">
      <div class="row">
        <button class="btn ok" id="btnHealth">Chạy kiểm tra</button>
        <button class="btn" id="btnFixSku">Sửa SKU lỗi</button>
      </div>
      <div class="out" id="outHealth"></div>
      <div class="row">
        <button class="btn primary" id="btnJson">Tạo JSON</button>
        <button class="btn" id="btnDownloadJson">Tải xuống</button>
        <button class="btn" id="btnCopyJson">Copy</button>
      </div>
      <div class="out" id="outJson"></div>
    </div>
  </section>

  <!-- 4) Worker -->
  <section class="panel">
    <h2>4) Worker tích hợp — hàng đợi & xuất bản</h2>
    <div class="body stack">
      <div class="row">
        <input id="workerUrl" type="url" placeholder="https://mxd-control-v2.mxd6686.workers.dev">
        <input id="workerKey" type="text" placeholder="X-Key (SECRET_KEY/ADMIN_KEY)">
      </div>
      <div class="row">
        <button class="btn" id="btnHealthW">Kiểm tra Worker</button>
        <button class="btn" id="btnDiag">Chẩn đoán</button>
        <button class="btn" id="btnStatus">Status</button>
      </div>
      <div class="row">
        <button class="btn ok" id="btnPushStoreSel">Đẩy SELECT → Store</button>
        <button class="btn warn" id="btnPushFeaturedSel">Đẩy SELECT → Nổi bật</button>
      </div>
      <div class="row">
        <button class="btn ok" id="btnPushStoreAll">Đẩy TẤT CẢ → Store</button>
        <button class="btn warn" id="btnPushFeaturedAll">Đẩy TẤT CẢ → Nổi bật</button>
      </div>
      <div class="row">
        <button class="btn primary" id="btnPublishStore">Publish ngay → Store</button>
        <button class="btn primary" id="btnPublishFeatured">Publish ngay → Nổi bật</button>
      </div>
      <div class="out" id="outPublish"></div>
      <div class="small">/queue nhận {channel,items}. /publish phát hành thẳng (POST JSON; nếu 404/405 sẽ fallback GET ?channel=...).</div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const $=(s,el=document)=>el.querySelector(s);
  const toast=(m)=>{const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1500);};

  // --------- Config (localStorage)
  const defaults={
    tplShopee:'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
    tplLazada:'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
    tplTiki:'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
    affId:'', sub1:'mxd210', sub2:'', sub3:'store', sub4:'oneatweb',
    workerUrl:'https://mxd-control-v2.mxd6686.workers.dev', workerKey:''
  };
  const store={k:'mxd-importer-v436',
    load(){try{return JSON.parse(localStorage.getItem(this.k))||{}}catch(e){return{}}},
    save(cfg){localStorage.setItem(this.k, JSON.stringify(cfg)); $("#cfgbadge").textContent="CFG: đã lưu " + new Date().toLocaleTimeString(); toast("Đã lưu cấu hình");}
  };
  const cfg=Object.assign({}, defaults, store.load());
  ["tplShopee","tplLazada","tplTiki","affId","sub1","sub2","sub3","sub4","workerUrl","workerKey"].forEach(id=>{ const el=$("#"+id); if(el) el.value=cfg[id]||""; });
  $("#cfgbadge").textContent = localStorage.getItem(store.k) ? ("CFG: đã tải " + new Date().toLocaleTimeString()) : "CFG: dùng mặc định";
  $("#btnSaveCfg").onclick=()=>{["tplShopee","tplLazada","tplTiki","affId","sub1","sub2","sub3","sub4","workerUrl","workerKey"].forEach(id=>cfg[id]=$("#"+id).value.trim()); store.save(cfg);};
  $("#btnClearCfg").onclick=()=>{localStorage.removeItem(store.k); $("#cfgbadge").textContent="CFG: đã xoá"; toast("Đã xóa cấu hình");};

  // --------- Helpers
  const slug=(s)=>{ if(!s) return ""; const from="ÁÀÃÂĂÄẮẰẴẪẤẦẪǍÅĀáàãâăäắằẵẫấầẫǎåāÉÈẼÊËĚĒéèẽêëěēÍÌĨÎÏĪíìĩîïīÓÒÕÔƠÖǑŌóòõôơöǒōÚÙŨÛƯÜŪúùũûưüūÝỲỸŶŸȲýỳỹŷÿȳĐđÇçÑñ",to="AAAAAAAAAAAAAAaaaaaaAAAAAAaaaaaaEEEEEEEeeeeeeeIIIIIIiiiiiiOOOOOOOOoooooooUUUUUUuuuuuYYYYYYyyyyyyDdCcNn"; let x=s.normalize("NFD").replace(/[\u0300-\u036f]/g,""); for(let i=0;i<from.length;i++) x=x.replace(new RegExp(from[i],"g"),to[i]); return x.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); };
  const detect=(u)=>{ try{const x=new URL(u); if(x.hostname.includes("shopee"))return"shopee"; if(x.hostname.includes("lazada"))return"lazada"; if(x.hostname.includes("tiki"))return"tiki"; return "";}catch(e){return "";} };
  const deeplink=(origin,merchant,sku)=>{ const base={shopee:cfg.tplShopee,lazada:cfg.tplLazada,tiki:cfg.tplTiki}[merchant]||""; if(!base) return ""; const enc=encodeURIComponent; const map={'{url}':enc(origin),'{aff_id}':cfg.affId||'','{sub1}':cfg.sub1||'mxd210','{sub2}':(cfg.sub2||'')||(sku||''),'{sub3}':cfg.sub3||'store','{sub4}':cfg.sub4||'oneatweb'}; let out=base; for(const k in map) out=out.split(k).join(map[k]); return out; };

  // --------- Parse & render
  const txt=$("#txt"), lineCount=$("#lineCount");
  txt.addEventListener("input",()=>{lineCount.textContent = txt.value.split(/\r?\n/).filter(s=>s.trim()).length;});
  $("#btnSample").onclick=()=>{txt.value="Máy mài góc 125mm điều tốc Bosch GWS 900-125 S | 1.790.000 | https://shopee.vn/product/123/456\nMáy cắt gạch Dekton DK-AG950S | 1.150.000 | https://lazada.vn/products/abc\nhttps://tiki.vn/may-khoan-dong-luc-cde"; lineCount.textContent=3;};

  const parseLines=(text)=>{
    const rows=[], lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    for(const line of lines){
      let name="", price="", link=line;
      if(line.includes("|")){ const p=line.split("|").map(s=>s.trim()); name=p[0]||""; price=p[1]||""; link=p[2]||""; }
      const merchant=detect(link);
      const sku=slug(name || link.split("?")[0].split("/").pop());
      const image=`/assets/img/products/${sku}.webp`;
      const priceNum=String(price).replace(/[^\d]/g,"");
      rows.push({name, price:priceNum?Number(priceNum):0, origin:link, merchant, sku, image, category:"", brand:"", featured:false, status:true, updated_at:new Date().toISOString(), selected:false});
    }
    return rows;
  };

  const el=(tag, attrs={}, children=[])=>{
    const e=document.createElement(tag);
    for(const k in attrs){ if(k==="class") e.className=attrs[k]; else if(k==="text") e.textContent=attrs[k]; else e.setAttribute(k,attrs[k]); }
    (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>e.appendChild(c));
    return e;
  };

  const render=(data)=>{
    const tb=$("#tbl tbody"); tb.innerHTML="";
    const sum=data.reduce((a,b)=>a+Number(b.price||0),0);
    const byM=data.reduce((m,r)=>{m[r.merchant||"auto"]=(m[r.merchant||"auto"]||0)+1; return m;}, {});
    const merchants=Object.entries(byM).map(([k,v])=>`${k}:${v}`).join(" · ");
    const selCount=data.filter(r=>r.selected).length;
    $("#kpi").innerHTML=`<span>Hàng: <b>${data.length}</b></span><span>Tổng giá: <b>${sum.toLocaleString("vi-VN")}</b></span><span>Merchant: ${merchants}</span><span>Đã chọn: <b id="selCount">${selCount}</b></span>`;

    data.forEach((r,i)=>{
      const tr=el("tr");
      // chọn dòng
      const tdSel=el("td",{class:"sel"}); const ck=el("input",{type:"checkbox"}); ck.checked=!!r.selected; ck.onchange=()=>{r.selected=ck.checked; $("#selCount").textContent = window._data.filter(x=>x.selected).length;}; tdSel.appendChild(ck); tr.appendChild(tdSel);
      tr.appendChild(el("td",{text:String(i+1)}));

      const tdInput=(val,cls,type="text")=>{
        const td=el("td"); const inp=el("input",{type, value:type==="number"?(val||0):(val||""), class:cls});
        inp.oninput=()=>{
          if(type==="number") r[cls]=Number(inp.value||0); else r[cls]=inp.value;
          if(cls==="name"){ r.sku=slug(r.name); tr.querySelector("input.sku").value=r.sku; tr.querySelector("input.image").value=`/assets/img/products/${r.sku}.webp`; }
          if(cls==="sku"){ tr.querySelector("input.image").value=`/assets/img/products/${r.sku}.webp`; }
          tr.querySelector(".deep").value = deeplink(r.origin,r.merchant,r.sku);
        };
        td.appendChild(inp); return td;
      };
      tr.appendChild(tdInput(r.name,"name"));
      tr.appendChild(tdInput(r.price,"price","number"));

      const tdMer=el("td"); const sel=el("select");
      ["","shopee","lazada","tiki"].forEach(m=>{ const o=el("option",{value:m,text:m||"(auto)"}); if(m===r.merchant) o.selected=true; sel.appendChild(o); });
      sel.onchange=()=>{ r.merchant=sel.value; tr.querySelector(".deep").value = deeplink(r.origin,r.merchant,r.sku); };
      tdMer.appendChild(sel); tr.appendChild(tdMer);

      tr.appendChild(tdInput(r.sku,"sku"));
      tr.appendChild(tdInput(r.image,"image"));

      const tdOrigin=el("td"); const ow=el("div",{class:"cell"},[ el("input",{type:"text",value:r.origin,class:"origin"}), el("button",{class:"btn sm",text:"Copy"}), el("a",{class:"btn sm",text:"Mở",href:r.origin,target:"_blank"}) ]);
      ow.querySelector("button").onclick=()=>{navigator.clipboard.writeText(ow.querySelector(".origin").value); toast("Đã copy link gốc");};
      ow.querySelector(".origin").oninput=()=>{ r.origin=ow.querySelector(".origin").value; tr.querySelector(".deep").value = deeplink(r.origin,r.merchant,r.sku); };
      tdOrigin.appendChild(ow); tr.appendChild(tdOrigin);

      const tdDeep=el("td"); const dw=el("div",{class:"cell"},[ el("input",{type:"text",value:deeplink(r.origin,r.merchant,r.sku),class:"deep"}), el("button",{class:"btn sm",text:"Copy"}), el("a",{class:"btn sm",text:"Mở",href:"#",target:"_blank"}) ]);
      dw.querySelector("button").onclick=()=>{navigator.clipboard.writeText(dw.querySelector(".deep").value); toast("Đã copy deep link");};
      const upd=()=>{ dw.querySelector("a").href = dw.querySelector(".deep").value || "#"; };
      dw.querySelector(".deep").oninput=upd; upd();
      tdDeep.appendChild(dw); tr.appendChild(tdDeep);

      tb.appendChild(tr);
    });
    window._data=data;
  };

  $("#btnParse").onclick=(e)=>{
    const text=txt.value.trim();
    if(!text){ toast("Chưa có dữ liệu"); return; }
    render(parseLines(text)); $("#outHealth").textContent=""; $("#outJson").textContent="";
    e.currentTarget.setAttribute("aria-pressed","true"); setTimeout(()=>e.currentTarget.removeAttribute("aria-pressed"),800);
  };
  $("#selAll").addEventListener("change", (e)=>{ if(!window._data) return; window._data.forEach(r=>r.selected=e.currentTarget.checked); render(window._data); });

  // --------- Health & JSON
  $("#btnFixSku").onclick=()=>{ if(!window._data){toast("Chưa có dữ liệu");return;} window._data.forEach(r=>{r.sku=slug(r.sku||r.name||""); r.image=`/assets/img/products/${r.sku}.webp`;}); render(window._data); };
  $("#btnHealth").onclick=()=>{
    if(!window._data){ $("#outHealth").textContent="Chưa có dữ liệu."; return; }
    const log=[], seen=new Set(); let ok=0,bad=0,warn=0;
    window._data.forEach((r,i)=>{
      const errs=[];
      if(!r.name || r.name.length<4) errs.push("name ngắn");
      if(!r.origin || !/^https?:\/\//.test(r.origin)) errs.push("link gốc sai");
      if(!r.merchant) errs.push("merchant chưa nhận dạng");
      if(!r.sku) errs.push("sku trống");
      if(r.sku && !/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(r.sku)) errs.push("sku sai định dạng");
      if(seen.has(r.sku)) errs.push("sku trùng"); else seen.add(r.sku);
      if(!r.image || !r.image.startsWith("/assets/img/products/")) errs.push("ảnh sai path");
      if((r.price||0)<=0){ warn++; errs.push("price=0"); }
      const lv = errs.some(x=>["link gốc sai","merchant chưa nhận dạng","sku trống","sku sai định dạng"].includes(x)) ? "BAD" : "OK";
      if(lv==="OK") ok++; else bad++;
      log.push(`[${lv}] #${i+1} ${r.sku||"(no-sku)"} — price=${Number(r.price||0).toLocaleString("vi-VN")} — ${errs.join(", ")||"hợp lệ"}`);
    });
    $("#outHealth").textContent = `Kết quả: OK=${ok} • Cảnh báo(price=0)=${warn} • Lỗi=${bad}\n` + log.join("\n");
  };
  $("#btnJson").onclick=()=>{
    if(!window._data){ $("#outJson").textContent="Chưa có dữ liệu."; return; }
    const arr=window._data.map(r=>({name:r.name,price:Number(r.price||0),origin:r.origin,merchant:r.merchant,sku:r.sku,image:r.image,category:r.category||"",brand:r.brand||"",featured:!!r.featured,status:!!r.status,updated_at:r.updated_at||new Date().toISOString()}));
    $("#outJson").textContent = JSON.stringify(arr,null,2);
  };
  $("#btnDownloadJson").onclick=()=>{ const s=$("#outJson").textContent.trim(); if(!s){toast("Chưa tạo JSON"); return;} const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([s],{type:"application/json"})); a.download="affiliates.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); };
  $("#btnCopyJson").onclick=()=>{ const s=$("#outJson").textContent.trim(); if(!s) return; navigator.clipboard.writeText(s); toast("Đã copy JSON"); };

  // --------- Worker I/O
  const base=()=>($("#workerUrl").value.trim()||cfg.workerUrl).replace(/\/$/,"");
  const hdr=()=>{ const h={'content-type':'application/json'}; const k=$("#workerKey").value.trim()||cfg.workerKey; if(k) h['x-key']=k; return h; };
  const remember=()=>{ cfg.workerUrl=$("#workerUrl").value.trim(); cfg.workerKey=$("#workerKey").value.trim(); store.save(cfg); };

  const selected=()=> (window._data||[]).filter(x=>x.selected).map(x=>({name:x.name,price:Number(x.price||0),origin:x.origin,merchant:x.merchant,sku:x.sku,image:x.image,featured:!!x.featured,status:true,updated_at:new Date().toISOString()}));
  const allItems=()=> (window._data||[]).map(x=>({name:x.name,price:Number(x.price||0),origin:x.origin,merchant:x.merchant,sku:x.sku,image:x.image,featured:!!x.featured,status:true,updated_at:new Date().toISOString()}));

  async function queue(channel, items){
    if(items.length===0){ $("#outPublish").textContent="Không có item để đẩy."; return; }
    try{
      const r=await fetch(base()+"/queue",{method:"POST",headers:hdr(),body:JSON.stringify({channel,items})});
      const t=await r.text();
      $("#outPublish").textContent="QUEUE "+channel.toUpperCase()+" "+r.status+" — "+t; remember();
    }catch(e){ $("#outPublish").textContent="Queue lỗi: "+e; }
  }
  async function publish(channel){
    try{
      let r=await fetch(base()+"/publish",{method:"POST",headers:hdr(),body:JSON.stringify({channel})});
      if(r.status===404||r.status===405){ r=await fetch(base()+"/publish?channel="+encodeURIComponent(channel),{headers:hdr()}); }
      const t=await r.text();
      $("#outPublish").textContent="PUBLISH "+channel.toUpperCase()+" "+r.status+" — "+t; remember();
    }catch(e){ $("#outPublish").textContent="Publish lỗi: "+e; }
  }

  $("#btnHealthW").onclick=async()=>{ try{const r=await fetch(base()+"/health"); const t=await r.text(); $("#outPublish").textContent="HEALTH "+r.status+" — "+t; }catch(e){ $("#outPublish").textContent="Lỗi: "+e; } };
  $("#btnDiag").onclick=async()=>{ try{const [rs,rf]=await Promise.all([fetch(base()+"/export/store"),fetch(base()+"/export/featured")]); const ts=await rs.text(), tf=await rf.text(); $("#outPublish").textContent=`STORE ${rs.status} — ${ts.slice(0,200)}...\nFEATURED ${rf.status} — ${tf.slice(0,200)}...`; }catch(e){ $("#outPublish").textContent="Diag lỗi: "+e; } };
  $("#btnStatus").onclick=async()=>{ try{let r=await fetch(base()+"/status",{headers:hdr()}); if(r.status===404) r=await fetch(base()+"/status"); const t=await r.text(); $("#outPublish").textContent="STATUS "+r.status+" — "+t; }catch(e){ $("#outPublish").textContent="Status lỗi: "+e; } };

  $("#btnPushStoreSel").onclick=()=>queue("store", selected());
  $("#btnPushFeaturedSel").onclick=()=>queue("featured", selected().map(x=>Object.assign({},x,{featured:true})));
  $("#btnPushStoreAll").onclick=()=>queue("store", allItems());
  $("#btnPushFeaturedAll").onclick=()=>queue("featured", allItems().map(x=>Object.assign({},x,{featured:true})));
  $("#btnPublishStore").onclick=()=>publish("store");
  $("#btnPublishFeatured").onclick=()=>publish("featured");
})();
</script>
</body>
</html>
