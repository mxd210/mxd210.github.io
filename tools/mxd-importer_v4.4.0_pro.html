<!-- REPLACE WHOLE FILE: /tools/mxd-importer_v4.4.0_pro.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MXD Importer v4.4.0 ‚Äî PRO + Multi-format + Size Presets + Auto-Compress + TikTok/Tiki + ClearAll</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#0b0f14;--fg:#e8f0fb;--muted:#a7b4c2;--b:#152132;--accent:#7cc4ff;
      --ok:#34d399;--warn:#f59e0b;--err:#ef4444;--toast-bottom: 12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:16px 0 8px}
    h1{font-size:20px}
    h2{font-size:16px;color:#cfe5ff}
    a{color:#7cc4ff}
    .wrap{max-width:1160px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid #223348;border-radius:12px;padding:14px}
    label{display:block;font-weight:700;margin:8px 0 6px;color:#cfe5ff}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3b52;background:#0f1622;color:var(--fg)}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .small{font-size:12px;color:#a7b4c2}
    .btn{cursor:pointer;border:1px solid #2b3b52;background:#102235}
    .btn:hover{background:#132a43}
    .btn.primary{background:#0b3a5e;border-color:#0b3a5e}
    .btn.primary:hover{background:#0d4570}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3b55;color:#a4bee8}
    .ok{color:#34d399} .warn{color:#f59e0b} .err{color:#ef4444}
    .deeplink-box{border:2px dashed #2f4666;border-radius:12px;padding:10px;background:#0c1623}
    .deeplink-text{font-size:13px;font-weight:600}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,#0b0f14 60%,#0b0f1400);padding:12px;border-top:1px solid #1b2a3f;z-index:9}
    .drop{border:2px dashed #3a5270;border-radius:12px;padding:16px;text-align:center;background:#0c1623}
    .drop.dragover{border-color:#8ab9ff;background:#0f1e32}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #27405e}
    .toast{position:fixed;right:12px;bottom:var(--toast-bottom);display:none;max-width:520px;background:#122232;border:1px solid #2b425e;border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;z-index:99999;pointer-events:none}
    .toast.show{display:block}
    code.inline{background:#0e1622;border:1px solid #223449;border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;border:1px solid #2b3b52;border-radius:999px;padding:2px 8px;font-size:11px;color:#a4bee8}

    /* Batch queue */
    table.queue{width:100%;border-collapse:separate;border-spacing:0 8px}
    table.queue th, table.queue td{font-size:13px;vertical-align:middle}
    table.queue th{color:#cfe5ff;text-align:left;padding:6px 8px}
    table.queue td{background:#0d1826;border:1px solid #23364b;padding:6px 8px}
    table.queue td:first-child{border-radius:10px 0 0 10px}
    table.queue td:last-child{border-radius:0 10px 10px 0}
    .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid #27405e;background:#0a1320}
    .mini{display:flex;gap:6px;align-items:center}
    .w-auto{width:auto}
    .nowrap{white-space:nowrap}
    .btn.sm{padding:6px 10px;border-radius:8px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .status{font-size:12px}
    .muted{color:#8fa5bd}

    /* Clear buttons */
    .input-wrap{position:relative;width:100%}
    .input-wrap > input, .input-wrap > textarea{padding-right:40px}
    .clear-btn{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:28px; height:28px; border-radius:8px;
      border:1px solid #ff8585; background:#2b0f12; color:#ffd1d1;
      display:grid; place-items:center; font-weight:900; line-height:1;
      box-shadow:0 0 0 1px #590e0e inset;
    }
    .input-wrap.textarea .clear-btn{ top:10px; transform:none }

    /* Debug panel */
    .debug-log{background:#0c1623;border:1px solid #2d3f57;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px;white-space:pre-wrap;max-height:220px;overflow:auto}

    /* Image options */
    .opts{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .opts .span2{grid-column:span 2}
    .opts .span4{grid-column:span 4}
    .range{display:flex;gap:8px;align-items:center}
    .range input[type=range]{flex:1}
  </style>
</head>
<body>
<div class="wrap">
  <h1>MXD Importer v4.4.0 <span class="pill">PRO</span> <span class="pill">Multi-format</span> <span class="pill">Size Presets</span> <span class="pill">Auto-Compress</span> <span class="pill">TikTok/Tiki</span></h1>
  <div class="small">H·ªó tr·ª£ webp/png/jpg, preset k√≠ch th∆∞·ªõc & W√óH tu·ª≥ ch·ªânh, auto-compress theo dung l∆∞·ª£ng m·ª•c ti√™u. Deep-link: Shopee/Lazada/Tiki/TikTok.</div>

  <div class="card">
    <h2>1) C√†i ƒë·∫∑t (l∆∞u v√†o tr√¨nh duy·ªát)</h2>
    <div class="grid g2">
      <div><label>Worker Base URL</label><input id="workerUrl" placeholder="https://mxd210.mxd6686.workers.dev"/></div>
      <div><label>X-Key (header b·∫£o v·ªá Worker)</label><input id="xKey" placeholder="V√≠ d·ª•: mxd210-secret-key"/></div>

      <div><label>Shopee template</label><input id="tplShopee" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
      <div><label>Lazada template</label><input id="tplLazada" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>

      <div><label>Tiki template</label><input id="tplTiki" placeholder="https://go.isclix.com/deep_link/6803097511817356947/4348614231480407268?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
      <div><label>TikTok template</label><input id="tplTiktok" placeholder="https://go.isclix.com/deep_link/6803097511817356947/6648523843406889655?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">üíæ L∆∞u c√†i ƒë·∫∑t</button>
      <button class="btn" id="btnLoadSettings">‚Üª T·∫£i l·∫°i</button>
      <button class="btn" id="btnClearSettings">üóë X√≥a c√†i ƒë·∫∑t</button>
      <span class="small" id="settingsStatus"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCheckWorker">Ki·ªÉm tra Worker</button>
      <button class="btn" id="btnCheckAuth">Ki·ªÉm tra X-Key</button>
      <button class="btn" id="btnCheckWrite">Ki·ªÉm tra quy·ªÅn commit</button>
      <button class="btn" id="btnTestUpload">Test upload 1√ó1</button>
      <span class="small" id="workerStatus"></span>
    </div>
  </div>

  <div class="grid g2">
    <div class="card">
      <h2>2) ·∫¢nh s·∫£n ph·∫©m (ƒë∆°n l·∫ª)</h2>
      <div id="drop" class="drop">K√©o <b>m·ªôt ho·∫∑c nhi·ªÅu</b> ·∫£nh v√†o ƒë√¢y ho·∫∑c ch·ªçn‚Ä¶</div>
      <input type="file" id="file" accept="image/*" multiple style="display:none"/>

      <div class="opts" style="margin-top:10px">
        <div>
          <label>ƒê·ªãnh d·∫°ng xu·∫•t</label>
          <select id="defaultFmt">
            <option value="webp">webp</option>
            <option value="png">png</option>
            <option value="jpg">jpg</option>
          </select>
        </div>
        <div>
          <label>Preset k√≠ch th∆∞·ªõc</label>
          <select id="sizePreset">
            <option value="max">C·∫°nh d√†i (m·∫∑c ƒë·ªãnh)</option>
            <option value="square1200">Vu√¥ng 1200√ó1200</option>
            <option value="icon400">Icon 400√ó400</option>
            <option value="og">OG 1200√ó630</option>
            <option value="custom">Tu·ª≥ ch·ªânh W√óH</option>
          </select>
        </div>
        <div>
          <label>Max side / Width</label>
          <input id="optW" type="number" value="1200" min="64" max="4096"/>
        </div>
        <div>
          <label>Height (n·∫øu d√πng W√óH)</label>
          <input id="optH" type="number" value="1200" min="64" max="4096"/>
        </div>

        <div class="span2">
          <label>Ch·∫•t l∆∞·ª£ng (0.4‚Äì0.95)</label>
          <div class="range">
            <input id="quality" type="range" min="0.4" max="0.95" step="0.01" value="0.82"/>
            <input id="qualityNum" type="number" min="0.4" max="0.95" step="0.01" value="0.82" style="width:110px"/>
          </div>
        </div>
        <div class="span2">
          <label>Auto-compress ‚â§ (KB, 0 = t·∫Øt)</label>
          <div class="range">
            <input id="targetKB" type="range" min="0" max="512" step="8" value="0"/>
            <input id="targetKBNum" type="number" min="0" max="2048" step="10" value="0" style="width:110px"/>
          </div>
        </div>

        <div class="span2">
          <label>Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFolder">
            <option value="/assets/img/products/">/assets/img/products/</option>
            <option value="/assets/img/categories/">/assets/img/categories/</option>
            <option value="/assets/img/og/">/assets/img/og/</option>
            <option value="/assets/img/brands/">/assets/img/brands/</option>
            <option value="custom">T·ª± nh·∫≠p‚Ä¶</option>
          </select>
        </div>
        <div class="span2" id="defaultCustomWrap" style="display:none">
          <label>ƒê∆∞·ªùng d·∫´n tu·ª≥ ch·ªânh (k·∫øt th√∫c b·∫±ng /)</label>
          <input id="defaultCustomPath" placeholder="/assets/img/blog/2025/"/>
        </div>
        <div class="span4">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="cbUseFilename" checked style="width:auto"/>
            D√πng <b>t√™n file</b> n·∫øu <b>SKU tr·ªëng</b>
          </label>
        </div>
      </div>

      <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
        <img id="thumb" alt="preview"/>
        <div class="small">
          <div><b>T√™n file ƒë·ªÅ xu·∫•t:</b> <code class="inline" id="imgName">-</code></div>
          <div><b>K√≠ch th∆∞·ªõc:</b> <span id="imgInfo">-</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSelectImg">Ch·ªçn ·∫£nh</button>
        <button class="btn" id="btnConvert">Convert/N√©n</button>
        <button class="btn" id="btnSaveImg">T·∫£i ·∫£nh</button>
        <button class="btn primary" id="btnUploadImg">Upload ·∫£nh</button>
        <button class="btn" id="btnQueueCurrent">‚ûï Th√™m ·∫£nh hi·ªán t·∫°i v√†o h√†ng ƒë·ª£i</button>
      </div>
      <div class="small">Preset g·ª£i √Ω: Product vu√¥ng 1200, Icon 400, OG 1200√ó630. PNG/WebP gi·ªØ n·ªÅn trong su·ªët; JPG s·∫Ω l√≥t n·ªÅn tr·∫Øng khi c·∫ßn.</div>
    </div>

    <div class="card">
      <h2>3) Th√¥ng tin s·∫£n ph·∫©m</h2>
      <div class="grid">
        <div class="row">
          <div><label>T√™n s·∫£n ph·∫©m</label><input id="name" data-clear placeholder="V√≠ d·ª•: Dekton DK-AG950S"/></div>
          <div><label>SKU (b·∫Øt bu·ªôc cho publish; c√≥ th·ªÉ tr·ªëng khi ch·ªâ upload ·∫£nh)</label><input id="sku" data-clear placeholder="dekton-dk-ag950s"/></div>
        </div>
        <div class="row">
          <div><label>Gi√° (VND, kh√¥ng ch·∫•m)</label><input id="price" data-clear type="number" placeholder="399000"/></div>
          <div>
            <label>Merchant</label>
            <select id="merchant">
              <option value="shopee">shopee</option>
              <option value="lazada">lazada</option>
              <option value="tiki">tiki</option>
              <option value="tiktok">tiktok</option>
            </select>
          </div>
        </div>
        <div><label>Link g·ªëc (origin)</label><input id="origin" data-clear placeholder="https://shopee.vn/‚Ä¶ | https://tiki.vn/‚Ä¶ | https://www.tiktok.com/‚Ä¶"/></div>
        <div class="row">
          <div><label>·∫¢nh (ƒë∆∞·ªùng d·∫´n)</label><input id="image" data-clear placeholder="/assets/img/products/dekton-dk-ag950s.webp"/></div>
          <div><label>Danh m·ª•c (category)</label><input id="category" data-clear placeholder="may-khoan-duc-vit / may-cat / phu-kien-may"/></div>
        </div>
        <div><label>Th∆∞∆°ng hi·ªáu (brand)</label><input id="brand" data-clear placeholder="dekton, bosch, makuta‚Ä¶"/></div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="featured" style="width:auto"/> N·ªïi b·∫≠t (featured)</label>
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="status" checked style="width:auto"/> Hi·ªÉn th·ªã (status)</label>
          <button class="btn" id="btnAuto">ƒêi·ªÅn auto t·ª´ t√™n</button>
          <button class="btn" id="btnClearAllFields">üßπ Xo√° t·∫•t c·∫£</button>
        </div>
        <div id="diag" class="small"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>2b) H√†ng ƒë·ª£i ·∫£nh (Batch)</h2>
    <div class="row">
      <button class="btn" id="btnConvertAll">Convert t·∫•t c·∫£</button>
      <button class="btn" id="btnDownloadAll">T·∫£i t·∫•t c·∫£</button>
      <button class="btn primary" id="btnUploadAll">Upload t·∫•t c·∫£</button>
      <button class="btn" id="btnClearQueue">Xo√° h√†ng ƒë·ª£i</button>
      <span class="small muted">Tip: th·∫£ <b>nhi·ªÅu ·∫£nh</b> v√†o v√πng tr√™n ƒë·ªÉ th√™m tr·ª±c ti·∫øp v√†o h√†ng ƒë·ª£i.</span>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table class="queue" id="queueTable">
        <thead><tr><th>·∫¢nh</th><th>T√™n xu·∫•t</th><th>Th∆∞ m·ª•c</th><th>ƒê·ªãnh d·∫°ng</th><th>ƒê∆∞·ªùng d·∫´n xu·∫•t</th><th>K√≠ch th∆∞·ªõc</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card deeplink-box">
    <h2>4) Deep-link (to, r√µ r√†ng, copy d·ªÖ)</h2>
    <div class="grid g2">
      <div>
        <label>Origin (ƒë√£ nh·∫≠p)</label>
        <textarea id="originOut" class="deeplink-text" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOrigin">Copy Origin</button>
          <button class="btn" id="openOrigin">M·ªü Origin</button>
        </div>
      </div>
      <div>
        <label>Affiliate deep-link</label>
        <div class="input-wrap textarea">
          <textarea id="deeplink" data-clear class="deeplink-text" placeholder="T·ª± sinh t·ª´ template ho·∫∑c d√°n s·∫µn t·∫°i ƒë√¢y"></textarea>
          <button class="clear-btn" title="Xo√°" aria-label="Xo√°" type="button">√ó</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnMakeDeeplink">T·∫°o t·ª´ template</button>
          <button class="btn" id="copyDeeplink">Copy Deep-link</button>
          <button class="btn" id="btnOpenDeeplink">M·ªü Deep-link</button>
          <span id="dlCheck" class="badge">‚Äì</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>5) JSON xu·∫•t b·∫£n</h2>
    <textarea id="jsonOut" rows="8" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">T·∫°o JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">T·∫£i affiliates.append.json</button>
    </div>
  </div>

  <div class="card">
    <h2>6) Worker Debug</h2>
    <div class="row">
      <button class="btn" id="btnProbeOptions">Probe OPTIONS /upload-image</button>
      <button class="btn" id="btnProbePublish">Probe OPTIONS /publish</button>
      <span class="small muted">Log d∆∞·ªõi ƒë√¢y gi√∫p ph√¢n bi·ªát: CORS / Auth / Payload.</span>
    </div>
    <div id="debugLog" class="debug-log" aria-live="polite">‚Äì</div>
  </div>

  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish ‚Üí Store</button>
    <button class="btn" id="btnPublishFeatured">Publish ‚Üí N·ªïi b·∫≠t</button>
    <button class="btn" id="btnVerify">‚úÖ Ki·ªÉm tra tr√™n Store</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
const $ = s => document.querySelector(s);

/* SETTINGS KEY (migrate from v4.3.8 if c√≥) */
const LS_KEY = 'MXD_IMPORTER_SETTINGS_V440';
function readSettingsRaw(key){ try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch(_){ return {}; } }
function readSettings(){
  const cur = readSettingsRaw(LS_KEY);
  if(Object.keys(cur).length) return cur;
  const old = readSettingsRaw('MXD_IMPORTER_SETTINGS_V438');
  return old;
}
function writeSettings(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

/* UTILS */
const slugify = s => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
function toast(msg,cls=''){ const t=$("#toast"); t.innerHTML=msg; t.className='toast show '+cls; setTimeout(()=>t.className='toast',4500); }
function log(msg){ const d=$("#debugLog"); d.textContent = (d.textContent && d.textContent!=='‚Äì' ? d.textContent + "\n" : "") + msg; d.scrollTop = d.scrollHeight; }
function updateToastOffset(){ const bar=document.querySelector('.sticky-actions'); const bottom=bar?(bar.offsetHeight+16):12; document.documentElement.style.setProperty('--toast-bottom', bottom+'px'); }
window.addEventListener('load', updateToastOffset); window.addEventListener('resize', updateToastOffset); if('ResizeObserver'in window){ new ResizeObserver(updateToastOffset).observe(document.querySelector('.sticky-actions')); }

const DEFAULT_TPL_SHOPEE = 'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
const DEFAULT_TPL_LAZADA = 'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
const DEFAULT_TPL_TIKI   = 'https://go.isclix.com/deep_link/6803097511817356947/4348614231480407268?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
const DEFAULT_TPL_TIKTOK = 'https://go.isclix.com/deep_link/6803097511817356947/6648523843406889655?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';

function computeSubs(sku, merchant){ return { sub1: sku||'sku', sub2:(merchant||'merchant').toLowerCase(), sub3:'tool', sub4:'mxd210' }; }
function ensureSubsInUrl(u, subs){ const has = k => new RegExp(`[?&]${k}=`,`i`).test(u); const qs=[]; for(const k of ['sub1','sub2','sub3','sub4']) if(!has(k)) qs.push(`${k}=${encodeURIComponent(subs[k])}`); return qs.length?(u+(u.includes('?')?'&':'?')+qs.join('&')):u; }
function cleanUrl(u){ return (u||'').trim().replace(/^["']+|["',]+$/g,''); }
function vn(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D').toLowerCase(); }
function sanitizeFolder(p){ if(!p) return '/assets/img/'; p=p.trim(); if(!p.startsWith('/')) p='/'+p; if(!p.endsWith('/')) p+='/'; return p; }

/* CATEGORY MAP (gi·ªØ nguy√™n + c√≥ th·ªÉ m·ªü r·ªông sau) */
function normCategory(raw){
  const base = vn(raw).replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'');

  if (/^(may-?cat|maycat|may\s*cat|may-mai|mai-goc|may-cat-sat|may-cat-gach)$/.test(base)) return 'may-cat';
  if (/^(may-?khoan(-|_)?duc(-|_)?vit|may-khoan|khoan-duc-vit|khoan-bua|impact(-|_)?(driver|wrench)|sds(plus|max)?)$/.test(base)) return 'may-khoan-duc-vit';
  if (/^(phu-?kien|phu-?kien-?may|phu-kien-may)$/.test(base)) return 'phu-kien-may';
  return base;
}
window.CATEGORY_KEYWORDS = window.CATEGORY_KEYWORDS || {};
window.CATEGORY_KEYWORDS["may-cat"] = {
  include:[
    /\b(m√°y\s*)?c·∫Øt\b/i,
    /\bm√°y\s*c∆∞a\b/i,
    /\bc∆∞a\s*(ƒëƒ©a|b√†n|ki·∫øm|l·ªçng)\b/i,
    /\bcut[\s-]?off\b/i,
    /\bcircular(\s*saw)?\b/i,
    /\bjig\s*saw\b/i,
    /\bjigsaw\b/i,
    /\breciprocating\b/i,
    /\bsabre\b/i,
    /\bm√°y\s*c·∫Øt\s*(g·∫°ch|s·∫Øt|nh√¥m|ƒëa\s*nƒÉng)\b/i,
    /\bm[·∫£a]i\s*g[√≥o]c\b/i,
    /\bmay\s*cat\b/i
  ],
  exclude:[
    /\b(l∆∞·ª°i|blade|ƒëƒ©a|disc|ƒë√°\s*c·∫Øt|ph·ª•\s*ki·ªán|m≈©i)\b/i,
    /\b(pin|s·∫°c|ch·ªïi\s*than|than|ƒë·∫ø|v·ªè|collet|b·∫ßu\s*k·∫πp|adapter|ƒë√°\s*m√†i|gi·∫•y\s*nh√°m|guard|ch·ª•p\s*b·∫£o\s*v·ªá)\b/i
  ],
  set:{category:"may-cat"}
};
window.CATEGORY_KEYWORDS["may-khoan-duc-vit"] = {
  include:[
    /\bm√°y\s*khoan\b/i,
    /\bkhoan\s*b√∫a\b/i,
    /\bSDS[\s-]?(Plus|Max)\b/i,
    /\bimpact\s*(driver|wrench)\b/i,
    /\bb[·∫Øa]n\s*v[√≠i]t\b/i,
    /\bsi[·∫øe]t\s*bu\s*l[o√¥]ng\b/i
  ],
  exclude:[
    /\b(pin|s·∫°c|l∆∞·ª°i|ƒëƒ©a|m≈©i|ch√©n|ch·ªïi\s*than|than|ƒë·∫ø|v·ªè|collet|b·∫ßu\s*k·∫πp|adapter|ƒë√°\s*m√†i|gi·∫•y\s*nh√°m|guard|ch·ª•p\s*b·∫£o\s*v·ªá)\b/i
  ],
  set:{category:"may-khoan-duc-vit"}
};
window.CATEGORY_KEYWORDS["phu-kien-may"] = {
  include:[
    /\bpin\b/i,
    /\bs·∫°c\b/i,
    /\bl∆∞·ª°i\b/i,
    /\bƒëƒ©a\b/i,
    /\bblade\b/i,
    /\bdisc\b/i,
    /\bm≈©i\b/i,
    /\bm≈©i\s*khoan\b/i,
    /\bƒë·∫ßu\s*v√≠t\b/i,
    /\bƒë·∫ßu\s*kh·∫©u\b/i,
    /\bch√©n\b/i,
    /\bƒë√°\s*m√†i\b/i,
    /\bcup\s*wheel\b/i,
    /\bch·ªïi\s*than\b/i,
    /\bthan\b/i,
    /\bƒë·∫ø\b/i,
    /\bcollet\b/i,
    /\bb·∫ßu\s*k·∫πp\b/i,
    /\badapter\b/i,
    /\bgi·∫•y\s*nh√°m\b/i,
    /\bguard\b/i,
    /\bch·ª•p\s*b·∫£o\s*v·ªá\b/i
  ],
  exclude:[
    /^(m√°y|th√¢n\s*m√°y|tool[\s-]?only|bare\s*tool)\b/i
  ],
  set:{category:"phu-kien-may"}
};
function autoCategory(text){
  const MAP = window.CATEGORY_KEYWORDS||{};
  for(const [slug,rule] of Object.entries(MAP)){
    const okInc=(rule.include||[]).some(rx=>rx.test(text));
    const okExc=(rule.exclude||[]).some(rx=>rx.test(text));
    if(okInc && !okExc) return slug;
  }
  return '';
}

/* STATE */
const state = { workerOk:false, imgBlob:null, imgName:null, imgW:0, imgH:0 };

/* SETTINGS UI BIND */
function uiToSettings(){
  return {
    workerUrl:$("#workerUrl").value.trim(),
    xKey:$("#xKey").value.trim(),
    tplShopee:$("#tplShopee").value.trim(),
    tplLazada:$("#tplLazada").value.trim(),
    tplTiki:$("#tplTiki").value.trim(),
    tplTiktok:$("#tplTiktok").value.trim(),
    defaultFolder:$("#defaultFolder").value,
    defaultCustomPath:$("#defaultCustomPath").value.trim(),
    defaultFmt:$("#defaultFmt").value,
    sizePreset:$("#sizePreset").value,
    optW:Number($("#optW").value||1200),
    optH:Number($("#optH").value||1200),
    quality:Number($("#quality").value||0.82),
    targetKB:Number($("#targetKBNum").value||0)
  };
}
function settingsToUi(s){
  $("#workerUrl").value=s.workerUrl||'';
  $("#xKey").value=s.xKey||'';
  $("#tplShopee").value=s.tplShopee||'';
  $("#tplLazada").value=s.tplLazada||'';
  $("#tplTiki").value=s.tplTiki||'';
  $("#tplTiktok").value=s.tplTiktok||'';
  if(s.defaultFolder) $("#defaultFolder").value=s.defaultFolder;
  if(s.defaultCustomPath) $("#defaultCustomPath").value=s.defaultCustomPath;
  if(s.defaultFmt) $("#defaultFmt").value=s.defaultFmt;
  if(s.sizePreset) $("#sizePreset").value=s.sizePreset;
  if(s.optW) $("#optW").value=s.optW;
  if(s.optH) $("#optH").value=s.optH;
  if(s.quality){ $("#quality").value=s.quality; $("#qualityNum").value=s.quality; }
  if(typeof s.targetKB==='number'){ $("#targetKB").value=Math.min(512,s.targetKB); $("#targetKBNum").value=s.targetKB; }
  ensureFolderBase();
  updateSingleUploadCta();
}
function saveSettings(){ writeSettings(uiToSettings()); $("#settingsStatus").textContent="ƒê√£ l∆∞u."; toast("ƒê√£ l∆∞u c√†i ƒë·∫∑t.","ok"); }
function loadSettings(){
  const s=readSettings(); settingsToUi(s);
  if(!$("#tplShopee").value) $("#tplShopee").value=DEFAULT_TPL_SHOPEE;
  if(!$("#tplLazada").value) $("#tplLazada").value=DEFAULT_TPL_LAZADA;
  if(!$("#tplTiki").value)   $("#tplTiki").value=DEFAULT_TPL_TIKI;
  if(!$("#tplTiktok").value) $("#tplTiktok").value=DEFAULT_TPL_TIKTOK;
  $("#settingsStatus").textContent="ƒê√£ t·∫£i c√†i ƒë·∫∑t.";
}
$("#btnSaveSettings").onclick=saveSettings;
$("#btnLoadSettings").onclick=loadSettings;
$("#btnClearSettings").onclick=()=>{ localStorage.removeItem(LS_KEY); settingsToUi({}); $("#settingsStatus").textContent="ƒê√£ x√≥a."; };
loadSettings();

/* WORKER CHECKS */
function hdr(){
  const s=readSettings();
  const h={};
  if(s.xKey) h['x-key']=s.xKey;
  h['content-type']='application/json';
  return h;
}
async function check(url){
  try{
    const r=await fetch(url,{mode:"cors",headers:hdr()});
    const text=await r.text().catch(()=>'' );
    return {ok:r.ok,status:r.status,text};
  }catch(e){
    return {ok:false,status:-1,text:String(e)};
  }
}
$("#btnCheckWorker").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ $("#workerStatus").textContent="Ch∆∞a c·∫•u h√¨nh Worker."; return; }
  const u=s.workerUrl.replace(/\/$/,'')+"/health";
  const r=await check(u);
  state.workerOk=r.ok;
  const msg=r.ok?`Worker OK (health ${r.status})`:`Worker l·ªói (${r.status}). ${r.text.slice(0,120)}`;
  $("#workerStatus").textContent=msg;
  log("[/health] "+msg);
  toast(r.ok?"Worker OK":"Worker l·ªói "+r.status, r.ok?"ok":"err");
};
$("#btnCheckAuth").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const u=s.workerUrl.replace(/\/$/,'')+"/whoami";
  const r=await check(u);
  const msg=r.ok?"X-Key h·ª£p l·ªá.":"X-Key kh√¥ng h·ª£p l·ªá ("+r.status+")";
  log("[/whoami] "+msg+" ‚Äî "+r.text.slice(0,120));
  toast(msg, r.ok?"ok":"err");
};
$("#btnCheckWrite").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const u=s.workerUrl.replace(/\/$/,'')+"/can-write";
  const r=await check(u);
  const msg=r.ok?"C√≥ quy·ªÅn commit.":"Kh√¥ng c√≥ quy·ªÅn ("+r.status+")";
  log("[/can-write] "+msg+" ‚Äî "+r.text.slice(0,120));
  toast(msg, r.ok?"ok":"err");
};
$("#btnProbeOptions").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  try{
    const u=s.workerUrl.replace(/\/$/,'')+"/upload-image";
    const r=await fetch(u,{method:"OPTIONS",mode:"cors",headers:hdr()});
    log(`[OPTIONS /upload-image] ${r.status} ${r.ok?'OK':''} ‚Äî ALLOW: ${r.headers.get('allow')||'-'} | ACR: ${r.headers.get('access-control-allow-methods')||'-'}`);
    toast("ƒê√£ probe OPTIONS /upload-image","ok");
  }catch(e){
    log("[OPTIONS /upload-image] L·ªói: "+e.message);
    toast("Probe l·ªói.","err");
  }
};
$("#btnProbePublish").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  try{
    const u=s.workerUrl.replace(/\/$/,'')+"/publish";
    const r=await fetch(u,{method:"OPTIONS",mode:"cors",headers:hdr()});
    log(`[OPTIONS /publish] ${r.status} ${r.ok?'OK':''} ‚Äî ALLOW: ${r.headers.get('allow')||'-'} | ACR: ${r.headers.get('access-control-allow-methods')||'-'}`);
    toast("ƒê√£ probe OPTIONS /publish","ok");
  }catch(e){
    log("[OPTIONS /publish] L·ªói: "+e.message);
    toast("Probe l·ªói.","err");
  }
};

/* üîß FIX: Test upload d√πng c√πng logic fallback nh∆∞ upload th·∫≠t */
$("#btnTestUpload").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const base=s.workerUrl.replace(/\/$/,'');
  const c=document.createElement('canvas');
  c.width=1; c.height=1;
  const blob=await new Promise(res=>c.toBlob(res,'image/webp',0.5));
  if(!blob){ toast("Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh test.","err"); return; }

  const dataUrl=await blobToBase64(blob);
  const path='/assets/img/test/ping.webp';

  try{
    // L·∫ßn 1: g·ª≠i full dataURL (gi·ªëng upload hi·ªán t·∫°i)
    let r=await fetch(base+'/upload-image',{
      method:'POST',
      mode:'cors',
      headers:hdr(),
      body:JSON.stringify({sku:'ping',path,file:dataUrl})
    });
    let text=await r.text().catch(()=>'');

    // N·∫øu Worker ch·ªâ nh·∫≠n pure base64 ‚Üí th·ª≠ l·∫ßn 2 gi·ªëng uploadItem
    if(!r.ok){
      const {mime,base64}=splitDataUrl(dataUrl);
      r=await fetch(base+'/upload-image',{
        method:'POST',
        mode:'cors',
        headers:hdr(),
        body:JSON.stringify({sku:'ping',path,file:base64,mime})
      });
      text=await r.text().catch(()=>'' );
    }

    if(!r.ok){
      log(`[TEST UPLOAD] FAIL ${r.status} ‚Äî ${text.slice(0,180)}`);
      toast("Test upload FAIL "+r.status,"err");
      return;
    }

    log(`[TEST UPLOAD] OK ${r.status} ‚Äî ${text.slice(0,180)}`);
    toast("Test upload OK","ok");
  }catch(e){
    log("[TEST UPLOAD] L·ªói: "+e.message);
    toast("Test upload l·ªói.","err");
  }
};

/* IMAGE OPTIONS + HELPERS */
function getSelectedFolder(){
  const sel=$("#defaultFolder").value;
  if(sel==='custom'){
    const p=$("#defaultCustomPath").value.trim()||'/assets/img/';
    return sanitizeFolder(p);
  }
  return sanitizeFolder(sel);
}
function getSelectedFmt(){ return ($("#defaultFmt").value||'webp').toLowerCase(); }
function getExt(fmt){ return fmt==='jpg'?'jpg':(fmt==='png'?'png':'webp'); }
function ensureFolderBase(){
  const sel=$("#defaultFolder").value;
  if(sel==='custom'){
    $("#defaultCustomWrap").style.display='block';
    let p=$("#defaultCustomPath").value.trim();
    if(!p) $("#defaultCustomPath").value="/assets/img/";
  } else {
    $("#defaultCustomWrap").style.display='none';
  }
}
function updateSingleUploadCta(){
  const folder=getSelectedFolder();
  const sku=($("#sku").value.trim()||'<sku>');
  const ext=getExt(getSelectedFmt());
  $("#btnUploadImg").textContent=`Upload ·∫£nh ‚Üí ${folder}${slugify(sku)}.${ext}`;
}
["defaultFolder","defaultCustomPath","defaultFmt","sizePreset","optW","optH","quality","qualityNum","targetKB","targetKBNum"].forEach(id=>{
  const el=$("#"+id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    if(id==='quality') $("#qualityNum").value=$("#quality").value;
    if(id==='qualityNum') $("#quality").value=$("#qualityNum").value;
    if(id==='targetKB') $("#targetKBNum").value=$("#targetKB").value;
    if(id==='targetKBNum') $("#targetKB").value=$("#targetKBNum").value;
    saveSettings(); updateSingleUploadCta();
  });
});
$("#defaultFolder").addEventListener('change', ()=>{ ensureFolderBase(); updateSingleUploadCta(); saveSettings(); });

function getImageOpts(){
  const s=readSettings();
  let preset = $("#sizePreset").value || s.sizePreset || 'max';
  let w = Number($("#optW").value||1200);
  let h = Number($("#optH").value||1200);
  if(preset==='square1200'){ w=1200; h=1200; }
  if(preset==='icon400'){ w=400; h=400; }
  if(preset==='og'){ w=1200; h=630; }
  const fmt=getSelectedFmt();
  const q=Number($("#quality").value||0.82);
  const targetKB=Number($("#targetKBNum").value||0);
  return { preset, w, h, fmt, q, targetKB };
}
/* Resize with contain; pad if needed (jpg pads white, webp/png transparent) */
async function resizeContainToBlob(img, opts){
  let outW, outH, canvasW, canvasH;
  if(opts.preset==='max'){
    const maxSide = opts.w||1200;
    const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
    outW=Math.round(img.width*scale); outH=Math.round(img.height*scale);
    canvasW=outW; canvasH=outH;
  } else {
    canvasW=opts.w; canvasH=opts.h;
    const scale=Math.min(canvasW/img.width, canvasH/img.height);
    outW=Math.round(img.width*scale); outH=Math.round(img.height*scale);
  }
  const c=document.createElement('canvas'); c.width=canvasW; c.height=canvasH;
  const ctx=c.getContext('2d');
  if(opts.fmt==='jpg'){ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvasW,canvasH); }
  const dx=Math.round((canvasW-outW)/2), dy=Math.round((canvasH-outH)/2);
  ctx.drawImage(img,dx,dy,outW,outH);
  const mime = opts.fmt==='jpg'?'image/jpeg':(opts.fmt==='png'?'image/png':'image/webp');
  let q = opts.fmt==='png'?1.0:opts.q;
  let blob = await new Promise(res=>c.toBlob(res,mime,q));
  if(opts.targetKB>0 && blob && blob.size/1024>opts.targetKB && mime!=='image/png'){
    // auto-compress loop
    let step=0; while(blob.size/1024>opts.targetKB && q>0.4 && step<10){
      q = Math.max(0.4, q-0.06); step++;
      blob = await new Promise(res=>c.toBlob(res,mime,q));
      if(!blob) break;
    }
  }
  return { blob, w:canvasW, h:canvasH };
}

/* IMAGE single + batch */
const drop=$("#drop"), file=$("#file"), thumb=$("#thumb"), imgName=$("#imgName"), imgInfo=$("#imgInfo");
drop.addEventListener('click', ()=>file.click());
$("#btnSelectImg").onclick=()=>file.click();
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
file.onchange=e=>handleFiles(e.target.files);

function baseNameWithoutExt(filename){ const s=(filename||'').split('/').pop(); const i=s.lastIndexOf('.'); return (i>0?s.slice(0,i):s); }
function decideNameFor(file){
  const sku=$("#sku").value.trim();
  const useFilename=$("#cbUseFilename").checked;
  if(sku) return slugify(sku);
  if(useFilename && file && file.name) return slugify(baseNameWithoutExt(file.name));
  const nm=$("#name").value.trim();
  if(nm) return slugify(nm);
  return 'mxd';
}

async function handleFiles(files){
  if(!files || !files.length) return;
  if(files.length===1){ await handleSingleFile(files[0]); }
  else {
    for(const f of files){ await queueAddRawFile(f); }
    toast(`ƒê√£ th√™m ${files.length} ·∫£nh v√†o h√†ng ƒë·ª£i.`,'ok');
  }
}
function renderPreview(name, blob, w, h){
  state.imgBlob=blob; state.imgW=w; state.imgH=h;
  const ext=getExt(getSelectedFmt());
  state.imgName=`${name}.${ext}`;
  const folder=getSelectedFolder();
  if($("#sku").value.trim()){
    $("#image").value=`${folder}${slugify($("#sku").value.trim())}.${ext}`;
  } else {
    $("#image").value=`${folder}${name}.${ext}`;
  }
  $("#imgPreview").style.display='flex';
  thumb.src=URL.createObjectURL(blob);
  imgName.textContent=state.imgName;
  imgInfo.textContent=`${w}√ó${h}, ${(blob.size/1024).toFixed(1)} KB`;
  updateSingleUploadCta();
}
async function handleSingleFile(f){
  return new Promise(res=>{
    if(!f) return res();
    const reader=new FileReader();
    reader.onload=async ev=>{
      const img=new Image();
      img.onload=async ()=>{
        const base=decideNameFor(f);
        const opts=getImageOpts();
        const {blob,w,h} = await resizeContainToBlob(img, opts);
        renderPreview(base, blob, w, h);
        res();
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(f);
  });
}

const queue=[]; let seq=0;
function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

async function queueProcess(item){
  if(item.outBlob && item.w && item.h){ item.status='ready'; return; }
  if(!item.srcFile){ item.status='error'; return; }
  item.status='processing';
  const dataUrl=await readFileAsDataURL(item.srcFile);
  const img=document.createElement('img'); await new Promise(r=>{ img.onload=r; img.src=dataUrl; });
  const g=getImageOpts();
  const opts={ preset:g.preset, w:g.w, h:g.h, fmt:item.fmt||g.fmt||'webp', q:g.q, targetKB:g.targetKB };
  const out = await resizeContainToBlob(img, opts);
  item.outBlob=out.blob; item.w=out.w; item.h=out.h; item.status='ready';
}
async function queueAddRawFile(file){
  const name=decideNameFor(file);
  const fmt=getSelectedFmt();
  let folder=getSelectedFolder();
  const item={ id:(++seq), srcFile:file, name, fmt, folder, customPath:$("#defaultFolder").value==='custom', outBlob:null, w:0, h:0, status:'pending' };
  queue.push(item);
  await queueProcess(item);
  renderQueue();
}
async function queueAddCurrent(){
  if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh xem tr∆∞·ªõc.","warn"); return; }
  const fmt=getSelectedFmt();
  let folder=getSelectedFolder();
  const base=(state.imgName||'mxd.webp').replace(/\.(webp|png|jpg)$/,'');
  const item={ id:(++seq), srcFile:null, name:base, fmt, folder, customPath:$("#defaultFolder").value==='custom', outBlob:state.imgBlob, w:state.imgW, h:state.imgH, status:'ready' };
  queue.push(item);
  renderQueue();
  toast("ƒê√£ th√™m v√†o h√†ng ƒë·ª£i.","ok");
}
$("#btnQueueCurrent").onclick=queueAddCurrent;

function pathFor(it){
  let base=sanitizeFolder(it.folder||'/assets/img/');
  const ext='.'+getExt(it.fmt||'webp');
  return base+it.name+ext;
}

function renderQueue(){
  const tbody=$("#queueBody");
  if(!queue.length){
    tbody.innerHTML='<tr><td colspan="8" class="muted">Ch∆∞a c√≥ g√¨ trong h√†ng ƒë·ª£i.</td></tr>';
    return;
  }
  tbody.innerHTML=queue.map(it=>{
    const url=it.outBlob?URL.createObjectURL(it.outBlob):'';
    const status=it.status==='ready'?'S·∫µn s√†ng':(it.status==='processing'?'ƒêang x·ª≠ l√Ω':(it.status==='uploaded'?'ƒê√£ upload':(it.status==='error'?'L·ªói':'Ch·ªù')));
    return `<tr data-id="${it.id}">
  <td><div class="mini">${ url ? `<img class="thumb" src="${url}" alt="thumb">` : '' }</div></td>
  <td><input class="name" value="${it.name}"/></td>
  <td>
    <select class="folder">
      <option value="/assets/img/products/" ${it.folder==="/assets/img/products/"?'selected':''}>/assets/img/products/</option>
      <option value="/assets/img/categories/" ${it.folder==="/assets/img/categories/"?'selected':''}>/assets/img/categories/</option>
      <option value="/assets/img/og/" ${it.folder==="/assets/img/og/"?'selected':''}>/assets/img/og/</option>
      <option value="/assets/img/brands/" ${it.folder==="/assets/img/brands/"?'selected':''}>/assets/img/brands/</option>
      <option value="custom" ${it.customPath?'selected':''}>T·ª± nh·∫≠p‚Ä¶</option>
    </select>
    <input class="customPath" placeholder="/assets/img/blog/2025/" style="margin-top:6px;display:${it.customPath?'block':'none'}" value="${it.customPath?it.folder:''}"/>
  </td>
  <td>
    <select class="fmt">
      <option value="webp" ${it.fmt==='webp'?'selected':''}>webp</option>
      <option value="png" ${it.fmt==='png'?'selected':''}>png</option>
      <option value="jpg" ${it.fmt==='jpg'?'selected':''}>jpg</option>
    </select>
  </td>
  <td class="nowrap">${pathFor(it)}</td>
  <td>${it.w||'‚Äì'}√ó${it.h||'‚Äì'}<div class="small muted">${it.outBlob? (it.outBlob.size/1024|0)+' KB':''}</div></td>
  <td class="status">${status}</td>
  <td class="controls">
    <button class="btn sm do-convert">Convert</button>
    <button class="btn sm do-download">T·∫£i</button>
    <button class="btn sm do-upload">Upload</button>
    <button class="btn sm do-remove">Xo√°</button>
  </td>
</tr>`;
  }).join('');
  tbody.querySelectorAll('tr').forEach(tr=>{
    const id=Number(tr.getAttribute('data-id'));
    const it=queue.find(x=>x.id===id);
    const nameInput=tr.querySelector('.name');
    const folderSel=tr.querySelector('.folder');
    const customInput=tr.querySelector('.customPath');
    const fmtSel=tr.querySelector('.fmt');
    const pathCell=tr.children[4];
    const statusEl=tr.querySelector('.status');
    nameInput.oninput=()=>{ it.name=slugify(nameInput.value||'mxd'); pathCell.textContent=pathFor(it); };
    folderSel.onchange=()=>{
      if(folderSel.value==='custom'){
        it.customPath=true;
        customInput.style.display='block';
        if(customInput.value.trim()==='') customInput.value='/assets/img/';
        it.folder=sanitizeFolder(customInput.value.trim());
      } else {
        it.customPath=false;
        customInput.style.display='none';
        it.folder=folderSel.value;
      }
      pathCell.textContent=pathFor(it);
    };
    customInput.oninput=()=>{ it.folder=sanitizeFolder(customInput.value.trim()); pathCell.textContent=pathFor(it); };
    fmtSel.onchange=async()=>{
      it.fmt=fmtSel.value;
      pathCell.textContent=pathFor(it);
      await queueProcess(it);
      statusEl.textContent='S·∫µn s√†ng';
      renderQueue();
    };
    tr.querySelector('.do-remove').onclick=()=>{
      const idx=queue.findIndex(x=>x.id===id);
      if(idx>=0){ queue.splice(idx,1); renderQueue(); }
    };
    tr.querySelector('.do-convert').onclick=async()=>{
      statusEl.textContent='ƒêang x·ª≠ l√Ω';
      await queueProcess(it);
      statusEl.textContent='S·∫µn s√†ng';
      renderQueue();
    };
    tr.querySelector('.do-download').onclick=()=>{
      if(!it.outBlob){ toast("Ch∆∞a convert.","warn"); return; }
      const a=document.createElement('a');
      a.href=URL.createObjectURL(it.outBlob);
      a.download=it.name+'.'+getExt(it.fmt||'webp');
      a.click();
    };
    tr.querySelector('.do-upload').onclick=()=>uploadItem(it, statusEl);
  });
}
$("#btnClearQueue").onclick=()=>{ queue.length=0; renderQueue(); };
$("#btnConvertAll").onclick=async()=>{
  for(const it of queue){ await queueProcess(it); }
  toast("ƒê√£ convert t·∫•t c·∫£.","ok");
  renderQueue();
};
$("#btnDownloadAll").onclick=()=>{
  for(const it of queue){
    if(!it.outBlob) continue;
    const a=document.createElement('a');
    a.href=URL.createObjectURL(it.outBlob);
    a.download=it.name+'.'+getExt(it.fmt||'webp');
    a.click();
  }
};
$("#btnUploadAll").onclick=async()=>{
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  for(const it of queue){
    const row=document.querySelector(`tr[data-id="${it.id}"] .status`);
    await uploadItem(it,row);
  }
  toast("Upload t·∫•t c·∫£ xong (xem tr·∫°ng th√°i t·ª´ng m·ª•c).","ok");
};

/* UPLOAD */
function splitDataUrl(d){
  const m = String(d||'').match(/^data:([^;]+);base64,(.+)$/);
  return m ? { mime:m[1], base64:m[2] } : { mime:'', base64:d||'' };
}
async function blobToBase64(blob){
  return new Promise(res=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.readAsDataURL(blob);
  });
}
async function convertBlobToWebp(blob, w, h){
  const url=URL.createObjectURL(blob);
  const img=new Image(); await new Promise(r=>{ img.onload=r; img.src=url; });
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  c.getContext('2d').drawImage(img,0,0,w,h);
  return await new Promise(res=>c.toBlob(res,'image/webp',0.82));
}
async function uploadItem(it, statusEl){
  let path=pathFor(it);
  try{
    if(!it.outBlob){
      statusEl.textContent='ƒêang x·ª≠ l√Ω';
      await queueProcess(it);
    }
    const s=readSettings();
    if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    const base=s.workerUrl.replace(/\/$/,'');
    const dataUrl=await blobToBase64(it.outBlob);
    statusEl.textContent='Uploading‚Ä¶';
    let r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ sku:it.name, path, file:dataUrl })});
    let text=await r.text().catch(()=>'');

    if(!r.ok){
      log(`[upload ${path}] FAIL ${r.status}. Th·ª≠ pure base64‚Ä¶ ‚Äî ${text.slice(0,140)}`);
      const {mime, base64} = splitDataUrl(dataUrl);
      r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ sku:it.name, path, file:base64, mime })});
      text=await r.text().catch(()=>'' );
    }

    if(!r.ok && it.fmt!=='webp'){
      log(`[upload ${path}] FAIL n·ªØa. Fallback WebP‚Ä¶`);
      const webpBlob=await convertBlobToWebp(it.outBlob, it.w||1200, it.h||1200);
      const newDataUrl=await blobToBase64(webpBlob);
      const newPath=path.replace(/\.(png|jpg)$/i,'.webp');
      r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ sku:it.name, path:newPath, file:newDataUrl })});
      text=await r.text().catch(()=>'' );
      if(r.ok){ it.fmt='webp'; it.outBlob=webpBlob; path=newPath; }
    }

    if(!r.ok){
      statusEl.textContent='L·ªói upload';
      log(`[upload ${path}] FAIL cu·ªëi ${r.status}: ${text.slice(0,200)}`);
      toast("Upload l·ªói "+r.status,"err");
      return;
    }

    statusEl.textContent='ƒê√£ upload';
    it.status='uploaded';
    log(`[upload ${path}] OK`);
    const sku=$("#sku").value.trim();
    if(sku && it.name===slugify(sku)) $("#image").value=path;
  }catch(e){
    statusEl.textContent='L·ªói upload';
    log(`[upload ${path}] EXC: ${e.message}`);
    toast("Upload l·ªói: "+e.message,"err");
  }
}

/* SINGLE buttons */
$("#btnConvert").onclick=()=>{
  if(!state.imgBlob){ toast("Ch·ªçn ·∫£nh tr∆∞·ªõc.","warn"); return; }
  toast("ƒê√£ convert theo tu·ª≥ ch·ªçn.","ok");
};
$("#btnSaveImg").onclick=()=>{
  if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh.","warn"); return; }
  const a=document.createElement('a');
  a.href=URL.createObjectURL(state.imgBlob);
  a.download=state.imgName||('product.'+getExt(getSelectedFmt()));
  a.click();
};
$("#btnUploadImg").onclick=async()=>{
  if(!state.imgBlob){ toast("Ch∆∞a c√≥ ·∫£nh.","warn"); return; }
  const s=readSettings();
  if(!s.workerUrl){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
  const base=s.workerUrl.replace(/\/$/,'');
  const sku=($("#sku").value.trim()||'mxd');
  const folder=getSelectedFolder();
  const ext=getExt(getSelectedFmt());
  const path=`${folder}${slugify(sku)}.${ext}`;
  const dataUrl=await blobToBase64(state.imgBlob);
  try{
    let r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ sku:slugify(sku), path, file:dataUrl })});
    let text=await r.text().catch(()=>'');

    if(!r.ok){
      const {mime, base64} = splitDataUrl(dataUrl);
      r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ sku:slugify(sku), path, file:base64, mime })});
      text=await r.text().catch(()=>'' );
    }
    log(`[single upload ${path}] ${r.status} ${r.ok?'OK':'FAIL'} ‚Äî ${text.slice(0,160)}`);
    toast(r.ok?"ƒê√£ upload ·∫£nh l√™n repo.":"Upload ·∫£nh l·ªói "+r.status, r.ok?"ok":"err");
    if(r.ok) $("#image").value=path;
  }catch(e){
    log("[single upload] EXC: "+e.message);
    toast("Upload ·∫£nh l·ªói: "+e.message,"err");
  }
};

/* PRODUCT form helpers */
function runDiag(){
  const sku=$("#sku").value.trim();
  const img=$("#image").value.trim();
  const origin=cleanUrl($("#origin").value.trim());
  const merchant=$("#merchant").value;
  const expectedFolder=getSelectedFolder();
  const ext=getExt(getSelectedFmt());
  const msgs=[];
  if(!sku) msgs.push("‚Ä¢ Thi·∫øu SKU (b·∫Øt bu·ªôc cho publish).");
  if(img && !img.startsWith(`${expectedFolder}${sku||'...'}`)) msgs.push("‚Ä¢ ·∫¢nh n√™n l√† "+expectedFolder+(sku||'&lt;sku&gt;')+"."+ext);
  if(origin && !/shopee\.vn|lazada\.vn|tiki\.vn|tiktok\.com/i.test(origin)) msgs.push("‚Ä¢ Origin kh√¥ng ph·∫£i Shopee/Lazada/Tiki/TikTok.");
  msgs.push("‚Ä¢ Merchant: "+merchant);
  $("#diag").innerHTML=msgs.length?msgs.map(x=>`<div>${x}</div>`).join(""):'<span class="ok">T·∫°m ·ªïn.</span>';
  $("#originOut").value=origin;
}
$("#btnAuto").onclick=()=>{
  const name=$("#name").value.trim();
  const skuNow=$("#sku").value.trim();
  if(name && !skuNow) $("#sku").value=slugify(name);
  const folder=getSelectedFolder();
  const baseSku=$("#sku").value.trim()||'...';
  if($("#sku").value && !$("#image").value) $("#image").value=`${folder}${slugify(baseSku)}.`+getExt(getSelectedFmt());
  $("#originOut").value=cleanUrl($("#origin").value.trim());
  const g=autoCategory(`${name} ${$("#brand").value} ${$("#origin").value}`);
  if(g && !$("#category").value.trim()) $("#category").value=g;
  runDiag();
  updateSingleUploadCta();
};
["name","sku","origin","image","merchant"].forEach(id=>$("#"+id).addEventListener('input', ()=>{ runDiag(); if(id==='sku') updateSingleUploadCta(); }));

/* CLEAR ALL */
$("#btnClearAllFields").onclick=()=>{
  const sels=['#name','#sku','#price','#origin','#image','#category','#brand','#deeplink','#commitMsg'];
  for(const sel of sels){
    const el=document.querySelector(sel);
    if(el){ el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); }
  }
  $("#featured").checked=false;
  $("#status").checked=true;
  $("#merchant").value='shopee';
  $("#diag").innerHTML='';
  toast("ƒê√£ xo√° to√†n b·ªô th√¥ng tin s·∫£n ph·∫©m.","ok");
};

/* CLEAR buttons auto-attach */
function installClearers(){
  const sels=['#name','#sku','#price','#origin','#image','#category','#brand','#deeplink'];
  for(const sel of sels){
    const el=document.querySelector(sel); if(!el) continue;
    if(el.parentElement && el.parentElement.classList.contains('input-wrap')){
      if(!el.parentElement.querySelector('.clear-btn')) addClearButton(el.parentElement, el);
      continue;
    }
    const wrap=document.createElement('div'); wrap.className='input-wrap'+(el.tagName==='TEXTAREA'?' textarea':'');
    el.parentNode.insertBefore(wrap,el); wrap.appendChild(el); addClearButton(wrap, el);
  }
}
function addClearButton(wrap, el){
  const b=document.createElement('button'); b.type='button'; b.className='clear-btn'; b.title='Xo√°'; b.setAttribute('aria-label','Xo√°'); b.textContent='√ó';
  b.onclick=(e)=>{ e.preventDefault(); el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); el.focus(); };
  wrap.appendChild(b);
}
installClearers();

/* DEEPLINK */
function activeTplFor(merchant){
  const s=readSettings();
  const map={ shopee:s.tplShopee, lazada:s.tplLazada, tiki:s.tplTiki, tiktok:s.tplTiktok };
  let raw=(map[merchant]||'').trim();
  if(raw) return raw;
  if(merchant==='shopee') return DEFAULT_TPL_SHOPEE;
  if(merchant==='lazada') return DEFAULT_TPL_LAZADA;
  if(merchant==='tiki')   return DEFAULT_TPL_TIKI;
  if(merchant==='tiktok') return DEFAULT_TPL_TIKTOK;
  return DEFAULT_TPL_SHOPEE;
}
function makeDeeplink(){
  const origin=cleanUrl($("#origin").value.trim());
  const sku=$("#sku").value.trim();
  const merchant=$("#merchant").value;
  if(!origin){ toast("Thi·∫øu Origin.","warn"); return; }
  const tpl=activeTplFor(merchant);
  const subs=computeSubs(sku,merchant);
  let link=tpl
    .replace(/\{url\}/g,encodeURIComponent(origin))
    .replace(/\{sku\}/g,sku||'sku')
    .replace(/\{sub1\}/g,subs.sub1)
    .replace(/\{sub2\}/g,subs.sub2)
    .replace(/\{sub3\}/g,subs.sub3)
    .replace(/\{sub4\}/g,subs.sub4);
  link=ensureSubsInUrl(link,subs);
  $("#deeplink").value=link;
  validateDeeplink();
}
$("#btnMakeDeeplink").onclick=makeDeeplink;
["origin","sku","merchant","tplShopee","tplLazada","tplTiki","tplTiktok","defaultFolder","defaultCustomPath"].forEach(id=>{
  const el=$("#"+id);
  if(el) el.addEventListener('input', ()=>{
    if($("#origin").value.trim()) makeDeeplink();
    updateSingleUploadCta();
    runDiag();
    saveSettings();
  });
});
$("#deeplink").addEventListener('input', validateDeeplink);
function validateDeeplink(){
  const dl=$("#deeplink").value.trim();
  const badge=$("#dlCheck");
  if(!dl){ badge.textContent="ch∆∞a c√≥ deeplink"; badge.className='badge'; return; }
  const okHost=/(^https?:\/\/)?([^/]*\.)?isclix\.com/i.test(dl);
  const hasUrl=/[?&]url=/.test(dl);
  const s1=/[?&]sub1=/.test(dl), s2=/[?&]sub2=/.test(dl), s3=/[?&]sub3=/.test(dl), s4=/[?&]sub4=/.test(dl);
  if(okHost && hasUrl && s1 && s2 && s3 && s4){ badge.textContent="OK affiliate"; badge.className='badge'; return; }
  if(okHost && !hasUrl){ badge.textContent="isclix thi·∫øu url="; badge.className='badge'; return; }
  if(okHost){
    const missing=['sub1','sub2','sub3','sub4'].filter(k=>!new RegExp(`[?&]${k}=`).test(dl));
    badge.textContent="isclix thi·∫øu: "+missing.join(', ');
    badge.className='badge';
    return;
  }
  badge.textContent="KH√îNG qua affiliate";
  badge.className='badge';
}
$("#copyOrigin").onclick=()=>{ const t=$("#originOut"); t.select(); document.execCommand('copy'); toast("ƒê√£ copy Origin.","ok"); };
$("#openOrigin").onclick=()=>{ const u=$("#originOut").value.trim()||$("#origin").value.trim(); if(u){ window.open(u,'_blank'); } else { toast("Ch∆∞a c√≥ Origin.","warn"); } };
$("#copyDeeplink").onclick=()=>{ const t=$("#deeplink"); t.select(); document.execCommand('copy'); toast("ƒê√£ copy Deep-link."); };
$("#btnOpenDeeplink").onclick=()=>{ const u=$("#deeplink").value.trim(); if(u){ window.open(u,'_blank'); } else { toast("Ch∆∞a c√≥ Deep-link.","warn"); } };

/* VERIFY + JSON + PUBLISH (gi·ªØ nguy√™n) */
$("#btnVerify").onclick=async()=>{
  const sku=$("#sku").value.trim();
  if(!sku){ toast("Ch∆∞a c√≥ SKU ƒë·ªÉ ki·ªÉm tra.","warn"); return; }
  try{
    const r=await fetch('/affiliates.json?_='+Date.now(),{cache:'no-cache'});
    const arr=await r.json();
    const found=(Array.isArray(arr)?arr:(arr.items||[])).some(x=>(String(x.sku||'').toLowerCase())===sku.toLowerCase());
    toast(found?"ƒê√É C√ì trong affiliates.json.":"CH∆ØA TH·∫§Y trong affiliates.json.", found?"ok":"warn");
  }catch(e){
    toast("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c affiliates.json: "+e.message, "err");
  }
  const url=`/store.html?dev=1&sku=${encodeURIComponent(sku)}&v=${Date.now()}`;
  window.open(url,'_blank');
};
function buildJson(){
  if(!$("#category").value.trim()){
    const text=`${$("#name").value} ${$("#brand").value} ${$("#origin").value}`;
    const guess=autoCategory(text);
    if(guess) $("#category").value=guess;
  }
  $("#category").value=normCategory($("#category").value);
  const now=new Date().toISOString();
  const obj={
    name:$("#name").value.trim(),
    price:Number($("#price").value||0),
    origin:cleanUrl($("#origin").value.trim()),
    merchant:$("#merchant").value,
    sku:$("#sku").value.trim(),
    image:$("#image").value.trim(),
    category:$("#category").value.trim(),
    brand:$("#brand").value.trim(),
    featured:$("#featured").checked,
    status:$("#status").checked,
    updated_at:now
  };
  const dl=$("#deeplink").value.trim();
  if(dl) obj.deeplink=dl;
  $("#jsonOut").value=JSON.stringify([obj],null,2);
  return obj;
}
$("#btnToJson").onclick=buildJson;
$("#btnCopyJson").onclick=()=>{ $("#jsonOut").select(); document.execCommand('copy'); toast("ƒê√£ copy JSON."); };
$("#btnDownloadJson").onclick=()=>{
  if(!$("#jsonOut").value) buildJson();
  const blob=new Blob([$("#jsonOut").value],{type:"application/json"});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='affiliates.append.json';
  a.click();
};

$("#btnPublish").onclick=()=>doPublish(false);
$("#btnPublishFeatured").onclick=()=>doPublish(true);
async function doPublish(forceFeatured){
  const obj=buildJson();
  if(forceFeatured){
    obj.featured=true;
    $("#featured").checked=true;
    $("#jsonOut").value=JSON.stringify([obj],null,2);
  }
  if(!obj.sku){ toast("Thi·∫øu SKU.","err"); return; }
  if(!obj.origin){ toast("Thi·∫øu origin.","warn"); return; }
  if(!$("#deeplink").value.trim()){
    const maybe=activeTplFor($("#merchant").value);
    if(maybe){
      makeDeeplink();
      const dl=$("#deeplink").value.trim();
      if(dl){ obj.deeplink=dl; $("#jsonOut").value=JSON.stringify([obj],null,2); }
    }
  }
  const s=readSettings();
  if(s.workerUrl){
    try{
      const r=await fetch(s.workerUrl.replace(/\/$/,'')+"/publish",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify(obj)});
      const text=await r.text().catch(()=>'' );
      log(`[publish ${obj.sku}] ${r.status} ${r.ok?'OK':'FAIL'} ‚Äî ${text.slice(0,200)}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      toast("Publish OK ‚Üí store"+(obj.featured?" + n·ªïi b·∫≠t":""),"ok");
      window.scrollTo({top:0,behavior:'smooth'});
      return;
    }catch(e){
      toast("Publish l·ªói (s·∫Ω t·∫£i JSON ƒë·ªÉ commit tay): "+e.message,"err");
    }
  }
  const blob=new Blob([JSON.stringify([obj],null,2)],{type:"application/json"});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='affiliates.append.json';
  a.click();
}

/* INIT */
function updateOriginMirror(){ $("#originOut").value=cleanUrl($("#origin").value); }
$("#origin").addEventListener('input', updateOriginMirror);
updateToastOffset();
updateOriginMirror();
runDiag();
updateSingleUploadCta();
</script>
<script defer src="/tools/mxd-soi-addon.js?v=2.4.3"></script>
</body>
</html>
