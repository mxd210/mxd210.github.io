<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MXD Importer v4.5.0</title>
<meta name="robots" content="noindex,follow"/>
<style>
:root{
  --bg:#0b0f14; --fg:#e8f0fb; --muted:#a7b4c2; --b:#223043; --accent:#7cc4ff;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --card:#121821; --card2:#0f1520;
  --input:#121a28; --chip:#0b1220;
}
* { box-sizing: border-box; }
html, body { height:100%; }
body { margin:0; background:var(--bg); color:var(--fg); font:14px/1.5 system-ui, Segoe UI, Roboto; }
header { position:sticky; top:0; z-index:10; background:linear-gradient(180deg, var(--bg), rgba(11,15,20,0.85)); border-bottom:1px solid var(--b); }
header .wrap { display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:10px 14px; }
h1 { margin:0; font-size:18px; }
.badge { padding:2px 8px; border:1px solid var(--b); border-radius:999px; background:#162132; }
.small { font-size:12px; color:var(--muted); }
main { padding:14px; max-width:1440px; margin:auto; }
.panel { margin-bottom:16px; border:1px solid var(--b); border-radius:10px; background:var(--card); overflow:hidden; }
.panel h2 { margin:0; padding:10px 12px; background:var(--card2); border-bottom:1px solid var(--b); font-size:15px; }
.panel .body { padding:12px; }
.stack { display:flex; flex-direction:column; gap:8px; }
.row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center; }
.row > *:nth-child(3) { grid-column: span 2; }
.btn { display:inline-flex; align-items:center; gap:6px; background:#1a2330; border:1px solid var(--b); color:var(--fg); padding:8px 10px; border-radius:10px; cursor:pointer; user-select:none; }
.btn.primary { background:#12263f; border-color:#223a5e; color:#a7c8e8; }
.btn.ok { background:#0f2b17; border-color:#134e26; color:#aff5c4; }
.btn.warn { background:#3a2a08; border-color:#5f420c; color:#ffe1a3; }
.btn.bad { background:#3f0e0e; border-color:#7a1f1f; color:#ffb3b3; }
.btn:active { transform:scale(0.97); }
.btn[disabled] { opacity:0.5; pointer-events:none; }
table { width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed; }
th, td { border-bottom:1px solid var(--b); padding:6px 8px; vertical-align:top; }
th { position:sticky; top:0; background:var(--card2); z-index:1; text-align:left; }
th.sel, td.sel { width:36px; text-align:center; }
.w90 { width:90px; }
.w120 { width:120px; }
.w160 { width:160px; }
.w360 { width:360px; }
td img { max-height:50px; display:block; margin:0 auto; }
.missing { color: var(--bad); font-weight:bold; }
.out { min-height:120px; background:var(--chip); border:1px dashed var(--b); padding:8px; border-radius:10px; white-space:pre-wrap; word-break:break-word; }
#toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:8px 12px; border-radius:6px; font-size:13px; opacity:0; transition:opacity 0.3s; pointer-events:none; }
#toast.show { opacity:1; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>MXD Importer v4.5.0</h1>
    <span class="badge">drop-in / 1 file</span>
    <span class="badge">GA4 tr∆∞·ªõc Affiliate</span>
    <span style="margin-left:auto;"></span>
    <span id="cfgbadge" class="small">CFG: d√πng m·∫∑c ƒë·ªãnh</span>
    <button id="btnLang" class="badge">EN</button>
  </div>
</header>
<main>
  <section class="panel">
    <h2 id="sec1Title">Nh·∫≠p d·ªØ li·ªáu &amp; c·∫•u h√¨nh</h2>
    <div class="body stack">
      <label for="inputList" id="listLabel">D√°n danh s√°ch (m·ªói d√≤ng: <code>T√™n | gi√° | link</code> ho·∫∑c ch·ªâ <code>link</code>)</label>
      <textarea id="inputList" rows="5" placeholder="T√™n s·∫£n ph·∫©m | gi√° | link..."></textarea>
      <div class="small">D√≤ng hi·ªán c√≥: <span id="lineCount">0</span></div>
      <div class="row">
        <button class="btn primary" id="btnParse">1) Parse</button>
        <button class="btn" id="btnSample">D√°n v√≠ d·ª•</button>
      </div>
      <div class="row">
        <div id="dropZone" class="dropzone"></div>
      </div>
      <div class="row">
        <input id="category" type="text" placeholder="Slug danh m·ª•c" required>
      </div>
      <div class="row">
        <input id="singleName" type="text" placeholder="T√™n s·∫£n ph·∫©m">
      </div>
      <div class="row">
        <input id="singlePrice" type="number" placeholder="Gi√° (VND)">
        <input id="singleBrand" type="text" placeholder="Brand (t√πy ch·ªçn)">
      </div>
      <div class="row">
        <input id="singleLink" type="url" placeholder="Link g·ªëc s·∫£n ph·∫©m">
      </div>
      <div class="row">
        <select id="singleStatus">
          <option value="active">active</option>
          <option value="draft">draft</option>
          <option value="archived">archived</option>
        </select>
        <button class="btn" id="btnAddSingle">Th√™m s·∫£n ph·∫©m</button>
      </div>
      <div class="row">
        <input id="tplShopee" type="url" placeholder="Template Shopee (d√πng {url},{sub1..4})">
      </div>
      <div class="row">
        <input id="tplLazada" type="url" placeholder="Template Lazada">
      </div>
      <div class="row">
        <button class="btn" id="btnSaveCfg">L∆∞u c·∫•u h√¨nh</button>
        <button class="btn" id="btnResetCfg">X√≥a c·∫•u h√¨nh</button>
      </div>
    </div>
  </section>
  <section class="panel">
    <h2 id="sec2Title">2) B·∫£ng d·ªØ li·ªáu</h2>
    <div class="body stack">
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th class="sel"><input type="checkbox" id="selAll"></th>
              <th>#</th>
              <th class="w160">T√™n</th>
              <th class="w90">Gi√°</th>
              <th class="w120">Merchant</th>
              <th class="w120">Brand</th>
              <th class="w120">SKU</th>
              <th class="w160">·∫¢nh</th>
              <th class="w360">Link g·ªëc</th>
              <th class="w360">Deep link</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="tip" class="small">M·∫πo: s·ª≠a nhanh b·∫±ng Tab/Enter. SKU lowercase-kebab. Ch·ªçn d√≤ng (checkbox) ƒë·ªÉ ƒë·∫©y SELECT.</div>
      <div id="kpi" class="small"></div>
      <div class="row">
        <button class="btn bad" id="btnDelete">X√≥a SELECT</button>
      </div>
    </div>
  </section>
  <section class="panel">
    <h2 id="sec3Title">3) Health-check &amp; Xu·∫•t JSON</h2>
    <div class="body stack">
      <div class="row">
        <button class="btn ok" id="btnHealth">Ch·∫°y ki·ªÉm tra</button>
        <button class="btn" id="btnFixSku">S·ª≠a SKU l·ªói</button>
      </div>
      <div class="out" id="outHealth"></div>
      <div class="row">
        <button class="btn primary" id="btnJson">T·∫°o JSON</button>
        <button class="btn" id="btnSnippet">T·∫°o Snippet</button>
        <button class="btn" id="btnDownload">T·∫£i xu·ªëng</button>
        <button class="btn" id="btnCopy">Copy</button>
      </div>
      <div class="out" id="outJson"></div>
    </div>
  </section>
  <section class="panel">
    <h2 id="sec4Title">4) Worker t√≠ch h·ª£p ‚Äî h√†ng ƒë·ª£i &amp; xu·∫•t b·∫£n</h2>
    <div class="body stack">
      <div class="row">
        <input id="workerUrl" type="url" placeholder="Worker URL">
        <input id="workerKey" type="text" placeholder="X-Key (SECRET_KEY/ADMIN_KEY)">
      </div>
      <div class="row">
        <button class="btn" id="btnHealthW">Ki·ªÉm tra Worker</button>
        <button class="btn" id="btnDiag">Ch·∫©n ƒëo√°n</button>
        <button class="btn" id="btnStatus">Status</button>
      </div>
      <div class="row">
        <button class="btn" id="btnPushStoreSel">ƒê·∫©y SELECT ‚Üí Store</button>
        <button class="btn warn" id="btnPushFeaturedSel">ƒê·∫©y SELECT ‚Üí N·ªïi b·∫≠t</button>
      </div>
      <div class="row">
        <button class="btn" id="btnPushStoreAll">ƒê·∫©y T·∫§T C·∫¢ ‚Üí Store</button>
        <button class="btn warn" id="btnPushFeaturedAll">ƒê·∫©y T·∫§T C·∫¢ ‚Üí N·ªïi b·∫≠t</button>
      </div>
      <div class="row">
        <button class="btn" id="btnPublishStore">Publish ngay ‚Üí Store</button>
        <button class="btn warn" id="btnPublishFeatured">Publish ngay ‚Üí N·ªïi b·∫≠t</button>
      </div>
      <div class="row">
        <textarea id="commitMsg" rows="2" placeholder="commit message (vd: feat(data): add 3 products (category: may-cat))"></textarea>
        <button class="btn" id="btnGenMsg">T·∫°o message</button>
      </div>
      <div class="row">
        <label><input type="checkbox" id="autoPublish"> T·ª± ƒë·ªông Publish sau khi ƒê·∫©y</label>
      </div>
      <div class="out" id="outPublish"></div>
      <div class="small">/queue nh·∫≠n {channel,items}. /publish ph√°t h√†nh th·∫≥ng (POST JSON; n·∫øu 404/405 fallback GET ?channel=...).</div>
    </div>
  </section>
</main>
<div id="toast"></div>
<script>
(function(){
  'use strict';
  const $ = (s, el = document) => el.querySelector(s);
  const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));
  const toast = (msg) => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1500);
  };
  const el = (tag, attrs = {}) => {
    const element = document.createElement(tag);
    Object.assign(element, attrs);
    return element;
  };
  const defaults = {
    tplShopee: 'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
    tplLazada: 'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
    affId: '',
    sub1: '', sub2: '', sub3: 'store', sub4: 'oneatweb',
    workerUrl: '',
    workerKey: '',
    lang: 'vi'
  };
  const store = {
    key: 'mxd-importer-v450',
    load() {
      try {
        return JSON.parse(localStorage.getItem(this.key)) || {};
      } catch(e) {
        return {};
      }
    },
    save(cfg) {
      try {
        localStorage.setItem(this.key, JSON.stringify(cfg));
      } catch(e) {
        console.error('Cannot save to localStorage', e);
      }
    },
    clear() {
      localStorage.removeItem(this.key);
    }
  };
  const loadedCfg = store.load();
  let cfg = Object.assign({}, defaults, loadedCfg);
  // Apply loaded config to fields:
  if(cfg.tplShopee) $("#tplShopee").value = cfg.tplShopee;
  if(cfg.tplLazada) $("#tplLazada").value = cfg.tplLazada;
  if(cfg.workerUrl) $("#workerUrl").value = cfg.workerUrl;
  if(cfg.workerKey) $("#workerKey").value = cfg.workerKey;
  // Set initial config badge text
  if(Object.keys(loadedCfg).length) {
    $("#cfgbadge").textContent = (cfg.lang === 'en' ? 'CFG: loaded' : 'CFG: ƒë√£ t·∫£i');
  } else {
    $("#cfgbadge").textContent = (cfg.lang === 'en' ? 'CFG: default' : 'CFG: d√πng m·∫∑c ƒë·ªãnh');
  }
  // Language setup:
  let currentLang = cfg.lang || 'vi';
  const langText = {
    vi: {
      sec1Title: "Nh·∫≠p d·ªØ li·ªáu & c·∫•u h√¨nh",
      sec2Title: "2) B·∫£ng d·ªØ li·ªáu",
      sec3Title: "3) Health-check & Xu·∫•t JSON",
      sec4Title: "4) Worker t√≠ch h·ª£p ‚Äî h√†ng ƒë·ª£i & xu·∫•t b·∫£n",
      listLabel: "D√°n danh s√°ch (m·ªói d√≤ng: T√™n | gi√° | link ho·∫∑c ch·ªâ link)",
      btnParse: "1) Parse",
      btnSample: "D√°n v√≠ d·ª•",
      dropZone: "üì¶ K√©o & th·∫£ ·∫£nh (.webp) ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn",
      categoryPlaceholder: "Slug danh m·ª•c",
      singleName: "T√™n s·∫£n ph·∫©m",
      singlePrice: "Gi√° (VND)",
      singleBrand: "Brand (t√πy ch·ªçn)",
      singleLink: "Link g·ªëc s·∫£n ph·∫©m",
      singleStatusOptions: {"active":"active","draft":"draft","archived":"archived"},
      btnAddSingle: "Th√™m s·∫£n ph·∫©m",
      tplShopee: "Template Shopee (d√πng {url},{sub1..4})",
      tplLazada: "Template Lazada",
      btnSaveCfg: "L∆∞u c·∫•u h√¨nh",
      btnResetCfg: "X√≥a c·∫•u h√¨nh",
      sec2Tip: "M·∫πo: s·ª≠a nhanh b·∫±ng Tab/Enter. SKU lowercase-kebab. Ch·ªçn d√≤ng (checkbox) ƒë·ªÉ ƒë·∫©y SELECT.",
      btnDelete: "X√≥a SELECT",
      btnHealth: "Ch·∫°y ki·ªÉm tra",
      btnFixSku: "S·ª≠a SKU l·ªói",
      btnJson: "T·∫°o JSON",
      btnSnippet: "T·∫°o Snippet",
      btnDownload: "T·∫£i xu·ªëng",
      btnCopy: "Copy",
      btnHealthW: "Ki·ªÉm tra Worker",
      btnDiag: "Ch·∫©n ƒëo√°n",
      btnStatus: "Status",
      btnPushStoreSel: "ƒê·∫©y SELECT ‚Üí Store",
      btnPushFeaturedSel: "ƒê·∫©y SELECT ‚Üí N·ªïi b·∫≠t",
      btnPushStoreAll: "ƒê·∫©y T·∫§T C·∫¢ ‚Üí Store",
      btnPushFeaturedAll: "ƒê·∫©y T·∫§T C·∫¢ ‚Üí N·ªïi b·∫≠t",
      btnPublishStore: "Publish ngay ‚Üí Store",
      btnPublishFeatured: "Publish ngay ‚Üí N·ªïi b·∫≠t",
      commitPlaceholder: "commit message (vd: feat(data): add 3 products (category: may-cat))",
      btnGenMsg: "T·∫°o message",
      autoPublishLabel: " T·ª± ƒë·ªông Publish sau khi ƒê·∫©y",
      cfgbadge_default: "CFG: d√πng m·∫∑c ƒë·ªãnh",
      cfgbadge_loaded: "CFG: ƒë√£ t·∫£i",
      toastSaved: "ƒê√£ l∆∞u c·∫•u h√¨nh",
      toastCleared: "ƒê√£ x√≥a c·∫•u h√¨nh"
    },
    en: {
      sec1Title: "Input data & config",
      sec2Title: "2) Data table",
      sec3Title: "3) Health-check & Export JSON",
      sec4Title: "4) Worker integration ‚Äî queue & publish",
      listLabel: "Paste list (each line: Name | price | link, or link only)",
      btnParse: "1) Parse",
      btnSample: "Paste example",
      dropZone: "üì¶ Drop product images (.webp) or click to select",
      categoryPlaceholder: "Category slug",
      singleName: "Product name",
      singlePrice: "Price (VND)",
      singleBrand: "Brand (optional)",
      singleLink: "Original product link",
      singleStatusOptions: {"active":"active","draft":"draft","archived":"archived"},
      btnAddSingle: "Add product",
      tplShopee: "Template Shopee (use {url},{sub1..4})",
      tplLazada: "Template Lazada",
      btnSaveCfg: "Save config",
      btnResetCfg: "Reset config",
      sec2Tip: "Tip: quick edit with Tab/Enter. SKU in lowercase-kebab. Select rows (checkbox) to push SELECT.",
      btnDelete: "Delete SELECT",
      btnHealth: "Run check",
      btnFixSku: "Fix SKU issues",
      btnJson: "Generate JSON",
      btnSnippet: "Generate Snippet",
      btnDownload: "Download",
      btnCopy: "Copy",
      btnHealthW: "Check Worker",
      btnDiag: "Diagnose",
      btnStatus: "Status",
      btnPushStoreSel: "Push SELECT ‚Üí Store",
      btnPushFeaturedSel: "Push SELECT ‚Üí Featured",
      btnPushStoreAll: "Push ALL ‚Üí Store",
      btnPushFeaturedAll: "Push ALL ‚Üí Featured",
      btnPublishStore: "Publish now ‚Üí Store",
      btnPublishFeatured: "Publish now ‚Üí Featured",
      commitPlaceholder: "commit message (e.g.: feat(data): add 3 products (category: may-cat))",
      btnGenMsg: "Generate message",
      autoPublishLabel: " Auto Publish after Push",
      cfgbadge_default: "CFG: default",
      cfgbadge_loaded: "CFG: loaded",
      toastSaved: "Config saved",
      toastCleared: "Config cleared"
    }
  };
  const applyLanguage = (lang) => {
    const t = langText[lang];
    $("#sec1Title").textContent = t.sec1Title;
    $("#sec2Title").textContent = t.sec2Title;
    $("#sec3Title").textContent = t.sec3Title;
    $("#sec4Title").textContent = t.sec4Title;
    $("#listLabel").textContent = t.listLabel;
    $("#btnParse").textContent = t.btnParse;
    $("#btnSample").textContent = t.btnSample;
    $("#dropZone").innerHTML = t.dropZone;
    $("#category").placeholder = t.categoryPlaceholder;
    $("#singleName").placeholder = t.singleName;
    $("#singlePrice").placeholder = t.singlePrice;
    $("#singleBrand").placeholder = t.singleBrand;
    $("#singleLink").placeholder = t.singleLink;
    const statusSelect = $("#singleStatus");
    statusSelect.options[0].textContent = t.singleStatusOptions["active"];
    statusSelect.options[1].textContent = t.singleStatusOptions["draft"];
    statusSelect.options[2].textContent = t.singleStatusOptions["archived"];
    $("#btnAddSingle").textContent = t.btnAddSingle;
    $("#tplShopee").placeholder = t.tplShopee;
    $("#tplLazada").placeholder = t.tplLazada;
    $("#btnSaveCfg").textContent = t.btnSaveCfg;
    $("#btnResetCfg").textContent = t.btnResetCfg;
    $("#tip").textContent = t.sec2Tip;
    $("#btnDelete").textContent = t.btnDelete;
    $("#btnHealth").textContent = t.btnHealth;
    $("#btnFixSku").textContent = t.btnFixSku;
    $("#btnJson").textContent = t.btnJson;
    $("#btnSnippet").textContent = t.btnSnippet;
    $("#btnDownload").textContent = t.btnDownload;
    $("#btnCopy").textContent = t.btnCopy;
    $("#btnHealthW").textContent = t.btnHealthW;
    $("#btnDiag").textContent = t.btnDiag;
    $("#btnStatus").textContent = t.btnStatus;
    $("#btnPushStoreSel").textContent = t.btnPushStoreSel;
    $("#btnPushFeaturedSel").textContent = t.btnPushFeaturedSel;
    $("#btnPushStoreAll").textContent = t.btnPushStoreAll;
    $("#btnPushFeaturedAll").textContent = t.btnPushFeaturedAll;
    $("#btnPublishStore").textContent = t.btnPublishStore;
    $("#btnPublishFeatured").textContent = t.btnPublishFeatured;
    $("#commitMsg").placeholder = t.commitPlaceholder;
    $("#btnGenMsg").textContent = t.btnGenMsg;
    $("#autoPublish").nextSibling.textContent = t.autoPublishLabel;
  };
  applyLanguage(currentLang);
  if(currentLang === 'en') {
    $("#btnLang").textContent = 'VI';
  }
  $("#btnLang").onclick = () => {
    const newLang = (currentLang === 'vi' ? 'en' : 'vi');
    applyLanguage(newLang);
    currentLang = newLang;
    cfg.lang = newLang;
    $("#btnLang").textContent = (newLang === 'vi' ? 'EN' : 'VI');
  };
  let data = [];
  const imagesSet = new Set();
  const imagePreviewMap = {};
  const slugify = (str) => {
    let x = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    x = x.replace(/ƒë/g, "d").replace(/ƒê/g, "D");
    return x.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
  };
  const detect = (url) => {
    try {
      const h = (new URL(url)).hostname;
      if(h.includes("shopee")) return "shopee";
      if(h.includes("lazada")) return "lazada";
      if(h.includes("tiki")) return "tiki";
    } catch(e) {}
    return "";
  };
  const guessNameFromUrl = (url) => {
    try {
      const u = new URL(url);
      let path = u.pathname;
      path = path.replace(/\.html.*/, "");
      const idx = path.indexOf("-i.");
      if(idx !== -1) {
        const slugPart = path.substring(1, idx);
        return decodeURIComponent(slugPart).replace(/-/g, " ");
      }
      const li = path.lastIndexOf("-i");
      if(li !== -1) {
        const slugPart = path.substring(path.lastIndexOf("/")+1, li);
        return decodeURIComponent(slugPart).replace(/-/g, " ");
      }
      const lastSeg = path.substring(path.lastIndexOf("/")+1);
      if(lastSeg) {
        return decodeURIComponent(lastSeg).replace(/-/g, " ");
      }
    } catch(e) {}
    return "";
  };
  const updateKpi = () => {
    const sum = data.reduce((a, b) => a + (Number(b.price) || 0), 0);
    const byM = data.reduce((m, r) => {
      const key = r.merchant || "auto";
      m[key] = (m[key] || 0) + 1;
      return m;
    }, {});
    const merchants = Object.entries(byM).map(([k, v]) => `${k}:${v}`).join(" ¬∑ ");
    const selCount = data.filter(r => r.selected).length;
    const prodLabel = currentLang === 'vi' ? 'H√†ng' : 'Items';
    const priceLabel = currentLang === 'vi' ? 'T·ªïng gi√°' : 'Total';
    const merchantLabel = currentLang === 'vi' ? 'Merchant' : 'Merchants';
    const selectedLabel = currentLang === 'vi' ? 'ƒê√£ ch·ªçn' : 'Selected';
    $("#kpi").innerHTML = `<span>${prodLabel}: <b>${data.length}</b></span><span>${priceLabel}: <b>${sum.toLocaleString("vi-VN")}</b></span><span>${merchantLabel}: ${merchants}</span><span>${selectedLabel}: <b id="selCount">${selCount}</b></span>`;
  };
  const renderTable = () => {
    const tbody = $("#tbody");
    tbody.textContent = "";
    data.forEach((r, i) => {
      const tr = el("tr");
      const tdSel = el("td");
      tdSel.className = "sel";
      const cb = el("input");
      cb.type = "checkbox";
      cb.checked = !!r.selected;
      cb.onclick = () => {
        r.selected = cb.checked;
        $("#selCount").textContent = data.filter(x => x.selected).length;
      };
      tdSel.appendChild(cb);
      tr.appendChild(tdSel);
      const tdNum = el("td");
      tdNum.textContent = i + 1;
      tr.appendChild(tdNum);
      const tdName = el("td");
      const inpName = el("input");
      inpName.value = r.name;
      inpName.onblur = () => {
        r.name = inpName.value.trim();
      };
      tdName.appendChild(inpName);
      tr.appendChild(tdName);
      const tdPrice = el("td");
      const inpPrice = el("input");
      inpPrice.type = "number";
      inpPrice.value = r.price ? r.price : "";
      inpPrice.onblur = () => {
        r.price = Number(inpPrice.value) || 0;
        updateKpi();
      };
      tdPrice.appendChild(inpPrice);
      tr.appendChild(tdPrice);
      const tdMerchant = el("td");
      tdMerchant.textContent = r.merchant || "";
      tr.appendChild(tdMerchant);
      const tdBrand = el("td");
      const inpBrand = el("input");
      inpBrand.value = r.brand || "";
      inpBrand.onblur = () => {
        r.brand = inpBrand.value.trim();
      };
      tdBrand.appendChild(inpBrand);
      tr.appendChild(tdBrand);
      const tdSku = el("td");
      const inpSku = el("input");
      inpSku.value = r.sku;
      inpSku.onblur = () => {
        const newSlug = slugify(inpSku.value);
        if(newSlug !== r.sku) {
          if(imagesSet.has(r.sku)) {
            const oldSku = r.sku;
            imagesSet.delete(oldSku);
            imagesSet.add(newSlug);
            imagePreviewMap[newSlug] = imagePreviewMap[oldSku];
            delete imagePreviewMap[oldSku];
          }
          r.sku = newSlug;
          r.image = `/assets/img/products/${newSlug}.webp`;
          inpSku.value = newSlug;
        }
      };
      tdSku.appendChild(inpSku);
      tr.appendChild(tdSku);
      const tdImg = el("td");
      if(imagesSet.has(r.sku) && imagePreviewMap[r.sku]) {
        const imgElem = el("img");
        imgElem.src = imagePreviewMap[r.sku];
        imgElem.alt = r.sku;
        tdImg.appendChild(imgElem);
      } else {
        tdImg.innerHTML = '<span class="missing">‚úò</span>';
      }
      tr.appendChild(tdImg);
      const tdOrigin = el("td");
      const inpOrigin = el("input");
      inpOrigin.value = r.origin;
      inpOrigin.onblur = () => {
        r.origin = inpOrigin.value.trim();
        const newMerc = detect(r.origin);
        r.merchant = newMerc || "";
        tdMerchant.textContent = r.merchant;
        r.deep = createDeepLink(r);
        inpDeep.value = r.deep || "";
      };
      tdOrigin.appendChild(inpOrigin);
      tr.appendChild(tdOrigin);
      const tdDeep = el("td");
      const inpDeep = el("input");
      inpDeep.value = r.deep || "";
      inpDeep.readOnly = true;
      tdDeep.appendChild(inpDeep);
      tr.appendChild(tdDeep);
      tbody.appendChild(tr);
    });
  };
  const createAffObject = (r) => {
    const nowVN = new Date().toLocaleString('sv-SE', { timeZone: 'Asia/Ho_Chi_Minh', hour12: false }).replace(' ', 'T');
    return {
      name: r.name.trim(),
      price: Number(r.price) || 0,
      origin: r.origin.trim(),
      merchant: r.merchant || "",
      sku: r.sku,
      image: `/assets/img/products/${r.sku}.webp`,
      category: r.category || $("#category").value.trim(),
      brand: r.brand || "",
      featured: !!r.featured,
      status: r.status || "active",
      updated_at: nowVN + "+07:00",
      sub1: r.sku,
      notes: r.notes || ""
    };
  };
  const createDeepLink = (r) => {
    if(!r.merchant) return "";
    const baseTpl = (r.merchant === "shopee" ? $("#tplShopee").value.trim() : (r.merchant === "lazada" ? $("#tplLazada").value.trim() : ""));
    if(!baseTpl) return "";
    const urlEnc = encodeURIComponent(r.origin);
    const sub1val = encodeURIComponent(r.sku);
    const sub2val = encodeURIComponent(cfg.sub2 || "");
    const sub3val = encodeURIComponent(cfg.sub3 || "");
    const sub4val = encodeURIComponent(cfg.sub4 || "");
    return baseTpl.replace("{url}", urlEnc).replace("{sub1}", sub1val).replace("{sub2}", sub2val).replace("{sub3}", sub3val).replace("{sub4}", sub4val);
  };
  $("#inputList").oninput = () => {
    const lines = $("#inputList").value.split(/\r?\n/).filter(line => line.trim());
    $("#lineCount").textContent = lines.length;
  };
  $("#btnSample").onclick = () => {
    const example = "S·∫£n ph·∫©m A | 199000 | https://shopee.vn/Example-Product-A-i.123456.654321\nS·∫£n ph·∫©m B | 299000 | https://www.lazada.vn/products/example-product-b-i123456789.html\nhttps://shopee.vn/Another-Product-i.111222.333444";
    $("#inputList").value = example;
    $("#lineCount").textContent = example.split(/\n/).length;
  };
  $("#btnParse").onclick = () => {
    const text = $("#inputList").value.trim();
    if(!text) return;
    const lines = text.split(/\r?\n/);
    lines.forEach(line => {
      if(!(line = line.trim())) return;
      let name = "", priceNum = "", link = "";
      if(line.includes("|")) {
        const parts = line.split("|").map(p => p.trim());
        if(parts.length >= 3) {
          name = parts[0];
          priceNum = parts[1].replace(/[^0-9]/g, "");
          link = parts[2];
        } else if(parts.length == 2) {
          name = parts[0];
          priceNum = "";
          link = parts[1];
        }
      } else {
        link = line;
      }
      const merchant = detect(link);
      let guessedName = "";
      if(name === "" && link) {
        guessedName = guessNameFromUrl(link);
        name = guessedName;
      }
      const skuBase = name ? slugify(name) : (guessedName ? slugify(guessedName) : "");
      let sku = skuBase;
      if(sku === "" && merchant) {
        if(merchant === "shopee" && link.includes("-i.")) {
          const idMatch = link.match(/-i\.\d+\.(\d+)/);
          if(idMatch) sku = "sp-" + idMatch[1];
        }
        if(merchant === "lazada" && link.includes("-i")) {
          const idMatch = link.match(/-i(\d+)/);
          if(idMatch) sku = "lz-" + idMatch[1];
        }
        if(!sku) {
          sku = "item-" + Math.random().toString(36).slice(2,8);
        }
      }
      let origSku = sku;
      let count = 2;
      while(data.some(item => item.sku === sku)) {
        sku = origSku + "-" + count++;
      }
      const prod = {
        name: name || "",
        price: priceNum ? Number(priceNum) : 0,
        origin: link || "",
        merchant: merchant || "",
        sku: sku,
        image: `/assets/img/products/${sku}.webp`,
        category: $("#category").value.trim(),
        brand: "",
        featured: false,
        status: "active",
        updated_at: "",
        sub1: "",
        notes: "",
        selected: false
      };
      prod.deep = createDeepLink(prod);
      data.push(prod);
    });
    $("#inputList").value = "";
    $("#lineCount").textContent = "0";
    renderTable();
    updateKpi();
    toast("ƒê√£ nh·∫≠p " + data.length + " s·∫£n ph·∫©m.");
  };
  $("#btnAddSingle").onclick = () => {
    const name = $("#singleName").value.trim();
    const priceStr = $("#singlePrice").value.trim().replace(/[^0-9]/g, "");
    const link = $("#singleLink").value.trim();
    if(!name || !link) {
      toast("Vui l√≤ng nh·∫≠p t√™n v√† link");
      return;
    }
    const merchant = detect(link);
    let skuBase = slugify(name);
    if(!skuBase) {
      skuBase = "item-" + Math.random().toString(36).slice(2,8);
    }
    let sku = skuBase;
    let count = 2;
    while(data.some(item => item.sku === sku)) {
      sku = skuBase + "-" + count++;
    }
    const prod = {
      name: name,
      price: priceStr ? Number(priceStr) : 0,
      origin: link,
      merchant: merchant || "",
      sku: sku,
      image: `/assets/img/products/${sku}.webp`,
      category: $("#category").value.trim(),
      brand: $("#singleBrand").value.trim() || "",
      featured: false,
      status: $("#singleStatus").value,
      updated_at: "",
      sub1: "",
      notes: "",
      selected: false
    };
    prod.deep = createDeepLink(prod);
    data.push(prod);
    $("#singleName").value = "";
    $("#singlePrice").value = "";
    $("#singleLink").value = "";
    $("#singleBrand").value = "";
    $("#singleStatus").value = "active";
    renderTable();
    updateKpi();
    toast("ƒê√£ th√™m s·∫£n ph·∫©m.");
  };
  $("#btnSaveCfg").onclick = () => {
    cfg.tplShopee = $("#tplShopee").value.trim();
    cfg.tplLazada = $("#tplLazada").value.trim();
    cfg.workerUrl = $("#workerUrl").value.trim();
    cfg.workerKey = $("#workerKey").value.trim();
    store.save(cfg);
    $("#cfgbadge").textContent = (currentLang === 'vi' ? "CFG: ƒë√£ l∆∞u " : "CFG: saved ") + new Date().toLocaleTimeString();
    toast(currentLang === 'vi' ? "ƒê√£ l∆∞u c·∫•u h√¨nh" : "Config saved");
  };
  $("#btnResetCfg").onclick = () => {
    store.clear();
    cfg = Object.assign({}, defaults);
    $("#tplShopee").value = cfg.tplShopee;
    $("#tplLazada").value = cfg.tplLazada;
    $("#workerUrl").value = cfg.workerUrl;
    $("#workerKey").value = cfg.workerKey;
    if(currentLang !== 'vi') {
      applyLanguage('vi');
      currentLang = 'vi';
      $("#btnLang").textContent = 'EN';
    }
    $("#cfgbadge").textContent = (currentLang === 'vi' ? "CFG: d√πng m·∫∑c ƒë·ªãnh" : "CFG: default");
    toast(currentLang === 'vi' ? "ƒê√£ x√≥a c·∫•u h√¨nh" : "Config cleared");
  };
  const fileInput = el("input");
  fileInput.type = "file";
  fileInput.accept = ".webp";
  fileInput.multiple = true;
  fileInput.style.display = "none";
  fileInput.onchange = () => {
    const files = Array.from(fileInput.files || []);
    files.forEach(file => {
      if(!file.name.toLowerCase().endsWith(".webp")) return;
      const sku = file.name.replace(/\.webp$/i, "").toLowerCase();
      if(!data.some(item => item.sku === sku)) {
        toast("·∫¢nh " + file.name + " kh√¥ng kh·ªõp SKU n√†o");
      } else {
        imagesSet.add(sku);
        const url = URL.createObjectURL(file);
        imagePreviewMap[sku] = url;
      }
    });
    renderTable();
  };
  document.body.appendChild(fileInput);
  $("#dropZone").onclick = () => fileInput.click();
  $("#dropZone").ondragover = (e) => {
    e.preventDefault();
    $("#dropZone").classList.add("hover");
  };
  $("#dropZone").ondragleave = (e) => {
    $("#dropZone").classList.remove("hover");
  };
  $("#dropZone").ondrop = (e) => {
    e.preventDefault();
    $("#dropZone").classList.remove("hover");
    const files = Array.from(e.dataTransfer.files || []);
    files.forEach(file => {
      if(!file.name.toLowerCase().endsWith(".webp")) return;
      const sku = file.name.replace(/\.webp$/i, "").toLowerCase();
      if(!data.some(item => item.sku === sku)) {
        toast("·∫¢nh " + file.name + " kh√¥ng kh·ªõp SKU n√†o");
      } else {
        imagesSet.add(sku);
        const url = URL.createObjectURL(file);
        imagePreviewMap[sku] = url;
      }
    });
    renderTable();
  };
  $("#btnHealth").onclick = () => {
    let issues = [];
    const missingImgs = data.filter(r => !imagesSet.has(r.sku)).map(r => r.sku);
    if(missingImgs.length) issues.push("‚ö†Ô∏è Thi·∫øu ·∫£nh: " + missingImgs.join(", "));
    const skuCounts = data.reduce((acc, r) => {
      acc[r.sku] = (acc[r.sku] || 0) + 1;
      return acc;
    }, {});
    const dupSku = Object.entries(skuCounts).filter(([sku, count]) => count > 1).map(([sku]) => sku);
    if(dupSku.length) issues.push("‚ö†Ô∏è Tr√πng SKU: " + dupSku.join(", "));
    const originCounts = data.reduce((acc, r) => {
      const key = r.origin.trim();
      if(key) acc[key] = (acc[key] || 0) + 1;
      return acc;
    }, {});
    const dupOri = Object.entries(originCounts).filter(([url, count]) => count > 1).map(([url]) => url);
    if(dupOri.length) issues.push("‚ö†Ô∏è Tr√πng link g·ªëc: " + dupOri.join(", "));
    const invalidLinks = data.filter(r => {
      const merc = detect(r.origin);
      if(!merc || (merc !== "shopee" && merc !== "lazada")) return true;
      const h = (() => { try{ return (new URL(r.origin)).hostname; } catch(e){return "";} })();
      return h.includes("isclix") || h.includes("accesstrade") || h.includes("go.") || h.includes("ir-");
    }).map(r => r.sku);
    if(invalidLinks.length) issues.push("‚ö†Ô∏è Link g·ªëc kh√¥ng h·ª£p l·ªá (ho·∫∑c deep-link): " + invalidLinks.join(", "));
    const missingNames = data.filter(r => !r.name.trim()).map(r => r.sku);
    if(missingNames.length) issues.push("‚ö†Ô∏è Thi·∫øu t√™n s·∫£n ph·∫©m: " + missingNames.join(", "));
    const missingPrices = data.filter(r => !r.price).map(r => r.sku);
    if(missingPrices.length) issues.push("‚ö†Ô∏è Thi·∫øu gi√°: " + missingPrices.join(", "));
    if(issues.length === 0) {
      $("#outHealth").textContent = "‚úÖ Kh√¥ng c√≥ v·∫•n ƒë·ªÅ.";
    } else {
      $("#outHealth").innerHTML = issues.join("\n");
    }
  };
  $("#btnFixSku").onclick = () => {
    const seen = {};
    data.forEach(r => {
      let base = r.name ? slugify(r.name) : slugify(r.sku);
      if(!base) base = "item";
      let newSku = base;
      if(seen[base] !== undefined) {
        seen[base]++;
        newSku = base + "-" + seen[base];
      } else {
        seen[base] = 1;
      }
      while(data.some(x => x !== r && x.sku === newSku)) {
        seen[base]++;
        newSku = base + "-" + seen[base];
      }
      if(newSku !== r.sku) {
        if(imagesSet.has(r.sku)) {
          imagesSet.delete(r.sku);
          imagesSet.add(newSku);
          imagePreviewMap[newSku] = imagePreviewMap[r.sku];
          delete imagePreviewMap[r.sku];
        }
        r.sku = newSku;
        r.image = `/assets/img/products/${newSku}.webp`;
      }
      r.sku = slugify(r.sku);
      r.image = `/assets/img/products/${r.sku}.webp`;
    });
    renderTable();
    toast("ƒê√£ s·ª≠a SKU tr√πng/l·ªói.");
  };
  const finalizeEdits = () => {
    if(document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
  };
  $("#btnJson").onclick = () => {
    finalizeEdits();
    const outputArr = data.map(r => createAffObject(r));
    $("#outJson").textContent = JSON.stringify(outputArr, null, 2);
  };
  $("#btnSnippet").onclick = () => {
    finalizeEdits();
    let snippetLines = [];
    data.forEach(r => {
      const origin = r.origin.trim();
      const merchant = r.merchant || detect(r.origin) || "";
      const name = r.name.trim() || "(no name)";
      const price = Number(r.price) || 0;
      snippetLines.push(`<a class="product-meta" href="${origin}" data-merchant="${merchant}" data-sku="${r.sku}" data-img="/assets/img/products/${r.sku}.webp" data-price="${price}">${name}</a>`);
      snippetLines.push(`<a class="buy" href="${origin}">Mua t·∫°i ${merchant.charAt(0).toUpperCase() + merchant.slice(1)}</a>`);
      snippetLines.push("");
    });
    $("#outJson").textContent = snippetLines.join("\n");
  };
  $("#btnCopy").onclick = async () => {
    try {
      const text = $("#outJson").textContent;
      await navigator.clipboard.writeText(text);
      toast(currentLang === 'vi' ? "ƒê√£ copy v√†o clipboard" : "Copied to clipboard");
    } catch(e) {
      console.error(e);
      toast("Copy failed");
    }
  };
  $("#btnDownload").onclick = () => {
    const text = $("#outJson").textContent;
    if(!text) return;
    let blob;
    let filename;
    if(text.trim().startsWith("[")) {
      blob = new Blob([text], { type: "application/json" });
      filename = "affiliates.json";
    } else {
      blob = new Blob([text], { type: "text/html" });
      filename = "snippet.html";
    }
    const a = el("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  };
  const selectedItems = () => data.filter(r => r.selected);
  const allItems = () => data.slice();
  const hdr = () => {
    const headers = { "Content-Type": "application/json" };
    const key = $("#workerKey").value.trim() || cfg.workerKey;
    if(key) headers["X-Key"] = key;
    return headers;
  };
  $("#btnHealthW").onclick = async () => {
    try {
      const r = await fetch($("#workerUrl").value.trim() + "/health", { headers: hdr() });
      const text = await r.text();
      $("#outPublish").textContent = text;
    } catch(e) {
      $("#outPublish").textContent = "Error: " + e;
    }
  };
  $("#btnDiag").onclick = async () => {
    try {
      const base = $("#workerUrl").value.trim();
      const [rs, rf] = await Promise.all([
        fetch(base + "/queue?channel=store", { headers: hdr() }),
        fetch(base + "/queue?channel=featured", { headers: hdr() })
      ]);
      const ts = await rs.text();
      const tf = await rf.text();
      $("#outPublish").textContent = "QUEUE (store): " + ts + "\nQUEUE (featured): " + tf;
    } catch(e) {
      $("#outPublish").textContent = "Error: " + e;
    }
  };
  $("#btnStatus").onclick = async () => {
    try {
      const r = await fetch($("#workerUrl").value.trim() + "/status", { headers: hdr() });
      const text = await r.text();
      $("#outPublish").textContent = text;
    } catch(e) {
      $("#outPublish").textContent = "Error: " + e;
    }
  };
  const queueItems = async (channel, items) => {
    if(!items || items.length === 0) {
      toast(currentLang === 'vi' ? "Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o" : "No products selected");
      return;
    }
    try {
      const payload = { channel: channel, items: items.map(it => createAffObject(it)) };
      let r = await fetch($("#workerUrl").value.trim() + "/queue", {
        method: "POST",
        headers: hdr(),
        body: JSON.stringify(payload)
      });
      const resText = await r.text();
      $("#outPublish").textContent = resText;
      if($("#autoPublish").checked) {
        await publishChannel(channel);
      }
    } catch(e) {
      $("#outPublish").textContent = "Error: " + e;
    }
  };
  const publishChannel = async (channel) => {
    try {
      let r = await fetch($("#workerUrl").value.trim() + "/publish", {
        method: "POST",
        headers: hdr(),
        body: JSON.stringify({ channel: channel })
      });
      if(r.status === 404 || r.status === 405) {
        r = await fetch($("#workerUrl").value.trim() + "/publish?channel=" + channel, { headers: hdr() });
      }
      const text = await r.text();
      $("#outPublish").textContent += "\n" + text;
    } catch(e) {
      $("#outPublish").textContent += "\nError: " + e;
    }
  };
  $("#btnPushStoreSel").onclick = () => {
    queueItems("store", selectedItems());
  };
  $("#btnPushFeaturedSel").onclick = () => {
    queueItems("featured", selectedItems().map(it => { const copy = Object.assign({}, it); copy.featured = true; return copy; }));
  };
  $("#btnPushStoreAll").onclick = () => {
    queueItems("store", data.slice());
  };
  $("#btnPushFeaturedAll").onclick = () => {
    queueItems("featured", data.map(it => { const copy = Object.assign({}, it); copy.featured = true; return copy; }));
  };
  $("#btnPublishStore").onclick = async () => {
    await publishChannel("store");
  };
  $("#btnPublishFeatured").onclick = async () => {
    await publishChannel("featured");
  };
  $("#btnGenMsg").onclick = () => {
    const count = data.filter(r => r.selected).length || data.length;
    const slug = $("#category").value.trim() || "<slug>";
    const msg = `feat(data): add ${count} product${count > 1 ? "s" : ""} (category: ${slug})`;
    $("#commitMsg").value = msg;
  };
})();
</script>
</body>
</html>
