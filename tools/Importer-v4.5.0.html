<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>MXD Importer v4.5.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; margin-bottom: 0.5em; }
    .mode-toggle button { padding: 10px 20px; margin-right: 5px; cursor: pointer; }
    .mode-toggle button.active { font-weight: bold; }
    #bulk-section, #detail-section { margin: 15px 0; }
    textarea { width: 100%; min-height: 150px; }
    .form-fields { display: flex; flex-wrap: wrap; gap: 10px; }
    .field-group { flex: 1 1 220px; display: flex; flex-direction: column; }
    .field-group label { font-weight: bold; margin-bottom: 5px; }
    .field-group input, .field-group select { padding: 5px; }
    .field-group input[type="checkbox"] { width: auto; padding: 0; margin-right: 5px; }
    .field-inline { display: flex; align-items: center; }
    .field-inline label { font-weight: bold; margin-left: 5px; }
    .actions { margin: 15px 0; }
    button { padding: 8px 16px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #drop-zone { border: 2px dashed #ccc; border-radius: 5px; padding: 20px; text-align: center; color: #777; margin-top: 10px; }
    #drop-zone.highlight { background-color: #f0f8ff; border-color: #333; }
    #product-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
    #product-table th, #product-table td { border: 1px solid #ccc; padding: 5px 8px; text-align: left; }
    #product-table th { background: #f9f9f9; }
    #output { white-space: pre; background: #f9f9f9; padding: 10px; overflow: auto; max-height: 300px; }
    @media (max-width: 600px) {
      .form-fields { flex-direction: column; }
      .field-group { flex: 1 1 100%; }
      button, input, select, textarea { min-height: 44px; font-size: 16px; }
    }
    @media (min-width: 601px) {
      button, input, select, textarea { font-size: 14px; }
      button { min-height: 36px; }
    }
  </style>
</head>
<body>
  <h1>MXD Importer v4.5.0</h1>
  <div class="mode-toggle">
    <button id="tab-bulk" class="active">Nhập danh sách</button>
    <button id="tab-detail">Nhập từng mục</button>
    <button id="langToggle" style="float:right;">EN</button>
  </div>

  <div id="bulk-section">
    <p>Dán danh sách sản phẩm hoặc tải lên file CSV. Mỗi dòng: Tên | Giá | Link</p>
    <textarea id="bulk-input" placeholder="Mỗi dòng: Tên | Giá | Link"></textarea><br>
    <input type="file" id="csvFile" accept=".csv, text/csv, text/plain" style="margin-top:5px;">
  </div>

  <div id="detail-section" style="display:none;">
    <p>Nhập chi tiết từng trường cho sản phẩm:</p>
    <div class="form-fields">
      <div class="field-group">
        <label for="name">Tên sản phẩm</label>
        <input type="text" id="name" placeholder="Tên sản phẩm">
      </div>
      <div class="field-group">
        <label for="price">Giá (VND)</label>
        <input type="text" id="price" placeholder="Giá (VND)">
      </div>
      <div class="field-group">
        <label for="origin">Link gốc</label>
        <input type="url" id="origin" placeholder="URL gốc sản phẩm">
      </div>
      <div class="field-group">
        <label for="sku">SKU</label>
        <input type="text" id="sku" placeholder="Mã SKU">
      </div>
      <div class="field-group">
        <label for="category">Danh mục</label>
        <input type="text" id="category" placeholder="Slug danh mục">
      </div>
      <div class="field-group">
        <label for="brand">Thương hiệu</label>
        <input type="text" id="brand" placeholder="Tên thương hiệu">
      </div>
      <div class="field-group">
        <label>
          <input type="checkbox" id="featured"> Nổi bật
        </label>
      </div>
      <div class="field-group">
        <label for="status">Trạng thái</label>
        <select id="status">
          <option value="active">Hoạt động</option>
          <option value="draft">Nháp</option>
          <option value="archived">Lưu trữ</option>
        </select>
      </div>
    </div>
    <button id="add-product">Thêm sản phẩm</button>
  </div>

  <div id="drop-zone">Kéo & thả hoặc bấm để tải ảnh sản phẩm (.webp)</div>
  <input type="file" id="imageInput" accept="image/*" multiple style="display:none;">

  <div class="actions">
    <button id="generate">Tạo dữ liệu</button>
  </div>

  <table id="product-table" style="display:none;">
    <thead>
      <tr>
        <th>Tên</th>
        <th>Giá</th>
        <th>Link gốc</th>
        <th>SKU</th>
        <th>Ảnh</th>
        <th>Danh mục</th>
        <th>Thương hiệu</th>
        <th>Nổi bật</th>
        <th>Trạng thái</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions" id="export-actions" style="display:none;">
    <button id="download-json">Tải JSON</button>
    <button id="download-snippet">Tải Snippet HTML</button>
  </div>

  <div id="output" style="display:none;"></div>

<script>
(() => {
  "use strict";
  // Song ngữ Việt/Anh
  const translations = {
    vi: {
      bulkInstructions: "Dán danh sách sản phẩm hoặc tải lên file CSV. Mỗi dòng: Tên | Giá | Link",
      detailInstructions: "Nhập chi tiết từng trường cho sản phẩm:",
      // ... (các chuỗi khác nếu cần)
    },
    en: {
      bulkInstructions: "Paste a list of products or upload a CSV file. Each line: Name | Price | Link",
      detailInstructions: "Enter detailed fields for each product:",
      // ... (other strings if needed)
    }
  };
  let currentLang = "vi";
  const langToggleBtn = document.getElementById("langToggle");
  const updateLanguage = (lang) => {
    currentLang = lang;
    // Cập nhật các đoạn text chính
    document.querySelector("#bulk-section p").textContent = translations[lang].bulkInstructions;
    document.querySelector("#detail-section p").textContent = translations[lang].detailInstructions;
    document.getElementById("tab-bulk").textContent = (lang === "vi" ? "Nhập danh sách" : "Bulk Input");
    document.getElementById("tab-detail").textContent = (lang === "vi" ? "Nhập từng mục" : "Detailed Input");
    document.getElementById("add-product").textContent = (lang === "vi" ? "Thêm sản phẩm" : "Add Product");
    document.getElementById("generate").textContent = (lang === "vi" ? "Tạo dữ liệu" : "Generate Data");
    document.getElementById("download-json").textContent = (lang === "vi" ? "Tải JSON" : "Download JSON");
    document.getElementById("download-snippet").textContent = (lang === "vi" ? "Tải Snippet HTML" : "Download Snippet");
    // Cập nhật placeholder
    document.getElementById("bulk-input").placeholder = translations[lang].bulkInstructions.split('. ')[1] || "";
    document.getElementById("name").placeholder = (lang === "vi" ? "Tên sản phẩm" : "Product Name");
    document.getElementById("price").placeholder = (lang === "vi" ? "Giá (VND)" : "Price (VND)");
    document.getElementById("origin").placeholder = (lang === "vi" ? "URL gốc sản phẩm" : "Product URL");
    document.getElementById("sku").placeholder = (lang === "vi" ? "Mã SKU" : "SKU");
    document.getElementById("category").placeholder = (lang === "vi" ? "Slug danh mục" : "Category slug");
    document.getElementById("brand").placeholder = (lang === "vi" ? "Tên thương hiệu" : "Brand name");
    // Nút toggle
    langToggleBtn.textContent = (lang === "vi" ? "EN" : "VI");
  };
  langToggleBtn.addEventListener("click", () => {
    updateLanguage(currentLang === "vi" ? "en" : "vi");
  });
  // Slugify (loại dấu, ký tự đặc biệt)
  const slugify = (text) => {
    return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
               .toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
  };
  // Tự động tạo SKU từ tên
  let skuEdited = false;
  const nameInput = document.getElementById("name");
  const skuInput = document.getElementById("sku");
  nameInput.addEventListener("input", () => {
    if (!skuEdited) {
      skuInput.value = slugify(nameInput.value);
    }
  });
  skuInput.addEventListener("input", () => {
    skuEdited = true;
  });
  nameInput.addEventListener("blur", () => {
    if (!skuEdited) {
      skuInput.value = slugify(nameInput.value);
    }
  });
  // Chuẩn hóa giá
  const parsePrice = (s) => {
    s = s.trim();
    if (!s) return 0;
    const lower = s.toLowerCase();
    let factor = 1;
    if (lower.includes('tr') || lower.includes('k')) {
      if (lower.includes('tr')) factor = 1000000;
      else if (lower.includes('k')) factor = 1000;
      // Đổi dấu phẩy thành chấm (nếu có) để xử lý số thập phân
      let numStr = lower.replace(/,/g, '.').replace(/[^0-9\\.]/g, '');
      let num = parseFloat(numStr);
      if (isNaN(num)) {
        // nếu vẫn không parse được (vd: "1.234.000"), bỏ hết ký tự không phải số
        const intStr = lower.replace(/\D/g, '');
        num = intStr ? parseFloat(intStr) : 0;
      }
      return Math.floor(num * factor);
    } else {
      const digits = s.replace(/\D/g, '');
      return digits ? parseInt(digits) : 0;
    }
  };
  // Xác định merchant từ link
  const detectMerchant = (url) => {
    try {
      const host = (new URL(url)).hostname;
      if (host.includes('shopee')) return 'shopee';
      if (host.includes('lazada')) return 'lazada';
      if (host.includes('tiki')) return 'tiki';
    } catch(e) {
      if (url.includes('shopee')) return 'shopee';
      if (url.includes('lazada')) return 'lazada';
      if (url.includes('tiki')) return 'tiki';
    }
    return '';
  };
  // Danh sách sản phẩm tạm
  const products = [];
  // Xử lý thêm sản phẩm (form chi tiết)
  document.getElementById("add-product").addEventListener("click", () => {
    const name = nameInput.value.trim();
    const priceStr = document.getElementById("price").value;
    let origin = document.getElementById("origin").value.trim();
    const skuVal = skuInput.value.trim() || slugify(name);
    const category = document.getElementById("category").value.trim();
    const brand = document.getElementById("brand").value.trim();
    const featured = document.getElementById("featured").checked;
    const status = document.getElementById("status").value;
    if (!name || !origin) {
      alert(currentLang === 'vi' ? 'Vui lòng nhập Tên và Link gốc.' : 'Please enter Name and Origin link.');
      return;
    }
    if (!/^https?:\/\//i.test(origin)) {
      origin = 'https://' + origin;
    }
    const priceVal = parsePrice(priceStr);
    const merchant = detectMerchant(origin);
    // Thời gian hiện tại (ISO 8601 +07:00)
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const vnTime = new Date(utc + 7 * 3600000);
    const updatedISO = vnTime.toISOString().replace('Z', '+07:00');
    // Tạo object sản phẩm
    const product = {
      name: name,
      price: priceVal,
      origin: origin,
      merchant: merchant,
      sku: skuVal,
      image: "/assets/img/products/" + skuVal + ".webp",
      category: category || "",
      brand: brand || "",
      featured: !!featured,
      status: status || "active",
      updated_at: updatedISO,
      sub1: skuVal,
      notes: ""
    };
    products.push(product);
    // Reset form (giữ lại category, brand, status để tiện nhập nhiều sp cùng loại)
    nameInput.value = "";
    document.getElementById("price").value = "";
    document.getElementById("origin").value = "";
    skuEdited = false;
    skuInput.value = "";
    document.getElementById("featured").checked = false;
    // Cập nhật bảng sản phẩm
    renderTable();
  });
  // Đọc file CSV upload
  document.getElementById("csvFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      const text = evt.target.result;
      document.getElementById("bulk-input").value = text;
    };
    reader.readAsText(file);
  });
  // Xử lý nút Generate (tạo JSON & snippet)
  document.getElementById("generate").addEventListener("click", () => {
    if (document.getElementById("bulk-section").style.display !== "none") {
      // Đang ở chế độ nhập danh sách
      const inputText = document.getElementById("bulk-input").value;
      if (!inputText.trim()) {
        alert(currentLang === 'vi' ? 'Vui lòng nhập danh sách sản phẩm.' : 'Please enter product list.');
        return;
      }
      const lines = inputText.split(/\r?\n/);
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        let name = "", priceVal = 0, origin = "";
        if (trimmed.includes('|')) {
          const parts = trimmed.split('|').map(p => p.trim());
          if (parts.length >= 3) {
            name = parts[0];
            priceVal = parsePrice(parts[1]);
            origin = parts.slice(2).join('|'); // nếu link chứa ký tự '|' thì ghép lại
          } else if (parts.length === 2) {
            name = parts[0];
            priceVal = 0;
            origin = parts[1];
          } else {
            origin = parts[0];
          }
        } else {
          origin = trimmed;
        }
        if (!origin) continue;
        if (!/^https?:\/\//i.test(origin)) {
          origin = 'https://' + origin;
        }
        const merchant = detectMerchant(origin);
        if (!name) {
          try {
            const urlObj = new URL(origin);
            const pathSeg = urlObj.pathname.split('/').filter(Boolean);
            const lastSeg = pathSeg.pop() || "";
            name = decodeURIComponent(lastSeg.replace(/[-_]/g, ' ')) || origin;
          } catch {
            name = origin;
          }
        }
        const skuVal = slugify(name);
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const vnTime = new Date(utc + 7 * 3600000);
        const updatedISO = vnTime.toISOString().replace('Z', '+07:00');
        const product = {
          name: name,
          price: priceVal || 0,
          origin: origin,
          merchant: merchant,
          sku: skuVal,
          image: "/assets/img/products/" + skuVal + ".webp",
          category: "",
          brand: "",
          featured: false,
          status: "active",
          updated_at: updatedISO,
          sub1: skuVal,
          notes: ""
        };
        products.push(product);
      }
    }
    if (products.length === 0) {
      alert(currentLang === 'vi' ? 'Chưa có sản phẩm nào.' : 'No products added.');
      return;
    }
    renderTable();
    document.getElementById("export-actions").style.display = "block";
  });
  // Cập nhật bảng HTML hiển thị danh sách sản phẩm
  const renderTable = () => {
    const table = document.getElementById("product-table");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";
    products.forEach(prod => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${prod.name}</td>
        <td>${prod.price}</td>
        <td><a href="${prod.origin}" target="_blank">Link</a></td>
        <td>${prod.sku}</td>
        <td>${prod.image}</td>
        <td>${prod.category}</td>
        <td>${prod.brand}</td>
        <td>${prod.featured ? "✔" : ""}</td>
        <td>${prod.status}</td>
      `;
      tbody.appendChild(row);
    });
    table.style.display = products.length ? "table" : "none";
  };
  // Kéo-thả và chọn file ảnh
  const dropZone = document.getElementById("drop-zone");
  const imageInput = document.getElementById("imageInput");
  dropZone.addEventListener("click", () => imageInput.click());
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("highlight");
  });
  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("highlight");
  });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("highlight");
    const files = e.dataTransfer.files;
    handleFiles(files);
  });
  imageInput.addEventListener("change", (e) => {
    handleFiles(e.target.files);
  });
  const handleFiles = (files) => {
    if (!files) return;
    const fileList = Array.from(files);
    fileList.forEach(file => {
      const baseName = file.name.replace(/\.[^.]+$/, '').toLowerCase();
      products.forEach(prod => {
        if (prod.sku.toLowerCase() === baseName) {
          // Nếu tên file trùng SKU, coi như ảnh đã gán đúng sản phẩm
          // (Ở đây có thể đánh dấu hoặc thay thế placeholder nếu cần)
        }
      });
    });
    alert(currentLang === 'vi'
      ? 'Đã tải ' + files.length + ' ảnh (tự động khớp theo SKU).'
      : files.length + ' images uploaded (matched by SKU).');
  };
  // Tải file JSON
  document.getElementById("download-json").addEventListener("click", () => {
    const jsonStr = JSON.stringify(products, null, 2);
    const blob = new Blob([jsonStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "affiliates.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  // Tải file HTML snippet
  document.getElementById("download-snippet").addEventListener("click", () => {
    if (products.length === 0) return;
    let snippetHtml = "";
    products.forEach(prod => {
      const merchantName = prod.merchant ? (prod.merchant.charAt(0).toUpperCase() + prod.merchant.slice(1)) : "";
      snippetHtml += `<a class="product-meta" href="${prod.origin}" data-merchant="${prod.merchant}" data-sku="${prod.sku}" data-img="${prod.image}" data-price="${prod.price}">${prod.name}</a>\n`;
      snippetHtml += `<a class="buy" href="${prod.origin}">Mua tại ${merchantName}</a>\n`;
    });
    const blob = new Blob([snippetHtml], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "snippet.html";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  // Chuyển đổi tab nhập liệu
  document.getElementById("tab-bulk").addEventListener("click", () => {
    document.getElementById("tab-bulk").classList.add("active");
    document.getElementById("tab-detail").classList.remove("active");
    document.getElementById("bulk-section").style.display = "";
    document.getElementById("detail-section").style.display = "none";
  });
  document.getElementById("tab-detail").addEventListener("click", () => {
    document.getElementById("tab-detail").classList.add("active");
    document.getElementById("tab-bulk").classList.remove("active");
    document.getElementById("detail-section").style.display = "";
    document.getElementById("bulk-section").style.display = "none";
  });
})();
</script>
</body>
</html>
