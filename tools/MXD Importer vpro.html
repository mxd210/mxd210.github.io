<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MXD Importer v4.3.8 — PRO (Settings + X-Key + Publish 1-click)</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{ --bg:#0b0f14;--fg:#e8f0fb;--muted:#a7b4c2;--b:#152132;--accent:#7cc4ff;--ok:#34d399;--warn:#f59e0b;--err:#ef4444;--toast-bottom:12px; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:16px 0 8px} h1{font-size:20px} h2{font-size:16px;color:#cfe5ff}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid #223348;border-radius:12px;padding:14px}
    label{display:block;font-weight:700;margin:8px 0 6px;color:#cfe5ff}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3b52;background:#0f1622;color:var(--fg)}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .btn{cursor:pointer;border:1px solid #2b3b52;background:#102235}
    .btn:hover{background:#132a43}
    .btn.primary{background:#0b3a5e;border-color:#0b3a5e}
    .btn.primary:hover{background:#0d4570}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3b55;color:#a9c6ff}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .deeplink-box{border:2px dashed #2f4666;border-radius:12px;padding:10px;background:#0c1623}
    .deeplink-text{font-size:13px;font-weight:600}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,#0b0f14 60%,#0b0f1400);padding:12px;border-top:1px solid #1b2a3f;z-index:9}
    .drop{border:2px dashed #3a5270;border-radius:12px;padding:16px;text-align:center;background:#0c1623}
    .drop.dragover{border-color:#8ab9ff;background:#0f1e32}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #27405e}
    .toast{position:fixed;right:12px;bottom:var(--toast-bottom);display:none;max-width:520px;background:#122232;border:1px solid #2b425e;border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;z-index:99999;pointer-events:none}
    .toast.show{display:block}
    code.inline{background:#0e1622;border:1px solid #223449;border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;border:1px solid #2b3b52;border-radius:999px;padding:2px 8px;font-size:11px;color:#a4bee8}
    .tbl{width:100%;border-collapse:collapse;margin-top:8px}
    .tbl th,.tbl td{border:1px solid #2b3b52;padding:6px 8px;font-size:12px}
    .chip{display:inline-block;padding:2px 8px;border:1px solid #2b3b52;border-radius:999px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>MXD Importer v4.3.8 <span class="pill">PRO</span></h1>
  <div class="small">“Một click lên web” nhưng không đánh rơi chuẩn MXD210: ảnh đúng đường dẫn, JSON chuẩn schema, link đi qua affiliate. Bản này có <b>Upload đa thư mục</b>, <b>preset ảnh chuẩn MXD</b>, <b>batch ảnh</b> và <b>batch link gốc → JSON/Publish</b>.</div>

  <div class="card">
    <h2>1) Cài đặt (lưu vào trình duyệt)</h2>
    <div class="grid g2">
      <div><label>Worker Base URL</label><input id="workerUrl" placeholder="https://mxd210.mxd6686.workers.dev"/></div>
      <div><label>X-Key (header bảo vệ Worker)</label><input id="xKey" placeholder="Ví dụ: mxd210-secret-key"/></div>
      <div><label>Shopee template</label><input id="tplShopee" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
      <div><label>Lazada template</label><input id="tplLazada" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">💾 Lưu cài đặt</button>
      <button class="btn" id="btnLoadSettings">↻ Tải lại</button>
      <button class="btn" id="btnClearSettings">🗑 Xóa cài đặt</button>
      <span class="small" id="settingsStatus"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCheckWorker">Kiểm tra Worker</button>
      <button class="btn" id="btnCheckAuth">Kiểm tra X-Key</button>
      <button class="btn" id="btnCheckWrite">Kiểm tra quyền commit</button>
      <span class="small" id="workerStatus"></span>
    </div>
  </div>

  <div class="grid g2">
    <div class="card">
      <h2>2) Ảnh — đơn & batch</h2>

      <div class="row">
        <div>
          <label>Preset ảnh (chuẩn MXD)</label>
          <select id="imgPreset">
            <option value="product-1200">Sản phẩm (dài 1200) — .webp q=0.82</option>
            <option value="category-512">Icon danh mục (vuông 512) — .webp q=0.82</option>
            <option value="cover-1200x630">Ảnh cover blog (1200×630) — .webp q=0.82</option>
            <option value="banner-1920x800">Banner (1920×800) — .webp q=0.82</option>
            <option value="original">Giữ nguyên kích thước — .webp q=0.82</option>
          </select>
        </div>
        <div>
          <label>Thư mục đích</label>
          <select id="targetFolder">
            <option value="/assets/img/products/">/assets/img/products/</option>
            <option value="/assets/img/categories/">/assets/img/categories/</option>
            <option value="/assets/img/blog/">/assets/img/blog/</option>
            <option value="/assets/img/banners/">/assets/img/banners/</option>
            <option value="__custom__">Tự nhập…</option>
          </select>
        </div>
        <div><label>Thư mục tự nhập (nếu chọn trên)</label><input id="customFolder" placeholder="/assets/img/custom/"/></div>
      </div>

      <div class="row">
        <div>
          <label>Quy tắc đặt tên</label>
          <select id="nameMode">
            <option value="sku">Theo SKU (thêm -01, -02 khi batch)</option>
            <option value="filename">Theo tên file</option>
            <option value="custom">Tuỳ chỉnh</option>
          </select>
        </div>
        <div><label>Tên file tuỳ chỉnh (không đuôi)</label><input id="customName" placeholder="ten-anh"/></div>
        <div><label class="small">Đuôi file</label><div class="chip">.webp</div></div>
      </div>

      <div id="drop" class="drop">Kéo & thả ảnh vào đây hoặc chọn…</div>
      <input type="file" id="file" accept="image/*" multiple style="display:none"/>

      <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
        <img id="thumb" alt="preview"/>
        <div class="small">
          <div><b>Tên file đề xuất:</b> <code class="inline" id="imgName">-</code></div>
          <div><b>Kích thước:</b> <span id="imgInfo">-</span></div>
          <div><b>Đường dẫn:</b> <code class="inline" id="imgPath">-</code></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSelectImg">Chọn ảnh</button>
        <button class="btn" id="btnConvert">Nén .webp</button>
        <button class="btn" id="btnSaveImg">Tải ảnh (.webp)</button>
        <button class="btn primary" id="btnUploadImg">Upload ảnh (đơn)</button>
      </div>

      <hr style="border:0;border-top:1px dashed #2b3b52;margin:12px 0"/>

      <label>Batch bằng URL (mỗi dòng 1 link ảnh)</label>
      <textarea id="urlList" placeholder="https://example.com/image1.jpg
https://example.com/image2.png"></textarea>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnAddUrls">Thêm URL vào batch</button>
        <button class="btn" id="btnClearBatch">Xoá danh sách</button>
        <button class="btn" id="btnProcessBatch">Xử lý ảnh (chuẩn MXD)</button>
        <button class="btn primary" id="btnUploadBatch">Upload TẤT CẢ</button>
        <button class="btn" id="btnDownloadBatch">Tải TẤT CẢ (.webp)</button>
      </div>

      <table class="tbl" id="batchTable" aria-live="polite">
        <thead><tr><th>#</th><th>Nguồn</th><th>Tên gợi ý</th><th>Kích thước</th><th>Trạng thái</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>3) Thông tin sản phẩm</h2>
      <div class="grid">
        <div class="row">
          <div><label>Tên sản phẩm</label><input id="name" placeholder="Ví dụ: Dekton DK-AG950S"/></div>
          <div><label>SKU (bắt buộc, có thể sửa)</label><input id="sku" placeholder="dekton-dk-ag950s"/></div>
        </div>
        <div class="row">
          <div><label>Giá (VND, không chấm)</label><input id="price" type="number" placeholder="399000"/></div>
          <div><label>Merchant</label><select id="merchant"><option value="shopee">shopee</option><option value="lazada">lazada</option></select></div>
        </div>
        <div><label>Link gốc (origin)</label><input id="origin" placeholder="https://shopee.vn/…"/></div>
        <div class="row">
          <div><label>Ảnh (đường dẫn)</label><input id="image" placeholder="/assets/img/products/dekton-dk-ag950s.webp"/></div>
          <div><label>Danh mục (category)</label><input id="category" placeholder="may-khoan / may-mai / phu-kien"/></div>
        </div>
        <div><label>Thương hiệu (brand)</label><input id="brand" placeholder="dekton, bosch, makuta…"/></div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="featured" style="width:auto"/> Nổi bật (featured)</label>
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="status" checked style="width:auto"/> Hiển thị (status)</label>
          <button class="btn" id="btnAuto">Điền auto từ tên</button>
        </div>
        <div id="diag" class="small"></div>
      </div>
    </div>
  </div>

  <div class="card deeplink-box">
    <h2>4) Deep-link (to, rõ ràng, copy dễ)</h2>
    <div class="grid g2">
      <div>
        <label>Origin (đã nhập)</label>
        <textarea id="originOut" class="deeplink-text" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOrigin">Copy Origin</button>
          <button class="btn" id="openOrigin">Mở Origin</button>
        </div>
      </div>
      <div>
        <label>Affiliate deep-link</label>
        <textarea id="deeplink" class="deeplink-text" placeholder="Tự sinh từ template hoặc dán sẵn tại đây"></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnMakeDeeplink">Tạo từ template</button>
          <button class="btn" id="copyDeeplink">Copy Deep-link</button>
          <button class="btn" id="openDeeplink">Mở Deep-link</button>
          <span id="dlCheck" class="badge">–</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>5) JSON xuất bản</h2>
    <textarea id="jsonOut" rows="8" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">Tạo JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">Tải affiliates.append.json</button>
    </div>
  </div>

  <div class="card">
    <h2>6) Batch link gốc → JSON / Publish</h2>
    <div class="row">
      <div>
        <label>Danh sách link gốc (mỗi dòng 1 URL)</label>
        <textarea id="originBatchInput" placeholder="https://shopee.vn/May-...-i.1308.......
https://www.lazada.vn/products/....html"></textarea>
      </div>
      <div>
        <label>Mặc định Brand</label>
        <input id="batchBrand" placeholder="bosch / makita / hukan …"/>
        <label>Mặc định Category</label>
        <input id="batchCategory" placeholder="may-cat / may-khoan …"/>
        <label><input type="checkbox" id="batchFeatured" style="width:auto"/> Mark featured</label>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnParseOrigins">Phân tích URL</button>
      <button class="btn" id="btnGenJsonFromOrigins">Tạo JSON từ danh sách</button>
      <button class="btn primary" id="btnPublishOrigins">Publish HÀNG LOẠT</button>
      <button class="btn" id="btnClearOrigins">Xoá danh sách</button>
    </div>

    <table class="tbl" id="originTable">
      <thead><tr><th>#</th><th>Merchant</th><th>Tên gợi ý</th><th>SKU</th><th>Category</th><th>Deeplink</th><th>Trạng thái</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small">Ghi chú: Tool dùng tên trong URL để gợi ý tên & SKU. Không gọi vào trang đích (tránh CORS). Bạn có thể chỉnh SKU hay Category sau khi tạo JSON (một cách thủ công ở file JSON nếu cần).</div>
  </div>

  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish → Store</button>
    <button class="btn" id="btnPublishFeatured">Publish → Nổi bật</button>
    <button class="btn" id="btnVerify">✅ Kiểm tra trên Store</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
const $ = s => document.querySelector(s);
const LS_KEY = 'MXD_IMPORTER_SETTINGS_V438';
const slugify = s => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

// ==== Templates mặc định (AccessTrade) ====
const DEFAULT_TPL_SHOPEE =
  'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
const DEFAULT_TPL_LAZADA =
  'https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';

// SUB chuẩn MXD210
function computeSubs(sku, merchant){ return {sub1: sku||'sku', sub2:(merchant||'merchant').toLowerCase(), sub3:'tool', sub4:'mxd210'}; }
function ensureSubsInUrl(u,subs){ const has=k=>new RegExp(`[?&]${k}=`,`i`).test(u); const qs=[]; if(!has('sub1'))qs.push(`sub1=${encodeURIComponent(subs.sub1)}`); if(!has('sub2'))qs.push(`sub2=${encodeURIComponent(subs.sub2)}`); if(!has('sub3'))qs.push(`sub3=${encodeURIComponent(subs.sub3)}`); if(!has('sub4'))qs.push(`sub4=${encodeURIComponent(subs.sub4)}`); return qs.length?(u+(u.includes('?')?'&':'?')+qs.join('&')):u; }
function cleanUrl(u){ return (u||'').trim().replace(/^["']+|["',]+$/g,''); }

// === NORMALIZE HELPERS (vi → slug) ===
function vn(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D').toLowerCase();}
function normCategory(raw){
  const base = vn(raw).replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'');
  if (/^(may-?cat|maycat|may\s*cat|may-mai|mai-goc|may-cat-sat|may-cat-gach)$/.test(base)) return 'may-cat';
  return base;
}

// === CATEGORY MAP (CONFIG) — MXD Canonical ===
window.CATEGORY_KEYWORDS = window.CATEGORY_KEYWORDS || {};
window.CATEGORY_KEYWORDS["may-cat"] = {
  include: [/\b(máy\s*)?cắt\b/i, /\bmáy\s*cưa\b/i, /\bcưa\s*(đĩa|bàn|kiếm|lọng)\b/i, /\bcut[\s-]?off\b/i, /\bcircular(\s*saw)?\b/i, /\bjig\s*saw\b/i, /\bjigsaw\b/i, /\breciprocating\b/i, /\bsabre\b/i, /\bmáy\s*cắt\s*(gạch|sắt|nhôm|đa\s*năng)\b/i, /\bm[ảa]i\s*g[óo]c\b/i, /\bmay\s*cat\b/i],
  exclude: [/\b(lưỡi|blade|đĩa|disc|đá\s*cắt|phụ\s*kiện|mũi)\b/i],
  set: { category: "may-cat" }
};
function autoCategory(text){
  const MAP = window.CATEGORY_KEYWORDS || {};
  for (const [slug, rule] of Object.entries(MAP)){
    const okInc = (rule.include||[]).some(rx => rx.test(text));
    const okExc = (rule.exclude||[]).some(rx => rx.test(text));
    if (okInc && !okExc) return slug;
  } return '';
}

// ====== State / Toast ======
const state = { workerOk:false, imgBlob:null, imgName:null, imgW:0, imgH:0, imgPath:null };
function toast(msg,cls=''){ const t=$("#toast"); t.innerHTML=msg; t.className='toast show '+cls; setTimeout(()=>t.className='toast',4500); }
function updateToastOffset(){ const bar=document.querySelector('.sticky-actions'); const bottom=bar?(bar.offsetHeight+16):12; document.documentElement.style.setProperty('--toast-bottom', bottom+'px'); }
window.addEventListener('load', updateToastOffset); window.addEventListener('resize', updateToastOffset); if('ResizeObserver'in window){ new ResizeObserver(updateToastOffset).observe(document.querySelector('.sticky-actions')); }

// ---------- Settings ----------
function readSettings(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
function writeSettings(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
function uiToSettings(){ return { workerUrl:$("#workerUrl").value.trim(), xKey:$("#xKey").value.trim(), tplShopee:$("#tplShopee").value.trim(), tplLazada:$("#tplLazada").value.trim() }; }
function settingsToUi(s){ $("#workerUrl").value=s.workerUrl||''; $("#xKey").value=s.xKey||''; $("#tplShopee").value=s.tplShopee||''; $("#tplLazada").value=s.tplLazada||''; }
function saveSettings(){ writeSettings(uiToSettings()); $("#settingsStatus").textContent="Đã lưu."; toast("Đã lưu cài đặt.","ok"); }
function loadSettings(){ const s=readSettings(); settingsToUi(s); if(!$("#tplShopee").value) $("#tplShopee").value=DEFAULT_TPL_SHOPEE; if(!$("#tplLazada").value) $("#tplLazada").value=DEFAULT_TPL_LAZADA; $("#settingsStatus").textContent="Đã tải cài đặt."; }
$("#btnSaveSettings").onclick=saveSettings; $("#btnLoadSettings").onclick=loadSettings; $("#btnClearSettings").onclick=()=>{ localStorage.removeItem(LS_KEY); settingsToUi({}); $("#settingsStatus").textContent="Đã xóa."; }; loadSettings();

function hdr(){ const s=readSettings(); const h={}; if(s.xKey) h['x-key']=s.xKey; h['content-type']='application/json'; return h; }
async function check(url){ try{ const r=await fetch(url,{mode:"cors",headers:hdr()}); return {ok:r.ok,status:r.status,text:await r.text().catch(()=>'' )}; }catch(e){ return {ok:false,status:-1,text:String(e)}; } }
$("#btnCheckWorker").onclick=async()=>{ const s=readSettings(); if(!s.workerUrl){ $("#workerStatus").textContent="Chưa cấu hình Worker."; return; } const u=s.workerUrl.replace(/\/$/,'')+"/health"; const r=await check(u); state.workerOk=r.ok; $("#workerStatus").textContent=r.ok?`Worker OK (health ${r.status}).`:`Worker lỗi (${r.status}). `+r.text.slice(0,120); toast(r.ok?"Worker OK":"Worker lỗi "+r.status, r.ok?"ok":"err"); };
$("#btnCheckAuth").onclick=async()=>{ const s=readSettings(); if(!s.workerUrl){ toast("Chưa cấu hình Worker.","warn"); return; } const u=s.workerUrl.replace(/\/$/,'')+"/whoami"; const r=await check(u); toast(r.ok?"X-Key hợp lệ.":"X-Key không hợp lệ ("+r.status+")", r.ok?"ok":"err"); };
$("#btnCheckWrite").onclick=async()=>{ const s=readSettings(); if(!s.workerUrl){ toast("Chưa cấu hình Worker.","warn"); return; } const u=s.workerUrl.replace(/\/$/,'')+"/can-write"; const r=await check(u); toast(r.ok?"Có quyền commit.":"Không có quyền ("+r.status+")", r.ok?"ok":"err"); };

// ---------- Auto fill / diagnostics ----------
$("#btnAuto").onclick=()=>{ const name=$("#name").value.trim(); const skuNow=$("#sku").value.trim(); if(name && !skuNow) $("#sku").value=slugify(name); if($("#sku").value && !$("#image").value) $("#image").value=`/assets/img/products/${$("#sku").value}.webp`; $("#originOut").value=cleanUrl($("#origin").value.trim()); const g=autoCategory(`${name} ${$("#brand").value} ${$("#origin").value}`); if(g && !$("#category").value.trim()) $("#category").value=g; runDiag(); };
["name","sku","origin","image","merchant"].forEach(id=>$("#"+id).addEventListener('input', runDiag));
function runDiag(){ const sku=$("#sku").value.trim(); const img=$("#image").value.trim(); const origin=cleanUrl($("#origin").value.trim()); const merchant=$("#merchant").value; const msgs=[]; if(!sku) msgs.push("• Thiếu SKU."); if(img && !img.startsWith(`/assets/img/products/${sku||'...'}`)) msgs.push("• Ảnh nên là /assets/img/products/"+(sku||'&lt;sku&gt;')+".webp"); if(origin && !/shopee\.vn|lazada\.vn/i.test(origin)) msgs.push("• Origin không phải Shopee/Lazada."); msgs.push("• Merchant: "+merchant); $("#diag").innerHTML = msgs.length? msgs.map(x=>`<div>${x}</div>`).join("") : '<span class="ok">Tạm ổn.</span>'; $("#originOut").value=origin; }

// ---------- Deep-link ----------
function activeTplFor(m){ const s=readSettings(); const raw=(m==='shopee'?(s.tplShopee||''):(s.tplLazada||'')).trim(); return raw|| (m==='shopee'?DEFAULT_TPL_SHOPEE:DEFAULT_TPL_LAZADA); }
function makeDeeplink(){ const origin=cleanUrl($("#origin").value.trim()); const sku=$("#sku").value.trim(); const merchant=$("#merchant").value; if(!origin){ toast("Thiếu Origin.","warn"); return; } const tpl=activeTplFor(merchant); const subs=computeSubs(sku,merchant); let link=tpl.replace(/\{url\}/g, encodeURIComponent(origin)).replace(/\{sku\}/g, sku||'sku').replace(/\{sub1\}/g, subs.sub1).replace(/\{sub2\}/g, subs.sub2).replace(/\{sub3\}/g, subs.sub3).replace(/\{sub4\}/g, subs.sub4); link=ensureSubsInUrl(link,subs); $("#deeplink").value=link; validateDeeplink(); }
$("#btnMakeDeeplink").onclick=makeDeeplink;
["origin","sku","merchant","tplShopee","tplLazada"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener('input', ()=>{ if($("#origin").value.trim()) makeDeeplink(); }); });
$("#origin").addEventListener('input', ()=>$("#originOut").value=cleanUrl($("#origin").value));
function validateDeeplink(){ const dl=$("#deeplink").value.trim(); const badge=$("#dlCheck"); if(!dl){ badge.textContent="chưa có deeplink"; badge.className='badge'; return; } const okHost=/(^https?:\/\/)?([^/]*\.)?isclix\.com/i.test(dl); const hasUrl=/[?&]url=/.test(dl); const s1=/[?&]sub1=/.test(dl), s2=/[?&]sub2=/.test(dl), s3=/[?&]sub3=/.test(dl), s4=/[?&]sub4=/.test(dl); if(okHost && hasUrl && s1 && s2 && s3 && s4){ badge.textContent="OK affiliate"; badge.className='badge'; return; } if(okHost && !hasUrl){ badge.textContent="isclix thiếu url="; badge.className='badge'; return; } if(okHost){ const missing=['sub1','sub2','sub3','sub4'].filter(k=>!new RegExp(`[?&]${k}=`).test(dl)); badge.textContent="isclix thiếu: "+missing.join(', '); badge.className='badge'; return; } badge.textContent="KHÔNG qua affiliate"; badge.className='badge'; }
$("#deeplink").addEventListener('input', validateDeeplink);

// ---------- Presets & Target Folder (Ảnh) ----------
function getPreset(){ const v=$("#imgPreset").value; const q=0.82; if(v==='product-1200') return {mode:'longedge', long:1200, q}; if(v==='category-512') return {mode:'square', w:512, h:512, q}; if(v==='cover-1200x630') return {mode:'cover', w:1200, h:630, q}; if(v==='banner-1920x800') return {mode:'cover', w:1920, h:800, q}; return {mode:'original', q}; }
function getTargetFolder(){ const v=$("#targetFolder").value; if(v==='__custom__') return ($("#customFolder").value.trim()||'/assets/img/custom/').replace(/\/?$/,'/').replace(/\/+/g,'/').replace(/^(?!\/)/,'/'); return v; }
function getFileBase(i, origName){ const mode=$("#nameMode").value; if(mode==='sku'){ let base=$("#sku").value.trim() || slugify($("#name").value.trim()||'mxd'); if(i>0) base += '-' + String(i+1).padStart(2,'0'); return base; } if(mode==='custom'){ let base=slugify($("#customName").value.trim()||'image'); if(i>0) base += '-' + String(i+1).padStart(2,'0'); return base; } const n=(origName||'image').replace(/\.[^.]+$/,''); return slugify(n||'image'); }

// ---------- Image processing ----------
function drawProcessed(img, preset){
  let cw, ch, sx=0, sy=0, sw=img.width, sh=img.height;
  if(preset.mode==='longedge'){ const scale=Math.min(1, preset.long/Math.max(img.width,img.height)); cw=Math.round(img.width*scale); ch=Math.round(img.height*scale); }
  else if(preset.mode==='square'){ const side=Math.min(img.width,img.height); sx=(img.width-side)/2; sy=(img.height-side)/2; sw=sh=side; cw=preset.w; ch=preset.h; }
  else if(preset.mode==='cover'){ const {w,h}=preset; const scale=Math.max(w/img.width, h/img.height); const dw=img.width*scale, dh=img.height*scale; cw=w; ch=h; const canvas=document.createElement('canvas'); canvas.width=cw; canvas.height=ch; const ctx=canvas.getContext('2d'); const dx=(cw-dw)/2, dy=(ch-dh)/2; ctx.drawImage(img, dx, dy, dw, dh); return canvas; }
  else{ cw=img.width; ch=img.height; }
  const canvas=document.createElement('canvas'); canvas.width=cw; canvas.height=ch; const ctx=canvas.getContext('2d'); ctx.drawImage(img, sx, sy, sw, sh, 0, 0, cw, ch); return canvas;
}
function blobToBase64(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }

// ---------- Single image ----------
const drop=$("#drop"), file=$("#file"), thumb=$("#thumb"), imgName=$("#imgName"), imgInfo=$("#imgInfo"), imgPath=$("#imgPath");
drop.addEventListener('click', ()=>file.click());
$("#btnSelectImg").onclick=()=>file.click();
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', ()=>drop.classList.remove('dragover'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files && e.dataTransfer.files.length>1){ queueBatchFiles(e.dataTransfer.files); } else { handleFile(e.dataTransfer.files[0]); } });
file.onchange = e=>{ if(e.target.files.length>1){ queueBatchFiles(e.target.files); } else { handleFile(e.target.files[0]); } };

function handleFile(f){
  if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image(); img.onload=()=>{
      const preset=getPreset(); const canvas=drawProcessed(img, preset);
      canvas.toBlob(async blob=>{
        const folder=getTargetFolder(); const base=getFileBase(0, f.name);
        state.imgBlob=blob; state.imgW=canvas.width; state.imgH=canvas.height; state.imgName=`${base}.webp`; state.imgPath = folder + state.imgName;
        $("#image").value = (folder==='/assets/img/products/'? state.imgPath : $("#image").value || state.imgPath);
        $("#imgPreview").style.display='flex'; thumb.src=URL.createObjectURL(blob);
        imgName.textContent=state.imgName; imgInfo.textContent=`${canvas.width}×${canvas.height}, ${(blob.size/1024).toFixed(1)} KB`;
        imgPath.textContent=state.imgPath;
      }, 'image/webp', preset.q||0.82);
    }; img.src=ev.target.result;
  }; reader.readAsDataURL(f);
}
$("#btnConvert").onclick=()=>{ if(!state.imgBlob){ toast("Chưa chọn ảnh.","warn"); return; } toast("Ảnh đã được chuyển .webp theo preset.","ok"); };
$("#btnSaveImg").onclick=()=>{ if(!state.imgBlob){ toast("Chưa có ảnh.","warn"); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(state.imgBlob); a.download=state.imgName || 'image.webp'; a.click(); };
$("#btnUploadImg").onclick=async()=>{ if(!state.imgBlob){ toast("Chưa có ảnh.","warn"); return; } const s=readSettings(); if(!s.workerUrl){ toast("Chưa cấu hình Worker — dùng 'Tải ảnh' để lưu file và commit tay.","warn"); return; } const base=s.workerUrl.replace(/\/$/,''); const path=state.imgPath || (`/assets/img/products/${$("#sku").value.trim()||'mxd'}.webp`); const b64=await blobToBase64(state.imgBlob); try{ const r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ path, file:b64 })}); if(!r.ok) throw new Error(String(r.status)); toast("Đã upload ảnh (đơn).","ok"); }catch(e){ toast("Upload ảnh lỗi: "+e.message,"err"); } };

// ---------- BATCH ẢNH ----------
const batch=[]; // {type:'file'|'url', src, name:'', blob:null, w:0,h:0, status:''}
function renderBatch(){ const tb=$("#batchTable tbody"); tb.innerHTML=''; batch.forEach((it,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${idx+1}</td><td>${it.type==='file'? it.src.name : it.src}</td><td>${it.name||'-'}</td><td>${it.w?`${it.w}×${it.h}`:'-'}</td><td>${it.status||'-'}</td>`; tb.appendChild(tr); }); }
function queueBatchFiles(fileList){ Array.from(fileList).forEach(f=>batch.push({type:'file', src:f, name:'', blob:null, w:0, h:0, status:'chờ xử lý'})); renderBatch(); toast(`Đã thêm ${fileList.length} ảnh vào batch.`,'ok'); }
$("#btnAddUrls").onclick=()=>{ const lines=$("#urlList").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); lines.forEach(u=>batch.push({type:'url', src:u, name:'', blob:null, w:0, h:0, status:'chờ tải'})); renderBatch(); toast(`Đã thêm ${lines.length} URL vào batch.`,'ok'); };
$("#btnClearBatch").onclick=()=>{ batch.length=0; renderBatch(); toast("Đã xoá danh sách batch."); };
async function loadImageFromUrl(url){ try{ const r=await fetch(url, {mode:'cors'}); if(!r.ok) throw new Error('HTTP '+r.status); const blob=await r.blob(); return await blobToDataURL(blob); }catch(e){ return null; } }
function blobToDataURL(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }
async function processItem(it, idx){ try{ let dataURL=null, origName='image'; if(it.type==='file'){ origName=it.src.name||'image'; dataURL=await blobToDataURL(it.src); } else { dataURL=await loadImageFromUrl(it.src); origName=it.src.split('/').pop().split('?')[0]||'image'; if(!dataURL){ it.status='CORS blocked'; return; } } const img=await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=dataURL; im.crossOrigin='anonymous'; }); const preset=getPreset(); const canvas=drawProcessed(img, preset); const blob=await new Promise(res=>canvas.toBlob(b=>res(b),'image/webp', preset.q||0.82)); it.blob=blob; it.w=canvas.width; it.h=canvas.height; const base=getFileBase(idx, origName); it.name=`${base}.webp`; it.status='đã xử lý'; }catch(e){ it.status='lỗi xử lý'; } }
$("#btnProcessBatch").onclick=async()=>{ if(!batch.length){ toast("Danh sách batch đang trống.","warn"); return; } for(let i=0;i<batch.length;i++){ await processItem(batch[i], i); renderBatch(); } toast("Đã xử lý xong batch theo preset.","ok"); };
$("#btnUploadBatch").onclick=async()=>{ if(!batch.length){ toast("Danh sách batch đang trống.","warn"); return; } const s=readSettings(); if(!s.workerUrl){ toast("Chưa cấu hình Worker — dùng 'Tải TẤT CẢ' để tải về máy.","warn"); return; } const base=s.workerUrl.replace(/\/$/,''); const folder=getTargetFolder(); for(let i=0;i<batch.length;i++){ const it=batch[i]; if(!it.blob){ await processItem(it,i); renderBatch(); if(!it.blob) continue; } const path= (folder + it.name).replace(/\/+/g,'/').replace(/^(?!\/)/,'/'); try{ const b64=await blobToBase64(it.blob); const r=await fetch(base+"/upload-image",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify({ path, file:b64 })}); if(!r.ok) throw new Error(String(r.status)); it.status='uploaded → '+path; }catch(e){ it.status='upload lỗi: '+e.message; } renderBatch(); } toast("Batch upload hoàn tất (xem cột Trạng thái).","ok"); };
$("#btnDownloadBatch").onclick=async()=>{ if(!batch.length){ toast("Danh sách batch đang trống.","warn"); return; } for(let i=0;i<batch.length;i++){ const it=batch[i]; if(!it.blob){ await processItem(it,i); } if(it.blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(it.blob); a.download=it.name||`image-${i+1}.webp`; a.click(); it.status='đã tải về'; }else{ it.status='lỗi xử lý'; } renderBatch(); } toast("Đã tải toàn bộ ảnh (.webp) về máy.","ok"); };

// ---------- JSON (đơn) ----------
function buildJson(){
  if (!$("#category").value.trim()){ const text=`${$("#name").value} ${$("#brand").value} ${$("#origin").value}`; const guess=autoCategory(text); if (guess) $("#category").value=guess; }
  $("#category").value=normCategory($("#category").value);
  const now=new Date().toISOString();
  const obj={ name:$("#name").value.trim(), price:Number($("#price").value||0), origin:cleanUrl($("#origin").value.trim()),
    merchant:$("#merchant").value, sku:$("#sku").value.trim(), image:$("#image").value.trim(), category:$("#category").value.trim(),
    brand:$("#brand").value.trim(), featured:$("#featured").checked, status:$("#status").checked, updated_at:now };
  const dl=$("#deeplink").value.trim(); if(dl) obj.deeplink=dl;
  $("#jsonOut").value=JSON.stringify([obj], null, 2); return obj;
}
$("#btnToJson").onclick=buildJson;
$("#btnCopyJson").onclick=()=>{ $("#jsonOut").select(); document.execCommand('copy'); toast("Đã copy JSON."); };
$("#btnDownloadJson").onclick=()=>{ if(!$("#jsonOut").value) buildJson(); const blob=new Blob([$("#jsonOut").value], {type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click(); };

// ---------- Commit message ----------
$("#btnGenCommit").onclick=()=>{ const sku=$("#sku").value.trim()||'sku'; const msg=`feat(data): add/update ${sku} (+images) via importer 4.3.8`; $("#commitMsg").value=msg; };

// ---------- Publish (đơn) ----------
$("#btnPublish").onclick=()=>doPublish(false);
$("#btnPublishFeatured").onclick=()=>doPublish(true);
async function doPublish(forceFeatured){
  const obj=buildJson(); if(forceFeatured){ obj.featured=true; $("#featured").checked=true; $("#jsonOut").value=JSON.stringify([obj],null,2); }
  if(!obj.sku){ toast("Thiếu SKU.","err"); return; }
  if(!obj.origin){ toast("Thiếu origin.","warn"); return; }
  if(!$("#deeplink").value.trim()){ makeDeeplink(); const dl=$("#deeplink").value.trim(); if(dl){ obj.deeplink=dl; $("#jsonOut").value=JSON.stringify([obj],null,2); } }
  validateDeeplink();
  const s=readSettings();
  if(s.workerUrl){
    try{ const r=await fetch(s.workerUrl.replace(/\/$/,'')+"/publish",{method:"POST",mode:"cors",headers:hdr(),body:JSON.stringify(obj)}); if(!r.ok) throw new Error('HTTP '+r.status);
      toast("Publish OK → store"+(obj.featured?" + nổi bật":""),"ok"); window.scrollTo({top:0,behavior:'smooth'}); return;
    }catch(e){ toast("Publish lỗi (sẽ tải JSON để commit tay): "+e.message,"err"); }
  }
  const blob=new Blob([JSON.stringify([obj],null,2)], {type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click();
}

// ---------- Verify on Store ----------
$("#btnVerify").onclick=async()=>{
  const sku=$("#sku").value.trim(); if(!sku){ toast("Chưa có SKU để kiểm tra.","warn"); return; }
  try{ const r=await fetch('/affiliates.json?_='+Date.now(), {cache:'no-cache'}); const arr=await r.json();
    const found=(Array.isArray(arr)?arr:(arr.items||[])).some(x=> (String(x.sku||'').toLowerCase())===sku.toLowerCase());
    toast(found?"ĐÃ CÓ trong affiliates.json.":"CHƯA THẤY trong affiliates.json.", found?"ok":"warn");
  }catch(e){ toast("Không đọc được affiliates.json: "+e.message, "err"); }
  const url=`/store.html?dev=1&sku=${encodeURIComponent(sku)}&v=${Date.now()}`; window.open(url,'_blank');
};

// ======== BATCH LINK GỐC → JSON / PUBLISH ========
const originBatch=[];
function renderOriginTable(){ const tb=$("#originTable tbody"); tb.innerHTML=''; originBatch.forEach((x,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${x.merchant}</td><td>${x.name||'-'}</td><td>${x.sku}</td><td>${x.category}</td><td>${x.deeplink?'OK':'-'}</td><td>${x._status||'-'}</td>`; tb.appendChild(tr); }); }

// heuristics
function merchantFromUrl(u){ try{ const h=new URL(u).hostname; if(/shopee\.vn/i.test(h)) return 'shopee'; if(/lazada\.vn/i.test(h)) return 'lazada'; if(/tiki\.vn/i.test(h)) return 'tiki'; if(/tiktok\.com/i.test(h)) return 'tiktok'; }catch{} return 'unknown'; }
function extractNameFromUrl(u){
  try{
    const url=new URL(u); let seg=decodeURIComponent(url.pathname.split('/').filter(Boolean).pop()||'');
    seg=seg.replace(/\.html?$/i,'');
    seg=seg.replace(/-i\.\d+\.\d+$/,'');      // Shopee tail
    seg=seg.replace(/-[0-9A-Za-z]+$/,'');     // Lazada tail like -s123 / -i123
    seg=seg.replace(/[_\-]+/g,' ').trim();
    if(!seg) seg=decodeURIComponent(url.hostname);
    return seg;
  }catch{ return 'Sản phẩm'; }
}
function uniqueSku(base, seen){ let s=slugify(base)||'item'; if(!seen.has(s)) return s; let i=2; while(seen.has(`${s}-${i}`)) i++; return `${s}-${i}`; }
function dlFor(origin, sku, merchant){
  const tpl=activeTplFor(merchant); const subs=computeSubs(sku, merchant||'merchant');
  let link=tpl.replace(/\{url\}/g, encodeURIComponent(origin)).replace(/\{sku\}/g, sku||'sku').replace(/\{sub1\}/g, subs.sub1).replace(/\{sub2\}/g, subs.sub2).replace(/\{sub3\}/g, subs.sub3).replace(/\{sub4\}/g, subs.sub4);
  return ensureSubsInUrl(link, subs);
}

$("#btnParseOrigins").onclick=()=>{
  const raw=$("#originBatchInput").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!raw.length){ toast("Danh sách URL trống.","warn"); return; }
  originBatch.length=0;
  const seen=new Set();
  const defBrand=($("#batchBrand").value||'').trim();
  const defCatNorm=normCategory($("#batchCategory").value||'');
  raw.forEach((u)=>{
    const origin=cleanUrl(u);
    const merchant=merchantFromUrl(origin);
    const name=extractNameFromUrl(origin);
    const sku=uniqueSku(name, seen); seen.add(sku);
    const image=`/assets/img/products/${sku}.webp`;
    const guessCat=autoCategory(name) || defCatNorm || '';
    const category=guessCat? guessCat : '';
    const deeplink = (/shopee\.vn|lazada\.vn/i.test(origin)) ? dlFor(origin, sku, merchant) : '';
    const obj={
      name, price:0, origin, merchant, sku, image,
      category: category || 'phu-kien',
      brand: defBrand, featured: !!$("#batchFeatured").checked, status: true,
      updated_at: new Date().toISOString(),
      deeplink
    };
    originBatch.push(obj);
  });
  renderOriginTable();
  $("#jsonOut").value = JSON.stringify(originBatch, null, 2);
  toast(`Đã phân tích ${originBatch.length} URL.`, 'ok');
};

$("#btnGenJsonFromOrigins").onclick=()=>{
  if(!originBatch.length){ toast("Chưa có dữ liệu batch. Bấm 'Phân tích URL' trước.","warn"); return; }
  $("#jsonOut").value = JSON.stringify(originBatch, null, 2);
  toast("Đã tạo JSON từ danh sách link gốc.", "ok");
};

$("#btnPublishOrigins").onclick=async()=>{
  if(!originBatch.length){ toast("Danh sách batch trống.","warn"); return; }
  const s=readSettings(); if(!s.workerUrl){ toast("Chưa cấu hình Worker. Không thể publish hàng loạt.","err"); return; }
  const base=s.workerUrl.replace(/\/$/,'');
  for(let i=0;i<originBatch.length;i++){
    const item=originBatch[i];
    try{
      if(!item.deeplink && /shopee\.vn|lazada\.vn/i.test(item.origin)){
        item.deeplink = dlFor(item.origin, item.sku, item.merchant);
      }
      const r=await fetch(base + "/publish", {method:"POST", mode:"cors", headers:hdr(), body:JSON.stringify(item)});
      if(!r.ok) throw new Error('HTTP '+r.status);
      item._status='published';
    }catch(e){
      item._status='lỗi: '+e.message;
    }
    renderOriginTable();
  }
  $("#jsonOut").value = JSON.stringify(originBatch, null, 2);
  toast("Publish hàng loạt hoàn tất.", "ok");
};

$("#btnClearOrigins").onclick=()=>{ originBatch.length=0; renderOriginTable(); toast("Đã xoá danh sách link gốc."); };

// ---------- Verify (đơn) ----------
$("#origin").addEventListener('input', ()=>$("#originOut").value=cleanUrl($("#origin").value));
runDiag();
</script>
</body>
</html>
