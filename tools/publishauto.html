<!-- REPLACE WHOLE FILE: /ops/importer.html -->
<!doctype html>
<html lang="vi">
<head>
  <!-- √Åp d·ª•ng MXD210 ‚Äî Quy chu·∫©n v2025-09-24 -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>MXD Importer v4.4.1 ‚Äî Multi-format + Size Presets + Auto-Compress + TikTok/Tiki + ClearAll + Shortlink</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#0b0f14;--fg:#e8f0fb;--muted:#a7b4c2;--b:#152132;--accent:#7cc4ff;
      --ok:#34d399;--warn:#f59e0b;--err:#ef4444;--toast-bottom: max(12px, env(safe-area-inset-bottom));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:16px 0 8px}
    h1{font-size:20px}
    h2{font-size:16px;color:#cfe5ff}
    a{color:#7cc4ff}
    .wrap{max-width:1160px;margin:0 auto;padding:16px; padding-bottom:120px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid #223348;border-radius:12px;padding:14px}
    label{display:block;font-weight:700;margin:8px 0 6px;color:#cfe5ff}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3b52;background:#0f1622;color:var(--fg)}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .small{font-size:12px;color:#a7b4c2}
    .btn{cursor:pointer;border:1px solid #2b3b52;background:#102235;min-height:44px}
    .btn:hover{background:#132a43}
    .btn.primary{background:#0b3a5e;border-color:#0b3a5e}
    .btn.primary:hover{background:#0d4570}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3b55;color:#a4bee8}
    .ok{color:#34d399} .warn{color:#f59e0b} .err{color:#ef4444}
    .deeplink-box{border:2px dashed #2f4666;border-radius:12px;padding:10px;background:#0c1623}
    .deeplink-text{font-size:13px;font-weight:600}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,#0b0f14 60%,#0b0f1400);padding:12px;border-top:1px solid #1b2a3f;z-index:9}
    .drop{border:2px dashed #3a5270;border-radius:12px;padding:16px;text-align:center;background:#0c1623;touch-action:manipulation}
    .drop.dragover{border-color:#8ab9ff;background:#0f1e32}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #27405e}
    .toast{position:fixed;right:12px;bottom:var(--toast-bottom);display:none;max-width:520px;background:#122232;border:1px solid #2b425e;border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;z-index:99999;pointer-events:none}
    .toast.show{display:block}
    code.inline{background:#0e1622;border:1px solid #223449;border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;border:1px solid #2b3b52;border-radius:999px;padding:2px 8px;font-size:11px;color:#a4bee8}

    /* Batch queue */
    .table-wrap{overflow-x:auto}
    table.queue{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:900px}
    table.queue th, table.queue td{font-size:13px;vertical-align:middle}
    table.queue th{color:#cfe5ff;text-align:left;padding:6px 8px}
    table.queue td{background:#0d1826;border:1px solid #23364b;padding:6px 8px}
    table.queue td:first-child{border-radius:10px 0 0 10px}
    table.queue td:last-child{border-radius:0 10px 10px 0}
    .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid #27405e;background:#0a1320}
    .mini{display:flex;gap:6px;align-items:center}
    .w-auto{width:auto}
    .nowrap{white-space:nowrap}
    .btn.sm{padding:6px 10px;border-radius:8px;min-height:34px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .status{font-size:12px}
    .muted{color:#8fa5bd}

    /* Clear buttons */
    .input-wrap{position:relative;width:100%}
    .input-wrap > input, .input-wrap > textarea{padding-right:40px}
    .clear-btn{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:28px; height:28px; border-radius:8px;
      border:1px solid #ff8585; background:#2b0f12; color:#ffd1d1;
      display:grid; place-items:center; font-weight:900; line-height:1;
      box-shadow:0 0 0 1px #590e0e inset;
    }
    .input-wrap.textarea .clear-btn{ top:10px; transform:none }

    /* Image options */
    .opts{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .opts .span2{grid-column:span 2}
    .opts .span4{grid-column:span 4}
    .range{display:flex;gap:8px;align-items:center}
    .range input[type=range]{flex:1}
    .helpbox{background:#0c1623;border:1px solid #2b3b52;border-radius:10px;padding:8px}

    /* Mobile tweaks */
    @media (max-width:820px){
      .g2{grid-template-columns:1fr}
      .preview img{width:80px;height:80px}
      .sticky-actions{padding-bottom:calc(env(safe-area-inset-bottom) + 12px)}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>MXD Importer v4.4.1 <span class="pill">Multi-format</span> <span class="pill">Size Presets</span> <span class="pill">Auto-Compress</span> <span class="pill">TikTok/Tiki</span> <span class="pill">Shortlink</span></h1>
  <div class="small">B·∫£n v√° t∆∞∆°ng th√≠ch di ƒë·ªông/in-app: b·ªè c√∫ ph√°p ‚Äú?.‚Äú, ƒë·∫£m b·∫£o bind s·ª± ki·ªán ƒë√∫ng, th√™m b·∫Øt l·ªói hi·ªÉn th·ªã r√µ r√†ng, t·ªëi ∆∞u click/touch.</div>

  <div class="card">
    <h2>1) C√†i ƒë·∫∑t (l∆∞u v√†o tr√¨nh duy·ªát)</h2>
    <div class="grid g2">
      <div><label>Worker Base URL</label><input id="workerUrl" placeholder="https://mxd210.mxd6686.workers.dev" inputmode="url" autocomplete="url"/></div>
      <div><label>X-Key (header b·∫£o v·ªá Worker)</label><input id="xKey" placeholder="V√≠ d·ª•: mxd210-secret-key" autocomplete="off"/></div>

      <div><label>Shopee template</label><input id="tplShopee" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
      <div><label>Lazada template</label><input id="tplLazada" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
      <div><label>Tiki template</label><input id="tplTiki" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
      <div><label>TikTok template</label><input id="tplTiktok" placeholder="https://go.isclix.com/deep_link/ID/ID?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">üíæ L∆∞u c√†i ƒë·∫∑t</button>
      <button class="btn" id="btnLoadSettings">‚Üª T·∫£i l·∫°i</button>
      <button class="btn" id="btnClearSettings">üóë X√≥a c√†i ƒë·∫∑t</button>
      <span class="small" id="settingsStatus" aria-live="polite"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCheckWorker">Ki·ªÉm tra Worker</button>
      <button class="btn" id="btnCheckAuth">Ki·ªÉm tra X-Key</button>
      <button class="btn" id="btnCheckWrite">Ki·ªÉm tra quy·ªÅn commit</button>
      <button class="btn" id="btnTestUpload">Test upload 1√ó1</button>
      <span class="small" id="workerStatus" aria-live="polite"></span>
    </div>
  </div>

  <div class="grid g2">
    <div class="card">
      <h2>2) ·∫¢nh s·∫£n ph·∫©m (ƒë∆°n l·∫ª)</h2>
      <div id="drop" class="drop" role="button" tabindex="0" aria-label="Ch·ªçn ho·∫∑c k√©o th·∫£ ·∫£nh">K√©o <b>m·ªôt ho·∫∑c nhi·ªÅu</b> ·∫£nh v√†o ƒë√¢y ho·∫∑c ch·∫°m ƒë·ªÉ ch·ªçn‚Ä¶</div>
      <input type="file" id="file" accept="image/*" multiple style="display:none"/>

      <div class="opts" style="margin-top:10px">
        <div>
          <label>ƒê·ªãnh d·∫°ng xu·∫•t</label>
          <select id="defaultFmt">
            <option value="webp">webp</option>
            <option value="png">png</option>
            <option value="jpg">jpg</option>
          </select>
        </div>
        <div>
          <label>Preset k√≠ch th∆∞·ªõc</label>
          <select id="sizePreset">
            <option value="max">C·∫°nh d√†i (m·∫∑c ƒë·ªãnh)</option>
            <option value="square1200">Vu√¥ng 1200√ó1200</option>
            <option value="icon400">Icon 400√ó400</option>
            <option value="og">OG 1200√ó630</option>
            <option value="custom">Tu·ª≥ ch·ªânh W√óH</option>
          </select>
        </div>
        <div>
          <label>Max side / Width</label>
          <input id="optW" type="number" value="1200" min="64" max="4096" inputmode="numeric"/>
        </div>
        <div>
          <label>Height (n·∫øu d√πng W√óH)</label>
          <input id="optH" type="number" value="1200" min="64" max="4096" inputmode="numeric"/>
        </div>

        <div class="span2">
          <label>Ch·∫•t l∆∞·ª£ng (0.4‚Äì0.95)</label>
          <div class="range">
            <input id="quality" type="range" min="0.4" max="0.95" step="0.01" value="0.82"/>
            <input id="qualityNum" type="number" min="0.4" max="0.95" step="0.01" value="0.82" style="width:110px"/>
          </div>
        </div>
        <div class="span2">
          <label>Auto-compress ‚â§ (KB, 0 = t·∫Øt)</label>
          <div class="range">
            <input id="targetKB" type="range" min="0" max="512" step="8" value="0"/>
            <input id="targetKBNum" type="number" min="0" max="2048" step="10" value="0" style="width:110px"/>
          </div>
        </div>

        <div class="span2">
          <label>Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFolder">
            <option value="/assets/img/products/">/assets/img/products/ ‚Äî ·∫¢nh s·∫£n ph·∫©m</option>
            <option value="/assets/img/categories/">/assets/img/categories/ ‚Äî ·∫¢nh danh m·ª•c</option>
            <option value="/assets/img/og/">/assets/img/og/ ‚Äî ·∫¢nh chia s·∫ª (OG)</option>
            <option value="/assets/img/brands/">/assets/img/brands/ ‚Äî Logo/Brand</option>
            <option value="custom">T·ª± nh·∫≠p‚Ä¶</option>
          </select>
        </div>
        <div class="span2" id="defaultCustomWrap" style="display:none">
          <label>ƒê∆∞·ªùng d·∫´n tu·ª≥ ch·ªânh (k·∫øt th√∫c b·∫±ng /)</label>
          <input id="defaultCustomPath" placeholder="/assets/img/icons/"/>
        </div>
        <div class="span4 helpbox" id="folderHelp">
          <div><b>Ghi ch√∫:</b> <code>/assets/img/products/</code> d√πng cho ·∫£nh s·∫£n ph·∫©m; <code>/assets/img/categories/</code> cho ·∫£nh ƒë·∫°i di·ªán danh m·ª•c; <code>/assets/img/og/</code> cho ·∫£nh chia s·∫ª MXH (OG 1200√ó630); <code>/assets/img/brands/</code> cho logo.</div>
        </div>
        <div class="span4">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="cbUseFilename" checked style="width:auto"/>
            D√πng <b>t√™n file</b> n·∫øu <b>SKU tr·ªëng</b>
          </label>
        </div>
      </div>

      <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
        <img id="thumb" alt="preview"/>
        <div class="small">
          <div><b>T√™n file ƒë·ªÅ xu·∫•t:</b> <code class="inline" id="imgName">-</code></div>
          <div><b>K√≠ch th∆∞·ªõc:</b> <span id="imgInfo">-</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSelectImg">Ch·ªçn ·∫£nh</button>
        <button class="btn" id="btnConvert">Convert/N√©n</button>
        <button class="btn" id="btnSaveImg">T·∫£i ·∫£nh</button>
        <button class="btn primary" id="btnUploadImg">Upload ·∫£nh</button>
        <button class="btn" id="btnQueueCurrent">‚ûï Th√™m ·∫£nh hi·ªán t·∫°i v√†o h√†ng ƒë·ª£i</button>
      </div>
      <div class="small">Preset g·ª£i √Ω: Product vu√¥ng 1200, Icon 400, OG 1200√ó630. PNG/WebP gi·ªØ n·ªÅn trong su·ªët; JPG s·∫Ω l√≥t n·ªÅn tr·∫Øng khi c·∫ßn.</div>
    </div>

    <div class="card">
      <h2>3) Th√¥ng tin s·∫£n ph·∫©m</h2>
      <div class="grid">
        <div class="row">
          <div><label>T√™n s·∫£n ph·∫©m</label><input id="name" data-clear placeholder="V√≠ d·ª•: Dekton DK-AG950S"/></div>
          <div><label>SKU (b·∫Øt bu·ªôc cho publish; c√≥ th·ªÉ tr·ªëng khi ch·ªâ upload ·∫£nh)</label><input id="sku" data-clear placeholder="dekton-dk-ag950s"/></div>
        </div>
        <div class="row">
          <div><label>Gi√° (VND, kh√¥ng ch·∫•m)</label><input id="price" data-clear type="number" placeholder="399000" inputmode="numeric"/></div>
          <div>
            <label>Merchant</label>
            <select id="merchant">
              <option value="shopee">shopee</option>
              <option value="lazada">lazada</option>
              <option value="tiki">tiki</option>
              <option value="tiktok">tiktok</option>
            </select>
          </div>
        </div>
        <div><label>Link g·ªëc (origin)</label><input id="origin" data-clear placeholder="https://shopee.vn/‚Ä¶ | https://tiki.vn/‚Ä¶ | https://www.tiktok.com/‚Ä¶"/></div>
        <div class="row">
          <div><label>·∫¢nh (ƒë∆∞·ªùng d·∫´n)</label><input id="image" data-clear placeholder="/assets/img/products/dekton-dk-ag950s.webp"/></div>
          <div><label>Danh m·ª•c (category)</label><input id="category" data-clear placeholder="may-khoan-duc-vit / may-cat / phu-kien-may"/></div>
        </div>
        <div><label>Th∆∞∆°ng hi·ªáu (brand)</label><input id="brand" data-clear placeholder="dekton, bosch, makuta‚Ä¶"/></div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="featured" style="width:auto"/> N·ªïi b·∫≠t (featured)</label>
          <label style="display:flex;align-items:center;gap:8px;flex:unset"><input type="checkbox" id="status" checked style="width:auto"/> Hi·ªÉn th·ªã (status)</label>
          <button class="btn" id="btnAuto">ƒêi·ªÅn auto t·ª´ t√™n</button>
          <button class="btn" id="btnClearAllFields">üßπ Xo√° t·∫•t c·∫£</button>
        </div>
        <div id="diag" class="small" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- MXD-ANCHOR: DEEPLINK -->
  <div class="card deeplink-box">
    <h2>4) Deep-link & Short-link</h2>
    <div class="grid g2">
      <div>
        <label>Origin (ƒë√£ nh·∫≠p)</label>
        <textarea id="originOut" class="deeplink-text" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOrigin">Copy Origin</button>
          <button class="btn" id="openOrigin">M·ªü Origin</button>
        </div>
      </div>
      <div>
        <label>Affiliate deep-link</label>
        <div class="input-wrap textarea">
          <textarea id="deeplink" data-clear class="deeplink-text" placeholder="T·ª± sinh t·ª´ template ho·∫∑c d√°n s·∫µn t·∫°i ƒë√¢y"></textarea>
          <button class="clear-btn" title="Xo√°" aria-label="Xo√°" type="button">√ó</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnMakeDeeplink">T·∫°o t·ª´ template</button>
          <button class="btn" id="copyDeeplink">Copy Deep-link</button>
          <button class="btn" id="btnOpenDeeplink">M·ªü Deep-link</button>
          <span id="dlCheck" class="badge" aria-live="polite">‚Äì</span>
        </div>
        <div style="margin-top:10px">
          <label>Link r√∫t g·ªçn (tu·ª≥ n·ªÅn t·∫£ng ho·∫∑c do Worker t·∫°o)</label>
          <div class="row">
            <input id="shortlink" placeholder="https://shope.ee/XXXX | https://s.lazada.vn/XXXX | do Worker tr·∫£ v·ªÅ"/>
            <button class="btn" id="btnMakeShort">T·∫°o link r√∫t g·ªçn (Worker)</button>
            <button class="btn" id="btnCopyShort">Copy Short-link</button>
          </div>
          <div class="small muted">Ghi ch√∫: t·∫°o r√∫t g·ªçn g·ªëc (shope.ee / s.lazada.vn / tiki / tiktok) c·∫ßn Worker h·ªó tr·ª£ API t∆∞∆°ng ·ª©ng. N·∫øu Worker ch∆∞a c√≥, ƒëi·ªÅn tay ho·∫∑c d√πng shortlink ri√™ng.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MXD-ANCHOR: QUEUE-SECTION -->
  <div class="card">
    <h2>2b) H√†ng ƒë·ª£i ·∫£nh (nhi·ªÅu ·∫£nh)</h2>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" id="btnConvertAll">Convert t·∫•t c·∫£</button>
      <button class="btn" id="btnDownloadAll">T·∫£i t·∫•t c·∫£</button>
      <button class="btn" id="btnUploadAll">Upload t·∫•t c·∫£</button>
      <button class="btn" id="btnClearQueue">üßπ Xo√° h√†ng ƒë·ª£i</button>
      <span class="small muted">D√πng khi ƒë√£ th√™m nhi·ªÅu ·∫£nh v√†o h√†ng ƒë·ª£i.</span>
    </div>
    <div class="table-wrap">
      <table class="queue" aria-describedby="queueHelp">
        <thead>
          <tr>
            <th>·∫¢nh</th><th>T√™n</th><th>Th∆∞ m·ª•c</th><th>ƒê·ªãnh d·∫°ng</th><th>ƒê∆∞·ªùng d·∫´n</th><th>K√≠ch th∆∞·ªõc</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="queueBody">
          <tr><td colspan="8" class="muted">Ch∆∞a c√≥ g√¨ trong h√†ng ƒë·ª£i.</td></tr>
        </tbody>
      </table>
    </div>
    <div id="queueHelp" class="small muted" style="margin-top:6px">G·ª£i √Ω: th√™m ·∫£nh b·∫±ng c√°ch k√©o nhi·ªÅu file v√†o khu v·ª±c ·ªü m·ª•c 2) ho·∫∑c n√∫t ‚Äú‚ûï Th√™m ·∫£nh hi·ªán t·∫°i v√†o h√†ng ƒë·ª£i‚Äù.</div>
  </div>

  <div class="card">
    <h2>5) JSON xu·∫•t b·∫£n</h2>
    <textarea id="jsonOut" rows="8" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">T·∫°o JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">T·∫£i affiliates.append.json</button>
    </div>
  </div>

  <div class="card">
    <h2>6) Worker Debug</h2>
    <div class="row">
      <button class="btn" id="btnProbeOptions">Probe OPTIONS /upload-image</button>
      <button class="btn" id="btnProbePublish">Probe OPTIONS /publish</button>
      <span class="small muted">Log d∆∞·ªõi ƒë√¢y gi√∫p ph√¢n bi·ªát: CORS / Auth / Payload.</span>
    </div>
    <div id="debugLog" class="debug-log" aria-live="polite">‚Äì</div>
  </div>

  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish ‚Üí Store</button>
    <button class="btn" id="btnPublishFeatured">Publish ‚Üí N·ªïi b·∫≠t</button>
    <button class="btn" id="btnVerify">‚úÖ Ki·ªÉm tra tr√™n Store</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
</div>

<script>
(function(){
  // ===== Safe helpers (KH√îNG d√πng ?. ƒë·ªÉ t∆∞∆°ng th√≠ch in-app) =====
  function byId(id){ return document.getElementById(id); }
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return document.querySelectorAll(sel); }
  function text(el, s){ if(el){ el.textContent = s; } }
  function val(el){ return el ? (el.value || '') : ''; }
  function setVal(el, v){ if(el){ el.value = v; } }
  function hasText(s){ return (s||'').trim().length>0; }

  // Toast + debug
  function toast(msg, cls){
    var t = byId('toast'); if(!t) return;
    t.textContent = msg;
    t.className = 'toast show ' + (cls||'');
    setTimeout(function(){ if(t.classList.contains('show')) t.className='toast'; }, 4500);
  }
  function log(msg){
    var d = byId('debugLog'); if(!d) return;
    var old = (d.textContent && d.textContent !== '‚Äì') ? (d.textContent + "\n") : "";
    d.textContent = old + msg;
    d.scrollTop = d.scrollHeight;
  }

  // Bind (KH√îNG √©p passive:true cho click)
  function bind(id, ev, fn, opts){
    var el = byId(id); if(!el){ try{ log('[bind] thi·∫øu #' + id); }catch(_){}
      return false;
    }
    el.addEventListener(ev, fn, opts || false);
    return true;
  }

  // Clipboard helper
  function copyText(txt){
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt||'').then(function(){ toast('ƒê√£ copy.','ok'); })
          .catch(function(){ fallbackCopy(txt); });
      }else{ fallbackCopy(txt); }
    }catch(_){ fallbackCopy(txt); }
  }
  function fallbackCopy(txt){
    var ta = document.createElement('textarea');
    ta.value = txt || '';
    document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); }catch(_){}
    document.body.removeChild(ta);
    toast('ƒê√£ copy.','ok');
  }

  // SETTINGS
  var LS_KEY = 'MXD_IMPORTER_SETTINGS_V441';
  var DEFAULT_TPL_SHOPEE='https://go.isclix.com/deep_link/6803097511817356947/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
  var DEFAULT_TPL_LAZADA='https://go.isclix.com/deep_link/6803097511817356947/5127144557053758578?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
  var DEFAULT_TPL_TIKI   ='https://go.isclix.com/deep_link/6803097511817356947/4348614231480407268?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
  var DEFAULT_TPL_TIKTOK ='https://go.isclix.com/deep_link/6803097511817356947/6648523843406889655?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';

  function readSettings(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch(_){ return {}; }
  }
  function writeSettings(s){
    localStorage.setItem(LS_KEY, JSON.stringify(s));
  }
  function uiToSettings(){
    return {
      workerUrl: val(byId('workerUrl')).trim(),
      xKey:      val(byId('xKey')).trim(),
      tplShopee: val(byId('tplShopee')).trim(),
      tplLazada: val(byId('tplLazada')).trim(),
      tplTiki:   val(byId('tplTiki')).trim(),
      tplTiktok: val(byId('tplTiktok')).trim()
    };
  }
  function settingsToUi(s){
    setVal(byId('workerUrl'), s.workerUrl||'');
    setVal(byId('xKey'), s.xKey||'');
    setVal(byId('tplShopee'), s.tplShopee||'');
    setVal(byId('tplLazada'), s.tplLazada||'');
    setVal(byId('tplTiki'), s.tplTiki||'');
    setVal(byId('tplTiktok'), s.tplTiktok||'');
  }
  function saveSettings(){
    var cur = readSettings();
    var out = Object.assign(cur, uiToSettings());
    writeSettings(out);
    text(byId('settingsStatus'), 'ƒê√£ l∆∞u.');
    toast('ƒê√£ l∆∞u c√†i ƒë·∫∑t.','ok');
  }
  function loadSettings(){
    var s = readSettings();
    settingsToUi(s);
    if(!hasText(val(byId('tplShopee')))) setVal(byId('tplShopee'), DEFAULT_TPL_SHOPEE);
    if(!hasText(val(byId('tplLazada')))) setVal(byId('tplLazada'), DEFAULT_TPL_LAZADA);
    if(!hasText(val(byId('tplTiki'))))   setVal(byId('tplTiki'),   DEFAULT_TPL_TIKI);
    if(!hasText(val(byId('tplTiktok')))) setVal(byId('tplTiktok'), DEFAULT_TPL_TIKTOK);
    text(byId('settingsStatus'), 'ƒê√£ t·∫£i c√†i ƒë·∫∑t.');
  }

  // Worker checks
  function hdr(){
    var s = readSettings(); var h = {'content-type':'application/json'};
    if(s.xKey) h['x-key'] = s.xKey;
    return h;
  }
  function simpleGet(url, cb){
    try{
      fetch(url,{mode:'cors',headers:hdr()})
        .then(function(r){ return r.text().then(function(t){ cb({ok:r.ok,status:r.status,text:t}); }); })
        .catch(function(e){ cb({ok:false,status:-1,text:String(e)}); });
    }catch(e){ cb({ok:false,status:-1,text:String(e)}); }
  }

  // Slug + small utils
  function slugify(s){
    return String(s||'').toString()
      .normalize ? String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'') : String(s)
      .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }
  function sanitizeFolder(p){
    if(!p) return '/assets/img/';
    p = String(p).trim();
    if(p.charAt(0)!=='/') p='/'+p;
    if(p.charAt(p.length-1)!=='/') p+='/';
    return p;
  }
  function getExt(fmt){ return fmt==='jpg'?'jpg':(fmt==='png'?'png':'webp'); }

  // Category guess (r√∫t g·ªçn cho b·∫£n v√°)
  function normCategory(raw){
    var s = (raw||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'');
    if(/^may-?cat|may-mai|may-cat-(sat|gach)$/.test(s)) return 'may-cat';
    if(/^may-?khoan|khoan-bua|impact/.test(s)) return 'may-khoan-duc-vit';
    if(/^phu-?kien/.test(s)) return 'phu-kien-may';
    return s;
  }

  // ===== Image processing =====
  function updateFolderHelp(){
    var sel = byId('defaultFolder'), box = byId('folderHelp');
    if(!sel || !box) return;
    var v = val(sel);
    if(v==='custom'){
      box.innerHTML = '<b>Ghi ch√∫:</b> ƒê∆∞·ªùng d·∫´n tu·ª≥ ch·ªânh ‚Äî v√≠ d·ª• <code>/assets/img/icons/</code> cho favicon/app icons.';
      byId('defaultCustomWrap').style.display='block';
    }else{
      byId('defaultCustomWrap').style.display='none';
      var map={
        "/assets/img/products/":"·∫¢nh s·∫£n ph·∫©m; hi·ªÉn th·ªã trong trang chi ti·∫øt, danh s√°ch s·∫£n ph·∫©m.",
        "/assets/img/categories/":"·∫¢nh ƒë·∫°i di·ªán c·ªßa danh m·ª•c (collection).",
        "/assets/img/og/":"·∫¢nh chia s·∫ª MXH (Open Graph). Khuy√™n d√πng 1200√ó630, JPG/WebP.",
        "/assets/img/brands/":"Logo th∆∞∆°ng hi·ªáu/website. PNG/WebP gi·ªØ n·ªÅn trong su·ªët."
      };
      box.innerHTML = '<b>Ghi ch√∫:</b> ' + (map[v]||'');
    }
    updateSingleUploadCta();
  }
  function getSelectedFolder(){
    var sel = byId('defaultFolder'); if(!sel) return '/assets/img/';
    if(val(sel)==='custom'){
      var p = val(byId('defaultCustomPath'));
      return sanitizeFolder(p||'/assets/img/');
    }
    return sanitizeFolder(val(sel));
  }
  function getSelectedFmt(){
    var el = byId('defaultFmt'); return (el ? val(el).toLowerCase() : 'webp');
  }
  function updateSingleUploadCta(){
    var b = byId('btnUploadImg'); if(!b) return;
    var folder = getSelectedFolder();
    var sku = slugify(val(byId('sku'))||'<sku>');
    var ext = getExt(getSelectedFmt());
    b.textContent = 'Upload ·∫£nh ‚Üí ' + folder + sku + '.' + ext;
  }
  function getImageOpts(){
    var preset = val(byId('sizePreset'));
    var w = Number(val(byId('optW'))||1200);
    var h = Number(val(byId('optH'))||1200);
    if(preset==='square1200'){ w=1200; h=1200; }
    if(preset==='icon400'){ w=400; h=400; }
    if(preset==='og'){ w=1200; h=630; }
    var fmt = getSelectedFmt();
    var q = Number(val(byId('quality'))||0.82);
    var targetKB = Number(val(byId('targetKBNum'))||0);
    return {preset:preset,w:w,h:h,fmt:fmt,q:q,targetKB:targetKB};
  }
  function dataURLFromBlob(blob, cb){
    var fr = new FileReader();
    fr.onload = function(){ cb(fr.result); };
    fr.readAsDataURL(blob);
  }
  function resizeContainToBlob(img, opts, cb){
    var outW,outH,canvasW,canvasH;
    if(opts.preset==='max'){
      var maxSide = opts.w||1200;
      var scale = Math.min(1, maxSide/Math.max(img.width, img.height));
      outW = Math.round(img.width*scale); outH = Math.round(img.height*scale);
      canvasW = outW; canvasH = outH;
    }else{
      canvasW = opts.w; canvasH = opts.h;
      var scale2 = Math.min(canvasW/img.width, canvasH/img.height);
      outW = Math.round(img.width*scale2); outH = Math.round(img.height*scale2);
    }
    var c = document.createElement('canvas'); c.width=canvasW; c.height=canvasH;
    var ctx = c.getContext('2d');
    if(opts.fmt==='jpg'){ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvasW,canvasH); }
    var dx = Math.round((canvasW-outW)/2), dy = Math.round((canvasH-outH)/2);
    ctx.drawImage(img, dx, dy, outW, outH);
    var mime = (opts.fmt==='jpg')?'image/jpeg':(opts.fmt==='png'?'image/png':'image/webp');
    var q = (opts.fmt==='png')?1.0:opts.q;
    c.toBlob(function(blob){
      // target KB loop (ƒë∆°n gi·∫£n ho√°)
      (function tryCompress(b, qNow, step){
        if(!b){ cb({blob:null,w:canvasW,h:canvasH}); return; }
        if(opts.targetKB>0 && mime!=='image/png' && b.size/1024>opts.targetKB && qNow>0.4 && step<10){
          var c2 = document.createElement('canvas'); c2.width=canvasW; c2.height=canvasH;
          var ctx2 = c2.getContext('2d'); if(opts.fmt==='jpg'){ ctx2.fillStyle='#ffffff'; ctx2.fillRect(0,0,canvasH,canvasH); }
          ctx2.drawImage(c,0,0);
          qNow = Math.max(0.4, qNow - 0.06);
          c2.toBlob(function(b2){ tryCompress(b2,qNow,step+1); }, mime, qNow);
        }else{
          cb({blob:b,w:canvasW,h:canvasH});
        }
      })(blob,q,0);
    }, mime, q);
  }

  var state = { imgBlob:null, imgName:null, imgW:0, imgH:0, srcDataUrl:null };

  function baseNameWithoutExt(filename){ var s=(filename||'').split('/').pop(); var i=s.lastIndexOf('.'); return (i>0?s.slice(0,i):s); }
  function decideNameFor(file){
    var sku = (val(byId('sku'))||'').trim();
    var useFilename = (byId('cbUseFilename') && byId('cbUseFilename').checked);
    if(hasText(sku)) return slugify(sku);
    if(useFilename && file && file.name) return slugify(baseNameWithoutExt(file.name));
    var nm = (val(byId('name'))||'').trim(); if(hasText(nm)) return slugify(nm);
    return 'mxd';
  }
  function renderPreview(base, blob, w, h){
    state.imgBlob=blob; state.imgW=w; state.imgH=h;
    var ext = getExt(getSelectedFmt());
    state.imgName = base + '.' + ext;
    var folder = getSelectedFolder();

    var sku = (val(byId('sku'))||'').trim();
    setVal(byId('image'), folder + (hasText(sku)?slugify(sku):base) + '.' + ext);

    var p = byId('imgPreview'); if(p) p.style.display='flex';
    var th = byId('thumb'); if(th) th.src = URL.createObjectURL(blob);
    var nm = byId('imgName'); if(nm) nm.textContent = state.imgName;
    var inf = byId('imgInfo'); if(inf) inf.textContent = w + '√ó' + h + ', ' + (blob.size/1024).toFixed(1) + ' KB';
    updateSingleUploadCta();
  }
  function reconvertFromSource(){
    if(!state.srcDataUrl){ toast('Ch∆∞a c√≥ ·∫£nh ngu·ªìn ƒë·ªÉ n√©n l·∫°i.','warn'); return; }
    var img = new Image();
    img.onload = function(){
      var opts = getImageOpts();
      resizeContainToBlob(img, opts, function(out){ renderPreview((state.imgName||'mxd').replace(/\.(webp|png|jpg)$/,''), out.blob, out.w, out.h); });
    };
    img.src = state.srcDataUrl;
  }

  // Queue
  var queue = [], seq=0;
  function readFileAsDataURL(file, cb){
    var r = new FileReader();
    r.onload = function(){ cb(r.result); };
    r.readAsDataURL(file);
  }
  function getPathFor(it){
    var base = sanitizeFolder(it.folder||'/assets/img/'); var ext='.' + getExt(it.fmt||'webp'); return base + it.name + ext;
  }
  function renderQueue(){
    var tbody = byId('queueBody'); if(!tbody) return;
    if(!queue.length){ tbody.innerHTML = '<tr><td colspan="8" class="muted">Ch∆∞a c√≥ g√¨ trong h√†ng ƒë·ª£i.</td></tr>'; return; }
    var html = '';
    for(var i=0;i<queue.length;i++){
      var it = queue[i]; var url = it.outBlob ? URL.createObjectURL(it.outBlob) : '';
      var status = it.status==='ready'?'S·∫µn s√†ng':(it.status==='processing'?'ƒêang x·ª≠ l√Ω':(it.status==='uploaded'?'ƒê√£ upload':(it.status==='error'?'L·ªói':'Ch·ªù')));
      html += '<tr data-id="'+it.id+'">'+
        '<td><div class="mini">'+ (url?('<img class="thumb" src="'+url+'" alt="thumb">'):'') +'</div></td>'+
        '<td><input class="name" value="'+it.name+'"/></td>'+
        '<td>'+
          '<select class="folder">'+
            '<option value="/assets/img/products/" '+(it.folder==="/assets/img/products/"?'selected':'')+'>/assets/img/products/ ‚Äî ·∫¢nh s·∫£n ph·∫©m</option>'+
            '<option value="/assets/img/categories/" '+(it.folder==="/assets/img/categories/"?'selected':'')+'>/assets/img/categories/ ‚Äî ·∫¢nh danh m·ª•c</option>'+
            '<option value="/assets/img/og/" '+(it.folder==="/assets/img/og/"?'selected':'')+'>/assets/img/og/ ‚Äî ·∫¢nh chia s·∫ª (OG)</option>'+
            '<option value="/assets/img/brands/" '+(it.folder==="/assets/img/brands/"?'selected':'')+'>/assets/img/brands/ ‚Äî Logo/Brand</option>'+
            '<option value="custom" '+(it.customPath?'selected':'')+'>T·ª± nh·∫≠p‚Ä¶</option>'+
          '</select>'+
          '<input class="customPath" placeholder="/assets/img/icons/" style="margin-top:6px;display:'+(it.customPath?'block':'none')+'" value="'+(it.customPath?it.folder:'')+'"/>'+
        '</td>'+
        '<td>'+
          '<select class="fmt">'+
            '<option value="webp" '+(it.fmt==='webp'?'selected':'')+'>webp</option>'+
            '<option value="png" '+(it.fmt==='png'?'selected':'')+'>png</option>'+
            '<option value="jpg" '+(it.fmt==='jpg'?'selected':'')+'>jpg</option>'+
          '</select>'+
        '</td>'+
        '<td class="nowrap">'+getPathFor(it)+'</td>'+
        '<td>'+(it.w||'‚Äì')+'√ó'+(it.h||'‚Äì')+'<div class="small muted">'+(it.outBlob?((it.outBlob.size/1024|0)+' KB'):'')+'</div></td>'+
        '<td class="status">'+status+'</td>'+
        '<td class="controls">'+
          '<button class="btn sm do-convert">Convert</button>'+
          '<button class="btn sm do-download">T·∫£i</button>'+
          '<button class="btn sm do-upload">Upload</button>'+
          '<button class="btn sm do-remove">Xo√°</button>'+
        '</td>'+
      '</tr>';
    }
    tbody.innerHTML = html;

    // Wire per-row
    var rows = tbody.querySelectorAll('tr');
    for(var j=0;j<rows.length;j++){
      (function(tr){
        var id = Number(tr.getAttribute('data-id'));
        var it = null; for(var k=0;k<queue.length;k++){ if(queue[k].id===id){ it=queue[k]; break; } }
        if(!it) return;
        var nameInput = tr.querySelector('.name');
        var folderSel = tr.querySelector('.folder');
        var customInput= tr.querySelector('.customPath');
        var fmtSel    = tr.querySelector('.fmt');
        var pathCell  = tr.children[4];
        var statusEl  = tr.querySelector('.status');

        nameInput.oninput = function(){ it.name = slugify(nameInput.value||'mxd'); pathCell.textContent = getPathFor(it); };
        folderSel.onchange = function(){
          if(folderSel.value==='custom'){ it.customPath=true; customInput.style.display='block'; if(customInput.value.trim()==='') customInput.value='/assets/img/'; it.folder=sanitizeFolder(customInput.value.trim()); }
          else { it.customPath=false; customInput.style.display='none'; it.folder=folderSel.value; }
          pathCell.textContent = getPathFor(it);
        };
        customInput.oninput = function(){ it.folder=sanitizeFolder(customInput.value.trim()); pathCell.textContent = getPathFor(it); };
        fmtSel.onchange = function(){
          it.fmt = fmtSel.value;
          pathCell.textContent = getPathFor(it);
          statusEl.textContent='S·∫µn s√†ng';
        };
        tr.querySelector('.do-remove').onclick = function(){ for(var c=0;c<queue.length;c++){ if(queue[c].id===id){ queue.splice(c,1); break; } } renderQueue(); };
        tr.querySelector('.do-convert').onclick= function(){ statusEl.textContent='ƒêang x·ª≠ l√Ω'; queueProcess(it,function(){ statusEl.textContent='S·∫µn s√†ng'; renderQueue(); }); };
        tr.querySelector('.do-download').onclick=function(){ if(!it.outBlob){ toast('Ch∆∞a convert.','warn'); return; } var a=document.createElement('a'); a.href=URL.createObjectURL(it.outBlob); a.download= it.name + '.' + getExt(it.fmt||'webp'); a.click(); };
        tr.querySelector('.do-upload').onclick  = function(){ uploadItem(it, statusEl); };
      })(rows[j]);
    }
  }
  function queueProcess(it, cb){
    if(it.outBlob && it.w && it.h){ it.status='ready'; cb&&cb(); return; }
    if(!it.srcFile){ it.status='error'; cb&&cb(); return; }
    it.status='processing';
    readFileAsDataURL(it.srcFile, function(dataUrl){
      var img = new Image();
      img.onload = function(){
        var g = getImageOpts();
        var opts = { preset:g.preset,w:g.w,h:g.h, fmt:(it.fmt||g.fmt||'webp'), q:g.q, targetKB:g.targetKB };
        resizeContainToBlob(img, opts, function(out){
          it.outBlob = out.blob; it.w=out.w; it.h=out.h; it.status='ready';
          cb&&cb();
        });
      };
      img.src = dataUrl;
    });
  }
  function queueAddRawFile(file){
    var name = decideNameFor(file);
    var fmt = getSelectedFmt();
    var folder = getSelectedFolder();
    var item = { id:(++seq), srcFile:file, name:name, fmt:fmt, folder:folder, customPath:(val(byId('defaultFolder'))==='custom'), outBlob:null, w:0, h:0, status:'pending' };
    queue.push(item);
    queueProcess(item, function(){ renderQueue(); });
  }
  function queueAddCurrent(){
    if(!state.imgBlob){ toast('Ch∆∞a c√≥ ·∫£nh xem tr∆∞·ªõc.','warn'); return; }
    var fmt = getSelectedFmt(); var folder = getSelectedFolder();
    var base = (state.imgName||'mxd.webp').replace(/\.(webp|png|jpg)$/,'');
    var item = { id:(++seq), srcFile:null, name:base, fmt:fmt, folder:folder, customPath:(val(byId('defaultFolder'))==='custom'), outBlob:state.imgBlob, w:state.imgW, h:state.imgH, status:'ready' };
    queue.push(item); renderQueue(); toast('ƒê√£ th√™m v√†o h√†ng ƒë·ª£i.','ok');
  }

  // Upload
  function splitDataUrl(d){
    var m = String(d||'').match(/^data:([^;]+);base64,(.+)$/);
    return m ? { mime:m[1], base64:m[2] } : { mime:'', base64:d||'' };
  }
  function blobToDataURL(blob, cb){ var fr=new FileReader(); fr.onload=function(){ cb(fr.result); }; fr.readAsDataURL(blob); }
  function uploadItem(it, statusEl){
    var path = getPathFor(it);
    if(!it.outBlob){ statusEl && (statusEl.textContent='ƒêang x·ª≠ l√Ω'); queueProcess(it, function(){ uploadItem(it,statusEl); }); return; }
    var s = readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
    var base = s.workerUrl.replace(/\/$/,'');
    blobToDataURL(it.outBlob, function(dataUrl){
      statusEl && (statusEl.textContent='Uploading‚Ä¶');
      fetch(base+'/upload-image',{method:'POST',mode:'cors',headers:hdr(),body:JSON.stringify({sku:it.name, path:path, file:dataUrl })})
        .then(function(r){ return r.text().then(function(t){ return {r:r,t:t}; }); })
        .then(function(rt){
          if(rt.r.ok){ statusEl && (statusEl.textContent='ƒê√£ upload'); it.status='uploaded'; log('[upload '+path+'] OK'); return; }
          // th·ª≠ pure base64
          log('[upload '+path+'] FAIL '+rt.r.status+'. Th·ª≠ base64‚Ä¶ ‚Äî '+rt.t.slice(0,140));
          var sp = splitDataUrl(dataUrl);
          return fetch(base+'/upload-image',{method:'POST',mode:'cors',headers:hdr(),body:JSON.stringify({sku:it.name,path:path,file:sp.base64,mime:sp.mime})})
            .then(function(r2){ return r2.text().then(function(t2){ return {r:r2,t:t2}; }); })
            .then(function(rt2){
              if(rt2.r.ok){ statusEl && (statusEl.textContent='ƒê√£ upload'); it.status='uploaded'; log('[upload '+path+'] OK(base64)'); return; }
              // fallback WebP (ƒë∆°n gi·∫£n ho√°: d√πng blob s·∫µn n·∫øu fmt!=webp b·ªè qua v√¨ ƒë√£ c√≥ webp)
              statusEl && (statusEl.textContent='L·ªói upload'); toast('Upload l·ªói '+rt2.r.status,'err'); log('[upload '+path+'] FAIL cu·ªëi: '+rt2.t.slice(0,200));
            });
        })
        .catch(function(e){ statusEl && (statusEl.textContent='L·ªói upload'); toast('Upload l·ªói: '+e.message,'err'); log('[upload '+path+'] EXC: '+e.message); });
    });
  }

  // Product + deeplink
  function activeTplFor(merchant){
    var s=readSettings();
    var map={shopee:s.tplShopee,lazada:s.tplLazada,tiki:s.tplTiki,tiktok:s.tplTiktok};
    var raw = (map[merchant]||'').trim();
    if(raw) return raw;
    if(merchant==='shopee') return DEFAULT_TPL_SHOPEE;
    if(merchant==='lazada') return DEFAULT_TPL_LAZADA;
    if(merchant==='tiki') return DEFAULT_TPL_TIKI;
    if(merchant==='tiktok') return DEFAULT_TPL_TIKTOK;
    return DEFAULT_TPL_SHOPEE;
  }
  function computeSubs(sku, merchant){ return {sub1:(sku||'sku'), sub2:(merchant||'merchant').toLowerCase(), sub3:'tool', sub4:'mxd210'}; }
  function ensureSubsInUrl(u, subs){
    function has(k){ return new RegExp('[?&]'+k+'=','i').test(u); }
    var qs = [];
    ['sub1','sub2','sub3','sub4'].forEach(function(k){ if(!has(k)) qs.push(k+'='+encodeURIComponent(subs[k])); });
    if(qs.length) u += (u.indexOf('?')>=0?'&':'?') + qs.join('&');
    return u;
  }
  function cleanUrl(u){ return String(u||'').trim().replace(/^[\"']+|[\"',]+$/g,''); }

  function makeDeeplink(){
    var origin = cleanUrl(val(byId('origin')));
    var sku = val(byId('sku')).trim();
    var merchant = val(byId('merchant'));
    if(!origin){ toast('Thi·∫øu Origin.','warn'); return; }
    var tpl = activeTplFor(merchant);
    var subs = computeSubs(sku, merchant);
    var link = tpl.replace(/\{url\}/g, encodeURIComponent(origin))
                  .replace(/\{sku\}/g, sku||'sku')
                  .replace(/\{sub1\}/g, subs.sub1)
                  .replace(/\{sub2\}/g, subs.sub2)
                  .replace(/\{sub3\}/g, subs.sub3)
                  .replace(/\{sub4\}/g, subs.sub4);
    link = ensureSubsInUrl(link, subs);
    setVal(byId('deeplink'), link);
    validateDeeplink();
  }
  function validateDeeplink(){
    var dl = (val(byId('deeplink'))||'').trim();
    var badge = byId('dlCheck'); if(!badge) return;
    if(!dl){ badge.textContent='ch∆∞a c√≥ deeplink'; badge.className='badge'; return; }
    var okHost = /(^https?:\/\/)?([^/]*\.)?isclix\.com/i.test(dl);
    var hasUrl = /[?&]url=/.test(dl);
    var s1=/[?&]sub1=/.test(dl), s2=/[?&]sub2=/.test(dl), s3=/[?&]sub3=/.test(dl), s4=/[?&]sub4=/.test(dl);
    if(okHost && hasUrl && s1 && s2 && s3 && s4){ badge.textContent='OK affiliate'; badge.className='badge'; return; }
    if(okHost && !hasUrl){ badge.textContent='isclix thi·∫øu url='; badge.className='badge'; return; }
    if(okHost){
      var missing=[]; ['sub1','sub2','sub3','sub4'].forEach(function(k){ if(!new RegExp('[?&]'+k+'=').test(dl)) missing.push(k); });
      badge.textContent = 'isclix thi·∫øu: '+missing.join(', ');
      badge.className='badge'; return;
    }
    badge.textContent='KH√îNG qua affiliate'; badge.className='badge';
  }

  // JSON + publish
  function autoCategoryGuess(text){
    var s=text.toLowerCase();
    if(/m√°y\s*c·∫Øt|c∆∞a|circular|jig\s*saw|reciprocating|m√°y\s*c·∫Øt\s*(g·∫°ch|s·∫Øt)/i.test(s)) return 'may-cat';
    if(/m√°y\s*khoan|khoan\s*b√∫a|impact|sds/i.test(s)) return 'may-khoan-duc-vit';
    if(/pin|s·∫°c|l∆∞·ª°i|ƒëƒ©a|blade|m≈©i|ƒë·∫ßu\s*v√≠t|ƒë·∫ßu\s*kh·∫©u|ƒë√°\s*m√†i|gi·∫•y\s*nh√°m/i.test(s)) return 'phu-kien-may';
    return '';
  }
  function runDiag(){
    var sku = val(byId('sku')).trim();
    var img = val(byId('image')).trim();
    var origin = cleanUrl(val(byId('origin')).trim());
    var merchant = val(byId('merchant'));
    var expectedFolder = getSelectedFolder();
    var ext = getExt(getSelectedFmt());
    var msgs=[];
    if(!hasText(sku)) msgs.push('‚Ä¢ Thi·∫øu SKU (b·∫Øt bu·ªôc cho publish).');
    if(hasText(img) && img.indexOf(expectedFolder + (sku||'...'))!==0) msgs.push('‚Ä¢ ·∫¢nh n√™n l√† '+expectedFolder+(sku||'<sku>')+'.'+ext);
    if(hasText(origin) && !/shopee\.vn|lazada\.vn|tiki\.vn|tiktok\.com/i.test(origin)) msgs.push('‚Ä¢ Origin kh√¥ng ph·∫£i Shopee/Lazada/Tiki/TikTok.');
    msgs.push('‚Ä¢ Merchant: '+merchant);
    var d = byId('diag'); if(d) d.innerHTML = msgs.length ? msgs.map(function(x){return '<div>'+x+'</div>';}).join('') : '<span class="ok">T·∫°m ·ªïn.</span>';
    setVal(byId('originOut'), origin);
  }
  function buildJson(){
    var catEl = byId('category');
    if(catEl && !hasText(val(catEl))){
      var guess = autoCategoryGuess((val(byId('name'))||'') + ' ' + (val(byId('brand'))||'') + ' ' + (val(byId('origin'))||''));
      if(guess) setVal(catEl, guess);
    }
    if(catEl) setVal(catEl, normCategory(val(catEl)));

    var now = new Date().toISOString();
    var obj = {
      name: val(byId('name')).trim(),
      price: Number(val(byId('price'))||0),
      origin: cleanUrl(val(byId('origin')).trim()),
      merchant: val(byId('merchant')),
      sku: val(byId('sku')).trim(),
      image: val(byId('image')).trim(),
      category: val(byId('category')).trim(),
      brand: val(byId('brand')).trim(),
      featured: (byId('featured') && byId('featured').checked),
      status: (byId('status') ? byId('status').checked : true),
      updated_at: now
    };
    var dl = val(byId('deeplink')).trim(); if(dl) obj.deeplink = dl;
    var sl = val(byId('shortlink')).trim(); if(sl) obj.shortlink = sl;

    setVal(byId('jsonOut'), JSON.stringify([obj], null, 2));
    return obj;
  }
  function doPublish(forceFeatured){
    var obj = buildJson();
    if(forceFeatured){ obj.featured=true; if(byId('featured')) byId('featured').checked=true; setVal(byId('jsonOut'), JSON.stringify([obj],null,2)); }
    if(!hasText(obj.sku)){ toast('Thi·∫øu SKU.','err'); return; }
    if(!hasText(obj.origin)){ toast('Thi·∫øu origin.','warn'); return; }
    if(!hasText(val(byId('deeplink')))){
      var maybe = activeTplFor(val(byId('merchant')));
      if(maybe){ makeDeeplink(); var dl = val(byId('deeplink')).trim(); if(dl){ obj.deeplink=dl; setVal(byId('jsonOut'), JSON.stringify([obj],null,2)); } }
    }
    var s = readSettings();
    if(s.workerUrl){
      fetch(s.workerUrl.replace(/\/$/,'')+'/publish',{method:'POST',mode:'cors',headers:hdr(),body:JSON.stringify(obj)})
        .then(function(r){ return r.text().then(function(t){ return {r:r,t:t}; }); })
        .then(function(rt){
          log('[publish '+obj.sku+'] '+rt.r.status+' '+(rt.r.ok?'OK':'FAIL')+' ‚Äî '+rt.t.slice(0,200));
          if(!rt.r.ok) throw new Error('HTTP '+rt.r.status);
          toast('Publish OK ‚Üí store'+(obj.featured?' + n·ªïi b·∫≠t':''),'ok'); window.scrollTo({top:0,behavior:'smooth'});
        })
        .catch(function(e){
          toast('Publish l·ªói (s·∫Ω t·∫£i JSON ƒë·ªÉ commit tay): '+e.message,'err');
          var blob=new Blob([JSON.stringify([obj],null,2)],{type:'application/json'});
          var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click();
        });
      return;
    }
    var blob=new Blob([JSON.stringify([obj],null,2)],{type:'application/json'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click();
  }

  // === INIT (ƒë·∫£m b·∫£o DOM ready, bind t·∫•t c·∫£ n√∫t) ===
  function init(){
    // Global error capture
    window.addEventListener('error', function(e){ log('[runtime] '+e.message); toast('L·ªói script: '+e.message,'err'); });
    window.addEventListener('unhandledrejection', function(e){ log('[promise] '+(e.reason && e.reason.message ? e.reason.message : (e.reason || 'unknown'))); });

    // Settings bindings
    bind('btnSaveSettings','click', saveSettings);
    bind('btnLoadSettings','click', loadSettings);
    bind('btnClearSettings','click', function(){ localStorage.removeItem(LS_KEY); settingsToUi({}); text(byId('settingsStatus'),'ƒê√£ x√≥a.'); toast('ƒê√£ x√≥a c√†i ƒë·∫∑t.','ok'); });

    loadSettings();

    // Worker tests
    bind('btnCheckWorker','click', function(){
      var s=readSettings(); if(!s.workerUrl){ text(byId('workerStatus'),'Ch∆∞a c·∫•u h√¨nh Worker.'); toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var u=s.workerUrl.replace(/\/$/,'')+'/health';
      simpleGet(u, function(r){ var msg = (r.ok?('Worker OK (health '+r.status+')'):('Worker l·ªói ('+r.status+'). '+String(r.text).slice(0,120))); text(byId('workerStatus'), msg); log('[/health] '+msg); toast(r.ok?'Worker OK':'Worker l·ªói '+r.status, r.ok?'ok':'err'); });
    });
    bind('btnCheckAuth','click', function(){
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var u=s.workerUrl.replace(/\/$/,'')+'/whoami';
      simpleGet(u, function(r){ var msg = r.ok?'X-Key h·ª£p l·ªá.':'X-Key kh√¥ng h·ª£p l·ªá ('+r.status+')'; log('[/whoami] '+msg+' ‚Äî '+String(r.text).slice(0,120)); toast(msg, r.ok?'ok':'err'); });
    });
    bind('btnCheckWrite','click', function(){
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var u=s.workerUrl.replace(/\/$/,'')+'/can-write';
      simpleGet(u, function(r){ var msg = r.ok?'C√≥ quy·ªÅn commit.':'Kh√¥ng c√≥ quy·ªÅn ('+r.status+')'; log('[/can-write] '+msg+' ‚Äî '+String(r.text).slice(0,120)); toast(msg, r.ok?'ok':'err'); });
    });
    bind('btnProbeOptions','click', function(){
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var u=s.workerUrl.replace(/\/$/,'')+'/upload-image';
      fetch(u,{method:'OPTIONS',mode:'cors',headers:hdr()})
        .then(function(r){ log('[OPTIONS /upload-image] '+r.status+' '+(r.ok?'OK':'')+' ‚Äî ALLOW: '+(r.headers.get('allow')||'-')+' | ACR: '+(r.headers.get('access-control-allow-methods')||'-')); toast('ƒê√£ probe OPTIONS /upload-image','ok'); })
        .catch(function(e){ log('[OPTIONS /upload-image] L·ªói: '+e.message); toast('Probe l·ªói.','err'); });
    });
    bind('btnProbePublish','click', function(){
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var u=s.workerUrl.replace(/\/$/,'')+'/publish';
      fetch(u,{method:'OPTIONS',mode:'cors',headers:hdr()})
        .then(function(r){ log('[OPTIONS /publish] '+r.status+' '+(r.ok?'OK':'')+' ‚Äî ALLOW: '+(r.headers.get('allow')||'-')+' | ACR: '+(r.headers.get('access-control-allow-methods')||'-')); toast('ƒê√£ probe OPTIONS /publish','ok'); })
        .catch(function(e){ log('[OPTIONS /publish] L·ªói: '+e.message); toast('Probe l·ªói.','err'); });
    });
    bind('btnTestUpload','click', function(){
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var c=document.createElement('canvas'); c.width=1; c.height=1;
      c.toBlob(function(blob){
        dataURLFromBlob(blob, function(b64){
          var path='/assets/img/test/ping.webp';
          fetch(s.workerUrl.replace(/\/$/,'')+'/upload-image',{method:'POST',mode:'cors',headers:hdr(),body:JSON.stringify({sku:'ping',path:path,file:b64})})
            .then(function(r){ return r.text().then(function(t){ log('[TEST UPLOAD] '+r.status+' '+(r.ok?'OK':'FAIL')+' ‚Äî '+t.slice(0,180)); toast(r.ok?'Test upload OK':'Test upload FAIL '+r.status, r.ok?'ok':'err'); }); })
            .catch(function(e){ log('[TEST UPLOAD] L·ªói: '+e.message); toast('Test upload l·ªói.','err'); });
        });
      }, 'image/webp', 0.5);
    });

    // Image choose/drag
    var drop = byId('drop'), file = byId('file');
    if(drop){ drop.addEventListener('click', function(){ if(file) file.click(); }); }
    if(drop){ drop.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); if(file) file.click(); }}); }
    if(drop){ drop.addEventListener('dragover', function(e){ e.preventDefault(); drop.classList.add('dragover'); }); }
    if(drop){ drop.addEventListener('dragleave', function(){ drop.classList.remove('dragover'); }); }
    if(drop){ drop.addEventListener('drop', function(e){ e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); }); }
    if(file){ file.onchange = function(e){ handleFiles(e.target.files); }; }
    bind('btnSelectImg','click', function(){ if(file) file.click(); });
    bind('btnConvert','click', function(){ reconvertFromSource(); toast('ƒê√£ convert theo tu·ª≥ ch·ªçn.','ok'); });
    bind('btnSaveImg','click', function(){
      if(!state.imgBlob){ toast('Ch∆∞a c√≥ ·∫£nh.','warn'); return; }
      var a=document.createElement('a'); a.href=URL.createObjectURL(state.imgBlob); a.download= state.imgName || ('product.'+getExt(getSelectedFmt())); a.click();
    });
    bind('btnUploadImg','click', function(){
      if(!state.imgBlob){ toast('Ch∆∞a c√≥ ·∫£nh.','warn'); return; }
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      var base=s.workerUrl.replace(/\/$/,'');
      var sku = slugify(val(byId('sku'))||'mxd');
      var folder = getSelectedFolder();
      var ext = getExt(getSelectedFmt());
      var path = folder + sku + '.' + ext;
      dataURLFromBlob(state.imgBlob, function(dataUrl){
        fetch(base+'/upload-image',{method:'POST',mode:'cors',headers:hdr(),body:JSON.stringify({sku:sku, path:path, file:dataUrl})})
          .then(function(r){ return r.text().then(function(t){ log('[single upload '+path+'] '+r.status+' '+(r.ok?'OK':'FAIL')+' ‚Äî '+t.slice(0,160)); toast(r.ok?'ƒê√£ upload ·∫£nh l√™n repo.':'Upload ·∫£nh l·ªói '+r.status, r.ok?'ok':'err'); if(r.ok) setVal(byId('image'), path); }); })
          .catch(function(e){ log('[single upload] EXC: '+e.message); toast('Upload ·∫£nh l·ªói: '+e.message,'err'); });
      });
    });
    bind('btnQueueCurrent','click', queueAddCurrent);

    function handleFiles(files){
      if(!files || !files.length) return;
      if(files.length===1){
        var f = files[0];
        var reader = new FileReader();
        reader.onload = function(ev){
          state.srcDataUrl = ev.target.result;
          var img = new Image();
          img.onload = function(){
            var base = decideNameFor(f);
            var opts = getImageOpts();
            resizeContainToBlob(img, opts, function(out){ renderPreview(base,out.blob,out.w,out.h); });
          };
          img.src = state.srcDataUrl;
        };
        reader.readAsDataURL(f);
      }else{
        var cnt=0;
        Array.prototype.forEach.call(files, function(ff){
          queueAddRawFile(ff); cnt++;
        });
        toast('ƒê√£ th√™m '+cnt+' ·∫£nh v√†o h√†ng ƒë·ª£i.','ok');
      }
    }

    // Queue buttons
    bind('btnConvertAll','click', function(){ for(var i=0;i<queue.length;i++){ (function(it){ queueProcess(it,function(){}); })(queue[i]); } toast('ƒê√£ convert t·∫•t c·∫£.','ok'); renderQueue(); });
    bind('btnDownloadAll','click', function(){ for(var i=0;i<queue.length;i++){ var it=queue[i]; if(!it.outBlob) continue; var a=document.createElement('a'); a.href=URL.createObjectURL(it.outBlob); a.download= it.name + '.' + getExt(it.fmt||'webp'); a.click(); } });
    bind('btnUploadAll','click', function(){
      var s=readSettings(); if(!s.workerUrl){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      for(var i=0;i<queue.length;i++){
        (function(it){
          var row = $('#queueBody tr[data-id="'+it.id+'"] .status');
          uploadItem(it, row);
        })(queue[i]);
      }
      toast('Upload t·∫•t c·∫£ xong (xem tr·∫°ng th√°i t·ª´ng m·ª•c).','ok');
    });
    bind('btnClearQueue','click', function(){ queue.length=0; renderQueue(); });

    // Folder + options
    var selFolder = byId('defaultFolder'); if(selFolder){ selFolder.addEventListener('change', updateFolderHelp); }
    var customPath = byId('defaultCustomPath'); if(customPath){ customPath.addEventListener('input', updateSingleUploadCta); }
    var syncPairs = [['quality','qualityNum'],['targetKB','targetKBNum']];
    syncPairs.forEach(function(p){
      var a=byId(p[0]), b=byId(p[1]);
      if(a){ a.addEventListener('input', function(){ if(b) b.value=a.value; updateSingleUploadCta(); }); }
      if(b){ b.addEventListener('input', function(){ if(a) a.value=b.value; updateSingleUploadCta(); }); }
    });
    var sizePreset = byId('sizePreset'); if(sizePreset){ sizePreset.addEventListener('change', function(){ if(val(sizePreset)==='og'){ setVal(byId('optW'),1200); setVal(byId('optH'),630);} updateSingleUploadCta(); }); }

    // Deeplink + short
    bind('btnMakeDeeplink','click', makeDeeplink);
    var dlEl = byId('deeplink'); if(dlEl){ dlEl.addEventListener('input', validateDeeplink); }
    ;['origin','sku','merchant','tplShopee','tplLazada','tplTiki','tplTiktok','defaultFolder','defaultCustomPath'].forEach(function(id){
      var el = byId(id); if(el){ el.addEventListener('input', function(){ if(hasText(val(byId('origin')))) makeDeeplink(); updateSingleUploadCta(); runDiag(); saveSettings(); }); }
    });
    bind('openOrigin','click', function(){ var u = val(byId('originOut')) || val(byId('origin')); if(hasText(u)) window.open(u,'_blank'); else toast('Ch∆∞a c√≥ Origin.','warn'); });
    bind('btnOpenDeeplink','click', function(){ var u = val(byId('deeplink')) || val(byId('origin')); if(hasText(u)) window.open(u,'_blank'); else toast('Ch∆∞a c√≥ link.','warn'); });
    bind('copyOrigin','click', function(){ copyText(val(byId('originOut'))||''); });
    bind('copyDeeplink','click', function(){ copyText(val(byId('deeplink'))||''); });
    bind('btnMakeShort','click', function(){
      var s=readSettings(); var base=(s.workerUrl||'').replace(/\/$/,'');
      var url = (val(byId('deeplink')).trim() || val(byId('origin')).trim());
      var merchant = val(byId('merchant'));
      if(!hasText(base)){ toast('Ch∆∞a c·∫•u h√¨nh Worker.','warn'); return; }
      if(!hasText(url)){ toast('Ch∆∞a c√≥ URL ƒë·ªÉ r√∫t g·ªçn.','warn'); return; }
      fetch(base+'/shorten',{method:'POST',mode:'cors',headers:hdr(),body:JSON.stringify({merchant:merchant,url:url})})
        .then(function(r){ return r.json().catch(function(){return null;}).then(function(data){ return {ok:r.ok,data:data}; }); })
        .then(function(resp){ if(resp.ok && resp.data && resp.data.short){ setVal(byId('shortlink'), resp.data.short); toast('ƒê√£ t·∫°o short-link.','ok'); } else { toast('Worker kh√¥ng h·ªó tr·ª£ /shorten ho·∫∑c l·ªói.','warn'); } })
        .catch(function(e){ toast('Shorten l·ªói: '+e.message,'err'); });
    });
    bind('btnCopyShort','click', function(){ copyText(val(byId('shortlink'))||''); });

    // Commit
    bind('btnGenCommit','click', function(){
      var sku = val(byId('sku')).trim()||'(no-sku)';
      var m   = val(byId('merchant'));
      var price = val(byId('price')).trim();
      var cat = val(byId('category')).trim();
      var brand = val(byId('brand')).trim();
      var img = val(byId('image')).trim();
      var dl = val(byId('deeplink')).trim();
      var sl = val(byId('shortlink')).trim();
      var uploaded = queue.filter(function(x){return x.status==='uploaded';}).map(function(x){return getPathFor(x);}).join(', ');
      var parts = [];
      parts.push('feat(store): add '+sku);
      if(price) parts.push('price '+price);
      if(brand) parts.push('brand '+brand);
      if(cat) parts.push('cat '+cat);
      parts.push('via '+m);
      var header = parts.join(' ‚Ä¢ ');
      var body = [ img?('image: '+img):'', dl?('deeplink: '+dl):'', sl?('short: '+sl):'', uploaded?('uploaded: '+uploaded):'' ].filter(Boolean).join('\n');
      setVal(byId('commitMsg'), header + (body?('\n\n'+body):''));
      toast('ƒê√£ t·∫°o commit message.','ok');
    });

    // Verify + JSON + Publish
    bind('btnVerify','click', function(){
      var sku = val(byId('sku')).trim();
      if(!hasText(sku)){ toast('Ch∆∞a c√≥ SKU ƒë·ªÉ ki·ªÉm tra.','warn'); return; }
      fetch('/affiliates.json?_='+Date.now(),{cache:'no-cache'})
        .then(function(r){ return r.json(); })
        .then(function(arr){
          var list = Array.isArray(arr)?arr:(arr.items||[]);
          var found = false;
          for(var i=0;i<list.length;i++){ if(String(list[i].sku||'').toLowerCase()===sku.toLowerCase()){ found=true; break; } }
          toast(found?'ƒê√É C√ì trong affiliates.json.':'CH∆ØA TH·∫§Y trong affiliates.json.', found?'ok':'warn');
        })
        .catch(function(e){ toast('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c affiliates.json: '+e.message,'err'); });
      var url = '/store.html?dev=1&sku='+encodeURIComponent(sku)+'&v='+Date.now();
      try{ window.open(url,'_blank'); }catch(_){}
    });
    bind('btnToJson','click', buildJson);
    bind('btnCopyJson','click', function(){ copyText(val(byId('jsonOut'))||''); });
    bind('btnDownloadJson','click', function(){
      if(!hasText(val(byId('jsonOut')))) buildJson();
      var blob=new Blob([val(byId('jsonOut'))],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click();
    });
    bind('btnPublish','click', function(){ doPublish(false); });
    bind('btnPublishFeatured','click', function(){ doPublish(true); });

    // Auto helpers
    bind('btnAuto','click', function(){
      var name = val(byId('name')).trim(); var skuNow = val(byId('sku')).trim();
      if(hasText(name) && !hasText(skuNow)) setVal(byId('sku'), slugify(name));
      var folder = getSelectedFolder();
      var baseSku = val(byId('sku')).trim() || '...';
      if(hasText(val(byId('sku'))) && !hasText(val(byId('image')))) setVal(byId('image'), folder+slugify(baseSku)+'.'+getExt(getSelectedFmt()));
      setVal(byId('originOut'), cleanUrl(val(byId('origin')).trim()));
      var g = autoCategoryGuess(name+' '+val(byId('brand'))+' '+val(byId('origin')));
      if(g && !hasText(val(byId('category')))) setVal(byId('category'), g);
      runDiag(); updateSingleUploadCta();
    });
    bind('btnClearAllFields','click', function(){
      ['name','sku','price','origin','image','category','brand','deeplink','shortlink','commitMsg'].forEach(function(id){ setVal(byId(id),''); });
      if(byId('featured')) byId('featured').checked=false;
      if(byId('status')) byId('status').checked=true;
      if(byId('merchant')) byId('merchant').value='shopee';
      var d=byId('diag'); if(d) d.innerHTML='';
      toast('ƒê√£ xo√° to√†n b·ªô th√¥ng tin s·∫£n ph·∫©m.','ok');
    });

    // Clear buttons auto-install (cho input th∆∞·ªùng)
    (function installClearers(){
      var sels=['#name','#sku','#price','#origin','#image','#category','#brand','#deeplink'];
      for(var i=0;i<sels.length;i++){
        var el = $(sels[i]); if(!el) continue;
        if(el.parentElement && el.parentElement.classList.contains('input-wrap')){
          var b = el.parentElement.querySelector('.clear-btn');
          if(!b){
            var nb=document.createElement('button'); nb.type='button'; nb.className='clear-btn'; nb.title='Xo√°'; nb.setAttribute('aria-label','Xo√°'); nb.textContent='√ó';
            nb.addEventListener('click', function(e){ e.preventDefault(); el.value=''; el.dispatchEvent(new Event('input', {bubbles:true})); el.focus(); });
            el.parentElement.appendChild(nb);
          }else if(!b.dataset.bound){
            b.dataset.bound='1';
            b.addEventListener('click', function(e){ e.preventDefault(); el.value=''; el.dispatchEvent(new Event('input', {bubbles:true})); el.focus(); });
          }
          continue;
        }
        var wrap=document.createElement('div'); wrap.className='input-wrap'+(el.tagName==='TEXTAREA'?' textarea':'');
        el.parentNode.insertBefore(wrap, el); wrap.appendChild(el);
        var btn=document.createElement('button'); btn.type='button'; btn.className='clear-btn'; btn.title='Xo√°'; btn.setAttribute('aria-label','Xo√°'); btn.textContent='√ó';
        btn.addEventListener('click', function(e){
          e.preventDefault();
          var tgt = this.previousElementSibling;
          if(tgt){ tgt.value=''; tgt.dispatchEvent(new Event('input',{bubbles:true})); tgt.focus(); }
        });
        wrap.appendChild(btn);
      }
    })();

    // First paint
    updateFolderHelp();
    updateSingleUploadCta();
    setVal(byId('originOut'), cleanUrl(val(byId('origin'))));
    runDiag();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); }
  else { init(); }
})();
</script>
</body>
</html>
