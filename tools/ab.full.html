<!doctype html>

<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>MXD Importer v4.7.0 â€” Mobileâ€‘safe + Multiâ€‘Image + old_price/tags</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{--bg:#0b0f14;--fg:#e8f0fb;--muted:#a7b4c2;--b:#152132;--accent:#7cc4ff;--ok:#34d399;--warn:#f59e0b;--err:#ef4444;--toast-bottom:14px}
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:14px 0 8px} h1{font-size:20px} h2{font-size:16px;color:#cfe5ff}
    a{color:var(--accent)} .small{color:var(--muted);font-size:12px}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .grid{display:grid;gap:12px} .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid #223348;border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea,button,label.btn{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3b52;background:#0f1622;color:var(--fg)}
    textarea{min-height:70px;resize:vertical}
    .btn{cursor:pointer;border:1px solid #2b3b52;background:#102235;display:inline-block;text-align:center}
    .btn:hover{background:#132a43} .btn.primary{background:#0b3a5e;border-color:#0b3a5e}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3b55;font-size:12px;color:#a9c6ff}
    .tbl{width:100%;border-collapse:collapse;margin-top:8px}
    .tbl th,.tbl td{border:1px solid #2b3b52;padding:6px 8px;font-size:12px;vertical-align:top}
    .drop{border:2px dashed #3a5270;border-radius:12px;padding:16px;text-align:center;background:#0c1623}
    .drop.dragover{border-color:#8ab9ff;background:#0f1e32}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #27405e}
    .toast{position:fixed;right:12px;bottom:var(--toast-bottom);display:none;max-width:520px;background:#122232;border:1px solid #2b425e;border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;z-index:99999}
    .toast.show{display:block} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .badge{display:inline-block;border:1px solid #2b3b52;border-radius:999px;padding:2px 8px;font-size:11px;color:#a4bee8}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,#0b0f14 60%,#0b0f1400);padding:12px;border-top:1px solid #1b2a3f;z-index:9}
    .chip{display:inline-block;padding:2px 8px;border:1px solid #2b3b52;border-radius:999px}
    .xwrap{position:relative} .xwrap input,.xwrap textarea,.xwrap select{padding-right:36px}
    .xwrap .xbtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:24px;height:24px;border-radius:8px;border:1px solid #2b3b52;background:#0f1622;color:#9fb7d7;cursor:pointer}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{width:auto}
    .hidden-file{position:fixed;left:-9999px;top:-9999px;width:0;height:0;opacity:0;pointer-events:none}
    @media (max-width:820px){ .g2{grid-template-columns:1fr} }
    /* Gallery list */
    .gallery{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .gal-item{display:flex;gap:6px;align-items:center;border:1px solid #2b3b52;background:#0f1622;padding:6px;border-radius:10px}
    .gal-item img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #263e5b}
    .gal-item code{font-size:11px;color:#b9cff1}
    .gal-actions{display:flex;gap:4px}
    .gal-actions button{width:auto;padding:6px 8px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>MXD Importer v4.7.0 <span class="pill">Multiâ€‘Image</span> <span class="pill">Mobileâ€‘safe</span></h1>
  <div class="small">VÃ¡ chá»n áº£nh trÃªn Android; batch .webp; gallery áº£nh theo SKU (-01, -02â€¦); thÃªm <b>old_price</b>, <b>tags[]</b>, <b>categories[]</b>, <b>deal</b>, <b>desc_short</b>. GA4 luÃ´n trÆ°á»›c Affiliate.</div>  <!-- 1) CÃ€I Äáº¶T -->  <div class="card">
    <h2>1) CÃ i Ä‘áº·t</h2>
    <div class="grid g2">
      <div class="xwrap"><label>Worker Base URL</label><input id="workerUrl" list="workers" placeholder="https://mxd-control-v2.mxd6686.workers.dev"/><button class="xbtn" data-clear="#workerUrl">Ã—</button><datalist id="workers"><option value="https://mxd-control-v2.mxd6686.workers.dev"></option><option value="https://mxd210.mxd6686.workers.dev"></option></datalist></div>
      <div class="xwrap"><label>X-Key (header báº£o vá»‡ Worker)</label><input id="xKey" placeholder="mxd210-secret-key"/><button class="xbtn" data-clear="#xKey">Ã—</button></div>
      <div class="xwrap"><label>Shopee template</label><input id="tplShopee" placeholder="https://go.isclix.com/deep_link/...&url={url}&sub1={sku}&sub2={merchant}&sub3=tool&sub4=mxd210"/><button class="xbtn" data-clear="#tplShopee">Ã—</button></div>
      <div class="xwrap"><label>Lazada template</label><input id="tplLazada" placeholder="https://go.isclix.com/deep_link/...&url={url}&sub1={sku}&sub2={merchant}&sub3=tool&sub4=mxd210"/><button class="xbtn" data-clear="#tplLazada">Ã—</button></div>
      <div class="xwrap"><label>TikTok template</label><input id="tplTikTok" placeholder="(tuá»³ chá»n)"/><button class="xbtn" data-clear="#tplTikTok">Ã—</button></div>
      <div class="xwrap"><label>Tiki template</label><input id="tplTiki" placeholder="(tuá»³ chá»n)"/><button class="xbtn" data-clear="#tplTiki">Ã—</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="switch"><input type="checkbox" id="noPreflight"/> Noâ€‘preflight (Ä‘Æ°a <code>xk</code> vÃ o query)</label>
      <label class="switch"><input type="checkbox" id="mobileLimit" checked/> Giá»›i háº¡n áº£nh â‰¤ 1.8MB</label>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">ğŸ’¾ LÆ°u</button>
      <button class="btn" id="btnLoadSettings">â†» Táº£i láº¡i</button>
      <button class="btn" id="btnClearSettings">ğŸ—‘ XoÃ¡</button>
      <span class="small" id="settingsStatus"></span>
    </div>
  </div>  <div class="grid g2">
    <!-- 2) áº¢NH: Ä‘Æ¡n & batch -->
    <div class="card">
      <h2>2) áº¢nh â€” Ä‘Æ¡n & batch</h2>
      <div class="row">
        <div><label>Preset</label>
          <select id="imgPreset">
            <option value="product-1200">Sáº£n pháº©m (dÃ i 1200) â€” .webp q=0.82</option>
            <option value="category-512">Icon danh má»¥c (vuÃ´ng 512) â€” .webp q=0.82</option>
            <option value="cover-1200x630">áº¢nh cover blog (1200Ã—630) â€” .webp q=0.82</option>
            <option value="banner-1920x800">Banner (1920Ã—800) â€” .webp q=0.82</option>
            <option value="original">Giá»¯ nguyÃªn kÃ­ch thÆ°á»›c â€” .webp q=0.82</option>
          </select>
        </div>
        <div><label>ThÆ° má»¥c Ä‘Ã­ch</label>
          <select id="targetFolder">
            <option value="/assets/img/products/">/assets/img/products/</option>
            <option value="/assets/img/categories/">/assets/img/categories/</option>
            <option value="/assets/img/blog/">/assets/img/blog/</option>
            <option value="/assets/img/banners/">/assets/img/banners/</option>
            <option value="__custom__">Tá»± nháº­pâ€¦</option>
          </select>
        </div>
        <div class="xwrap"><label>ThÆ° má»¥c tá»± nháº­p</label><input id="customFolder" placeholder="/assets/img/custom/"/><button class="xbtn" data-clear="#customFolder">Ã—</button></div>
      </div>
      <div class="row">
        <div><label>Quy táº¯c Ä‘áº·t tÃªn</label>
          <select id="nameMode">
            <option value="sku">Theo SKU (thÃªm -01, -02 khi batch)</option>
            <option value="filename">Theo tÃªn file</option>
            <option value="custom">Tuá»³ chá»‰nh</option>
          </select>
        </div>
        <div class="xwrap"><label>TÃªn file tuá»³ chá»‰nh</label><input id="customName" placeholder="ten-anh"/><button class="xbtn" data-clear="#customName">Ã—</button></div>
        <div><label class="small">ÄuÃ´i</label><div class="chip">.webp</div></div>
      </div><div id="drop" class="drop" role="button" tabindex="0">KÃ©o & tháº£ áº£nh vÃ o Ä‘Ã¢y hoáº·c chá»nâ€¦</div>
  <input type="file" id="file" accept="image/*" multiple class="hidden-file"/>
  <div class="row" style="margin-top:10px">
    <label class="btn" id="btnSelectImg" for="file">Chá»n áº£nh</label>
    <button class="btn" id="btnConvert">NÃ©n .webp</button>
    <button class="btn" id="btnSaveImg">Táº£i áº£nh (.webp)</button>
    <button class="btn primary" id="btnUploadImg">Upload áº£nh (Ä‘Æ¡n)</button>
  </div>
  <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
    <img id="thumb" alt="preview"/>
    <div class="small">
      <div><b>TÃªn file Ä‘á» xuáº¥t:</b> <code id="imgName">-</code></div>
      <div><b>KÃ­ch thÆ°á»›c:</b> <span id="imgInfo">-</span></div>
      <div><b>ÄÆ°á»ng dáº«n:</b> <code id="imgPath">-</code></div>
    </div>
  </div>
  <hr style="border:0;border-top:1px dashed #2b3b52;margin:12px 0"/>
  <label>Batch báº±ng URL (má»—i dÃ²ng 1 link áº£nh)</label>
  <textarea id="urlList" placeholder="https://example.com/image1.jpg\nhttps://example.com/image2.png"></textarea>
  <div class="row" style="margin-top:6px">
    <button class="btn" id="btnAddUrls">ThÃªm URL vÃ o batch</button>
    <button class="btn" id="btnClearBatch">XoÃ¡ danh sÃ¡ch</button>
    <button class="btn" id="btnProcessBatch">Xá»­ lÃ½ áº£nh (chuáº©n MXD)</button>
    <button class="btn primary" id="btnUploadBatch">Upload Táº¤T Cáº¢</button>
    <button class="btn" id="btnDownloadBatch">Táº£i Táº¤T Cáº¢ (.webp)</button>
  </div>
  <table class="tbl" id="batchTable" aria-live="polite">
    <thead><tr><th>#</th><th>Nguá»“n</th><th>TÃªn gá»£i Ã½</th><th>KÃ­ch thÆ°á»›c</th><th>Tráº¡ng thÃ¡i</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- 3) THÃ”NG TIN Sáº¢N PHáº¨M + GALLERY -->
<div class="card">
  <h2>3) ThÃ´ng tin sáº£n pháº©m</h2>
  <div class="grid">
    <div class="row"><div class="xwrap"><label>TÃªn sáº£n pháº©m</label><input id="name" placeholder="VÃ­ dá»¥: Dekton DK-AG950S"/><button class="xbtn" data-clear="#name">Ã—</button></div><div class="xwrap"><label>SKU (báº¯t buá»™c)</label><input id="sku" placeholder="dekton-dk-ag950s"/><button class="xbtn" data-clear="#sku">Ã—</button></div></div>
    <div class="row">
      <div class="xwrap"><label>GiÃ¡ (price, VND)</label><input id="price" type="number" placeholder="399000"/><button class="xbtn" data-clear="#price">Ã—</button></div>
      <div class="xwrap"><label>GiÃ¡ cÅ© (old_price, VND)</label><input id="old_price" type="number" placeholder="499000"/><button class="xbtn" data-clear="#old_price">Ã—</button></div>
      <div><label>Merchant</label><select id="merchant"><option value="shopee">shopee</option><option value="lazada">lazada</option><option value="tiktok">tiktok</option><option value="tiki">tiki</option></select></div>
    </div>
    <div class="xwrap"><label>Link gá»‘c (origin)</label><input id="origin" placeholder="https://shopee.vn/... hoáº·c lazada.vn/..."/><button class="xbtn" data-clear="#origin">Ã—</button></div>
    <div class="row"><div class="xwrap"><label>áº¢nh chÃ­nh (image)</label><input id="image" placeholder="/assets/img/products/sku.webp"/><button class="xbtn" data-clear="#image">Ã—</button></div><div class="xwrap"><label>Danh má»¥c (category)</label><input id="category" placeholder="thoi-trang / my-pham â€¦"/><button class="xbtn" data-clear="#category">Ã—</button></div></div>
    <div class="row"><div class="xwrap"><label>Categories[] (phÃ¢n tÃ¡ch báº±ng dáº¥u pháº©y)</label><input id="categories" placeholder="thoi-trang, thu-dong"/><button class="xbtn" data-clear="#categories">Ã—</button></div><div class="xwrap"><label>Tags[] (phÃ¢n tÃ¡ch báº±ng dáº¥u pháº©y)</label><input id="tags" placeholder="deal, flash-sale, giam-gia"/><button class="xbtn" data-clear="#tags">Ã—</button></div></div>
    <div class="xwrap"><label>ThÆ°Æ¡ng hiá»‡u (brand)</label><input id="brand" placeholder="dekton, boschâ€¦"/><button class="xbtn" data-clear="#brand">Ã—</button></div>
    <div class="xwrap"><label>MÃ´ táº£ ngáº¯n (desc_short)</label><textarea id="desc_short" placeholder="1â€“2 cÃ¢u mÃ´ táº£ ngáº¯n gá»n"></textarea></div>
    <div class="row">
      <label class="switch"><input type="checkbox" id="deal"/> deal (Æ°u tiÃªn vÃ o Deal hÃ´m nay)</label>
      <label class="switch"><input type="checkbox" id="featured"/> Ná»•i báº­t</label>
      <label class="switch"><input type="checkbox" id="status" checked/> Hiá»ƒn thá»‹</label>
      <button class="btn" id="btnAuto">Äiá»n auto</button>
      <button class="btn" id="btnSkuFromName">âš¡ SKU â† TÃªn</button>
    </div>
    <div id="diag" class="small"></div>
  </div>

  <h2 style="margin-top:14px">3b) Gallery áº£nh (images[])</h2>
  <div class="small">DÃ¹ng batch vá»›i <b>NameMode=sku</b> Ä‘á»ƒ sinh <code>-01</code>, <code>-02</code>... rá»“i â€œThÃªm tá»« batch â†’ galleryâ€. áº¢nh Ä‘áº§u tiÃªn lÃ  áº£nh chÃ­nh.</div>
  <div class="row" style="margin-top:6px">
    <button class="btn" id="btnAddCurrentToGallery">+ ThÃªm áº£nh hiá»‡n táº¡i</button>
    <button class="btn" id="btnAddBatchToGallery">+ ThÃªm Táº¤T Cáº¢ áº£nh tá»« batch</button>
    <button class="btn" id="btnClearGallery">ğŸ—‘ XoÃ¡ gallery</button>
  </div>
  <div class="gallery" id="galleryList"></div>
</div>

  </div>  <!-- 4) DEEPLINK -->  <div class="card">
    <h2>4) Deepâ€‘link</h2>
    <div class="grid g2">
      <div><label>Origin</label><textarea id="originOut" readonly></textarea><div class="row" style="margin-top:6px"><button class="btn" id="copyOrigin">Copy Origin</button><button class="btn" id="openOrigin">Má»Ÿ Origin</button></div></div>
      <div><label>Affiliate deepâ€‘link</label><textarea id="deeplink" class="deeplink-text" placeholder="Tá»± sinh tá»« template hoáº·c dÃ¡n sáºµn"></textarea><div class="row" style="margin-top:6px"><button class="btn" id="btnMakeDeeplink">Táº¡o tá»« template</button><button class="btn" id="copyDeeplink">Copy Deepâ€‘link</button><button class="btn" id="openDeeplink">Má»Ÿ Deepâ€‘link</button><span id="dlCheck" class="badge">â€“</span></div></div>
    </div>
  </div>  <!-- 5) JSON -->  <div class="card">
    <h2>5) JSON xuáº¥t báº£n</h2>
    <textarea id="jsonOut" rows="10" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">Táº¡o JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">Táº£i affiliates.append.json</button>
      <button class="btn" id="btnUploadJson">Upload JSON â†’ repo</button>
    </div>
  </div>  <!-- 6) BATCH URL â†’ JSON / Publish -->  <div class="card">
    <h2>6) Batch link gá»‘c â†’ JSON / Publish</h2>
    <div class="row">
      <div class="xwrap" style="flex:1 1 560px"><label>Danh sÃ¡ch link gá»‘c</label><textarea id="originBatchInput" placeholder="https://shopee.vn/May-...\nhttps://www.lazada.vn/products/....html"></textarea><button class="xbtn" data-clear="#originBatchInput" style="top:14px">Ã—</button></div>
      <div style="flex:1 1 260px">
        <div class="xwrap"><label>Máº·c Ä‘á»‹nh Brand</label><input id="batchBrand"/><button class="xbtn" data-clear="#batchBrand">Ã—</button></div>
        <div class="xwrap"><label>Máº·c Ä‘á»‹nh Category</label><input id="batchCategory"/><button class="xbtn" data-clear="#batchCategory">Ã—</button></div>
        <label class="switch"><input type="checkbox" id="batchFeatured"/> Mark featured</label>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnParseOrigins">PhÃ¢n tÃ­ch URL</button>
      <button class="btn" id="btnGenJsonFromOrigins">Táº¡o JSON tá»« danh sÃ¡ch</button>
      <button class="btn primary" id="btnPublishOrigins">Publish HÃ€NG LOáº T</button>
      <button class="btn" id="btnClearOrigins">XoÃ¡ danh sÃ¡ch</button>
    </div>
    <table class="tbl" id="originTable"><thead><tr><th>#</th><th>Merchant</th><th>TÃªn gá»£i Ã½</th><th>SKU</th><th>Category</th><th>Deeplink</th><th>Tráº¡ng thÃ¡i</th></tr></thead><tbody></tbody></table>
    <div class="small">Tool chá»‰ dá»±a trÃªn URL (khÃ´ng Ä‘á»c DOM trang Ä‘Ã­ch).</div>
  </div>  <!-- STICKY ACTIONS -->  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish â†’ Store</button>
    <button class="btn" id="btnPublishFeatured">Publish â†’ Ná»•i báº­t</button>
    <button class="btn" id="btnVerify">âœ… Kiá»ƒm tra trÃªn Store</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>  <div class="toast" id="toast"></div>
</div><script>
/* ========= Helpers ========= */
const $=s=>document.querySelector(s);
const LS_KEY='MXD_IMPORTER_SETTINGS_V470';
const slugify=s=>s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/Ä‘/g,'d').replace(/Ä/g,'D').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
function toast(msg,cls=''){ const t=$('#toast'); t.innerHTML=msg; t.className='toast show '+cls; setTimeout(()=>t.className='toast',4500); }
function updateToastOffset(){ const bar=document.querySelector('.sticky-actions'); const bottom=bar?(bar.offsetHeight+16):14; document.documentElement.style.setProperty('--toast-bottom', bottom+'px'); }
addEventListener('load',updateToastOffset); addEventListener('resize',updateToastOffset);

/* ========= CLEAR buttons ========= */
document.querySelectorAll('.xbtn').forEach(b=>{ const sel=b.getAttribute('data-clear'); b.addEventListener('click',()=>{ const el=document.querySelector(sel); if(el){ el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); }}); });

/* ========= Settings ========= */
const settings={ read(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch{return{}}}, write(o){localStorage.setItem(LS_KEY,JSON.stringify(o))} };
function uiToSettings(){ return { workerUrl:$('#workerUrl').value.trim(), xKey:$('#xKey').value.trim(), tplShopee:$('#tplShopee').value.trim(), tplLazada:$('#tplLazada').value.trim(), tplTikTok:$('#tplTikTok').value.trim(), tplTiki:$('#tplTiki').value.trim(), noPreflight:$('#noPreflight').checked, mobileLimit:$('#mobileLimit').checked }; }
function settingsToUi(s){ $('#workerUrl').value=s.workerUrl||''; $('#xKey').value=s.xKey||''; $('#tplShopee').value=s.tplShopee||''; $('#tplLazada').value=s.tplLazada||''; $('#tplTikTok').value=s.tplTikTok||''; $('#tplTiki').value=s.tplTiki||''; $('#noPreflight').checked=!!s.noPreflight; $('#mobileLimit').checked=s.mobileLimit!==false; }
function saveSettings(){ settings.write(uiToSettings()); $('#settingsStatus')?.textContent='ÄÃ£ lÆ°u.'; toast('ÄÃ£ lÆ°u cÃ i Ä‘áº·t.','ok'); }
function loadSettings(){ const s=settings.read(); settingsToUi(s); $('#settingsStatus')?.textContent='ÄÃ£ táº£i cÃ i Ä‘áº·t.'; }
$('#btnSaveSettings').onclick=saveSettings; $('#btnLoadSettings').onclick=loadSettings; $('#btnClearSettings').onclick=()=>{ localStorage.removeItem(LS_KEY); settingsToUi({}); $('#settingsStatus').textContent='ÄÃ£ xoÃ¡.'; }; loadSettings();

/* ========= Mobileâ€‘safe fetch ========= */
function hdr(){ const s=settings.read(); const h={'content-type':(s.noPreflight?'text/plain':'application/json')}; if(!s.noPreflight && s.xKey) h['x-key']=s.xKey; return h; }
async function mfetch(path,{method='GET',json=null,headers={}}={}){ const s=settings.read(); if(!s.workerUrl) throw new Error('ChÆ°a cáº¥u hÃ¬nh Worker'); const base=s.workerUrl.replace(/\/$/,''); const url=new URL(path,base); const body=json?((typeof json==='string')?json:JSON.stringify(json)):undefined; const h=Object.assign({},hdr(),headers); if(s.noPreflight && s.xKey) url.searchParams.set('xk',s.xKey); const opt={method,mode:'cors',keepalive:true,headers:h,body}; const tryOnce=async()=>{ const r=await fetch(url,opt); if(!r.ok) throw new Error('HTTP '+r.status); return r; }; try{ return await tryOnce(); }catch(e){ await new Promise(r=>setTimeout(r,600)); return await tryOnce(); } }

/* ========= Category & helpers ========= */
function vn(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/Ä‘/g,'d').replace(/Ä/g,'D').toLowerCase();}
function normCategory(raw){ const base=vn(raw).replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,''); return base; }
function autoCategory(text){ const rx=[{slug:'my-pham',inc:[/serum|kem|sua\s*r[aÄƒ]m|bha|aha|retinol|niacinamide|sunscreen|chong\s*nang/i]},{slug:'thoi-trang',inc:[/ao|quan|jean|tee|polo|khoac|giay/i]}]; for(const r of rx){ if(r.inc.some(x=>x.test(text))) return r.slug; } return ''; }
function cleanUrl(u){ return (u||'').trim().replace(/^["']+|["',]+$/g,''); }

/* ========= Deepâ€‘link ========= */
function activeTplFor(m){ const s=settings.read(); const map={shopee:s.tplShopee||'',lazada:s.tplLazada||'',tiktok:s.tplTikTok||'',tiki:s.tplTiki||''}; return map[m]||''; }
function computeSubs(sku,merchant){ return {sub1:sku||'sku', sub2:(merchant||'merchant').toLowerCase(), sub3:'tool', sub4:'mxd210'}; }
function ensureSubsInUrl(u,subs){ const has=k=>new RegExp(`[?&]${k}=`,`i`).test(u); const qs=[]; ['sub1','sub2','sub3','sub4'].forEach(k=>{ if(!has(k)) qs.push(`${k}=${encodeURIComponent(subs[k])}`); }); return qs.length?(u+(u.includes('?')?'&':'?')+qs.join('&')):u; }
function makeDeeplink(){ const origin=cleanUrl($('#origin').value.trim()); const sku=$('#sku').value.trim(); const merchant=$('#merchant').value; if(!origin){ toast('Thiáº¿u Origin.','warn'); return; } const tpl=activeTplFor(merchant); if(!tpl){ $('#deeplink').value=''; validateDeeplink(); return; } const subs=computeSubs(sku,merchant); let link=tpl.replace(/\{url\}/g, encodeURIComponent(origin)).replace(/\{sku\}/g, sku||'sku').replace(/\{sub1\}/g, subs.sub1).replace(/\{sub2\}/g, subs.sub2).replace(/\{sub3\}/g, subs.sub3).replace(/\{sub4\}/g, subs.sub4); link=ensureSubsInUrl(link,subs); $('#deeplink').value=link; validateDeeplink(); }
function validateDeeplink(){ const dl=$('#deeplink').value.trim(); const badge=$('#dlCheck'); if(!dl){ badge.textContent='chÆ°a cÃ³ deeplink'; badge.className='badge'; return; } const okHost=/(^https?:\/\/)?([^\/]*\.)?isclix\.com/i.test(dl); const hasUrl=/[?&]url=/.test(dl); const need=['sub1','sub2','sub3','sub4'].filter(k=>!new RegExp(`[?&]${k}=`).test(dl)); if(okHost && hasUrl && need.length===0){ badge.textContent='OK affiliate'; badge.className='badge'; } else if(okHost && !hasUrl){ badge.textContent='isclix thiáº¿u url='; badge.className='badge'; } else if(okHost){ badge.textContent='isclix thiáº¿u: '+need.join(', '); badge.className='badge'; } else { badge.textContent='KHÃ”NG qua affiliate'; badge.className='badge'; } }
['origin','sku','merchant','tplShopee','tplLazada','tplTikTok','tplTiki'].forEach(id=>{ const el=$('#'+id); el.addEventListener('input',()=>{ if($('#origin').value.trim()) makeDeeplink(); }); });
$('#btnMakeDeeplink').onclick=makeDeeplink; $('#deeplink').addEventListener('input', validateDeeplink); $('#copyDeeplink').onclick=()=>{ $('#deeplink').select(); document.execCommand('copy'); toast('ÄÃ£ copy deepâ€‘link.','ok'); }; $('#openDeeplink').onclick=()=>{ const dl=$('#deeplink').value.trim(); if(dl) window.open(dl,'_blank'); }; $('#copyOrigin').onclick=()=>{ $('#originOut').select(); document.execCommand('copy'); toast('ÄÃ£ copy origin.','ok'); }; $('#openOrigin').onclick=()=>{ const u=$('#originOut').value.trim(); if(u) window.open(u,'_blank'); };

/* ========= Auto fill ========= */
$('#btnSkuFromName').onclick=()=>{ const n=$('#name').value.trim(); if(n) $('#sku').value=slugify(n); syncImgPath(); runDiag(); };
$('#btnAuto').onclick=()=>{ const n=$('#name').value.trim(); if(n && !$('#sku').value.trim()) $('#sku').value=slugify(n); syncImgPath(); const g=autoCategory(`${n} ${$('#brand').value} ${$('#origin').value}`); if(g && !$('#category').value.trim()) $('#category').value=g; $('#originOut').value=cleanUrl($('#origin').value.trim()); runDiag(); };
['name','sku','origin','image','merchant'].forEach(id=>$('#'+id).addEventListener('input', runDiag));
function syncImgPath(){ const sku=$('#sku').value.trim(); if(sku && !$('#image').value.trim()) $('#image').value=`/assets/img/products/${sku}.webp`; }

/* ========= Diagnostics ========= */
function runDiag(){ const sku=$('#sku').value.trim(); const img=$('#image').value.trim(); const origin=cleanUrl($('#origin').value.trim()); const merch=$('#merchant').value; const msgs=[]; if(!sku) msgs.push('â€¢ Thiáº¿u SKU.'); if(img && sku && !img.startsWith(`/assets/img/products/${sku}`)) msgs.push('â€¢ áº¢nh nÃªn lÃ  /assets/img/products/'+sku+'.webp'); if(origin && !/shopee\.vn|lazada\.vn|tiki\.vn|tiktok\.com/i.test(origin)) msgs.push('â€¢ Origin khÃ´ng pháº£i sÃ n Ä‘Ã£ há»— trá»£.'); msgs.push('â€¢ Merchant: '+merch); $('#diag').innerHTML=msgs.length? msgs.map(x=>`<div>${x}</div>`).join('') : '<span class="ok">Táº¡m á»•n.</span>'; $('#originOut').value=origin; }

/* ========= Images (single & batch) ========= */
const state={imgBlob:null,imgName:null,imgW:0,imgH:0,imgPath:null};
const drop=$('#drop'), file=$('#file'), thumb=$('#thumb'), imgNameEl=$('#imgName'), imgInfo=$('#imgInfo'), imgPath=$('#imgPath');
async function openPicker(){ try{ if(file.showPicker){ await file.showPicker(); } else { file.click(); } }catch{ file.click(); } }
['click','keydown'].forEach(evt=>{ if(evt==='click'){ drop.addEventListener('click',()=>openPicker()); } else { drop.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openPicker(); }});} });
$('#btnSelectImg')?.addEventListener('click',e=>{ if(e.target.tagName!=='LABEL') openPicker(); });
drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('dragover');}); drop.addEventListener('dragleave',()=>drop.classList.remove('dragover')); drop.addEventListener('drop',e=>{ e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files && e.dataTransfer.files.length>1){ queueBatchFiles(e.dataTransfer.files); }else{ handleFile(e.dataTransfer.files[0]); } });
file.addEventListener('change',e=>{ if(e.target.files.length>1){ queueBatchFiles(e.target.files); } else { handleFile(e.target.files[0]); } });
function getPreset(){ const v=$('#imgPreset').value; const q=0.82; if(v==='product-1200') return {mode:'longedge',long:1200,q}; if(v==='category-512') return {mode:'square',w:512,h:512,q}; if(v==='cover-1200x630') return {mode:'cover',w:1200,h:630,q}; if(v==='banner-1920x800') return {mode:'cover',w:1920,h:800,q}; return {mode:'original',q}; }
function getTargetFolder(){ const v=$('#targetFolder').value; if(v==='__custom__') return ($('#customFolder').value.trim()||'/assets/img/custom/').replace(/\/?$/,'/').replace(/\/+/g,'/').replace(/^(?!\/)/,'/'); return v; }
function getFileBase(i,origName){ const mode=$('#nameMode').value; if(mode==='sku'){ let base=$('#sku').value.trim()||slugify($('#name').value.trim()||'mxd'); if(i>0) base+='-'+String(i+1).padStart(2,'0'); return base; } if(mode==='custom'){ let base=slugify($('#customName').value.trim()||'image'); if(i>0) base+='-'+String(i+1).padStart(2,'0'); return base; } const n=(origName||'image').replace(/\.[^.]+$/,''); return slugify(n||'image'); }
function drawProcessed(img,preset){ let cw,ch,sx=0,sy=0,sw=img.width,sh=img.height; if(preset.mode==='longedge'){ const scale=Math.min(1,preset.long/Math.max(img.width,img.height)); cw=Math.round(img.width*scale); ch=Math.round(img.height*scale); } else if(preset.mode==='square'){ const side=Math.min(img.width,img.height); sx=(img.width-side)/2; sy=(img.height-side)/2; sw=sh=side; cw=preset.w; ch=preset.h; } else if(preset.mode==='cover'){ const {w,h}=preset; const scale=Math.max(w/img.width,h/img.height); const dw=img.width*scale, dh=img.height*scale; cw=w; ch=h; const c=document.createElement('canvas'); c.width=cw; c.height=ch; const ctx=c.getContext('2d'); const dx=(cw-dw)/2, dy=(ch-dh)/2; ctx.drawImage(img,dx,dy,dw,dh); return c; } else { cw=img.width; ch=img.height; } const c=document.createElement('canvas'); c.width=cw; c.height=ch; c.getContext('2d').drawImage(img,sx,sy,sw,sh,0,0,cw,ch); return c; }
function blobToBase64(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }
function handleFile(f){ if(!f) return; const rd=new FileReader(); rd.onload=ev=>{ const img=new Image(); img.onload=()=>{ const preset=getPreset(); const c=drawProcessed(img,preset); c.toBlob(async blob=>{ const folder=getTargetFolder(); const base=getFileBase(0,f.name); const s=settings.read(); if(s.mobileLimit && blob.size>1.8*1024*1024){ toast('áº¢nh >1.8MB; thá»­ preset khÃ¡c hoáº·c giáº£m kÃ­ch thÆ°á»›c.','warn'); } state.imgBlob=blob; state.imgW=c.width; state.imgH=c.height; state.imgName=`${base}.webp`; state.imgPath=(folder+state.imgName).replace(/\/+/g,'/').replace(/^(?!\/)/,'/'); if(folder==='/assets/img/products/' && !$('#image').value.trim()) $('#image').value=state.imgPath; $('#imgPreview').style.display='flex'; thumb.src=URL.createObjectURL(blob); imgNameEl.textContent=state.imgName; imgInfo.textContent=`${c.width}Ã—${c.height}, ${(blob.size/1024).toFixed(1)} KB`; imgPath.textContent=state.imgPath; },'image/webp',preset.q||0.82); }; img.src=ev.target.result; }; rd.readAsDataURL(f); }
$('#btnConvert').onclick=()=>{ if(!state.imgBlob){ toast('ChÆ°a chá»n áº£nh.','warn'); return; } toast('áº¢nh Ä‘Ã£ chuyá»ƒn .webp theo preset.','ok'); };
$('#btnSaveImg').onclick=()=>{ if(!state.imgBlob){ toast('ChÆ°a cÃ³ áº£nh.','warn'); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(state.imgBlob); a.download=state.imgName||'image.webp'; a.click(); };
$('#btnUploadImg').onclick=async()=>{ try{ if(!state.imgBlob) return toast('ChÆ°a cÃ³ áº£nh.','warn'); const b64=await blobToBase64(state.imgBlob); const path=state.imgPath || (`/assets/img/products/${$('#sku').value.trim()||'mxd'}.webp`); const r=await mfetch('/upload-image',{method:'POST',json:{path, file:b64}}); if(!r.ok) throw new Error('HTTP '+r.status); toast('ÄÃ£ upload áº£nh (Ä‘Æ¡n).','ok'); }catch(e){ toast('Upload áº£nh lá»—i: '+e.message,'err'); } };

/* Batch */
const batch=[]; function renderBatch(){ const tb=$('#batchTable tbody'); tb.innerHTML=''; batch.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${it.type==='file'?it.src.name:it.src}</td><td>${it.name||'-'}</td><td>${it.w?`${it.w}Ã—${it.h}`:'-'}</td><td>${it.status||'-'}</td>`; tb.appendChild(tr); }); }
function queueBatchFiles(list){ Array.from(list).forEach(f=>batch.push({type:'file',src:f,name:'',blob:null,w:0,h:0,status:'chá» xá»­ lÃ½'})); renderBatch(); toast(`ÄÃ£ thÃªm ${list.length} áº£nh vÃ o batch.`,'ok'); }
$('#btnAddUrls').onclick=()=>{ const lines=$('#urlList').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); lines.forEach(u=>batch.push({type:'url',src:u,name:'',blob:null,w:0,h:0,status:'chá» táº£i'})); renderBatch(); toast(`ÄÃ£ thÃªm ${lines.length} URL.`,'ok'); };
$('#btnClearBatch').onclick=()=>{ batch.length=0; renderBatch(); };
async function urlToDataURL(u){ const r=await fetch(u,{mode:'cors'}); if(!r.ok) throw new Error('HTTP '+r.status); const b=await r.blob(); return await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b); }); }
async function processItem(it,idx){ try{ let dataURL=null, name='image'; if(it.type==='file'){ name=it.src.name||'image'; dataURL=await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(it.src); }); } else { name=it.src.split('/').pop().split('?')[0]||'image'; dataURL=await urlToDataURL(it.src); } const img=await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=dataURL; }); const c=drawProcessed(img,getPreset()); const blob=await new Promise(res=>c.toBlob(b=>res(b),'image/webp',0.82)); it.blob=blob; it.w=c.width; it.h=c.height; it.name=`${getFileBase(idx,name)}.webp`; it.status='Ä‘Ã£ xá»­ lÃ½'; }catch(e){ it.status='lá»—i: '+e.message; } }
$('#btnProcessBatch').onclick=async()=>{ if(!batch.length) return toast('Danh sÃ¡ch batch trá»‘ng.','warn'); for(let i=0;i<batch.length;i++){ await processItem(batch[i],i); renderBatch(); } toast('Xá»­ lÃ½ xong batch.','ok'); };
$('#btnUploadBatch').onclick=async()=>{ if(!batch.length) return toast('Danh sÃ¡ch batch trá»‘ng.','warn'); const folder=getTargetFolder(); for(let i=0;i<batch.length;i++){ const it=batch[i]; if(!it.blob){ await processItem(it,i); } try{ const path=(folder+it.name).replace(/\/+/g,'/').replace(/^(?!\/)/,'/'); const b64=await blobToBase64(it.blob); const r=await mfetch('/upload-image',{method:'POST',json:{path, file:b64}}); if(!r.ok) throw new Error('HTTP '+r.status); it.status='uploaded â†’ '+path; }catch(e){ it.status='upload lá»—i: '+e.message; } renderBatch(); } toast('Batch upload hoÃ n táº¥t.','ok'); };
$('#btnDownloadBatch').onclick=async()=>{ if(!batch.length) return toast('Danh sÃ¡ch batch trá»‘ng.','warn'); for(let i=0;i<batch.length;i++){ const it=batch[i]; if(!it.blob){ await processItem(it,i); } if(it.blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(it.blob); a.download=it.name; a.click(); it.status='Ä‘Ã£ táº£i vá»'; } renderBatch(); } };

/* ========= Gallery ========= */
const gallery=[]; // array of {src}
function renderGallery(){ const box=$('#galleryList'); box.innerHTML=''; gallery.forEach((g,i)=>{ const item=document.createElement('div'); item.className='gal-item'; item.innerHTML=`<img src="${g.src}" alt="gal"><code>${g.src}</code><div class="gal-actions"><button data-act="up" data-i="${i}">â†‘</button><button data-act="down" data-i="${i}">â†“</button><button data-act="del" data-i="${i}">âœ•</button></div>`; box.appendChild(item); }); }
function pushGallery(path){ if(!path) return; if(!gallery.some(x=>x.src===path)){ gallery.push({src:path}); renderGallery(); } }
$('#btnAddCurrentToGallery').onclick=()=>{ const p=$('#imgPath').textContent.trim()||$('#image').value.trim(); if(!p) return toast('ChÆ°a cÃ³ áº£nh hiá»‡n táº¡i.','warn'); pushGallery(p); if(!$('#image').value.trim()) $('#image').value=p; };
$('#btnAddBatchToGallery').onclick=()=>{ const folder=getTargetFolder(); let added=0; batch.forEach(it=>{ if(it.name){ const p=(folder+it.name).replace(/\/+/g,'/').replace(/^(?!\/)/,'/'); if(!gallery.some(x=>x.src===p)){ gallery.push({src:p}); added++; } } }); if(added){ renderGallery(); if(!$('#image').value.trim() && gallery.length) $('#image').value=gallery[0].src; toast('ÄÃ£ thÃªm '+added+' áº£nh tá»« batch.','ok'); } else { toast('KhÃ´ng cÃ³ áº£nh má»›i tá»« batch.','warn'); }};
$('#btnClearGallery').onclick=()=>{ gallery.length=0; renderGallery(); };
$('#galleryList').addEventListener('click',e=>{ const btn=e.target.closest('button'); if(!btn) return; const i=+btn.dataset.i; const act=btn.dataset.act; if(isNaN(i)) return; if(act==='del'){ gallery.splice(i,1); } else if(act==='up' && i>0){ const t=gallery[i]; gallery[i]=gallery[i-1]; gallery[i-1]=t; } else if(act==='down' && i<gallery.length-1){ const t=gallery[i]; gallery[i]=gallery[i+1]; gallery[i+1]=t; } renderGallery(); if(gallery.length && !$('#image').value.trim()) $('#image').value=gallery[0].src; });

/* ========= JSON (Ä‘Æ¡n) & Publish ========= */
function splitCSV(v){ return String(v||'').split(/[,;|]/).map(s=>s.trim()).filter(Boolean); }
function buildObj(){ if(!$('#category').value.trim()){ const guess=autoCategory(`${$('#name').value} ${$('#brand').value} ${$('#origin').value}`); if(guess) $('#category').value=guess; }
  $('#category').value=normCategory($('#category').value);
  const now=new Date().toISOString();
  const price=Number($('#price').value||0), oldp=Number($('#old_price').value||0);
  const sale_percent=(oldp>0 && price>0 && oldp>price) ? Math.round((1-price/oldp)*100) : undefined;
  const imgs=gallery.map(g=>g.src);
  const primary=$('#image').value.trim()||imgs[0]||''; if(primary && !imgs.includes(primary)) imgs.unshift(primary);
  const obj={ name:$('#name').value.trim(), price, old_price: oldp||undefined, sale_percent, origin:cleanUrl($('#origin').value.trim()), merchant:$('#merchant').value, sku:$('#sku').value.trim(), image:primary, images:imgs.length?imgs:undefined, category:$('#category').value.trim(), categories: splitCSV($('#categories').value), brand:$('#brand').value.trim(), tags: splitCSV($('#tags').value), desc_short: $('#desc_short').value.trim(), deal: $('#deal').checked||undefined, featured:$('#featured').checked, status:$('#status').checked, updated_at:now };
  const dl=$('#deeplink').value.trim(); if(dl) obj.deeplink=dl; return obj; }
function genJSON(){ const obj=buildObj(); $('#jsonOut').value=JSON.stringify([obj],null,2); return obj; }
$('#btnToJson').onclick=genJSON; $('#btnCopyJson').onclick=()=>{ if(!$('#jsonOut').value) genJSON(); $('#jsonOut').select(); document.execCommand('copy'); toast('ÄÃ£ copy JSON.','ok'); };
$('#btnDownloadJson').onclick=()=>{ if(!$('#jsonOut').value) genJSON(); const blob=new Blob([$('#jsonOut').value],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click(); };
$('#btnUploadJson').onclick=async()=>{ try{ const obj=genJSON(); const r=await mfetch('/publish',{method:'POST',json:obj}); if(!r.ok) throw new Error('HTTP '+r.status); toast('Upload JSON â†’ repo: OK','ok'); }catch(e){ toast('Upload JSON lá»—i: '+e.message,'err'); } };

$('#btnGenCommit').onclick=()=>{ const sku=$('#sku').value.trim()||'sku'; $('#commitMsg').value=`feat(data): add/update ${sku} (+gallery, pricing fields) via importer 4.7.0`; };
$('#btnPublish').onclick=()=>doPublish(false); $('#btnPublishFeatured').onclick=()=>doPublish(true);
async function doPublish(forceFeatured){ const obj=genJSON(); if(forceFeatured){ obj.featured=true; $('#featured').checked=true; $('#jsonOut').value=JSON.stringify([obj],null,2); } if(!obj.sku) return toast('Thiáº¿u SKU.','err'); if(!obj.origin) return toast('Thiáº¿u origin.','warn'); if(!$('#deeplink').value.trim()) makeDeeplink(); validateDeeplink(); try{ const r=await mfetch('/publish',{method:'POST',json:obj}); if(!r.ok) throw new Error('HTTP '+r.status); toast('Publish OK â†’ store'+(obj.featured?' + ná»•i báº­t':''),'ok'); scrollTo({top:0,behavior:'smooth'}); }catch(e){ toast('Publish lá»—i: '+e.message+' â€” sáº½ táº£i JSON Ä‘á»ƒ commit tay.', 'err'); const blob=new Blob([JSON.stringify([obj],null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='affiliates.append.json'; a.click(); } }

/* ========= Verify ========= */
$('#btnVerify').onclick=async()=>{ const sku=$('#sku').value.trim(); if(!sku) return toast('ChÆ°a cÃ³ SKU Ä‘á»ƒ kiá»ƒm tra.','warn'); try{ const r=await fetch('/affiliates.json?_='+Date.now(),{cache:'no-cache'}); const arr=await r.json(); const found=(Array.isArray(arr)?arr:(arr.items||[])).some(x=>String(x.sku||'').toLowerCase()===sku.toLowerCase()); toast(found?'ÄÃƒ CÃ“ trong affiliates.json.':'CHÆ¯A THáº¤Y trong affiliates.json.', found?'ok':'warn'); }catch(e){ toast('KhÃ´ng Ä‘á»c Ä‘Æ°á»£c affiliates.json: '+e.message,'err'); } window.open(`/store.html?dev=1&sku=${encodeURIComponent(sku)}&v=${Date.now()}`,'_blank'); };

/* ========= Batch URL â†’ JSON / Publish ========= */
const originBatch=[]; function renderOriginTable(){ const tb=$('#originTable tbody'); tb.innerHTML=''; originBatch.forEach((x,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${x.merchant}</td><td>${x.name||'-'}</td><td>${x.sku}</td><td>${x.category}</td><td>${x.deeplink?'OK':'-'}</td><td>${x._status||'-'}</td>`; tb.appendChild(tr); }); }
function merchantFromUrl(u){ try{ const h=new URL(u).hostname; if(/shopee\.vn/i.test(h)) return 'shopee'; if(/lazada\.vn/i.test(h)) return 'lazada'; if(/tiki\.vn/i.test(h)) return 'tiki'; if(/tiktok\.com/i.test(h)) return 'tiktok'; }catch{} return 'unknown'; }
function extractNameFromUrl(u){ try{ const url=new URL(u); let seg=decodeURIComponent(url.pathname.split('/').filter(Boolean).pop()||''); seg=seg.replace(/\.html?$/i,'').replace(/-i\.[0-9]+\.[0-9]+$/,'').replace(/-[0-9A-Za-z]+$/,'').replace(/[_\-]+/g,' ').trim(); if(!seg) seg=decodeURIComponent(url.hostname); return seg; }catch{ return 'Sáº£n pháº©m'; } }
function uniqueSku(base,seen){ let s=slugify(base)||'item'; if(!seen.has(s)) return s; let i=2; while(seen.has(`${s}-${i}`)) i++; return `${s}-${i}`; }
function dlFor(origin,sku,merchant){ const tpl=activeTplFor(merchant); if(!tpl) return ''; const subs=computeSubs(sku, merchant||'merchant'); let link=tpl.replace(/\{url\}/g, encodeURIComponent(origin)).replace(/\{sku\}/g, sku||'sku').replace(/\{sub1\}/g, subs.sub1).replace(/\{sub2\}/g, subs.sub2).replace(/\{sub3\}/g, subs.sub3).replace(/\{sub4\}/g, subs.sub4); return ensureSubsInUrl(link, subs); }
$('#btnParseOrigins').onclick=()=>{ const raw=$('#originBatchInput').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); if(!raw.length) return toast('Danh sÃ¡ch URL trá»‘ng.','warn'); originBatch.length=0; const seen=new Set(); const defBrand=$('#batchBrand').value.trim(); const defCatNorm=normCategory($('#batchCategory').value||''); raw.forEach(u=>{ const origin=cleanUrl(u); const merchant=merchantFromUrl(origin); const name=extractNameFromUrl(origin); const sku=uniqueSku(name,seen); seen.add(sku); const image=`/assets/img/products/${sku}.webp`; const category=autoCategory(name) || defCatNorm || 'phu-kien'; const deeplink=(/shopee\.vn|lazada\.vn|tiki\.vn|tiktok\.com/i.test(origin)) ? dlFor(origin, sku, merchant) : ''; originBatch.push({name,price:0,origin,merchant,sku,image,category,brand:defBrand,featured:!!$('#batchFeatured').checked,status:true,updated_at:new Date().toISOString(),deeplink}); }); renderOriginTable(); $('#jsonOut').value=JSON.stringify(originBatch,null,2); toast(`ÄÃ£ phÃ¢n tÃ­ch ${originBatch.length} URL.`,'ok'); };
$('#btnGenJsonFromOrigins').onclick=()=>{ if(!originBatch.length) return toast('ChÆ°a cÃ³ dá»¯ liá»‡u batch.','warn'); $('#jsonOut').value=JSON.stringify(originBatch,null,2); toast('ÄÃ£ táº¡o JSON tá»« danh sÃ¡ch.','ok'); };
$('#btnPublishOrigins').onclick=async()=>{ if(!originBatch.length) return toast('Danh sÃ¡ch batch trá»‘ng.','warn'); for(let i=0;i<originBatch.length;i++){ const item=originBatch[i]; try{ if(!item.deeplink && /shopee\.vn|lazada\.vn|tiki\.vn|tiktok\.com/i.test(item.origin)){ item.deeplink=dlFor(item.origin,item.sku,item.merchant); } const r=await mfetch('/publish',{method:'POST',json:item}); if(!r.ok) throw new Error('HTTP '+r.status); item._status='published'; }catch(e){ item._status='lá»—i: '+e.message; } renderOriginTable(); } $('#jsonOut').value=JSON.stringify(originBatch,null,2); toast('Publish hÃ ng loáº¡t hoÃ n táº¥t.','ok'); };
$('#btnClearOrigins').onclick=()=>{ originBatch.length=0; renderOriginTable(); toast('ÄÃ£ xoÃ¡ danh sÃ¡ch link gá»‘c.'); };

/* ========= Final ========= */
updateToastOffset(); runDiag();
</script></body>
</html>
