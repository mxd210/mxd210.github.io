<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<meta name="format-detection" content="telephone=no"/>
<title>MXD Importer v4.5.0 ‚Äî Pro+ (EN/VN)</title>
<meta name="description" content="Importer chu·∫©n MXD: Shopee/Lazada/Tiki ‚Üí affiliates.json + snippets + ·∫£nh .webp + health-check + SKU validator + commit generator."/>
<link rel="canonical" href="https://mxd210.github.io/tools/shopee-importer.html"/>
<meta name="robots" content="noindex,follow"/>

<!-- OG -->
<meta property="og:type" content="website"/>
<meta property="og:title" content="MXD Importer v4.5.0 ‚Äî Pro+"/>
<meta property="og:description" content="JSON + snippets + ·∫£nh + health-check + SKU tools. English (Vietnamese) labels."/>
<meta property="og:url" content="https://mxd210.github.io/tools/shopee-importer.html"/>
<meta property="og:image" content="/assets/img/products/placeholder.webp"/>

<!-- Convention MXD: GA4 tr∆∞·ªõc Affiliate -->
<script defer src="/assets/analytics.js"></script>
<script defer src="/assets/mxd-affiliate.js"></script>

<link rel="stylesheet" href="/assets/site.css"/>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>

<style>
  :root { --gap:12px; --br:14px; }
  body { max-width:1220px; margin:0 auto; padding:12px; line-height:1.55; }
  header { position:sticky; top:0; background:var(--bg,#fff); z-index:50; padding:8px 0; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .tabs { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0 12px; }
  .tab { padding:8px 12px; border:1px solid #d1d5db; border-radius:999px; background:#fff; cursor:pointer; }
  .tab.active { background:#111827; border-color:#111827; color:#fff; }
  .card { border:1px solid #e5e7eb; border-radius:var(--br); padding:12px; background:#fff; }
  h1{font-size:1.5rem;margin:6px 0 6px;} h2{font-size:1.15rem;margin:10px 0 8px;}
  textarea, input[type=text], input[type=url], input[type=number]{ width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; font-family: ui-monospace, Menlo, Consolas, monospace; }
  textarea{ min-height:120px; resize:vertical; }
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer; display:inline-flex; gap:8px; align-items:center }
  .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
  .btn.ghost{ background:transparent; }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  .btn.busy{ position:relative; }
  .btn.busy::after{ content:""; width:14px; height:14px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; position:absolute; right:8px; animation:spin .8s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .muted{ color:#6b7280; } .small{ font-size:.9em; }
  .hidden{ display:none; }
  .grid{ display:grid; gap:var(--gap); } .g2{ grid-template-columns:1fr 1fr; } .g3{ grid-template-columns:1fr 1fr 1fr; }
  @media (max-width:960px){ .g2,.g3{ grid-template-columns:1fr; } }
  .toolbar{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .spacer{ flex:1 }
  .section-sep{ margin-top:14px; }
  .nowrap{ white-space:nowrap; }
  /* Affiliate block spacing */
  #aff-block{ display:grid; grid-template-columns:1fr; gap:10px; }
  #aff-origin{ min-height:44px; }
  #aff-output{ min-height:96px; }
  /* Quick outputs */
  #quick-outputs textarea{ min-height:86px }
  /* tables */
  table { width:100%; border-collapse: collapse; font-size:.95rem; }
  th,td{ border-bottom:1px solid #eee; padding:8px; vertical-align:top; } th{ background:#fafafa; position:sticky; top:0; }
  td[contenteditable="true"]{ background:#fffbeb; outline:2px dashed #fde68a; }
  .ok{ color:#065f46 } .err{ color:#b91c1c } .warn{ color:#92400e }
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <div class="row">
      <a class="btn ghost" href="/">Home (Trang ch·ªß)</a>
      <a class="btn ghost" href="/store.html">Store (C·ª≠a h√†ng)</a>
      <a class="btn ghost" href="/blog/index.html">Blog (Tin t·ª©c)</a>
      <a class="btn ghost" href="/contact.html">Contact (Li√™n h·ªá)</a>
    </div>
    <div class="row">
      <span id="build-badge" class="small muted">build 2025-09-24 05:35 UTC</span>
      <label class="switch"><input id="compact" type="checkbox"> <span class="small muted">Compact mode (Ch·∫ø ƒë·ªô g·ªçn)</span></label>
    </div>
  </div>
  <h1>MXD Importer v4.5.0 ‚Äî Pro+ <span class="small muted">English (Ti·∫øng Vi·ªát)</span></h1>
  <div class="tabs">
    <button class="tab active" data-tab="import">Import (Nh·∫≠p)</button>
    <button class="tab" data-tab="output">Output (K·∫øt qu·∫£)</button>
    <button class="tab" data-tab="snippets">Snippets (ƒêo·∫°n ch√®n)</button>
    <button class="tab" data-tab="images">Images (·∫¢nh)</button>
    <button class="tab" data-tab="health">Health (Ki·ªÉm tra link)</button>
    <button class="tab" data-tab="log">Log (Nh·∫≠t k√Ω)</button>
    <button class="tab" data-tab="settings">Settings (C√†i ƒë·∫∑t)</button>
  </div>
</header>

<section id="guide" class="card">
  <h2>üìò H∆∞·ªõng d·∫´n (lu·ªìng thao t√°c nhanh)</h2>
  <ol class="small">
    <li>D√°n <b>Link g·ªëc</b> (1 ho·∫∑c nhi·ªÅu). H·ªôp b√™n d∆∞·ªõi sinh ngay <b>Link affiliate (auto)</b>.</li>
    <li>B·∫•m <b>Parse ‚Üí Fetch + Build</b>. Tool t·ª± sinh SKU, deeplink, ·∫£nh, v.v.</li>
    <li>Xem <b>Quick Outputs</b> ngay t·∫°i tab Import: JSON, HTML snippet, danh s√°ch ·∫£nh.</li>
    <li>M·ªü c√°c tab <b>Output/Images/Health</b> ƒë·ªÉ tinh ch·ªânh & export.</li>
  </ol>
</section>

<!-- Import -->
<section id="tab-import" class="card">
  <div class="grid g2">
    <div>
      <h2>1) Input (Nh·∫≠p d·ªØ li·ªáu)</h2>

      <div class="card section-sep">
        <h3>Auto-Search Shopee</h3>
        <div class="row">
          <input id="auto-q" type="text" placeholder="T·ª´ kh√≥a, v√≠ d·ª•: m√°y c·∫Øt g·∫°ch" style="max-width:360px">
          <input id="auto-pages" type="number" min="1" max="5" value="1" style="max-width:120px">
          <button class="btn" id="btn-auto-search">Get links (L·∫•y link)</button>
          <span class="small muted" id="auto-status"></span>
        </div>
        <p class="small muted">C√≥ th·ªÉ d√°n link search Shopee v√†o √¥ ‚ÄúInput‚Äù r·ªìi b·∫•m Get links (tool t·ª± nh·∫≠n d·∫°ng).</p>
      </div>

      <div class="card section-sep" id="aff-block">
        <div>
          <label class="small muted">Link g·ªëc (1 s·∫£n ph·∫©m) ‚Äî ho·∫∑c t·ª± l·∫•y link ƒë·∫ßu ti√™n trong √¥ Input</label>
          <textarea id="aff-origin" placeholder="https://shopee.vn/product/.../..."></textarea>
        </div>
        <div>
          <div class="row">
            <label class="small muted">Link affiliate (auto)</label>
            <button class="btn" id="aff-copy">Copy</button>
            <button class="btn" id="aff-open">Open</button>
            <button class="btn" id="aff-qr">QR</button>
            <button class="btn" id="aff-build-all">Build all from Input</button>
            <button class="btn" id="aff-copy-all">Copy all</button>
          </div>
          <textarea id="aff-output" placeholder="‚Äî deeplink s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y ‚Äî"></textarea>
          <p class="small muted">Template: isclix path <code>https://go.isclix.com/deep_link/{AFF_ID}/{CAMP_ID}?url={URL_ENC}&sub1={SKU}</code> ho·∫∑c d√πng template t√πy ch·ªânh (Settings).</p>
        </div>
      </div>

      <div class="section-sep">
        <div class="dropzone" id="drop">Drag & drop CSV/TXT here ‚Äì ho·∫∑c d√°n t·ª´ Excel: <b>T√™n|Gi√°|Link</b></div>
        <textarea id="txt-input" placeholder="https://shopee.vn/product/.../...\nM√°y c·∫Øt KYNKO | 1390000 | https://..." ></textarea>
      </div>

      <div class="row section-sep">
        <div class="row">
          <label class="small muted">ƒê·ªãnh d·∫°ng:</label>
          <label><input type="radio" name="fmt" value="link" checked> Links per line</label>
          <label><input type="radio" name="fmt" value="pipe"> Name|Price|Link</label>
        </div>
        <div class="row">
          <label class="small muted">Merchant:</label>
          <label><input type="radio" name="mrc" value="auto" checked> Auto</label>
          <label><input type="radio" name="mrc" value="shopee"> Shopee</label>
          <label><input type="radio" name="mrc" value="lazada"> Lazada</label>
          <label><input type="radio" name="mrc" value="tiki"> Tiki</label>
        </div>
      </div>

      <div class="row">
        <input id="default-sub1" type="text" placeholder="sub1 (optional / t√πy ch·ªçn)" style="max-width:220px">
        <label class="row"><input id="bulk-sub1" type="checkbox"> Bulk sub1={sku}</label>
        <span class="spacer"></span>
        <button class="btn" id="btn-parse">Parse</button>
        <button class="btn primary" id="btn-fetch">Fetch + Build</button>
      </div>

      <label class="row"><input id="auto-pipeline" type="checkbox"> Auto image pipeline after Fetch</label>
      <p class="small muted">Tool t·ª± sinh <b>SKU</b>, <code>/assets/img/products/&lt;sku&gt;.webp</code>, v√† deeplink (n·∫øu set AFF_ID + CAMP_ID ho·∫∑c template).</p>

      <div id="quick-outputs" class="card section-sep">
        <h3>‚ö° Quick Outputs (Xem nhanh & copy)</h3>
        <div class="row">
          <button class="btn" id="qo-refresh">Refresh t·ª´ Output</button>
          <span class="small muted" id="qo-status"></span>
        </div>
        <div class="grid g3 section-sep">
          <div>
            <h4 class="small">A) JSON (preview)</h4>
            <textarea id="qo-json" placeholder="{}"></textarea>
            <div class="row"><button class="btn" id="qo-copy-json">Copy</button></div>
          </div>
          <div>
            <h4 class="small">B) HTML snippet (Store)</h4>
            <label class="small"><input id="qo-use-deep" type="checkbox" checked> d√πng deep-link cho n√∫t Mua</label>
            <textarea id="qo-html" placeholder="&lt;a class='product-meta' ...&gt;"></textarea>
            <div class="row"><button class="btn" id="qo-copy-html">Copy</button></div>
          </div>
          <div>
            <h4 class="small">C) Danh s√°ch ·∫£nh</h4>
            <textarea id="qo-images" placeholder="/assets/img/products/sku.webp"></textarea>
            <div class="row"><button class="btn" id="qo-copy-images">Copy</button></div>
          </div>
        </div>
      </div>

    </div>

    <div>
      <div class="card">
        <h2>JSON link (Li√™n k·∫øt JSON)</h2>
        <div class="row">
          <input id="json-link" type="text" value="/assets/data/affiliates.json" readonly>
          <button class="btn" id="btn-copy-json-link">Copy link</button>
          <button class="btn" id="btn-open-json-link">Open</button>
        </div>
        <p class="small muted">ƒê∆∞·ªùng d·∫´n tƒ©nh commit l√™n GitHub Pages. Kh√¥ng ph·∫£i blob:URL.</p>
      </div>

      <div class="card section-sep">
        <h2>2) JSON (T·ªáp d·ªØ li·ªáu)</h2>
        <div class="row">
          <button class="btn" id="btn-load-existing">Load affiliates.json</button>
          <button class="btn" id="btn-merge">Merge & dedupe</button>
          <button class="btn" id="btn-copy-json">Copy JSON</button>
          <button class="btn primary" id="btn-download-json">Download affiliates.json</button>
        </div>
        <p id="out-msg" class="small muted"></p>
      </div>
    </div>
  </div>
</section>

<!-- Output tab -->
<section id="tab-output" class="card hidden">
  <div class="toolbar">
    <h2>Output table (B·∫£ng k·∫øt qu·∫£)</h2>
    <div class="row">
      <button class="btn" id="btn-validate-sku">Validate SKUs</button>
      <button class="btn" id="btn-normalize-sku">Normalize SKUs</button>
      <button class="btn" id="btn-commit">Commit message</button>
      <button class="btn" id="btn-copy-commit">Copy commit</button>
      <button class="btn" id="btn-goto-import">‚Üê Back to Import</button>
    </div>
  </div>
  <div style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:10px;">
    <table id="out-table"><thead><tr>
      <th>Name [edit]</th><th class="nowrap">Price</th><th class="nowrap">Merchant</th>
      <th>Origin</th><th class="nowrap">SKU [edit]</th><th>Image</th><th>Deep link</th>
      <th class="nowrap">Featured</th><th></th>
    </tr></thead><tbody></tbody></table>
  </div>
  <textarea id="commit-msg" class="small" placeholder="Commit message‚Ä¶" style="margin-top:8px; min-height:80px"></textarea>
  <textarea id="sku-report" class="small" placeholder="SKU report‚Ä¶" style="margin-top:8px; min-height:80px"></textarea>
</section>

<!-- Snippets -->
<section id="tab-snippets" class="card hidden">
  <div class="row">
    <label class="row"><input id="snip-deep" type="checkbox"> Use deep-link for buy</label>
    <button class="btn" id="btn-build-snippets">Build snippets</button>
    <button class="btn" id="btn-copy-snippets">Copy</button>
  </div>
  <textarea id="snippets" placeholder="Snippets chu·∫©n MXD‚Ä¶" style="margin-top:8px; min-height:140px"></textarea>
</section>

<!-- Images -->
<section id="tab-images" class="card hidden">
  <h2>Image tools (C√¥ng c·ª• ·∫£nh)</h2>
  <div class="grid g3">
    <div>
      <h3 class="small">A) Extract images</h3>
      <p class="small muted">L·∫•y og:image qua Worker /head.</p>
      <div class="row">
        <button class="btn" id="btn-img-from-head">Extract via /head</button>
        <button class="btn" id="btn-img-from-out">Use fetched images</button>
      </div>
    </div>
    <div>
      <h3 class="small">B) Presets</h3>
      <select id="img-preset">
        <option value="store">Store card 800√ó800 ‚Üí /assets/img/products/&lt;sku&gt;.webp</option>
        <option value="home">Homepage 1200√ó800 ‚Üí /assets/img/hero/&lt;sku&gt;-hero.webp</option>
        <option value="banner">Banner 1600√ó500 ‚Üí /assets/img/banners/&lt;sku&gt;-banner.webp</option>
        <option value="blog">Blog/OG 1200√ó630 ‚Üí /assets/img/tin-tuc/&lt;sku&gt;-og.webp</option>
        <option value="thumb">Thumb 400√ó400 ‚Üí /assets/img/products/&lt;sku&gt;-thumb.webp</option>
      </select>
      <label class="small"><input id="img-fit" type="checkbox" checked> Cover (crop gi·ªØa) / b·ªè ch·ªçn = Contain</label>
      <label>Quality</label>
      <input id="img-q" type="number" min="0.6" max="0.95" step="0.01" value="0.86"/>
    </div>
    <div>
      <h3 class="small">C) Export</h3>
      <div class="row"><button class="btn primary" id="btn-make-images">Generate & ZIP</button></div>
      <p id="img-msg" class="small muted"></p>
    </div>
  </div>
  <textarea id="images-list" placeholder="/assets/img/products/<sku>.webp" style="margin-top:8px; min-height:120px"></textarea>
</section>

<!-- Health -->
<section id="tab-health" class="card hidden">
  <h2>Health-check (Ki·ªÉm tra)</h2>
  <div class="row">
    <label>Throttle (ms)</label><input id="hc-throttle" type="number" min="50" step="10" value="120" style="max-width:120px">
    <button class="btn" id="btn-hc-scan">Scan affiliates.json</button>
    <button class="btn" id="btn-hc-copy">Copy report</button>
    <button class="btn primary" id="btn-hc-download">Download affiliates.prune.json</button>
  </div>
  <textarea id="hc-report" class="small" placeholder="Health report‚Ä¶" style="margin-top:8px; min-height:200px"></textarea>
</section>

<!-- Log -->
<section id="tab-log" class="card hidden">
  <h2>Fetch Log (Nh·∫≠t k√Ω)</h2>
  <div style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:10px;">
    <table id="log-table"><thead><tr>
      <th class="nowrap">Time</th><th>URL</th><th class="nowrap">Merchant</th>
      <th class="nowrap">Status</th><th class="nowrap">Parser</th><th>Msg</th>
    </tr></thead><tbody></tbody></table>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="btn-clear-log">Clear log</button>
  </div>
</section>

<!-- Settings -->
<section id="tab-settings" class="card hidden">
  <div class="grid g2">
    <div>
      <h2>Settings</h2>
      <label>Worker Base</label><input id="set-worker" type="url" placeholder="https://mxd210.mxd6686.workers.dev">
      <div class="card section-sep">
        <h3>isclix path-format (ƒë∆°n gi·∫£n)</h3>
        <label>AFF_ID</label><input id="set-affid" type="text" placeholder="ATxxxxxxx">
        <label>CAMP_ID</label><input id="set-campid" type="text" placeholder="VD: SHOPEE (ho·∫∑c ID chi·∫øn d·ªãch)">
        <label class="row"><input id="use-isclix-path" type="checkbox" checked> B·∫≠t isclix path-format: <code>/deep_link/{AFF_ID}/{CAMP_ID}?url=‚Ä¶&sub1=‚Ä¶</code></label>
      </div>
      <div class="card section-sep">
        <h3>Ho·∫∑c d√πng template tu·ª≥ ch·ªânh (n√¢ng cao)</h3>
        <label>Template Shopee</label>
        <input id="tpl-shopee" type="text" placeholder="https://go.isclix.com/deep_link?url={url}&aff_id={aff_id}&merchant=shopee&sub1={sub1}">
        <label>Template Lazada</label>
        <input id="tpl-lazada" type="text" placeholder="https://go.isclix.com/deep_link?url={url}&aff_id={aff_id}&merchant=lazada&sub1={sub1}">
        <label>Template Tiki</label>
        <input id="tpl-tiki" type="text" placeholder="https://go.isclix.com/deep_link?url={url}&aff_id={aff_id}&merchant=tiki&sub1={sub1}">
        <label class="row"><input id="override-deeplink" type="checkbox"> Deep-link override for buy</label>
      </div>
      <div class="row section-sep">
        <button class="btn" id="btn-save-settings">Save</button>
        <button class="btn" id="btn-test-head">Test /head</button>
        <span id="settings-msg" class="small muted"></span>
      </div>
    </div>
    <div>
      <h2>Shortcuts</h2>
      <ul class="small">
        <li><b>Ctrl+Enter</b> ‚Üí Fetch</li>
        <li><b>Ctrl+S</b> ‚Üí Save settings</li>
        <li><b>Alt+1..6</b> ‚Üí Tabs</li>
        <li><b>Alt+V</b> ‚Üí Validate SKU</li>
        <li><b>Alt+C</b> ‚Üí Generate commit</li>
      </ul>
    </div>
  </div>
</section>

<script>
// ===== State =====
let SETTINGS = loadSettings();
let LOGS = [];
let OUT = [];
let EXISTING = [];
let HC_LAST = { kept: [], removed: [], report: '' };

// ===== Utils =====
const q = s => document.querySelector(s);
const qa = s => Array.from(document.querySelectorAll(s));
const nowStr = () => new Date().toLocaleString();
const escapeHTML = s => String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;' }[m]));
const sleep = ms => new Promise(r=>setTimeout(r, ms));
const go = id => document.getElementById(id)?.scrollIntoView({behavior:'smooth', block:'start'});
function withBusy(btn, fn){
  const el = (typeof btn==='string')? q(btn) : btn;
  if (!el) return fn();
  el.classList.add('busy'); el.setAttribute('disabled',''); const txt=el.textContent; el.textContent = (txt||'')+'‚Ä¶';
  return Promise.resolve(fn()).finally(()=>{ el.classList.remove('busy'); el.removeAttribute('disabled'); el.textContent = txt; });
}

function slugifyVN(s){
  s = String(s||'').toLowerCase().trim();
  s = s.normalize('NFD').replace(/[\\u0300-\\u036f]/g,'');
  s = s.replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  return s || ('mxd-'+Date.now().toString(36));
}
function guessMerchant(u){
  u = String(u||'').toLowerCase();
  if (u.includes('shopee.')) return 'shopee';
  if (u.includes('lazada.')) return 'lazada';
  if (u.includes('tiki.vn')) return 'tiki';
  return '';
}
function parseShopeeIDs(u){ const m = String(u||'').match(/product\\/(\\d+)\\/(\\d+)/i); return m ? {shop:m[1], item:m[2]} : null; }
function isLazadaProduct(u){ try{ const p=new URL(u).pathname; return /-i\\d+\\.html$/i.test(p) || /\\/products\\//i.test(p);}catch{ return false; } }
function isTikiProduct(u){ try{ const p=new URL(u).pathname; return /-p\\d+\\.html$/i.test(p) || /\\/p\\//i.test(p);}catch{ return false; } }
const isProductUrl = (u)=>{ try{ const host=new URL(u).hostname; return (
  (/shopee\\./.test(host) && /\\/product\\/\\d+\\/\\d+$/i.test(new URL(u).pathname)) ||
  (/lazada\\./.test(host) && isLazadaProduct(u)) || (/tiki\\.vn$/.test(host) && isTikiProduct(u))
);}catch{ return false; } };
const toNumber = (x)=>{ if (x==null) return null; const n = String(x).replace(/[^\\d]/g,''); return n? Number(n): null; };

function logPush({url, merchant, status, parser, message}){
  LOGS.unshift({ts: nowStr(), url, merchant, status, parser, message});
  const tb = q('#log-table tbody');
  tb.innerHTML = LOGS.map(l=>`
    <tr>
      <td class="nowrap">${l.ts}</td>
      <td>${escapeHTML(l.url||'')}</td>
      <td class="nowrap">${l.merchant||''}</td>
      <td class="nowrap ${Number(l.status)>=200&&Number(l.status)<400?'ok':(Number(l.status)>=300&&Number(l.status)<400?'warn':'err')}">${l.status||''}</td>
      <td class="nowrap">${l.parser||''}</td>
      <td class="small">${escapeHTML(l.message||'')}</td>
    </tr>
  `).join('');
}

// ===== Settings =====
function loadSettings(){
  const raw = localStorage.getItem('mxd_settings_v45_pro');
  if (raw) return JSON.parse(raw);
  return {
    worker:'', aff_id:'', camp_id:'',
    use_isclix_path:true,
    tpl_shopee:'https://go.isclix.com/deep_link?url={url}&aff_id={aff_id}&merchant=shopee&sub1={sub1}',
    tpl_lazada:'https://go.isclix.com/deep_link?url={url}&aff_id={aff_id}&merchant=lazada&sub1={sub1}',
    tpl_tiki:'https://go.isclix.com/deep_link?url={url}&aff_id={aff_id}&merchant=tiki&sub1={sub1}',
    override:false
  };
}
function mountSettings(){
  q('#set-worker').value = SETTINGS.worker || '';
  q('#set-affid').value = SETTINGS.aff_id || '';
  q('#set-campid').value = SETTINGS.camp_id || '';
  q('#use-isclix-path').checked = !!SETTINGS.use_isclix_path;
  q('#tpl-shopee').value = SETTINGS.tpl_shopee || '';
  q('#tpl-lazada').value = SETTINGS.tpl_lazada || '';
  q('#tpl-tiki').value = SETTINGS.tpl_tiki || '';
  q('#override-deeplink').checked = !!SETTINGS.override;
}
function saveSettings(){
  SETTINGS.worker = q('#set-worker').value.trim();
  SETTINGS.aff_id = q('#set-affid').value.trim();
  SETTINGS.camp_id = q('#set-campid').value.trim();
  SETTINGS.use_isclix_path = q('#use-isclix-path').checked;
  SETTINGS.tpl_shopee = q('#tpl-shopee').value.trim();
  SETTINGS.tpl_lazada = q('#tpl-lazada').value.trim();
  SETTINGS.tpl_tiki = q('#tpl-tiki').value.trim();
  SETTINGS.override = q('#override-deeplink').checked;
  localStorage.setItem('mxd_settings_v45_pro', JSON.stringify(SETTINGS));
  q('#settings-msg').textContent = 'Saved (ƒê√£ l∆∞u).'; setTimeout(()=> q('#settings-msg').textContent='', 1600);
  updateAffiliatePreview();
}

// Tabs
function showTab(id){
  qa('section[id^="tab-"]').forEach(el=>el.classList.add('hidden'));
  q('#tab-'+id).classList.remove('hidden');
  qa('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  localStorage.setItem('tab', id);
  go('tab-'+id);
}
qa('.tab').forEach(b=> b.onclick = ()=> showTab(b.dataset.tab));
showTab(localStorage.getItem('tab') || 'import');

q('#compact').onchange = (e)=>{
  document.body.style.setProperty('--gap', e.target.checked ? '8px' : '12px');
  document.body.querySelectorAll('.btn').forEach(b=>b.style.padding = e.target.checked?'6px 10px':'8px 12px');
};
document.addEventListener('keydown', (ev)=>{
  if (ev.ctrlKey && ev.code==='Enter'){ q('#btn-fetch').click(); ev.preventDefault(); }
  if (ev.ctrlKey && ev.key.toLowerCase()==='s'){ q('#btn-save-settings').click(); ev.preventDefault(); }
  if (ev.altKey){
    const map = {'Digit1':'import','Digit2':'output','Digit3':'snippets','Digit4':'images','Digit5':'health','Digit6':'settings'};
    if (map[ev.code]){ showTab(map[ev.code]); ev.preventDefault(); }
    if (ev.key.toLowerCase()==='v'){ q('#btn-validate-sku').click(); ev.preventDefault(); }
    if (ev.key.toLowerCase()==='c'){ q('#btn-commit').click(); ev.preventDefault(); }
  }
});

// ===== Affiliate builders =====
function deeplinkTemplate(merchant, origin, sub1){
  const aff = SETTINGS.aff_id || '';
  if (SETTINGS.use_isclix_path && aff && SETTINGS.camp_id){
    return `https://go.isclix.com/deep_link/${encodeURIComponent(aff)}/${encodeURIComponent(SETTINGS.camp_id)}?url=${encodeURIComponent(origin)}&sub1=${encodeURIComponent(sub1||'')}`;
  }
  const map = { shopee: SETTINGS.tpl_shopee, lazada: SETTINGS.tpl_lazada, tiki: SETTINGS.tpl_tiki };
  const tpl = map[merchant] || '';
  if (!tpl || !aff) return origin;
  return tpl.replace('{url}', encodeURIComponent(origin))
    .replace('{aff_id}', encodeURIComponent(aff))
    .replace('{sub1}', encodeURIComponent(sub1||''));
}
async function buildAffiliatePreview(origin, sub1=''){
  const merchant = guessMerchant(origin);
  const tplDeep = deeplinkTemplate(merchant, origin, sub1);
  if (tplDeep && tplDeep !== origin) return { url: tplDeep, via:'template', merchant };
  const base = (SETTINGS.worker||'').replace(/\\/+$/,'');
  if (base){
    try{
      const r = await fetch(`${base}/aff?url=${encodeURIComponent(origin)}&merchant=${merchant}&sub1=${encodeURIComponent(sub1||'')}`, {mode:'cors'});
      const j = await r.json(); if (j && j.url) return { url:j.url, via:'worker', merchant };
    }catch(_){}
  }
  return { url: origin, via:'none', merchant };
}
function firstLinkInText(txt){ const m = String(txt||'').match(/\\bhttps?:\\/\\/[^\\s<>"']+/i); return m ? m[0] : ''; }
function qrUrl(u, size=260){ return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(u)}`; }

// ===== Parse input (drag & drop) =====
function parseInput(raw, fmt, forceMerchant){
  if (/\\t/.test(raw) || /,https?:\\/\\//.test(raw)){
    const rows = raw.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
    raw = rows.map(line=>{
      const parts = line.split(/\\t|,(?=https?:\\/\\/)/);
      const [name, price, link] = [parts[0]||'', parts[1]||'', parts[2]||parts[1]||''];
      return `${name} | ${price} | ${link}`;
    }).join('\\n');
    fmt = 'pipe';
  }
  const lines = raw.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  for (const line of lines){
    if (fmt==='pipe'){
      const [name, priceStr, link] = line.split('|').map(s=>s.trim());
      if (!link || !isProductUrl(link)) continue;
      const origin = link.split('?')[0];
      const merchant = forceMerchant==='auto' ? guessMerchant(origin) : forceMerchant;
      const priceNum = toNumber(priceStr);
      if (priceNum==null) continue;
      out.push({name, price: priceNum, origin, merchant});
    } else {
      if (!isProductUrl(line)) continue;
      const origin = line.split('?')[0];
      const merchant = forceMerchant==='auto' ? guessMerchant(origin) : forceMerchant;
      out.push({name:'', price:0, origin, merchant});
    }
  }
  return out;
}
// Drag & drop
const drop = q('#drop');
['dragenter','dragover'].forEach(e=> drop.addEventListener(e, ev=>{ ev.preventDefault(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(e=> drop.addEventListener(e, ev=>{ ev.preventDefault(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', ev=>{
  const f = ev.dataTransfer.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ q('#txt-input').value = (q('#txt-input').value+'\\n'+reader.result).trim(); updateAffiliatePreview(); };
  reader.readAsText(f);
});

// ===== Worker helpers =====
async function fetchHead(url){
  const base = (SETTINGS.worker||'').replace(/\\/+$/,'');
  if (!base) return {status:0, parser:'fallback', title:'', image:'', price:null, brand:''};
  const res = await fetch(base + '/head?url=' + encodeURIComponent(url), {mode:'cors'});
  let data = {}; try { data = await res.json(); } catch(_){}
  return {
    status: res.status || 0, parser: 'worker-head',
    title: data.title || data.ogTitle || '',
    image: data.image || data.ogImage || '',
    price: (data.price!=null && isFinite(Number(data.price))) ? Number(data.price) : null,
    brand: data.brand || ''
  };
}
function fallbackFromURL(u){
  try { const url = new URL(u); const last = url.pathname.split('/').filter(Boolean).pop() || url.hostname; const name = last.replace(/[-_]+/g,' ').slice(0,80); return {title: name, image:'', price:null, brand:''}; }
  catch { return {title:'', image:'', price:null, brand:''}; }
}
function isShopeeSearchURL(s){ try { const u = new URL(s); return u.hostname.includes('shopee') && u.pathname.replace(/\\/+$/,'')==='/search'; } catch { return false; } }
async function searchShopeeLinks(qOrUrl, pages){
  const base = (SETTINGS.worker||'').replace(/\\/+$/,'');
  if (!base) throw new Error('Worker ch∆∞a c·∫•u h√¨nh (Settings ‚Üí Worker Base).');
  const results = new Set();
  if (isShopeeSearchURL(qOrUrl)) {
    const r = await fetch(`${base}/search?url=${encodeURIComponent(qOrUrl)}`, {mode:'cors'});
    const j = await r.json(); (j.links||[]).forEach(h=>results.add(h));
  } else {
    for (let p=1; p<=pages; p++){
      const u = `https://shopee.vn/search?keyword=${encodeURIComponent(qOrUrl)}&page=${p-1}`;
      const r = await fetch(`${base}/search?url=${encodeURIComponent(u)}`, {mode:'cors'});
      const j = await r.json(); (j.links||[]).forEach(h=>results.add(h));
      await sleep(200);
    }
  }
  return Array.from(results);
}

// ===== OUT rendering =====
function renderOUT(){
  const tb = q('#out-table tbody');
  tb.innerHTML = OUT.map((it,idx)=>`
    <tr>
      <td contenteditable="true" oninput="editField(${idx},'name',this.textContent)">${escapeHTML(it.name||'')}</td>
      <td class="nowrap"><input type="number" min="0" step="1" value="${isFinite(it.price)?it.price:''}" oninput="editPrice(${idx},this.value)" style="width:110px"></td>
      <td class="nowrap">${it.merchant||''}</td>
      <td>${escapeHTML(it.origin||'')}</td>
      <td contenteditable="true" oninput="editField(${idx},'sku',this.textContent)">${escapeHTML(it.sku||'')}</td>
      <td class="small">${escapeHTML(it.image||'')}</td>
      <td class="small">${escapeHTML(it.deeplink||'')}</td>
      <td class="nowrap"><input type="checkbox" ${it.featured?'checked':''} onchange="toggleFeat(${idx},this.checked)"></td>
      <td class="nowrap"><button class="btn" onclick="removeRow(${idx})">X</button></td>
    </tr>
  `).join('');
}
window.editField = (i,k,v)=>{ OUT[i][k]=String(v||'').trim(); syncDerived(i); };
window.editPrice = (i,v)=>{ OUT[i].price = Number(v)||0; syncDerived(i); };
window.toggleFeat = (i,checked)=>{ OUT[i].featured = !!checked; };
window.removeRow = (i)=>{ OUT.splice(i,1); renderOUT(); };

function syncDerived(i){
  const it = OUT[i];
  if (!it.sku) it.sku = slugifyVN(it.name || it.origin);
  it.image = `/assets/img/products/${it.sku}.webp`;
  if (q('#bulk-sub1').checked) it.sub1 = it.sku;
  it.deeplink = deeplinkTemplate(it.merchant||'', it.origin||'', it.sub1||'');
}

// Helpers
function dedupe(items){ const map = new Map(); for (const it of items){ const key=(it.origin||'')+'#'+(it.sku||''); if(!map.has(key)) map.set(key,it);} return Array.from(map.values()); }
const isRenderable = (it)=> it && isProductUrl(it.origin) && isFinite(it.price) && Number(it.price)>0;
function toAffJSON(items){
  return items.filter(isRenderable).map(it=>({
    name:String(it.name||'').trim(), price:Number(it.price)||0,
    origin:String(it.origin||'').trim(), merchant:String(it.merchant||'').trim(),
    sku:String(it.sku||'').trim(), image: it.image || (`/assets/img/products/${String(it.sku||'').trim()}.webp`),
    category:String(it.category||'').trim(), brand:String(it.brand||'').trim(),
    featured:!!it.featured, sub1:String(it.sub1||'').trim(),
    deeplink:String(it.deeplink||it.origin||'').trim(), srcImage: it.srcImage || ''
  }));
}
function download(filename, text){
  const blob = new Blob([text], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

// ===== Affiliate UI actions =====
async function updateAffiliatePreview(){
  const first = (q('#aff-origin').value.trim() || firstLinkInText(q('#txt-input').value) || '').split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean)[0];
  if (!first){ q('#aff-output').value = ''; return; }
  const sub1 = (q('#default-sub1').value || '').trim();
  const info = await buildAffiliatePreview(first, sub1);
  q('#aff-output').value = info.url || first;
}
async function buildAllDeeplinksFromInput(){
  const txt = q('#txt-input').value || '';
  const lines = txt.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
  const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
  const sub1 = q('#default-sub1').value.trim();
  const out = [];
  for (const line of lines){
    const origin = line.split('|').pop().trim();
    const link = isProductUrl(origin) ? origin : (isProductUrl(line)? line : '');
    if (!link) continue;
    const m = (forceM==='auto')? guessMerchant(link) : forceM;
    const sku = slugifyVN(link);
    const deep = deeplinkTemplate(m, link, q('#bulk-sub1').checked?sku:(sub1||''));
    out.push(deep);
  }
  q('#aff-output').value = out.join('\\n');
  return out.length;
}
q('#aff-copy').onclick = ()=> navigator.clipboard.writeText(q('#aff-output').value||'');
q('#aff-open').onclick = ()=>{ const u=(q('#aff-output').value||'').split(/\\r?\\n/)[0]; if (u) window.open(u,'_blank'); };
q('#aff-qr').onclick = ()=>{ const u=(q('#aff-output').value||'').split(/\\r?\\n/)[0]; if (!u) return; const w=window.open('about:blank','_blank'); if (w) w.document.write(`<img alt="QR" src="${qrUrl(u,280)}"/>`); };
q('#aff-build-all').onclick = ()=> withBusy('#aff-build-all', async()=>{ const n = await buildAllDeeplinksFromInput(); q('#auto-status').textContent = `Built ${n} deeplinks.`; go('quick-outputs'); });
q('#aff-copy-all').onclick = ()=> navigator.clipboard.writeText(q('#aff-output').value||'');

// ===== Actions: Import =====
q('#btn-parse').onclick = ()=> withBusy('#btn-parse', ()=>{
  const fmt = (qa('input[name="fmt"]').find(x=>x.checked)||{}).value || 'link';
  const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
  const sub1 = q('#default-sub1').value.trim();
  const rows = parseInput(q('#txt-input').value, fmt, forceM);
  OUT = rows.map(r=>{
    const m = r.merchant || guessMerchant(r.origin);
    const ids = (m==='shopee') ? parseShopeeIDs(r.origin) : null;
    let sku = slugifyVN(r.name || r.origin);
    if ((!r.name || r.name.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
    const it = { name: r.name || r.origin, price:r.price||0, origin:r.origin, merchant:m,
      sku, image:`/assets/img/products/${sku}.webp`, brand:'', category:'', featured:false, sub1, srcImage:'' };
    if (q('#bulk-sub1').checked) it.sub1 = it.sku;
    it.deeplink = deeplinkTemplate(it.merchant, it.origin, it.sub1);
    return it;
  });
  OUT = dedupe(OUT); renderOUT(); showTab('output');
  q('#out-msg').textContent = `Parsed ${OUT.length} rows.`; setTimeout(()=> q('#out-msg').textContent='', 1600);
  updateAffiliatePreview();
});

q('#btn-auto-search').onclick = async ()=> withBusy('#btn-auto-search', async()=>{
  const kw = (q('#auto-q').value || '').trim();
  const pages = Number(q('#auto-pages').value)||1;
  const raw = (q('#txt-input').value || '').trim();
  const maybeUrl = raw.split(/\\r?\\n/).map(s=>s.trim()).find(isShopeeSearchURL) || '';
  q('#auto-status').textContent = 'ƒêang l·∫•y link‚Ä¶';
  try {
    const links = await searchShopeeLinks(maybeUrl || kw, Math.max(1, Math.min(pages,5)));
    if (!links.length){ q('#auto-status').textContent = 'Kh√¥ng th·∫•y link product.'; return; }
    const current = q('#txt-input').value.trim();
    q('#txt-input').value = (current ? (current+'\\n') : '') + links.join('\\n');
    (qa('input[name="fmt"]').find(x=>x.value==='link')||{}).checked = true;
    q('#auto-status').textContent = `ƒê√£ l·∫•y ${links.length} link.`;
    updateAffiliatePreview(); go('txt-input');
  } catch(e){ q('#auto-status').textContent = 'L·ªói: ' + e.message; }
});

q('#btn-fetch').onclick = async ()=> withBusy('#btn-fetch', async()=>{
  const fmt = (qa('input[name="fmt"]').find(x=>x.checked)||{}).value || 'link';
  const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
  const sub1 = q('#default-sub1').value.trim();
  const rows = parseInput(q('#txt-input').value, fmt, forceM);
  OUT = [];
  for (const r of rows){
    const m = r.merchant || guessMerchant(r.origin);
    if (!isProductUrl(r.origin)) continue;
    try {
      const head = await fetchHead(r.origin);
      const fb = fallbackFromURL(r.origin);
      let name = r.name || head.title || fb.title;
      let price = isFinite(r.price)&&r.price>0 ? r.price : (toNumber(head.price)!=null? Number(head.price):0);
      const ids = (m==='shopee') ? parseShopeeIDs(r.origin) : null;
      let sku = slugifyVN(name || r.origin);
      if ((!name || name.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
      OUT.push({
        name, price, origin:r.origin, merchant:m, brand: head.brand||'',
        category:'', sku, image:`/assets/img/products/${sku}.webp`,
        featured:false, sub1, deeplink: deeplinkTemplate(m, r.origin, q('#bulk-sub1').checked?sku:(sub1||'')),
        srcImage: head.image || ''
      });
      logPush({url:r.origin, merchant:m, status: head.status, parser: head.parser, message: name? 'Parsed':'Name empty'});
    } catch(e){
      const fb = fallbackFromURL(r.origin);
      const ids = (m==='shopee') ? parseShopeeIDs(r.origin) : null;
      let sku = slugifyVN(fb.title || r.origin);
      if ((!fb.title || fb.title.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
      OUT.push({
        name: r.name || fb.title, price: isFinite(r.price)?r.price:0, origin:r.origin, merchant:m,
        brand:'', category:'', sku, image:`/assets/img/products/${sku}.webp`,
        featured:false, sub1, deeplink: deeplinkTemplate(m, r.origin, q('#bulk-sub1').checked?sku:(sub1||'')), srcImage:''
      });
      logPush({url:r.origin, merchant:m, status:0, parser:'fallback', message:String(e)});
    }
  }
  OUT = dedupe(OUT); renderOUT(); showTab('output');
  // Quick outputs
  refreshQuickOutputs(); showTab('import'); go('quick-outputs');
  q('#out-msg').textContent = `Done: ${OUT.length} items.`; setTimeout(()=> q('#out-msg').textContent='', 1800);
  if (q('#auto-pipeline').checked){ showTab('images'); await extractImagesViaHead(); await generateZipPreset('store'); }
  updateAffiliatePreview();
});

// ===== Load/Merge/Export JSON =====
q('#btn-load-existing').onclick = async ()=> withBusy('#btn-load-existing', async()=>{
  try { const res = await fetch('/assets/data/affiliates.json', {cache:'no-store'}); const arr = await res.json(); EXISTING = Array.isArray(arr) ? arr : []; q('#out-msg').textContent = `Loaded ${EXISTING.length} items.`; }
  catch(e){ q('#out-msg').textContent = 'Cannot load /assets/data/affiliates.json.'; }
});
q('#btn-merge').onclick = ()=>{
  const merged = dedupe([...EXISTING, ...OUT]);
  OUT = merged.map(x=>{
    const m = x.merchant || guessMerchant(x.origin);
    const ids = (m==='shopee') ? parseShopeeIDs(x.origin) : null;
    let sku = x.sku || slugifyVN(x.name||x.origin);
    if ((!x.name || x.name.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
    return { name:x.name||'', price:isFinite(x.price)?Number(x.price):0, origin:x.origin||'', merchant:m,
      sku, image:x.image || `/assets/img/products/${sku}.webp`, brand:x.brand||'', category:x.category||'',
      featured:!!x.featured, sub1:x.sub1||'', deeplink:x.deeplink||x.origin, srcImage: x.srcImage||'' };
  });
  renderOUT(); showTab('output'); q('#out-msg').textContent = `Merged & deduped: ${OUT.length} items.`;
};
q('#btn-copy-json').onclick = ()=>{ const txt = JSON.stringify(toAffJSON(OUT), null, 2); navigator.clipboard.writeText(txt).then(()=>{ q('#out-msg').textContent = 'Copied JSON.'; setTimeout(()=> q('#out-msg').textContent='', 1200); }); };
q('#btn-download-json').onclick = ()=>{ const txt = JSON.stringify(toAffJSON(OUT), null, 2); download('affiliates.json', txt); };
q('#btn-copy-json-link').onclick = ()=> navigator.clipboard.writeText(q('#json-link').value||'');
q('#btn-open-json-link').onclick = ()=> window.open(q('#json-link').value||'/assets/data/affiliates.json','_blank');

// ===== Snippets =====
function buildSnippetFor(it, useDeep){
  const buyHref = useDeep ? (it.deeplink||it.origin) : it.origin;
  const label = it.merchant==='shopee'?'Shopee':it.merchant==='lazada'?'Lazada':it.merchant==='tiki'?'Tiki':'Buy';
  return [
    `<a class="product-meta" href="${it.origin}" data-merchant="${it.merchant}" data-sku="${it.sku}" data-img="/assets/img/products/${it.sku}.webp" data-price="${isFinite(it.price)?it.price:0}">${it.name}</a>`,
    `<a class="buy" href="${buyHref}" data-merchant="${it.merchant}">Mua ${label}</a>`
  ].join('\\n');
}
q('#btn-build-snippets').onclick = ()=>{ const useDeep = q('#snip-deep').checked || SETTINGS.override; q('#snippets').value = OUT.filter(isRenderable).map(it=> buildSnippetFor(it, useDeep)).join('\\n\\n'); };
q('#btn-copy-snippets').onclick = ()=> navigator.clipboard.writeText(q('#snippets').value||'');

// ===== Images =====
function presetInfo(key){
  if (key==='store')  return {w:800,  h:800,  path:(sku)=>`assets/img/products/${sku}.webp`};
  if (key==='home')   return {w:1200, h:800,  path:(sku)=>`assets/img/hero/${sku}-hero.webp`};
  if (key==='banner') return {w:1600, h:500,  path:(sku)=>`assets/img/banners/${sku}-banner.webp`};
  if (key==='blog')   return {w:1200, h:630,  path:(sku)=>`assets/img/tin-tuc/${sku}-og.webp`};
  if (key==='thumb')  return {w:400,  h:400,  path:(sku)=>`assets/img/products/${sku}-thumb.webp`};
  return {w:800, h:800, path:(sku)=>`assets/img/products/${sku}.webp`};
}
async function fetchImageBlobBypass(url){
  const base = (SETTINGS.worker||'').replace(/\\/+$/,'');
  const src = base ? `${base}/img?url=${encodeURIComponent(url)}` : url;
  const res = await fetch(src, {mode: base ? 'cors' : 'no-cors'});
  return await res.blob();
}
async function resizeToWebp(blob, w, h, fit='cover', quality=0.86){
  const imgBitmap = await createImageBitmap(blob);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
  const iw = imgBitmap.width, ih = imgBitmap.height;
  const r = Math[fit==='cover'?'max':'min'](w/iw, h/ih);
  const nw = iw*r, nh = ih*r;
  const dx = (w - nw)/2, dy = (h - nh)/2;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(imgBitmap, dx, dy, nw, nh);
  return await new Promise(res=> canvas.toBlob(res, 'image/webp', Math.min(Math.max(quality,0.6),0.95)));
}
async function extractImagesViaHead(){
  let ok=0;
  for (const it of OUT){ try { const head = await fetchHead(it.origin); if (head.image){ it.srcImage = head.image; ok++; } } catch(_){} }
  q('#images-list').value = OUT.map(it=> `${it.sku} ‚Üê ${it.srcImage||'(no image)'}`).join('\\n');
  q('#img-msg').textContent = `Got images for ${ok}/${OUT.length}.`;
}
q('#btn-img-from-head').onclick = ()=> withBusy('#btn-img-from-head', extractImagesViaHead);
q('#btn-img-from-out').onclick = ()=>{ q('#images-list').value = OUT.map(it=> `${it.sku} ‚Üê ${it.srcImage||'(no image)'}`).join('\\n'); q('#img-msg').textContent = `Listed current srcImage.`; };
async function generateZipPreset(presetKey){
  const preset = presetInfo(presetKey || q('#img-preset').value);
  const fit = q('#img-fit').checked ? 'cover' : 'contain';
  const quality = Number(q('#img-q').value)||0.86;
  const zip = new JSZip(); let cnt = 0;
  for (const it of OUT.filter(isRenderable)){
    if (!it.srcImage) continue;
    try { const blob = await fetchImageBlobBypass(it.srcImage); const webp = await resizeToWebp(blob, preset.w, preset.h, fit, quality); const path = preset.path(it.sku); zip.file(path, webp); cnt++; }
    catch(_){}
  }
  if (cnt===0){ q('#img-msg').textContent = 'No srcImage yet. Extract first.'; return; }
  const content = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(content);
  a.download = `mxd-images-${presetKey||q('#img-preset').value}-${Date.now()}.zip`; a.click(); URL.revokeObjectURL(a.href);
  q('#img-msg').textContent = `ZIP ready (${cnt} images).`;
}
q('#btn-make-images').onclick = ()=> withBusy('#btn-make-images', ()=>generateZipPreset());

// ===== SKU tools / Commit =====
function validateSKUList(items){
  const issues = []; const seen = new Set();
  for (const it of items){
    const raw = (it.sku||'').trim(); const norm = slugifyVN(raw);
    if (!/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(raw)) issues.push(`Invalid chars: ${raw} ‚Üí suggest ${norm}`);
    if (seen.has(raw)) issues.push(`Duplicate SKU: ${raw}`); seen.add(raw);
  } return issues;
}
q('#btn-validate-sku').onclick = ()=>{ const issues = validateSKUList(OUT.filter(isRenderable)); q('#sku-report').value = issues.length? issues.join('\\n') : 'All SKUs look good.'; };
q('#btn-normalize-sku').onclick = ()=>{ OUT.forEach(it=> it.sku = slugifyVN(it.sku || it.name || it.origin)); OUT = dedupe(OUT); renderOUT(); q('#sku-report').value = 'Normalized SKUs.'; };
q('#btn-commit').onclick = ()=>{
  const mapOld = new Map((EXISTING||[]).map(x=> [ (x.origin||'')+'#'+(x.sku||''), x ]));
  const mapNew = new Map(OUT.filter(isRenderable).map(x=> [ (x.origin||'')+'#'+(x.sku||''), x ]));
  const added = []; const updated = [];
  for (const [k,v] of mapNew){ if (!mapOld.has(k)) added.push(v); else { const o = mapOld.get(k); if ((o.name||'')!== (v.name||'') || Number(o.price||0)!==Number(v.price||0)) updated.push(v); } }
  const headAdd = added.slice(0,5).map(x=>x.sku).join(', ');
  const headUpd = updated.slice(0,5).map(x=>x.sku).join(', ');
  const parts = []; if (added.length) parts.push(`feat(data): add ${added.length} products [${headAdd}]`); if (updated.length) parts.push(`fix(data): update ${updated.length} products [${headUpd}]`);
  const msg = parts.length? parts.join('\\n') : 'chore(data): minor touch (no valid changes detected)';
  q('#commit-msg').value = msg;
};
q('#btn-copy-commit').onclick = ()=> navigator.clipboard.writeText(q('#commit-msg').value||'');
q('#btn-goto-import').onclick = ()=> showTab('import');

// ===== Health-check =====
async function hcCheckItem(it){
  const base = (SETTINGS.worker||'').replace(/\\/+$/,'');
  let h1 = {status:0}; let h2 = {status:0};
  try { h1 = await fetchHead(it.origin); } catch(_){ }
  const deep = (it.deeplink && it.deeplink!==it.origin) ? it.deeplink : '';
  if (base && deep){ try { const r2 = await fetch(`${base}/head?url=${encodeURIComponent(deep)}`, {mode:'cors'}); h2.status = r2.status||0; } catch(_){ } }
  const ok = (h1.status>=200 && h1.status<400); return { ok, originStatus:h1.status||0, deepStatus:h2.status||0 };
}
async function runHealthScan(items, throttleMs){
  const kept = []; const removed = []; const lines = []; let i=0;
  for (const it of items){ i++; const r = await hcCheckItem(it);
    const tag = r.ok? 'OK ' : 'ERR'; lines.push(`[${tag}] #${i} ${it.sku} ‚Ä¢ origin=${r.originStatus} ‚Ä¢ deep=${r.deepStatus} ‚Äî ${it.origin}`);
    if (r.ok) kept.push(it); else removed.push(it); await sleep(throttleMs);
  } return { kept, removed, report: lines.join('\\n') };
}
q('#btn-hc-scan').onclick = async ()=> withBusy('#btn-hc-scan', async()=>{
  const throttle = Math.max(50, Number(q('#hc-throttle').value)||120);
  let items = []; if (OUT && OUT.length) items = toAffJSON(OUT); else { try { const r = await fetch('/assets/data/affiliates.json', {cache:'no-store'}); items = await r.json(); } catch{ items = []; } }
  if (!Array.isArray(items) || !items.length){ q('#hc-report').value = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ qu√©t.'; return; }
  q('#hc-report').value = `ƒêang qu√©t ${items.length} items‚Ä¶`; HC_LAST = await runHealthScan(items, throttle);
  const summary = `Kept: ${HC_LAST.kept.length} ‚Ä¢ Removed: ${HC_LAST.removed.length}`; q('#hc-report').value = summary + '\\n' + HC_LAST.report; go('tab-health');
});
q('#btn-hc-copy').onclick = ()=> navigator.clipboard.writeText(q('#hc-report').value||'');
q('#btn-hc-download').onclick = ()=>{ const txt = JSON.stringify(HC_LAST.kept||[], null, 2); download('affiliates.prune.json', txt); };

// ===== Log helpers =====
q('#btn-clear-log').onclick = ()=>{ LOGS = []; q('#log-table tbody').innerHTML = ''; };

// ===== Settings actions =====
q('#btn-save-settings').onclick = ()=> withBusy('#btn-save-settings', saveSettings);
q('#btn-test-head').onclick = async ()=> withBusy('#btn-test-head', async()=>{
  const sample = q('#aff-origin').value.trim() || firstLinkInText(q('#txt-input').value) || 'https://shopee.vn/product/1/1';
  const r = await fetchHead(sample);
  q('#settings-msg').textContent = `/head ‚Üí status ${r.status} ‚Ä¢ title="${(r.title||'').slice(0,40)}"`; setTimeout(()=> q('#settings-msg').textContent='', 2400);
});

// ===== Quick Outputs =====
function refreshQuickOutputs(){
  const items = toAffJSON(OUT);
  q('#qo-json').value = JSON.stringify(items.slice(0,10), null, 2) + (items.length>10?`\\n/* ‚Ä¶and ${items.length-10} more */`:'');
  const useDeep = q('#qo-use-deep').checked;
  q('#qo-html').value = items.map(it=> {
    const buy = useDeep ? (it.deeplink||it.origin) : it.origin;
    return `<div class="card product"><img src="${it.image}" alt="${it.name}"><h3>${it.name}</h3><p class="price">${it.price.toLocaleString('vi-VN')}</p><p><a class="buy" href="${buy}" data-merchant="${it.merchant}">Mua</a></p></div>`;
  }).join('\\n');
  q('#qo-images').value = items.map(it=> it.image).join('\\n');
  q('#qo-status').textContent = `Items: ${items.length}`;
}
q('#qo-refresh').onclick = ()=> withBusy('#qo-refresh', ()=>{ refreshQuickOutputs(); go('quick-outputs'); });
q('#qo-copy-json').onclick = ()=> navigator.clipboard.writeText(q('#qo-json').value||'');
q('#qo-copy-html').onclick = ()=> navigator.clipboard.writeText(q('#qo-html').value||'');
q('#qo-copy-images').onclick = ()=> navigator.clipboard.writeText(q('#qo-images').value||'');
q('#qo-use-deep').onchange = refreshQuickOutputs;

// ===== Affiliate field reactions =====
q('#aff-origin').addEventListener('input', ()=> updateAffiliatePreview());
q('#default-sub1').addEventListener('input', ()=> updateAffiliatePreview());

// ===== Init =====
function init(){ mountSettings(); showTab(localStorage.getItem('tab') || 'import'); updateAffiliatePreview(); console.log('MXD Importer build:', q('#build-badge')?.textContent||'no-stamp'); }
init();
</script>
</body></html>
