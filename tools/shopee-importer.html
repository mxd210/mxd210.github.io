<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <meta name="format-detection" content="telephone=no"/>
  <title>MXD Importer 4.0 — auto-fetch debug</title>
  <meta name="description" content="Dán link gốc → tool auto-fetch meta, build affiliates.json, sinh product-meta snippets. Hỗ trợ Shopee, Lazada, Tiki."/>
  <link rel="canonical" href="https://mxd210.github.io/tools/shopee-importer.html"/>
  <meta name="robots" content="noindex,follow"/>

  <!-- OG -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="MXD Importer 4.0 — auto-fetch debug"/>
  <meta property="og:description" content="Nhập link gốc, xuất JSON + snippets, có log & deep-link builder."/>
  <meta property="og:url" content="https://mxd210.github.io/tools/shopee-importer.html"/>
  <meta property="og:image" content="/assets/img/products/placeholder.webp"/>

  <!-- Convention MXD: GA4 trước Affiliate -->
  <script defer src="/assets/analytics.js"></script>
  <script defer src="/assets/mxd-affiliate.js"></script>

  <!-- Site CSS chuẩn -->
  <link rel="stylesheet" href="/assets/site.css"/>

  <style>
    :root { --gap:12px; }
    body { max-width: 1100px; margin: 0 auto; padding: 16px; line-height: 1.55; }
    header, nav { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    nav a { text-decoration:none; padding:6px 10px; border-radius:10px; border:1px solid #ddd; }
    nav a:hover { background:#fafafa; }
    h1 { font-size:1.6rem; margin:12px 0 8px; }
    h2 { font-size:1.2rem; margin:14px 0 8px; }
    .grid { display:grid; gap: var(--gap); }
    .g2 { grid-template-columns: 1fr 1fr; }
    .card { border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff; }
    textarea { width:100%; min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    input[type=text], input[type=url], input[type=number] { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; }
    label { font-weight:600; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { padding:8px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .btn:hover { filter: brightness(0.98); }
    table { width:100%; border-collapse: collapse; font-size:.95rem; }
    th, td { border-bottom:1px solid #eee; padding:8px; vertical-align: top; }
    th { text-align:left; background:#fafafa; position:sticky; top:0; }
    .muted { color:#6b7280; }
    .small { font-size:.9em; }
    .nowrap { white-space:nowrap; }
    code.inline { padding:2px 6px; background:#f3f4f6; border-radius:6px; }
    td[contenteditable="true"] { background:#fffbeb; outline:2px dashed #fde68a; }
    .ok { color:#065f46; }
    .err { color:#b91c1c; }
    .warn { color:#92400e; }
    @media (max-width: 860px){ .g2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="row">
    <a class="pill" href="/">Trang chủ</a>
    <nav class="row">
      <a href="/store.html">Cửa hàng</a>
      <a href="/blog/index.html">Tin tức</a>
      <a href="/contact.html">Liên hệ</a>
    </nav>
  </header>

  <h1>MXD Importer 4.0 — auto-fetch debug</h1>
  <p class="muted">Khớp <b>MXD Web Conventions</b>: GA4 trước Affiliate, xuất <code class="inline">affiliates.json</code>, sinh <code class="inline">product-meta</code> snippets, ảnh theo <code class="inline">/assets/img/products/&lt;sku&gt;.webp</code>. Mặc định buy link dùng <i>link gốc</i>; deep-link override tùy chọn.</p>

  <!-- SETTINGS -->
  <section class="card grid g2">
    <div>
      <h2>Settings</h2>
      <div class="grid" style="gap:8px">
        <div><label>Worker Base (tùy chọn)</label><input id="set-worker" type="url" placeholder="https://mxd210.mxd6686.workers.dev"></div>
        <div><label>AFF_ID (AccessTrade)</label><input id="set-affid" type="text" placeholder="ATxxxxxxx (để trống = không deep)"></div>
        <div><label>Template Shopee</label><input id="tpl-shopee" type="text" placeholder="https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=shopee&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"></div>
        <div><label>Template Lazada</label><input id="tpl-lazada" type="text" placeholder="https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=lazada&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"></div>
        <div><label>Template Tiki (tùy chọn)</label><input id="tpl-tiki" type="text" placeholder="https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=tiki&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"></div>
        <div class="row">
          <label class="row"><input id="override-deeplink" type="checkbox"> Xuất buy link dạng deep-link (override – mặc định tắt)</label>
        </div>
        <div class="row">
          <button class="btn" id="btn-save-settings">Save settings</button>
          <button class="btn" id="btn-test-head">Test /head</button>
          <span id="settings-msg" class="muted small"></span>
        </div>
      </div>
      <p class="small muted">Mặc định buy link = link gốc (để <code>mxd-affiliate.js</code> tự rewrite). Bật “override” chỉ khi cần kiểm thử đặc biệt.</p>
    </div>

    <div>
      <h2>Nhập dữ liệu</h2>
      <div class="grid" style="gap:8px">
        <div>
          <label>Danh sách (mỗi dòng 1 sản phẩm)</label>
          <textarea id="txt-input" placeholder="Dạng 1: link
Dạng 2: Tên | giá | link"></textarea>
        </div>
        <div class="grid" style="gap:8px">
          <div class="row">
            <label>Định dạng:</label>
            <label><input type="radio" name="fmt" value="link" checked> Link mỗi dòng</label>
            <label><input type="radio" name="fmt" value="pipe"> Tên | giá | link</label>
          </div>
          <div class="row">
            <label>Merchant:</label>
            <label><input type="radio" name="mrc" value="auto" checked> Auto</label>
            <label><input type="radio" name="mrc" value="shopee"> Shopee</label>
            <label><input type="radio" name="mrc" value="lazada"> Lazada</label>
            <label><input type="radio" name="mrc" value="tiki"> Tiki</label>
          </div>
          <div class="row">
            <input id="default-sub1" type="text" placeholder="sub1 (tùy chọn)" style="max-width:220px">
            <button class="btn" id="btn-parse">Parse</button>
            <button class="btn primary" id="btn-fetch">Fetch + Build</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- LOG + OUTPUT -->
  <section class="grid g2" style="margin-top:16px">
    <div class="card">
      <h2>Fetch Log</h2>
      <div style="max-height:280px; overflow:auto; border:1px solid #eee; border-radius:10px;">
        <table id="log-table">
          <thead><tr>
            <th class="nowrap">Thời gian</th>
            <th>URL</th>
            <th class="nowrap">Merchant</th>
            <th class="nowrap">Status</th>
            <th class="nowrap">Parser</th>
            <th>Msg</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-clear-log">Clear log</button>
      </div>
    </div>

    <div class="card">
      <h2>Kết quả (affiliates)</h2>
      <div style="max-height:360px; overflow:auto; border:1px solid #eee; border-radius:10px;">
        <table id="out-table">
          <thead><tr>
            <th>Tên (edit)</th>
            <th class="nowrap">Giá</th>
            <th class="nowrap">Merchant</th>
            <th>Origin</th>
            <th class="nowrap">SKU (edit)</th>
            <th>Image</th>
            <th>Deep link</th>
            <th class="nowrap">Feat.</th>
            <th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-load-existing">Load existing JSON</button>
        <button class="btn" id="btn-merge">Merge & dedupe</button>
        <button class="btn" id="btn-copy-json">Copy JSON</button>
        <button class="btn primary" id="btn-download-json">Download affiliates.json</button>
        <span id="out-msg" class="muted small"></span>
      </div>
    </div>
  </section>

  <!-- SNIPPETS -->
  <section class="card" style="margin-top:16px">
    <h2>Product-meta Snippet Builder (chuẩn MXD)</h2>
    <p class="small muted">Sinh đúng block: <code class="inline">&lt;a class="product-meta" ...&gt;</code> → sau đó 1 buy link theo merchant. Ảnh = <code class="inline">/assets/img/products/&lt;sku&gt;.webp</code>. Giá đổ vào <code class="inline">data-price</code>.</p>
    <div class="row">
      <label class="row"><input id="snip-use-deep" type="checkbox"> Dùng deep-link cho buy link (override – mặc định OFF)</label>
      <button class="btn" id="btn-build-snippets">Build snippets</button>
      <button class="btn" id="btn-copy-snippets">Copy</button>
    </div>
    <textarea id="snippets" placeholder="Snippets sẽ xuất hiện ở đây…" style="margin-top:8px; min-height:140px"></textarea>
    <p class="small muted">Dán các snippet này vào nơi cần hiển thị (ví dụ danh mục, bài blog, hoặc khu vực tĩnh). Với <code>g.html</code> động, chỉ cần <code>affiliates.json</code>.</p>
  </section>

  <!-- IMAGE CHECKLIST -->
  <section class="card" style="margin-top:16px">
    <h2>Checklist ảnh theo SKU</h2>
    <div class="row">
      <button class="btn" id="btn-build-images">Build list</button>
      <button class="btn" id="btn-copy-images">Copy</button>
    </div>
    <textarea id="images-list" placeholder="/assets/img/products/<sku>.webp" style="margin-top:8px; min-height:120px"></textarea>
  </section>

  <script>
    // ===== State =====
    let SETTINGS = loadSettings();
    let LOGS = [];
    let OUT = [];
    let EXISTING = [];

    // ===== Utils =====
    const q = s => document.querySelector(s);
    const qa = s => Array.from(document.querySelectorAll(s));
    const nowStr = () => new Date().toLocaleString();

    function loadSettings(){
      const raw = localStorage.getItem('mxd_settings_v4');
      if (raw) return JSON.parse(raw);
      return {
        worker:'',
        aff_id:'',
        tpl_shopee:'https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=shopee&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
        tpl_lazada:'https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=lazada&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
        tpl_tiki:'https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=tiki&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
        override:false
      };
    }
    function mountSettings(){
      q('#set-worker').value = SETTINGS.worker || '';
      q('#set-affid').value = SETTINGS.aff_id || '';
      q('#tpl-shopee').value = SETTINGS.tpl_shopee || '';
      q('#tpl-lazada').value = SETTINGS.tpl_lazada || '';
      q('#tpl-tiki').value = SETTINGS.tpl_tiki || '';
      q('#override-deeplink').checked = !!SETTINGS.override;
    }
    function saveSettings(){
      SETTINGS.worker = q('#set-worker').value.trim();
      SETTINGS.aff_id = q('#set-affid').value.trim();
      SETTINGS.tpl_shopee = q('#tpl-shopee').value.trim();
      SETTINGS.tpl_lazada = q('#tpl-lazada').value.trim();
      SETTINGS.tpl_tiki = q('#tpl-tiki').value.trim();
      SETTINGS.override = q('#override-deeplink').checked;
      localStorage.setItem('mxd_settings_v4', JSON.stringify(SETTINGS));
      q('#settings-msg').textContent = 'Đã lưu.';
      setTimeout(()=> q('#settings-msg').textContent='', 1400);
    }
    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function slugifyVN(s){
      s = String(s||'').toLowerCase().trim();
      s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      s = s.replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      return s || ('mxd-'+Date.now().toString(36));
    }
    function guessMerchant(u){
      u = String(u||'').toLowerCase();
      if (u.includes('shopee.')) return 'shopee';
      if (u.includes('lazada.')) return 'lazada';
      if (u.includes('tiki.vn')) return 'tiki';
      return '';
    }
    function parseShopeeIDs(u){
      const m = String(u||'').match(/product\/(\d+)\/(\d+)/i);
      return m ? {shop:m[1], item:m[2]} : null;
    }
    function now(){ return new Date().toLocaleString(); }
    function logPush({url, merchant, status, parser, message}){
      LOGS.unshift({ts: now(), url, merchant, status, parser, message});
      const tb = q('#log-table tbody');
      tb.innerHTML = LOGS.map(l=>`
        <tr>
          <td class="nowrap">${l.ts}</td>
          <td>${escapeHTML(l.url||'')}</td>
          <td class="nowrap">${l.merchant||''}</td>
          <td class="nowrap ${Number(l.status)>=200&&Number(l.status)<400?'ok':'err'}">${l.status||''}</td>
          <td class="nowrap">${l.parser||''}</td>
          <td class="small">${escapeHTML(l.message||'')}</td>
        </tr>
      `).join('');
    }

    // ===== Affiliate =====
    function deeplinkOf(merchant, origin, sub1){
      const aff = SETTINGS.aff_id || '';
      const map = { shopee: SETTINGS.tpl_shopee, lazada: SETTINGS.tpl_lazada, tiki: SETTINGS.tpl_tiki };
      const tpl = map[merchant] || '';
      if (!tpl || !aff) return origin; // chưa set → dùng link gốc
      return tpl
        .replace('{url}', encodeURIComponent(origin))
        .replace('{aff_id}', encodeURIComponent(aff))
        .replace('{sub1}', encodeURIComponent(sub1||''))
        .replace('{sub2}','').replace('{sub3}','').replace('{sub4}','');
    }

    // ===== Fetch (/head) =====
    async function fetchHead(url){
      const base = (SETTINGS.worker||'').replace(/\/+$/,'');
      if (!base) return {status:0, parser:'fallback', title:'', image:'', price:null, brand:''};
      const res = await fetch(base + '/head?url=' + encodeURIComponent(url), {mode:'cors'});
      let data = {};
      try { data = await res.json(); } catch(_) {}
      return {
        status: res.status || 0,
        parser: 'worker-head',
        title: data.title || data.ogTitle || '',
        image: data.image || data.ogImage || '',
        price: (data.price!=null && isFinite(Number(data.price))) ? Number(data.price) : null,
        brand: data.brand || ''
      };
    }
    function fallbackFromURL(u){
      try {
        const url = new URL(u);
        const last = url.pathname.split('/').filter(Boolean).pop() || url.hostname;
        const name = last.replace(/[-_]+/g,' ').slice(0,80);
        return {title: name, image:'', price:null, brand:''};
      } catch { return {title:'', image:'', price:null, brand:''}; }
    }

    // ===== Parse input =====
    function parseInput(raw, fmt, forceMerchant){
      const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out = [];
      for (const line of lines){
        if (fmt==='pipe'){
          const [name, priceStr, link] = line.split('|').map(s=>s.trim());
          if (!link) continue;
          const origin = link;
          const merchant = forceMerchant==='auto' ? guessMerchant(origin) : forceMerchant;
          out.push({name, price: Number(priceStr||0)||0, origin, merchant});
        } else {
          const origin = line;
          const merchant = forceMerchant==='auto' ? guessMerchant(origin) : forceMerchant;
          out.push({name:'', price:0, origin, merchant});
        }
      }
      return out;
    }

    function renderOUT(){
      const tb = q('#out-table tbody');
      tb.innerHTML = OUT.map((it,idx)=>`
        <tr>
          <td contenteditable="true" oninput="editField(${idx},'name',this.textContent)">${escapeHTML(it.name||'')}</td>
          <td class="nowrap"><input type="number" min="0" step="1" value="${isFinite(it.price)?it.price:''}" oninput="editPrice(${idx},this.value)" style="width:110px"></td>
          <td class="nowrap">${it.merchant||''}</td>
          <td style="word-break:break-all">${escapeHTML(it.origin||'')}</td>
          <td contenteditable="true" oninput="editField(${idx},'sku',this.textContent)">${escapeHTML(it.sku||'')}</td>
          <td class="small">${escapeHTML(it.image||'')}</td>
          <td class="small" style="word-break:break-all">${escapeHTML(it.deeplink||'')}</td>
          <td class="nowrap"><input type="checkbox" ${it.featured?'checked':''} onchange="toggleFeat(${idx},this.checked)"></td>
          <td class="nowrap"><button class="btn" onclick="removeRow(${idx})">X</button></td>
        </tr>
      `).join('');
    }
    window.editField = (i,k,v)=>{ OUT[i][k]=String(v||'').trim(); syncDerived(i); };
    window.editPrice = (i,v)=>{ OUT[i].price = Number(v)||0; syncDerived(i); };
    window.toggleFeat = (i,checked)=>{ OUT[i].featured = !!checked; };
    window.removeRow = (i)=>{ OUT.splice(i,1); renderOUT(); };

    function syncDerived(i){
      const it = OUT[i];
      if (!it.sku) it.sku = slugifyVN(it.name || it.origin);
      it.image = `/assets/img/products/${it.sku}.webp`;
      it.deeplink = deeplinkOf(it.merchant||'', it.origin||'', it.sub1||'');
    }
    function dedupe(items){
      const map = new Map();
      for (const it of items){
        const key = (it.origin||'') + '#' + (it.sku||'');
        if (!map.has(key)) map.set(key, it);
      }
      return Array.from(map.values());
    }
    function toAffJSON(items){
      return items.map(it=>({
        name: String(it.name||'').trim(),
        price: isFinite(it.price)?Number(it.price):0,
        origin: String(it.origin||'').trim(),
        merchant: String(it.merchant||'').trim(),
        sku: String(it.sku||'').trim(),
        image: it.image || (`/assets/img/products/${String(it.sku||'').trim()}.webp`),
        category: String(it.category||'').trim(),
        brand: String(it.brand||'').trim(),
        featured: !!it.featured,
        sub1: String(it.sub1||'').trim(),
        deeplink: String(it.deeplink||it.origin||'').trim()
      }));
    }

    function download(filename, text){
      const blob = new Blob([text], {type:'application/json;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ===== Actions =====
    q('#btn-save-settings').onclick = saveSettings;
    q('#btn-test-head').onclick = async ()=>{
      const demo = 'https://shopee.vn/product/166287331/22741831588';
      const r = await fetchHead(demo);
      q('#settings-msg').textContent = `HEAD ${r.status} — parser: ${r.parser}`;
      setTimeout(()=> q('#settings-msg').textContent='', 1500);
    };
    q('#btn-clear-log').onclick = ()=>{ LOGS=[]; q('#log-table tbody').innerHTML=''; };

    q('#btn-parse').onclick = ()=>{
      const fmt = (qa('input[name="fmt"]').find(x=>x.checked)||{}).value || 'link';
      const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
      const sub1 = q('#default-sub1').value.trim();
      const rows = parseInput(q('#txt-input').value, fmt, forceM);
      OUT = rows.map(r=>{
        const fb = fallbackFromURL(r.origin);
        const name = r.name || fb.title;
        const m = r.merchant || guessMerchant(r.origin);
        let sku = slugifyVN(name || r.origin);
        if ((!name || name.length<2) && m==='shopee'){ const ids = parseShopeeIDs(r.origin); if (ids) sku = `sp${ids.shop}-${ids.item}`; }
        const item = {
          name, price:isFinite(r.price)?r.price:0, origin:r.origin, merchant:m,
          sku, image:`/assets/img/products/${sku}.webp`, brand:'', category:'', featured:false, sub1
        };
        item.deeplink = deeplinkOf(item.merchant, item.origin, item.sub1);
        return item;
      });
      OUT = dedupe(OUT);
      renderOUT();
      q('#out-msg').textContent = `Parsed ${OUT.length} dòng (chưa fetch).`;
      setTimeout(()=> q('#out-msg').textContent='', 1600);
    };

    q('#btn-fetch').onclick = async ()=>{
      const fmt = (qa('input[name="fmt"]').find(x=>x.checked)||{}).value || 'link';
      const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
      const sub1 = q('#default-sub1').value.trim();
      const rows = parseInput(q('#txt-input').value, fmt, forceM);
      OUT = [];
      for (const r of rows){
        const m = r.merchant || guessMerchant(r.origin);
        try {
          const head = await fetchHead(r.origin);
          let name = r.name || head.title || fallbackFromURL(r.origin).title;
          let price = isFinite(r.price)&&r.price>0 ? r.price : (isFinite(head.price)?head.price:0);
          let brand = head.brand || '';
          let sku = slugifyVN(name || r.origin);
          if ((!name || name.length<2) && m==='shopee'){ const ids = parseShopeeIDs(r.origin); if (ids) sku = `sp${ids.shop}-${ids.item}`; }
          const item = {
            name, price, origin:r.origin, merchant:m, brand, category:'',
            sku, image:`/assets/img/products/${sku}.webp`, featured:false, sub1,
            deeplink: deeplinkOf(m, r.origin, sub1)
          };
          OUT.push(item);
          logPush({url:r.origin, merchant:m, status: head.status, parser: head.parser, message: name? 'Parsed':'Name empty'});
        } catch(e){
          const fb = fallbackFromURL(r.origin);
          let sku = slugifyVN(fb.title || r.origin);
          if ((!fb.title || fb.title.length<2) && m==='shopee'){ const ids = parseShopeeIDs(r.origin); if (ids) sku = `sp${ids.shop}-${ids.item}`; }
          OUT.push({
            name: r.name || fb.title, price: isFinite(r.price)?r.price:0, origin:r.origin, merchant:m,
            brand:'', category:'', sku, image:`/assets/img/products/${sku}.webp`,
            featured:false, sub1, deeplink: deeplinkOf(m, r.origin, sub1)
          });
          logPush({url:r.origin, merchant:m, status:0, parser:'fallback', message:String(e)});
        }
      }
      OUT = dedupe(OUT);
      renderOUT();
      q('#out-msg').textContent = `Hoàn tất: ${OUT.length} sản phẩm.`;
      setTimeout(()=> q('#out-msg').textContent='', 1800);
    };

    q('#btn-load-existing').onclick = async ()=>{
      try {
        const res = await fetch('/assets/data/affiliates.json', {cache:'no-store'});
        const arr = await res.json();
        EXISTING = Array.isArray(arr) ? arr : [];
        q('#out-msg').textContent = `Loaded ${EXISTING.length} existing items.`;
      } catch(e){
        q('#out-msg').textContent = 'Không tải được /assets/data/affiliates.json (có thể chưa có).';
      }
      setTimeout(()=> q('#out-msg').textContent='', 1600);
    };

    q('#btn-merge').onclick = ()=>{
      const merged = dedupe([...EXISTING, ...toAffJSON(OUT)]);
      OUT = merged.map(x=>({
        name:x.name||'', price:isFinite(x.price)?Number(x.price):0,
        origin:x.origin||'', merchant:x.merchant||'',
        sku:x.sku||slugifyVN(x.name||x.origin),
        image:x.image || `/assets/img/products/${x.sku}.webp`,
        brand:x.brand||'', category:x.category||'',
        featured:!!x.featured, sub1:x.sub1||'',
        deeplink:x.deeplink||x.origin
      }));
      renderOUT();
      q('#out-msg').textContent = `Merged & deduped: ${OUT.length} items.`;
      setTimeout(()=> q('#out-msg').textContent='', 1600);
    };

    q('#btn-copy-json').onclick = ()=>{
      const txt = JSON.stringify(toAffJSON(OUT), null, 2);
      navigator.clipboard.writeText(txt).then(()=>{
        q('#out-msg').textContent = 'Đã copy JSON vào clipboard.'; setTimeout(()=> q('#out-msg').textContent='', 1200);
      });
    };
    q('#btn-download-json').onclick = ()=>{
      const txt = JSON.stringify(toAffJSON(OUT), null, 2);
      download('affiliates.json', txt);
    };

    // ===== Snippet Builder =====
    function buildSnippetFor(it, useDeep){
      const buyHref = useDeep ? (it.deeplink||it.origin) : it.origin;
      const merchantLabel = it.merchant==='shopee' ? 'Shopee' : it.merchant==='lazada' ? 'Lazada' : it.merchant==='tiki' ? 'Tiki' : 'Mua';
      return [
`<a class="product-meta" href="${it.origin}" data-merchant="${it.merchant}" data-sku="${it.sku}" data-img="/assets/img/products/${it.sku}.webp" data-price="${isFinite(it.price)?it.price:0}">${it.name}</a>`,
`<a class="buy" href="${buyHref}" data-merchant="${it.merchant}">Mua ${merchantLabel}</a>`
      ].join('\n');
    }
    q('#btn-build-snippets').onclick = ()=>{
      const useDeep = q('#snip-use-deep').checked || SETTINGS.override;
      const lines = OUT.map(it => buildSnippetFor(it, useDeep));
      q('#snippets').value = lines.join('\n\n');
    };
    q('#btn-copy-snippets').onclick = ()=>{
      navigator.clipboard.writeText(q('#snippets').value||'');
    };

    // ===== Image checklist =====
    q('#btn-build-images').onclick = ()=>{
      q('#images-list').value = OUT.map(it=>`/assets/img/products/${it.sku}.webp`).join('\n');
    };
    q('#btn-copy-images').onclick = ()=>navigator.clipboard.writeText(q('#images-list').value||'');

    // Mount
    mountSettings();
  </script>
</body>
</html>
