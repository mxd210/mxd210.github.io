<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <meta name="format-detection" content="telephone=no"/>
  <title>MXD Importer v4.2 — Pro+ (EN/VN)</title>
  <meta name="description" content="Importer chuẩn MXD: Shopee/Lazada/Tiki → affiliates.json + snippets + ảnh .webp + health-check + SKU validator + commit generator."/>
  <link rel="canonical" href="https://mxd210.github.io/tools/shopee-importer.html"/>
  <meta name="robots" content="noindex,follow"/>

  <!-- OG -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="MXD Importer v4.2 — Pro+"/>
  <meta property="og:description" content="JSON + snippets + ảnh + health-check + SKU tools. English (Vietnamese) labels."/>
  <meta property="og:url" content="https://mxd210.github.io/tools/shopee-importer.html"/>
  <meta property="og:image" content="/assets/img/products/placeholder.webp"/>

  <!-- Convention MXD: GA4 trước Affiliate -->
  <script defer src="/assets/analytics.js"></script>
  <script defer src="/assets/mxd-affiliate.js"></script>

  <!-- Site CSS -->
  <link rel="stylesheet" href="/assets/site.css"/>

  <!-- JSZip cho gói ảnh -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>

  <style>
    :root { --gap:12px; --br:14px; }
    body { max-width: 1220px; margin: 0 auto; padding: 12px; line-height: 1.55; }
    header { position: sticky; top:0; background: var(--bg, #fff); z-index: 50; padding: 8px 0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .tabs { display:flex; gap:6px; flex-wrap:wrap; margin: 8px 0 12px; }
    .tab { padding:8px 12px; border:1px solid #d1d5db; border-radius:999px; background:#fff; cursor:pointer; }
    .tab.active { background:#111827; border-color:#111827; color:#fff; }
    .card { border:1px solid #e5e7eb; border-radius:var(--br); padding:12px; background:#fff; }
    h1 { font-size:1.5rem; margin:6px 0 6px; }
    h2 { font-size:1.15rem; margin:10px 0 8px; }
    textarea { width:100%; min-height:150px; font-family: ui-monospace, Menlo, Consolas, monospace; resize: vertical; }
    input[type=text], input[type=url], input[type=number] { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; }
    .btn { padding:8px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .btn.ghost { background:transparent; }
    .muted { color:#6b7280; } .small { font-size:.9em; }
    table { width:100%; border-collapse: collapse; font-size:.95rem; }
    th, td { border-bottom:1px solid #eee; padding:8px; vertical-align: top; }
    th { text-align:left; background:#fafafa; position:sticky; top:0; }
    td, th { overflow-wrap:anywhere; }
    td[contenteditable="true"] { background:#fffbeb; outline:2px dashed #fde68a; }
    .ok { color:#065f46; } .err { color:#b91c1c; } .warn { color:#92400e; }
    .hidden { display:none; }
    .grid { display:grid; gap: var(--gap); }
    .g2 { grid-template-columns: 1fr 1fr; }
    .g3 { grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 960px){ .g2,.g3 { grid-template-columns: 1fr; } }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .spacer { flex:1; }
    .switch { display:inline-flex; gap:6px; align-items:center; }
    .dropzone { border:2px dashed #d1d5db; border-radius:12px; padding:10px; text-align:center; color:#6b7280; }
    .dropzone.drag { background:#f8fafc; border-color:#94a3b8; color:#0f172a; }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <div class="row">
        <a class="btn ghost" href="/">Home</a>
        <a class="btn ghost" href="/store.html">Store</a>
        <a class="btn ghost" href="/blog/index.html">Blog</a>
        <a class="btn ghost" href="/contact.html">Contact</a>
      </div>
      <div class="row">
        <label class="switch"><input id="compact" type="checkbox"> <span class="small muted">Compact mode (Chế độ gọn)</span></label>
      </div>
    </div>
    <h1>MXD Importer v4.2 — Pro+ <span class="small muted">English (Tiếng Việt)</span></h1>
    <div class="tabs">
      <button class="tab active" data-tab="import">Import (Nhập)</button>
      <button class="tab" data-tab="output">Output (Kết quả)</button>
      <button class="tab" data-tab="snippets">Snippets (Đoạn chèn)</button>
      <button class="tab" data-tab="images">Images (Ảnh)</button>
      <button class="tab" data-tab="health">Health (Kiểm tra link)</button>
      <button class="tab" data-tab="log">Log (Nhật ký)</button>
      <button class="tab" data-tab="settings">Settings (Cài đặt)</button>
    </div>
  </header>

  <!-- Import -->
  <section id="tab-import" class="card">
    <div class="grid g2">
      <div>
        <h2>1) Input (Nhập dữ liệu)</h2>
        <div class="dropzone" id="drop">Drag & drop CSV/TXT here – hoặc dán từ Excel: <b>Tên|Giá|Link</b></div>
        <textarea id="txt-input" placeholder="https://shopee.vn/product/.../...\nMáy cắt KYNKO | 1390000 | https://..." ></textarea>
        <div class="row">
          <div class="row">
            <label class="small muted">Format:</label>
            <label><input type="radio" name="fmt" value="link" checked> Links per line</label>
            <label><input type="radio" name="fmt" value="pipe"> Name|Price|Link</label>
          </div>
          <div class="row">
            <label class="small muted">Merchant:</label>
            <label><input type="radio" name="mrc" value="auto" checked> Auto</label>
            <label><input type="radio" name="mrc" value="shopee"> Shopee</label>
            <label><input type="radio" name="mrc" value="lazada"> Lazada</label>
            <label><input type="radio" name="mrc" value="tiki"> Tiki</label>
          </div>
          <input id="default-sub1" type="text" placeholder="sub1 (optional)" style="max-width:220px">
          <label class="row"><input id="bulk-sub1" type="checkbox"> Bulk sub1={sku}</label>
          <span class="spacer"></span>
          <button class="btn" id="btn-parse">Parse</button>
          <button class="btn primary" id="btn-fetch">Fetch + Build</button>
        </div>
        <label class="row"><input id="auto-pipeline" type="checkbox"> Auto image pipeline after Fetch</label>
        <p class="small muted">Tool tự sinh <b>SKU</b>, <code>/assets/img/products/&lt;sku&gt;.webp</code>, và deeplink (nếu set AFF_ID + template).</p>
      </div>

      <div>
        <h2>2) JSON (Tệp dữ liệu)</h2>
        <div class="row">
          <button class="btn" id="btn-load-existing">Load affiliates.json</button>
          <button class="btn" id="btn-merge">Merge & dedupe</button>
          <button class="btn" id="btn-copy-json">Copy JSON</button>
          <button class="btn primary" id="btn-download-json">Download affiliates.json</button>
        </div>
        <p id="out-msg" class="small muted"></p>
      </div>
    </div>
  </section>

  <!-- Output -->
  <section id="tab-output" class="card hidden">
    <div class="toolbar">
      <h2>Output table (Bảng kết quả)</h2>
      <div class="row">
        <button class="btn" id="btn-validate-sku">Validate SKUs</button>
        <button class="btn" id="btn-normalize-sku">Normalize SKUs</button>
        <button class="btn" id="btn-commit">Commit message</button>
        <button class="btn" id="btn-copy-commit">Copy commit</button>
      </div>
    </div>
    <div style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:10px;">
      <table id="out-table">
        <thead><tr>
          <th>Name [edit]</th><th class="nowrap">Price</th><th class="nowrap">Merchant</th>
          <th>Origin</th><th class="nowrap">SKU [edit]</th><th>Image</th><th>Deep link</th>
          <th class="nowrap">Featured</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <textarea id="commit-msg" class="small" placeholder="Commit message…" style="margin-top:8px; min-height:80px"></textarea>
    <textarea id="sku-report" class="small" placeholder="SKU report…" style="margin-top:8px; min-height:80px"></textarea>
  </section>

  <!-- Snippets -->
  <section id="tab-snippets" class="card hidden">
    <div class="row">
      <label class="row"><input id="snip-deep" type="checkbox"> Use deep-link for buy</label>
      <button class="btn" id="btn-build-snippets">Build snippets</button>
      <button class="btn" id="btn-copy-snippets">Copy</button>
    </div>
    <textarea id="snippets" placeholder="Snippets chuẩn MXD…" style="margin-top:8px; min-height:140px"></textarea>
  </section>

  <!-- Images -->
  <section id="tab-images" class="card hidden">
    <h2>Image tools</h2>
    <div class="grid g3">
      <div>
        <h3 class="small">A) Extract images</h3>
        <p class="small muted">Lấy og:image từ link sản phẩm (qua Worker /head).</p>
        <div class="row">
          <button class="btn" id="btn-img-from-head">Extract via /head</button>
          <button class="btn" id="btn-img-from-out">Use fetched images</button>
        </div>
      </div>
      <div>
        <h3 class="small">B) Presets</h3>
        <label>Context</label>
        <select id="img-preset">
          <option value="store">Store card 800×800 → /assets/img/products/&lt;sku&gt;.webp</option>
          <option value="home">Homepage 1200×800 → /assets/img/hero/&lt;sku&gt;-hero.webp</option>
          <option value="banner">Banner 1600×500 → /assets/img/banners/&lt;sku&gt;-banner.webp</option>
          <option value="blog">Blog/OG 1200×630 → /assets/img/tin-tuc/&lt;sku&gt;-og.webp</option>
          <option value="thumb">Thumb 400×400 → /assets/img/products/&lt;sku&gt;-thumb.webp</option>
        </select>
        <label class="small"><input id="img-fit" type="checkbox" checked> Cover (crop giữa) / bỏ chọn = Contain</label>
        <label>Quality</label>
        <input id="img-q" type="number" min="0.6" max="0.95" step="0.01" value="0.86"/>
      </div>
      <div>
        <h3 class="small">C) Export</h3>
        <div class="row">
          <button class="btn primary" id="btn-make-images">Generate & ZIP</button>
        </div>
        <p id="img-msg" class="small muted"></p>
      </div>
    </div>
    <textarea id="images-list" placeholder="/assets/img/products/<sku>.webp" style="margin-top:8px; min-height:120px"></textarea>
  </section>

  <!-- Health -->
  <section id="tab-health" class="card hidden">
    <h2>Health-check</h2>
    <div class="row">
      <label>Throttle (ms)</label>
      <input id="hc-throttle" type="number" min="50" step="10" value="120" style="max-width:120px">
      <button class="btn" id="btn-hc-scan">Scan affiliates.json</button>
      <button class="btn" id="btn-hc-copy">Copy report</button>
      <button class="btn primary" id="btn-hc-download">Download affiliates.prune.json</button>
    </div>
    <textarea id="hc-report" class="small" placeholder="Health report…" style="margin-top:8px; min-height:200px"></textarea>
  </section>

  <!-- Log -->
  <section id="tab-log" class="card hidden">
    <h2>Fetch Log</h2>
    <div style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:10px;">
      <table id="log-table">
        <thead><tr>
          <th class="nowrap">Time</th><th>URL</th><th class="nowrap">Merchant</th>
          <th class="nowrap">Status</th><th class="nowrap">Parser</th><th>Msg</th>
        </tr></thead><tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btn-clear-log">Clear log</button>
    </div>
  </section>

  <!-- Settings -->
  <section id="tab-settings" class="card hidden">
    <div class="grid g2">
      <div>
        <h2>Settings</h2>
        <label>Worker Base</label>
        <input id="set-worker" type="url" placeholder="https://mxd210.mxd6686.workers.dev">
        <label>AFF_ID (AccessTrade)</label>
        <input id="set-affid" type="text" placeholder="ATxxxxxxx">
        <label>Template Shopee</label>
        <input id="tpl-shopee" type="text" placeholder="https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=shopee&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}">
        <label>Template Lazada</label>
        <input id="tpl-lazada" type="text" placeholder="https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=lazada&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}">
        <label>Template Tiki</label>
        <input id="tpl-tiki" type="text" placeholder="https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=tiki&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}">
        <label class="row"><input id="override-deeplink" type="checkbox"> Deep-link override for buy</label>
        <div class="row">
          <button class="btn" id="btn-save-settings">Save</button>
          <button class="btn" id="btn-test-head">Test /head</button>
          <span id="settings-msg" class="small muted"></span>
        </div>
      </div>
      <div>
        <h2>Shortcuts</h2>
        <ul class="small">
          <li><b>Ctrl+Enter</b> → Fetch</li>
          <li><b>Ctrl+S</b> → Save settings</li>
          <li><b>Alt+1..6</b> → Tabs</li>
          <li><b>Alt+V</b> → Validate SKU</li>
          <li><b>Alt+C</b> → Generate commit</li>
        </ul>
      </div>
    </div>
  </section>

  <script>
    // ===== State =====
    let SETTINGS = loadSettings();
    let LOGS = [];
    let OUT = [];
    let EXISTING = [];

    // ===== Utils =====
    const q = s => document.querySelector(s);
    const qa = s => Array.from(document.querySelectorAll(s));
    const nowStr = () => new Date().toLocaleString();
    const escapeHTML = s => String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    function slugifyVN(s){
      s = String(s||'').toLowerCase().trim();
      s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      s = s.replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      return s || ('mxd-'+Date.now().toString(36));
    }
    function guessMerchant(u){
      u = String(u||'').toLowerCase();
      if (u.includes('shopee.')) return 'shopee';
      if (u.includes('lazada.')) return 'lazada';
      if (u.includes('tiki.vn')) return 'tiki';
      return '';
    }
    function parseShopeeIDs(u){
      const m = String(u||'').match(/product\/(\d+)\/(\d+)/i);
      return m ? {shop:m[1], item:m[2]} : null;
    }
    const isProductUrl = (u)=>{ try{ return /\/product\/\d+\/\d+$/i.test(new URL(u).pathname); }catch{ return false; } };
    const toNumber = (x)=>{ if (x==null) return null; const n = String(x).replace(/[^\d]/g,''); return n? Number(n): null; };

    function logPush({url, merchant, status, parser, message}){
      LOGS.unshift({ts: nowStr(), url, merchant, status, parser, message});
      const tb = q('#log-table tbody');
      tb.innerHTML = LOGS.map(l=>`
        <tr>
          <td class="nowrap">${l.ts}</td>
          <td>${escapeHTML(l.url||'')}</td>
          <td class="nowrap">${l.merchant||''}</td>
          <td class="nowrap ${Number(l.status)>=200&&Number(l.status)<400?'ok':(Number(l.status)>=300&&Number(l.status)<400?'warn':'err')}">${l.status||''}</td>
          <td class="nowrap">${l.parser||''}</td>
          <td class="small">${escapeHTML(l.message||'')}</td>
        </tr>
      `).join('');
    }

    // ===== Settings =====
    function loadSettings(){
      const raw = localStorage.getItem('mxd_settings_v42_pro');
      if (raw) return JSON.parse(raw);
      return {
        worker:'',
        aff_id:'',
        tpl_shopee:'https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=shopee&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
        tpl_lazada:'https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=lazada&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
        tpl_tiki:'https://go.accesstrade.vn/deep_link?url={url}&aff_id={aff_id}&merchant=tiki&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}',
        override:false
      };
    }
    function mountSettings(){
      q('#set-worker').value = SETTINGS.worker || '';
      q('#set-affid').value = SETTINGS.aff_id || '';
      q('#tpl-shopee').value = SETTINGS.tpl_shopee || '';
      q('#tpl-lazada').value = SETTINGS.tpl_lazada || '';
      q('#tpl-tiki').value = SETTINGS.tpl_tiki || '';
      q('#override-deeplink').checked = !!SETTINGS.override;
    }
    function saveSettings(){
      SETTINGS.worker = q('#set-worker').value.trim();
      SETTINGS.aff_id = q('#set-affid').value.trim();
      SETTINGS.tpl_shopee = q('#tpl-shopee').value.trim();
      SETTINGS.tpl_lazada = q('#tpl-lazada').value.trim();
      SETTINGS.tpl_tiki = q('#tpl-tiki').value.trim();
      SETTINGS.override = q('#override-deeplink').checked;
      localStorage.setItem('mxd_settings_v42_pro', JSON.stringify(SETTINGS));
      q('#settings-msg').textContent = 'Saved (Đã lưu).'; setTimeout(()=> q('#settings-msg').textContent='', 1400);
    }

    // ===== Tabs / Compact / Shortcuts =====
    function showTab(id){
      qa('section[id^="tab-"]').forEach(el=>el.classList.add('hidden'));
      q('#tab-'+id).classList.remove('hidden');
      qa('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      localStorage.setItem('tab', id);
    }
    qa('.tab').forEach(b=> b.onclick = ()=> showTab(b.dataset.tab));
    showTab(localStorage.getItem('tab') || 'import');

    q('#compact').onchange = (e)=>{
      document.body.style.setProperty('--gap', e.target.checked ? '8px' : '12px');
      document.body.querySelectorAll('.btn').forEach(b=>b.style.padding = e.target.checked?'6px 10px':'8px 12px');
    };

    document.addEventListener('keydown', (ev)=>{
      if (ev.ctrlKey && ev.code==='Enter'){ q('#btn-fetch').click(); ev.preventDefault(); }
      if (ev.ctrlKey && ev.key.toLowerCase()==='s'){ q('#btn-save-settings').click(); ev.preventDefault(); }
      if (ev.altKey){
        const map = {'Digit1':'import','Digit2':'output','Digit3':'snippets','Digit4':'images','Digit5':'health','Digit6':'settings'};
        if (map[ev.code]){ showTab(map[ev.code]); ev.preventDefault(); }
        if (ev.key.toLowerCase()==='v'){ q('#btn-validate-sku').click(); ev.preventDefault(); }
        if (ev.key.toLowerCase()==='c'){ q('#btn-commit').click(); ev.preventDefault(); }
      }
    });

    // ===== Affiliate =====
    function deeplinkOf(merchant, origin, sub1){
      const aff = SETTINGS.aff_id || '';
      const map = { shopee: SETTINGS.tpl_shopee, lazada: SETTINGS.tpl_lazada, tiki: SETTINGS.tpl_tiki };
      const tpl = map[merchant] || '';
      if (!tpl || !aff) return origin;
      return tpl
        .replace('{url}', encodeURIComponent(origin))
        .replace('{aff_id}', encodeURIComponent(aff))
        .replace('{sub1}', encodeURIComponent(sub1||''))
        .replace('{sub2}','').replace('{sub3}','').replace('{sub4}','');
    }

    // ===== Parse input (drag-drop + paste Excel) =====
    function parseInput(raw, fmt, forceMerchant){
      // Tự chuyển CSV/Tab → pipe
      if (/\t/.test(raw) || /,https?:\/\//.test(raw)){
        const rows = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        raw = rows.map(line=>{
          const parts = line.split(/\t|,(?=https?:\/\/)/);
          const [name, price, link] = [parts[0]||'', parts[1]||'', parts[2]||parts[1]||''];
          return `${name} | ${price} | ${link}`;
        }).join('\n');
        fmt = 'pipe';
      }

      const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out = [];
      for (const line of lines){
        if (fmt==='pipe'){
          const [name, priceStr, link] = line.split('|').map(s=>s.trim());
          if (!link || !isProductUrl(link)) continue;           // ❗ bỏ search/link sai
          const origin = link.split('?')[0];
          const merchant = forceMerchant==='auto' ? guessMerchant(origin) : forceMerchant;
          const priceNum = toNumber(priceStr);
          if (priceNum==null) continue;                         // ❗ bỏ item không có giá số
          out.push({name, price: priceNum, origin, merchant});
        } else {
          if (!isProductUrl(line)) continue;                    // ❗ chỉ lấy product URL
          const origin = line.split('?')[0];
          const merchant = forceMerchant==='auto' ? guessMerchant(origin) : forceMerchant;
          out.push({name:'', price:0, origin, merchant});
        }
      }
      return out;
    }

    // Drag & drop
    const drop = q('#drop');
    ['dragenter','dragover'].forEach(e=> drop.addEventListener(e, ev=>{ ev.preventDefault(); drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(e=> drop.addEventListener(e, ev=>{ ev.preventDefault(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', ev=>{
      const f = ev.dataTransfer.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ q('#txt-input').value = (q('#txt-input').value+'\n'+reader.result).trim(); };
      reader.readAsText(f);
    });

    // ===== OUT rendering =====
    function renderOUT(){
      const tb = q('#out-table tbody');
      tb.innerHTML = OUT.map((it,idx)=>`
        <tr>
          <td contenteditable="true" oninput="editField(${idx},'name',this.textContent)">${escapeHTML(it.name||'')}</td>
          <td class="nowrap"><input type="number" min="0" step="1" value="${isFinite(it.price)?it.price:''}" oninput="editPrice(${idx},this.value)" style="width:110px"></td>
          <td class="nowrap">${it.merchant||''}</td>
          <td>${escapeHTML(it.origin||'')}</td>
          <td contenteditable="true" oninput="editField(${idx},'sku',this.textContent)">${escapeHTML(it.sku||'')}</td>
          <td class="small">${escapeHTML(it.image||'')}</td>
          <td class="small">${escapeHTML(it.deeplink||'')}</td>
          <td class="nowrap"><input type="checkbox" ${it.featured?'checked':''} onchange="toggleFeat(${idx},this.checked)"></td>
          <td class="nowrap"><button class="btn" onclick="removeRow(${idx})">X</button></td>
        </tr>
      `).join('');
    }
    window.editField = (i,k,v)=>{ OUT[i][k]=String(v||'').trim(); syncDerived(i); };
    window.editPrice = (i,v)=>{ OUT[i].price = Number(v)||0; syncDerived(i); };
    window.toggleFeat = (i,checked)=>{ OUT[i].featured = !!checked; };
    window.removeRow = (i)=>{ OUT.splice(i,1); renderOUT(); };

    function syncDerived(i){
      const it = OUT[i];
      if (!it.sku) it.sku = slugifyVN(it.name || it.origin);
      it.image = `/assets/img/products/${it.sku}.webp`;
      if (q('#bulk-sub1').checked) it.sub1 = it.sku;
      it.deeplink = deeplinkOf(it.merchant||'', it.origin||'', it.sub1||'');
    }
    function dedupe(items){
      const map = new Map();
      for (const it of items){
        const key = (it.origin||'') + '#' + (it.sku||'');
        if (!map.has(key)) map.set(key, it);
      }
      return Array.from(map.values());
    }

    // Chỉ cho phép item hợp lệ đi tiếp
    const isRenderable = (it)=> it && isProductUrl(it.origin) && isFinite(it.price) && Number(it.price)>0;

    function toAffJSON(items){
      return items
        .filter(isRenderable) // ❗ lọc lần nữa trước khi xuất
        .map(it=>({
          name: String(it.name||'').trim(),
          price: Number(it.price)||0,
          origin: String(it.origin||'').trim(),
          merchant: String(it.merchant||'').trim(),
          sku: String(it.sku||'').trim(),
          image: it.image || (`/assets/img/products/${String(it.sku||'').trim()}.webp`),
          category: String(it.category||'').trim(),
          brand: String(it.brand||'').trim(),
          featured: !!it.featured,
          sub1: String(it.sub1||'').trim(),
          deeplink: String(it.deeplink||it.origin||'').trim(),
          srcImage: it.srcImage || ''
        }));
    }

    function download(filename, text){
      const blob = new Blob([text], {type:'application/json;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ===== Actions: Import =====
    q('#btn-parse').onclick = ()=>{
      const fmt = (qa('input[name="fmt"]').find(x=>x.checked)||{}).value || 'link';
      const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
      const sub1 = q('#default-sub1').value.trim();
      const rows = parseInput(q('#txt-input').value, fmt, forceM);

      OUT = rows.map(r=>{
        const m = r.merchant || guessMerchant(r.origin);
        const ids = (m==='shopee') ? parseShopeeIDs(r.origin) : null;
        let sku = slugifyVN(r.name || r.origin);
        if ((!r.name || r.name.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
        const it = {
          name: r.name || r.origin, price:r.price||0, origin:r.origin, merchant:m,
          sku, image:`/assets/img/products/${sku}.webp`, brand:'', category:'', featured:false, sub1, srcImage:''
        };
        if (q('#bulk-sub1').checked) it.sub1 = it.sku;
        it.deeplink = deeplinkOf(it.merchant, it.origin, it.sub1);
        return it;
      });
      OUT = dedupe(OUT);
      renderOUT(); showTab('output');
      q('#out-msg').textContent = `Parsed ${OUT.length} rows (valid only).`; setTimeout(()=> q('#out-msg').textContent='', 1600);
    };

    async function fetchHead(url){
      const base = (SETTINGS.worker||'').replace(/\/+$/,'');
      if (!base) return {status:0, parser:'fallback', title:'', image:'', price:null, brand:''};
      const res = await fetch(base + '/head?url=' + encodeURIComponent(url), {mode:'cors'});
      let data = {};
      try { data = await res.json(); } catch(_){}
      return {
        status: res.status || 0,
        parser: 'worker-head',
        title: data.title || data.ogTitle || '',
        image: data.image || data.ogImage || '',
        price: (data.price!=null && isFinite(Number(data.price))) ? Number(data.price) : null,
        brand: data.brand || ''
      };
    }
    function fallbackFromURL(u){
      try {
        const url = new URL(u);
        const last = url.pathname.split('/').filter(Boolean).pop() || url.hostname;
        const name = last.replace(/[-_]+/g,' ').slice(0,80);
        return {title: name, image:'', price:null, brand:''};
      } catch { return {title:'', image:'', price:null, brand:''}; }
    }

    q('#btn-fetch').onclick = async ()=>{
      const fmt = (qa('input[name="fmt"]').find(x=>x.checked)||{}).value || 'link';
      const forceM = (qa('input[name="mrc"]').find(x=>x.checked)||{}).value || 'auto';
      const sub1 = q('#default-sub1').value.trim();
      const rows = parseInput(q('#txt-input').value, fmt, forceM);
      OUT = [];
      for (const r of rows){
        const m = r.merchant || guessMerchant(r.origin);
        if (!isProductUrl(r.origin)) continue; // an toàn lần nữa
        try {
          const head = await fetchHead(r.origin);
          const fb = fallbackFromURL(r.origin);
          let name = r.name || head.title || fb.title;
          let price = isFinite(r.price)&&r.price>0 ? r.price : (toNumber(head.price)!=null? Number(head.price):0);
          const ids = (m==='shopee') ? parseShopeeIDs(r.origin) : null;
          let sku = slugifyVN(name || r.origin);
          if ((!name || name.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
          OUT.push({
            name, price, origin:r.origin, merchant:m, brand: head.brand||'',
            category:'', sku, image:`/assets/img/products/${sku}.webp`,
            featured:false, sub1, deeplink: deeplinkOf(m, r.origin, q('#bulk-sub1').checked?sku:(sub1||'')),
            srcImage: head.image || ''
          });
          logPush({url:r.origin, merchant:m, status: head.status, parser: head.parser, message: name? 'Parsed':'Name empty'});
        } catch(e){
          const fb = fallbackFromURL(r.origin);
          const ids = (m==='shopee') ? parseShopeeIDs(r.origin) : null;
          let sku = slugifyVN(fb.title || r.origin);
          if ((!fb.title || fb.title.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
          OUT.push({
            name: r.name || fb.title, price: isFinite(r.price)?r.price:0, origin:r.origin, merchant:m,
            brand:'', category:'', sku, image:`/assets/img/products/${sku}.webp`,
            featured:false, sub1, deeplink: deeplinkOf(m, r.origin, q('#bulk-sub1').checked?sku:(sub1||'')), srcImage:''
          });
          logPush({url:r.origin, merchant:m, status:0, parser:'fallback', message:String(e)});
        }
      }
      OUT = dedupe(OUT);
      renderOUT(); showTab('output');
      q('#out-msg').textContent = `Done: ${OUT.length} items (may filter more when exporting).`; setTimeout(()=> q('#out-msg').textContent='', 1800);

      if (q('#auto-pipeline').checked){
        showTab('images');
        await extractImagesViaHead();
        await generateZipPreset('store'); // 800x800
      }
    };

    // ===== Load/Merge/Export JSON =====
    q('#btn-load-existing').onclick = async ()=>{
      try {
        const res = await fetch('/assets/data/affiliates.json', {cache:'no-store'});
        const arr = await res.json();
        EXISTING = Array.isArray(arr) ? arr : [];
        q('#out-msg').textContent = `Loaded ${EXISTING.length} items.`; setTimeout(()=> q('#out-msg').textContent='', 1600);
      } catch(e){
        q('#out-msg').textContent = 'Cannot load /assets/data/affiliates.json.'; setTimeout(()=> q('#out-msg').textContent='', 2000);
      }
    };
    q('#btn-merge').onclick = ()=>{
      const merged = dedupe([...EXISTING, ...OUT]);
      OUT = merged.map(x=>{
        const m = x.merchant || guessMerchant(x.origin);
        const ids = (m==='shopee') ? parseShopeeIDs(x.origin) : null;
        let sku = x.sku || slugifyVN(x.name||x.origin);
        if ((!x.name || x.name.length<2) && ids) sku = `sp${ids.shop}-${ids.item}`;
        return {
          name:x.name||'', price:isFinite(x.price)?Number(x.price):0, origin:x.origin||'', merchant:m,
          sku, image:x.image || `/assets/img/products/${sku}.webp`,
          brand:x.brand||'', category:x.category||'', featured:!!x.featured, sub1:x.sub1||'',
          deeplink:x.deeplink||x.origin, srcImage: x.srcImage||''
        };
      });
      renderOUT(); showTab('output');
      q('#out-msg').textContent = `Merged & deduped: ${OUT.length} items.`; setTimeout(()=> q('#out-msg').textContent='', 1600);
    };
    q('#btn-copy-json').onclick = ()=>{
      const txt = JSON.stringify(toAffJSON(OUT), null, 2);
      navigator.clipboard.writeText(txt).then(()=>{ q('#out-msg').textContent = 'Copied JSON.'; setTimeout(()=> q('#out-msg').textContent='', 1200); });
    };
    q('#btn-download-json').onclick = ()=>{
      const txt = JSON.stringify(toAffJSON(OUT), null, 2);
      download('affiliates.json', txt);
    };

    // ===== Snippets =====
    function buildSnippetFor(it, useDeep){
      const buyHref = useDeep ? (it.deeplink||it.origin) : it.origin;
      const label = it.merchant==='shopee'?'Shopee':it.merchant==='lazada'?'Lazada':it.merchant==='tiki'?'Tiki':'Buy';
      return [
        `<a class="product-meta" href="${it.origin}" data-merchant="${it.merchant}" data-sku="${it.sku}" data-img="/assets/img/products/${it.sku}.webp" data-price="${isFinite(it.price)?it.price:0}">${it.name}</a>`,
        `<a class="buy" href="${buyHref}" data-merchant="${it.merchant}">Mua ${label}</a>`
      ].join('\n');
    }
    q('#btn-build-snippets').onclick = ()=>{
      const useDeep = q('#snip-deep').checked || SETTINGS.override;
      q('#snippets').value = OUT.filter(isRenderable).map(it=> buildSnippetFor(it, useDeep)).join('\n\n');
    };
    q('#btn-copy-snippets').onclick = ()=> navigator.clipboard.writeText(q('#snippets').value||'');

    // ===== Images =====
    function presetInfo(key){
      if (key==='store')  return {w:800,  h:800,  path:(sku)=>`assets/img/products/${sku}.webp`};
      if (key==='home')   return {w:1200, h:800,  path:(sku)=>`assets/img/hero/${sku}-hero.webp`};
      if (key==='banner') return {w:1600, h:500,  path:(sku)=>`assets/img/banners/${sku}-banner.webp`};
      if (key==='blog')   return {w:1200, h:630,  path:(sku)=>`assets/img/tin-tuc/${sku}-og.webp`};
      if (key==='thumb')  return {w:400,  h:400,  path:(sku)=>`assets/img/products/${sku}-thumb.webp`};
      return {w:800, h:800, path:(sku)=>`assets/img/products/${sku}.webp`};
    }
    async function fetchImageBlobBypass(url){
      const base = (SETTINGS.worker||'').replace(/\/+$/,'');
      const src = base ? `${base}/img?url=${encodeURIComponent(url)}` : url;
      const res = await fetch(src, {mode: base ? 'cors' : 'no-cors'});
      return await res.blob();
    }
    async function resizeToWebp(blob, w, h, fit='cover', quality=0.86){
      const imgBitmap = await createImageBitmap(blob);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
      const iw = imgBitmap.width, ih = imgBitmap.height;
      const r = Math[fit==='cover'?'max':'min'](w/iw, h/ih);
      const nw = iw*r, nh = ih*r;
      const dx = (w - nw)/2, dy = (h - nh)/2;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(imgBitmap, dx, dy, nw, nh);
      return await new Promise(res=> canvas.toBlob(res, 'image/webp', Math.min(Math.max(quality,0.6),0.95)));
    }
    async function extractImagesViaHead(){
      let ok=0;
      for (const it of OUT){
        try {
          const head = await fetchHead(it.origin);
          if (head.image){ it.srcImage = head.image; ok++; }
        } catch(_){}
      }
      q('#images-list').value = OUT.map(it=> `${it.sku} ← ${it.srcImage||'(no image)'}`).join('\n');
      q('#img-msg').textContent = `Got images for ${ok}/${OUT.length}.`;
    }
    q('#btn-img-from-head').onclick = extractImagesViaHead;
    q('#btn-img-from-out').onclick = ()=>{
      q('#images-list').value = OUT.map(it=> `${it.sku} ← ${it.srcImage||'(no image)'}`).join('\n');
      q('#img-msg').textContent = `Listed current srcImage.`;
    };
    async function generateZipPreset(presetKey){
      const preset = presetInfo(presetKey || q('#img-preset').value);
      const fit = q('#img-fit').checked ? 'cover' : 'contain';
      const quality = Number(q('#img-q').value)||0.86;
      const zip = new JSZip();
      let cnt = 0;
      for (const it of OUT.filter(isRenderable)){
        if (!it.srcImage) continue;
        try {
          const blob = await fetchImageBlobBypass(it.srcImage);
          const webp = await resizeToWebp(blob, preset.w, preset.h, fit, quality);
          const path = preset.path(it.sku);
          zip.file(path, webp);
          cnt++;
        } catch(_){}
      }
      if (cnt===0){ q('#img-msg').textContent = 'No srcImage yet. Extract first.'; return; }
      const content = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = `mxd-images-${presetKey||q('#img-preset').value}-${Date.now()}.zip`;
      a.click(); URL.revokeObjectURL(a.href);
      q('#img-msg').textContent = `ZIP ready (${cnt} images).`;
    }
    q('#btn-make-images').onclick = ()=> generateZipPreset();

    // ===== SKU Validator =====
    function validateSKUList(items){
      const issues = [];
      const seen = new Set();
      for (const it of items){
        const raw = (it.sku||'').trim();
        const norm = slugifyVN(raw);
        if (!/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(raw)) issues.push(`Invalid chars: ${raw} → suggest ${norm}`);
        if (seen.has(raw)) issues.push(`Duplicate SKU: ${raw}`);
        seen.add(raw);
      }
      return issues;
    }
    q('#btn-validate-sku').onclick = ()=>{
      const issues = validateSKUList(OUT.filter(isRenderable));
      q('#sku-report').value = issues.length? issues.join('\n') : 'All SKUs look good.';
    };
    q('#btn-normalize-sku').onclick = ()=>{
      OUT.forEach(it=> it.sku = slugifyVN(it.sku || it.name || it.origin));
      OUT = dedupe(OUT); renderOUT();
      q('#sku-report').value = 'Normalized SKUs to lowercase-kebab-case.';
    };

    // ===== Commit message generator =====
    q('#btn-commit').onclick = ()=>{
      const mapOld = new Map((EXISTING||[]).map(x=> [ (x.origin||'')+'#'+(x.sku||''), x ]));
      const mapNew = new Map(OUT.filter(isRenderable).map(x=> [ (x.origin||'')+'#'+(x.sku||''), x ]));
      const added = []; const updated = [];
      for (const [k,v] of mapNew){
        if (!mapOld.has(k)) added.push(v);
        else {
          const o = mapOld.get(k);
          if ((o.name||'')!== (v.name||'') || Number(o.price||0)!==Number(v.price||0)) updated.push(v);
        }
      }
      const headAdd = added.slice(0,5).map(x=>x.sku).join(', ');
      const headUpd = updated.slice(0,5).map(x=>x.sku).join(', ');
      const parts = [];
      if (added.length) parts.push(`feat(data): add ${added.length} products [${headAdd}]`);
      if (updated.length) parts.push(`fix(data): update ${updated.length} products [${headUpd}]`);
      const msg = parts.length? parts.join('\n') : 'chore(data): minor touch (no valid changes detected)';
      q('#commit-msg').value = msg;
    };
    q('#btn-copy-commit').onclick = ()=> navigator.clipboard.writeText(q('#commit-msg').value||'');

    // ===== Health-check (scan affiliates.json) =====
    async function hcHead(url){
      const base = (SETTINGS.worker||'').replace(/\/+$/,'');
      if (!base) return {status:0, location:''};
      const res = await fetch(base + '/head?url=' + encodeURIComponent(url), {mode:'cors'});
      let data={};
      try{ data = await res.json(); }catch(_){}
      return {status: res.status||0, location: data.location||''};
    }
    q('#btn-hc-scan').onclick = async ()=>{
      showTab('health');
      const throttle = Number(q('#hc-throttle').value)||120;
      let list = [];
      try {
        const r = await fetch('/assets/data/affiliates.json', {cache:'no-store'});
        list = await r.json();
      } catch(e){
        q('#hc-report').value = 'Cannot load affiliates.json.'; return;
      }
      // chỉ quét item hợp lệ
      list = list.filter(x=> isProductUrl(x.origin));
      const report = [];
      const prune = [];
      let ok=0, redir=0, nf=0, err=0;
      for (const it of list){
        const {status, location} = await hcHead(it.origin);
        if (status>=200 && status<300){ ok++; }
        else if (status>=300 && status<400){ redir++; report.push(`REDIRECT ${status} ${it.sku} → ${location||'?'}`); }
        else if (status===404){ nf++; report.push(`NOT FOUND 404 ${it.sku} ${it.origin}`); prune.push({origin:it.origin, sku:it.sku}); }
        else { err++; report.push(`ERROR ${status} ${it.sku} ${it.origin}`); }
        await sleep(throttle);
      }
      report.unshift(`SUMMARY: OK=${ok} Redirect=${redir} NotFound=${nf} Error=${err}`);
      q('#hc-report').value = report.join('\n');
      q('#btn-hc-download').onclick = ()=> download('affiliates.prune.json', JSON.stringify(prune, null, 2));
    };
    q('#btn-hc-copy').onclick = ()=> navigator.clipboard.writeText(q('#hc-report').value||'');

    // ===== Log / Settings buttons =====
    q('#btn-clear-log').onclick = ()=>{ LOGS=[]; q('#log-table tbody').innerHTML=''; };
    q('#btn-save-settings').onclick = saveSettings;
    q('#btn-test-head').onclick = async ()=>{
      const demo = 'https://shopee.vn/product/166287331/22741831588';
      const r = await fetchHead(demo);
      q('#settings-msg').textContent = `HEAD ${r.status} — parser: ${r.parser}`; setTimeout(()=> q('#settings-msg').textContent='', 1500);
    };

    // ===== Init =====
    mountSettings();
  </script>
</body>
</html>
