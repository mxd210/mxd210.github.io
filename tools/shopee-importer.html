<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MXD – Shopee Importer (Auto-Price + Affiliate + Images)</title>
  <style>
    :root { --bg:#0b0b0b; --fg:#eee; --muted:#666; --brand:#111; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 12px;line-height:1.55;color:#111}
    h1{margin:0 0 6px}
    h2,h3{margin:18px 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    textarea, input[type="url"], input[type="text"], input[type="number"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
    textarea{min-height:220px}
    .out{white-space:pre; background:var(--bg); color:var(--fg); padding:12px;border-radius:10px;overflow:auto;min-height:220px}
    .muted{color:var(--muted)}
    .tips{background:#fff7e6;border:1px solid #ffe0a3;padding:10px;border-radius:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    button.primary{background:var(--brand);color:#fff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd;background:#fafafa}
    .copy{float:right;margin-left:8px}
    .ok{color:#0a7c2f}.warn{color:#a66b00}.bad{color:#b91c1c}
    .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:#111;transition:width .2s}
    .kbd{font:12px/1.6 ui-monospace,SFMono-Regular,Menlo,monospace;background:#f4f4f4;padding:2px 6px;border-radius:6px}
    .small{font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <h1>MXD – Shopee → affiliates.json <span class="badge">Auto-Price + Affiliate + Images</span></h1>
  <p class="muted">Dán danh sách 1 dòng/1 sản phẩm. Hỗ trợ:</p>
  <ul>
    <li><b>Mode A:</b> <code>https://shopee.vn/product/&lt;shopId&gt;/&lt;itemId&gt;</code> (mọi dạng link Shopee đều được: có slug, có <code>i.&lt;sid&gt;.&lt;iid&gt;</code>…)</li>
    <li><b>Mode B:</b> <code>Tên sản phẩm | giá (số) | link Shopee</code></li>
  </ul>

  <div class="grid">
    <section>
      <h3>1) Dữ liệu đầu vào</h3>
      <textarea id="input" placeholder="Ví dụ:
NEED_NAME | 0 | https://shopee.vn/product/279547485/5274192859
https://shopee.vn/HUKAN-...i.1109739439.245575152525?sp_atk=..."></textarea>

      <div class="tips">
        <b>Quy ước MXD:</b>
        <ul>
          <li><b>sku</b> = slug tên SP → khớp ảnh <code>/assets/img/products/&lt;sku&gt;.webp</code></li>
          <li><b>merchant</b>=<code>shopee</code>, <b>origin</b>= link Shopee gốc (hoặc deep link nếu bật Affiliate).</li>
          <li>Thiếu <code>name</code> → tool tự lấy tiêu đề từ Worker.</li>
        </ul>
      </div>

      <div class="row small" style="margin-top:10px">
        <label class="row"><input type="checkbox" id="autolowerprice" checked> Giảm giá hiển thị 3%</label>
        <label class="row"><input type="checkbox" id="forceMin" checked> Dùng <code>priceMin</code> khi có min/max</label>
      </div>

      <div style="margin-top:10px">
        <label>Proxy Worker URL:
          <input id="proxy" type="url" placeholder="https://mxd-price-worker.<subdomain>.workers.dev/">
        </label>
        <div class="row" style="margin-top:8px">
          <button id="autoprice">Lấy giá tự động</button>
          <button id="gen" class="primary">Generate JSON &amp; Meta</button>
          <button id="dedup">Khử trùng link</button>
          <button id="normalize">Chuẩn hoá link</button>
          <button id="check-worker">Kiểm tra Worker</button>
          <button id="clear">Xoá</button>
        </div>
      </div>

      <h3 style="margin-top:18px">2) Affiliate (chuyển link gốc → deep link)</h3>
      <div class="row">
        <label>Preset affiliate:
          <select id="aff-preset">
            <option value="custom">— Tự điền —</option>
            <option value="at-full">AccessTrade (đủ sub1..sub4)</option>
            <option value="sap">Shopee Affiliate Program</option>
          </select>
        </label>
      </div>
      <p class="muted small">Template deep link <b>bắt buộc</b> chứa <code>{url}</code> (đích là link Shopee gốc). Có thể dùng <code>{sub1}</code>…<code>{sub4}</code>.</p>
      <div class="row">
        <label style="flex:1">Template:
          <input id="aff-tpl" type="text" placeholder="https://example-aff.com/deep?url={url}&sub1={sub1}&sub2={sub2}">
        </label>
      </div>
      <div class="row">
        <label>sub1: <input id="aff-sub1" type="text" placeholder="store"></label>
        <label>sub2: <input id="aff-sub2" type="text" placeholder="xaydung"></label>
        <label>sub3: <input id="aff-sub3" type="text" placeholder="mxd210"></label>
        <label>sub4: <input id="aff-sub4" type="text" placeholder="YYYYMMDD"></label>
      </div>
      <div class="row small">
        <label class="row"><input type="checkbox" id="aff-use" checked> Xuất JSON dùng <b>affiliate link</b> (tắt → dùng origin)</label>
        <button id="aff-convert">Chuyển toàn bộ input → affiliate</button>
        <button id="aff-test">Test 5 link đầu (HEAD)</button>
      </div>

      <p id="status" class="muted"></p>
      <div class="progress"><div id="prog" class="bar"></div></div>
    </section>

    <section>
      <h3>3) Kết quả – dán vào <code>assets/data/affiliates.json</code>
        <button class="copy" data-copy="json">Copy JSON</button>
      </h3>
      <div id="json" class="out">{ }</div>

      <h3 style="margin-top:16px">4) HTML meta (dán vào trang danh mục)
        <button class="copy" data-copy="meta">Copy Meta</button>
      </h3>
      <div id="meta" class="out">&lt;!-- no items parsed --&gt;</div>
    </section>
  </div>

  <hr style="margin:24px 0">

  <h2>5) Ảnh (Resize + WebP + ZIP)</h2>
  <p class="muted">Dùng cùng Proxy Worker URL để lấy ảnh Shopee qua proxy (tránh CORS). Có thể dán URL ảnh / tải ảnh từ máy.</p>

  <div class="row" style="margin-bottom:8px">
    <label>SKU (đặt tên file): <input id="img-sku" type="text" placeholder="vd: may-cat-cam-tay-dekton-dk-ag950s"></label>
    <label>WebP quality: <input id="img-q" type="number" min="0" max="1" step="0.01" value="0.82" style="width:90px"></label>
  </div>

  <div class="row" style="margin-bottom:8px">
    <label style="flex:1 1 100%">URL ảnh (1 dòng/ảnh):</label>
    <textarea id="img-urls" placeholder="https://down-vn.img.susercontent.com/file/xxx
https://down-vn.img.susercontent.com/file/yyy"></textarea>
  </div>

  <div class="row" style="margin-bottom:8px">
    <input id="img-file" type="file" accept="image/*" multiple>
    <button id="img-fetch-from-worker">Lấy ảnh từ Worker theo link Shopee ở ô trên</button>
  </div>

  <div class="row" style="margin-bottom:8px">
    <label>Preset:
      <select id="img-preset">
        <option value="product">Sản phẩm (1200, 800, 400)</option>
        <option value="og">OG 1200x630</option>
        <option value="hero">Hero/Nền (1920x1080, 1600x900)</option>
        <option value="icon">Icon (512, 256)</option>
        <option value="custom">Tự chọn</option>
      </select>
    </label>
    <label>Kích thước tuỳ chọn (W×H, dấu phẩy):
      <input id="img-sizes" type="text" placeholder="1200x1200,800x800" disabled>
    </label>
  </div>

  <div class="row" style="margin-bottom:8px">
    <button id="img-generate" class="primary">Tạo ảnh & ZIP</button>
    <span id="img-log" class="muted small"></span>
  </div>

  <script>
  // ===== Helpers chung =====
  const el = id => document.getElementById(id);
  const setStatus = (msg, cls='')=>{ const s=el('status'); s.textContent=msg; s.className='muted '+cls; };
  const setProg = (num, den)=>{ const p=el('prog'); const v = !den?0: Math.min(100, Math.round(num/den*100)); p.style.width = v+'%'; };
  const persist = {
    save(){
      localStorage.setItem('mxd_proxy', el('proxy').value.trim());
      localStorage.setItem('mxd_lower', el('autolowerprice').checked?'1':'0');
      localStorage.setItem('mxd_forceMin', el('forceMin').checked?'1':'0');
      localStorage.setItem('mxd_affTpl', el('aff-tpl').value.trim());
      localStorage.setItem('mxd_affUse', el('aff-use').checked?'1':'0');
      localStorage.setItem('mxd_affSub1', el('aff-sub1').value);
      localStorage.setItem('mxd_affSub2', el('aff-sub2').value);
      localStorage.setItem('mxd_affSub3', el('aff-sub3').value);
      localStorage.setItem('mxd_affSub4', el('aff-sub4').value);
    },
    load(){
      const p=localStorage.getItem('mxd_proxy'); if(p) el('proxy').value=p;
      el('autolowerprice').checked = localStorage.getItem('mxd_lower')!=='0';
      el('forceMin').checked = localStorage.getItem('mxd_forceMin')!=='0';
      el('aff-tpl').value = localStorage.getItem('mxd_affTpl') || '';
      el('aff-use').checked = localStorage.getItem('mxd_affUse')!=='0';
      el('aff-sub1').value = localStorage.getItem('mxd_affSub1') || 'store';
      el('aff-sub2').value = localStorage.getItem('mxd_affSub2') || 'xaydung';
      el('aff-sub3').value = localStorage.getItem('mxd_affSub3') || 'mxd210';
      el('aff-sub4').value = localStorage.getItem('mxd_affSub4') || todayYYYYMMDD();
    }
  };
  persist.load();

  function slugify(s){
    return (s||'').toString()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-')
      .replace(/^-+|-+$/g,'').replace(/--+/g,'-');
  }

  // === robust parser for Shopee links ===
  function parseShopeeId(url){
    try{
      const u = new URL((url||'').trim());
      const p = u.pathname;

      // /product/<shopId>/<itemId>
      let m = p.match(/\/product\/(\d+)\/(\d+)/);
      if (m) return { shopId: m[1], itemId: m[2] };

      // /shop/<shopId>/item/<itemId>
      m = p.match(/\/shop\/(\d+)\/item\/(\d+)/);
      if (m) return { shopId: m[1], itemId: m[2] };

      // ... i.<shopId>.<itemId> ... (link chia sẻ)
      m = (url||'').match(/i\.(\d+)\.(\d+)/);
      if (m) return { shopId: m[1], itemId: m[2] };

      // ?shopid=...&itemid=...
      const sh = u.searchParams.get('shopid') || u.searchParams.get('shopId');
      const it = u.searchParams.get('itemid') || u.searchParams.get('itemId');
      if (sh && it) return { shopId: sh, itemId: it };

      return null;
    }catch(e){ return null; }
  }
  function canonShopee(url){
    const ids = parseShopeeId(url);
    return ids ? `https://shopee.vn/product/${ids.shopId}/${ids.itemId}` : (url||'').trim();
  }
  const fmtPrice = n => Math.max(0, Math.round(n||0));

  // Utility: today YYYYMMDD
  function todayYYYYMMDD(){
    const d=new Date(); const mm=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
    return `${d.getFullYear()}${mm}${dd}`;
  }

  // Copy buttons
  document.querySelectorAll('button.copy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = btn.dataset.copy;
      const text = el(target).textContent;
      navigator.clipboard.writeText(text).then(()=>{
        const old=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,900);
      });
    });
  });

  // Khử trùng link
  el('dedup').addEventListener('click', ()=>{
    const lines = el('input').value.trim().split(/\r?\n/).filter(Boolean);
    const seen=new Set(); const out=[];
    for (let line of lines){
      const link = line.includes('|') ? (line.split('|')[2]||'').trim() : line.trim();
      const ids = parseShopeeId(link); const key = ids ? `${ids.shopId}_${ids.itemId}` : line.trim();
      if (seen.has(key)) continue; seen.add(key); out.push(line);
    }
    el('input').value = out.join('\n'); setStatus(`Đã khử trùng: còn ${out.length} dòng.`, 'ok'); persist.save();
  });

  // Chuẩn hoá link → /product/<sid>/<iid>
  el('normalize').addEventListener('click', ()=>{
    const lines = el('input').value.trim().split(/\r?\n/).filter(Boolean);
    const out = lines.map(line=>{
      const parts = line.includes('|') ? line.split('|').map(s=>s.trim()) : [null,null,line.trim()];
      let [n,p,l] = parts.length===3 ? parts : [null,null, line.trim()];
      const ids = parseShopeeId(l||'');
      const canon = ids ? `https://shopee.vn/product/${ids.shopId}/${ids.itemId}` : (l||'');
      return line.includes('|') ? `${n||'NEED_NAME'} | ${parseInt((p||'0').replace(/[^\d]/g,''),10)||0} | ${canon}` : canon;
    });
    el('input').value = out.join('\n');
    setStatus('Đã chuẩn hoá tất cả link.', 'ok');
  });

  // Kiểm tra Worker
  el('check-worker').addEventListener('click', async ()=>{
    const proxy = el('proxy').value.trim();
    if(!proxy){ setStatus('Chưa nhập Proxy Worker URL.', 'bad'); return; }
    const test = 'https://shopee.vn/product/772892494/21507014059';
    try{
      const u = new URL(proxy); u.searchParams.set('url', test);
      const r = await fetch(u.toString());
      const ok = r.ok && (await r.clone().json()).title;
      setStatus(ok ? 'Worker OK (trả JSON).' : 'Worker trả về không hợp lệ.', ok?'ok':'warn');
    }catch(e){ setStatus('Worker lỗi hoặc URL sai.', 'bad'); }
  });

  // Worker: detail
  async function fetchDetail(proxy, link){
    try{
      const u = new URL(proxy); u.searchParams.set('url', canonShopee(link));
      const r = await fetch(u.toString()); if(!r.ok) throw new Error('fetch fail '+r.status);
      return await r.json(); // { title, priceMin, priceMax, price, images[] }
    }catch(e){ return null; }
  }

  // Worker: build affiliate
  async function buildAffiliate(proxy, dest, {tpl, sub1, sub2, sub3, sub4}){
    if (!tpl || !tpl.includes('{url}')) return dest;
    try{
      const u = new URL(proxy); u.pathname = u.pathname.replace(/\/?$/, '/aff');
      u.searchParams.set('url', dest);
      u.searchParams.set('tpl', tpl);
      if (sub1) u.searchParams.set('sub1', sub1);
      if (sub2) u.searchParams.set('sub2', sub2);
      if (sub3) u.searchParams.set('sub3', sub3);
      if (sub4) u.searchParams.set('sub4', sub4);
      const r = await fetch(u.toString());
      if (!r.ok) throw new Error('aff fail');
      const j = await r.json();
      return j.affiliate || dest;
    } catch (e) {
      return dest;
    }
  }

  // Worker: head check
  async function headCheck(proxy, url){
    try{
      const u = new URL(proxy); u.pathname = u.pathname.replace(/\/?$/, '/head'); u.searchParams.set('url', url);
      const r = await fetch(u.toString()); if(!r.ok) return { ok:false, status:r.status };
      return await r.json();
    }catch(e){ return { ok:false, error:String(e) }; }
  }

  // Preset affiliate filler
  function fillAffiliatePreset(kind){
    if(kind==='at-full'){
      el('aff-tpl').value = 'https://go.isclix.com/deep_link?url={url}&aff_sub1={sub1}&aff_sub2={sub2}&aff_sub3={sub3}&aff_sub4={sub4}';
      el('aff-sub1').value = el('aff-sub1').value || 'store';
      el('aff-sub2').value = el('aff-sub2').value || 'xaydung';
      el('aff-sub3').value = el('aff-sub3').value || 'mxd210';
      el('aff-sub4').value = el('aff-sub4').value || todayYYYYMMDD();
      el('aff-use').checked = true;
      setStatus('Preset AccessTrade đã được điền.', 'ok');
    } else if(kind==='sap'){
      el('aff-tpl').value = 'https://affiliate.shopee.vn/track?deep_url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}';
      el('aff-sub1').value = el('aff-sub1').value || 'store';
      el('aff-sub2').value = el('aff-sub2').value || 'xaydung';
      el('aff-sub3').value = el('aff-sub3').value || 'mxd210';
      el('aff-sub4').value = el('aff-sub4').value || todayYYYYMMDD();
      el('aff-use').checked = true;
      setStatus('Preset Shopee Affiliate đã được điền.', 'ok');
    }
  }
  document.getElementById('aff-preset').addEventListener('change', e=>fillAffiliatePreset(e.target.value));
  // Prime defaults on first load (if no local storage)
  if(!localStorage.getItem('mxd_affTpl')) fillAffiliatePreset('at-full');

  // Auto-price
  el('autoprice').addEventListener('click', async ()=>{
    const proxy = el('proxy').value.trim();
    if (!proxy){ setStatus('Chưa nhập Proxy Worker URL. Tool vẫn chạy nhưng không tự lấy giá.', 'warn'); }
    persist.save();

    const lines = el('input').value.trim().split(/\r?\n/);
    const out=[]; const useMin = el('forceMin').checked;
    let ok=0, miss=0; setProg(0, lines.length);

    for (let i=0;i<lines.length;i++){
      let line = lines[i].trim(); if (!line) continue;
      let name='', price=0, link='';
      if (line.includes('|')){ const [n, p, l] = line.split('|').map(s=>s.trim()); name=n||''; price=parseInt((p||'0').replace(/[^\d]/g,''),10)||0; link=l||''; }
      else { link=line; }

      const ids = parseShopeeId(link);
      if (ids && proxy){
        const d = await fetchDetail(proxy, link);
        if (d){
          let auto = useMin ? (d.priceMin||d.price||0) : (d.price||d.priceMin||0);
          if (!price) price = auto;
          if (!name || /^need_name/i.test(name)) name = d.title || name || '';
          ok++;
        } else miss++;
      }
      out.push(`${name||'NEED_NAME'} | ${price||0} | ${canonShopee(link)}`);
      setProg(i+1, lines.length);
    }

    el('input').value = out.join('\n');
    setStatus(`Auto-price xong. Thành công ${ok}, lỗi ${miss}.`, miss? 'warn':'ok');
  });

  // Affiliate convert (thay link trong input)
  el('aff-convert').addEventListener('click', async ()=>{
    const proxy = el('proxy').value.trim();
    const tpl = el('aff-tpl').value.trim();
    const opt = {
      tpl,
      sub1: el('aff-sub1').value.trim(),
      sub2: el('aff-sub2').value.trim(),
      sub3: el('aff-sub3').value.trim(),
      sub4: el('aff-sub4').value.trim()
    };
    persist.save();

    if (!tpl || !tpl.includes('{url}')) { setStatus('Template affiliate thiếu {url}.', 'bad'); return; }
    if (!proxy){ setStatus('Cần Proxy Worker URL để build affiliate.', 'bad'); return; }

    const lines = el('input').value.trim().split(/\r?\n/);
    const out=[]; setProg(0, lines.length);
    for (let i=0;i<lines.length;i++){
      let line = lines[i].trim(); if (!line) continue;
      let name='', price=0, link='';
      if (line.includes('|')){ const [n, p, l] = line.split('|').map(s=>s.trim()); name=n||''; price=parseInt((p||'0').replace(/[^\d]/g,''),10)||0; link=l||''; }
      else { link=line; }

      if (/^https?:\/\//.test(link)) {
        const aff = await buildAffiliate(proxy, canonShopee(link), opt);
        if (line.includes('|')) out.push(`${name||'NEED_NAME'} | ${price||0} | ${aff}`);
        else out.push(aff);
      } else {
        out.push(line);
      }
      setProg(i+1, lines.length);
    }
    el('input').value = out.join('\n');
    setStatus('Đã chuyển toàn bộ link sang affiliate theo template.', 'ok');
  });

  // Test 5 link đầu (HEAD)
  el('aff-test').addEventListener('click', async ()=>{
    const proxy = el('proxy').value.trim();
    if (!proxy){ setStatus('Nhập Proxy Worker URL để test HEAD.', 'bad'); return; }
    const lines = el('input').value.trim().split(/\r?\n/).filter(Boolean).slice(0,5);
    const results = [];
    for (const line of lines){
      const link = line.includes('|') ? (line.split('|')[2]||'').trim() : line.trim();
      if (!/^https?:\/\//.test(link)) continue;
      const h = await headCheck(proxy, canonShopee(link));
      results.push({ link: canonShopee(link), ...h });
    }
    setStatus('HEAD test: ' + results.map(r=>`${r.ok?'OK':'BAD'} ${r.status||''}`).join(' | '));
    console.log('HEAD results', results);
  });

  // Generate JSON + Meta
  el('gen').addEventListener('click', async ()=>{
    persist.save();
    const wantLower = el('autolowerprice').checked;
    const useAff = el('aff-use').checked;
    const tpl = el('aff-tpl').value.trim();
    const opt = {
      tpl,
      sub1: el('aff-sub1').value.trim(),
      sub2: el('aff-sub2').value.trim(),
      sub3: el('aff-sub3').value.trim(),
      sub4: el('aff-sub4').value.trim()
    };
    const proxy = el('proxy').value.trim();

    const lines = el('input').value.trim().split(/\r?\n/).filter(Boolean);
    const seen=new Set(); const items=[]; const metas=[];
    for (const line of lines){
      let name='', price=0, link='';
      if (line.includes('|')){ const [n, p, l] = line.split('|').map(s=>s.trim()); name=n||''; price=parseInt((p||'0').replace(/[^\d]/g,''),10)||0; link=l||''; }
      else { link=line.trim(); }
      const ids = parseShopeeId(link); if (!ids) continue;
      const key = `${ids.shopId}_${ids.itemId}`; if (seen.has(key)) continue; seen.add(key);

      const origin = canonShopee(link);
      // chọn URL xuất
      let outUrl = origin;
      if (useAff && tpl && tpl.includes('{url}') && proxy) {
        outUrl = await buildAffiliate(proxy, origin, opt);
      }

      let sku = name ? slugify(name) : `p-${ids.itemId}`;
      if (wantLower && price>0) price=Math.round(price*0.97);

      const rec = { sku, name: name || `NEED_NAME_${ids.itemId}`, price: fmtPrice(price), origin: outUrl, merchant: "shopee" };
      items.push(rec);

      metas.push(
        `<a class="product-meta" href="${rec.origin}" data-merchant="shopee" data-sku="${rec.sku}" data-img="/assets/img/products/${rec.sku}.webp" data-price="${rec.price}">${rec.name}</a>
<a class="buy" href="${rec.origin}" data-merchant="shopee" data-sub1="${opt.sub1||''}" data-sub2="${opt.sub2||''}" data-sub3="${opt.sub3||''}" data-sub4="${opt.sub4||''}">Mua ngay</a>`
      );
    }
    el('json').textContent = JSON.stringify(items, null, 2);
    el('meta').textContent = metas.join('\n\n') || '<!-- no items parsed -->';
    const skipped = el('input').value.trim().split(/\r?\n/).filter(Boolean).length - items.length;
    setStatus(skipped>0 ? `Generate xong: ${items.length} SP, bỏ qua ${skipped} dòng (không nhận diện được shopId/itemId).` : `Generate xong: ${items.length} SP.`, skipped>0?'warn':'ok');
  });

  // ===== Ảnh =====
  const presetSizes = (p)=> p==='product' ? ['1200x1200','800x800','400x400']
                     : p==='og' ? ['1200x630']
                     : p==='hero' ? ['1920x1080','1600x900']
                     : p==='icon' ? ['512x512','256x256'] : [];

  el('img-preset').addEventListener('change', e=>{
    const v=e.target.value, inp=el('img-sizes');
    if(v==='custom'){ inp.disabled=false; inp.focus(); }
    else { inp.disabled=true; inp.value=presetSizes(v).join(','); }
  });

  function drawResize(img, w, h, q){
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d');
    const ratio=Math.max(w/img.naturalWidth, h/img.naturalHeight);
    const nw=img.naturalWidth*ratio, nh=img.naturalHeight*ratio;
    const dx=(w-nw)/2, dy=(h-nh)/2; ctx.drawImage(img, dx, dy, nw, nh);
    return new Promise(res=> c.toBlob(b=>res(b), 'image/webp', q));
  }

  async function fetchImageViaWorker(proxy, rawUrl){
    const u = new URL(proxy); u.pathname = u.pathname.replace(/\/?$/, '/img'); u.searchParams.set('url', rawUrl);
    const r = await fetch(u.toString(), { mode:'cors' }); if(!r.ok) throw new Error('fetch image '+r.status);
    return await r.blob();
  }

  async function collectSourceImages(){
    const list = [];
    const ta = el('img-urls').value.trim();
    if (ta){ ta.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(u=>list.push({type:'url', url=u})); }
    const files = Array.from(el('img-file').files||[]);
    const local = await Promise.all(files.map(f => new Promise(res=>{
      const reader = new FileReader(); reader.onload = () => res({ type:'dataurl', dataUrl: reader.result, name: f.name }); reader.readAsDataURL(f);
    })));
    local.forEach(x=>list.push(x));
    return list;
  }

  el('img-fetch-from-worker').addEventListener('click', async ()=>{
    const proxy = el('proxy').value.trim(); if (!proxy){ el('img-log').textContent='Chưa nhập Proxy Worker URL.'; return; }
    const lines = el('input').value.trim().split(/\r?\n/).filter(Boolean);
    const imgBox = el('img-urls'); let found=0;
    for(const line of lines){
      const link = line.includes('|') ? (line.split('|')[2]||'').trim() : line.trim();
      const ids = parseShopeeId(link);
      if (!ids) continue;
      try{
        const u = new URL(proxy); u.searchParams.set('url', canonShopee(link));
        const r = await fetch(u.toString()); if(!r.ok) continue;
        const d = await r.json(); (d.images||[]).forEach(href=>{ imgBox.value += (imgBox.value?'\n':'') + href; found++; });
      }catch(e){}
    }
    el('img-log').textContent = `Đã lấy ${found} URL ảnh từ Worker.`;
  });

  el('img-generate').addEventListener('click', async ()=>{
    const proxy = el('proxy').value.trim();
    const sku = (el('img-sku').value||'mxd').trim();
    const q = Math.max(0, Math.min(1, parseFloat(el('img-q').value)||0.82));

    let sizes = []; const preset = el('img-preset').value;
    sizes = preset==='custom' ? (el('img-sizes').value.trim()? el('img-sizes').value.trim().split(',').map(s=>s.trim()) : [])
                              : presetSizes(preset);
    if (!sizes.length){ el('img-log').textContent='Chưa có kích thước.'; return; }

    const sources = await collectSourceImages(); if(!sources.length){ el('img-log').textContent='Chưa có ảnh nguồn.'; return; }

    const zip = new JSZip(); let done=0, total=sources.length*sizes.length; setProg(0, total);
    for(const src of sources){
      const img = new Image(); img.crossOrigin='anonymous';
      try{
        if (src.type==='url'){ const blob = await fetchImageViaWorker(proxy, src.url); img.src = URL.createObjectURL(blob); }
        else if (src.type==='dataurl'){ img.src = src.dataUrl; } else { continue; }
        await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; });

        for(const s of sizes){
          const [w,h] = s.toLowerCase().split('x').map(n=>parseInt(n,10)); if(!w||!h) continue;
          const blob = await drawResize(img, w, h, q);
          const suffix = (preset==='og' && w===1200 && h===630) ? 'og' :
                         (preset==='hero' ? `${w}x${h}` :
                         (preset==='icon' ? `${w}` : `${w}`));
          const fname = `${sku}-${suffix}.webp`;
          zip.file(fname, blob);
          done++; setProg(done, total);
          el('img-log').textContent = `Đang xử lý ${done}/${total}…`;
        }
      }catch(e){}
      finally{ URL.revokeObjectURL(img.src); }
    }
    const content = await zip.generateAsync({ type:'blob' });
    const a = document.createElement('a'); a.href=URL.createObjectURL(content); a.download=`${sku}-images.zip`; document.body.appendChild(a); a.click(); a.remove();
    el('img-log').textContent = `Xong. ZIP ${sources.length} ảnh × ${sizes.length} kích thước.`;
  });
  </script>

  <p class="muted small" style="margin-top:24px">
    Preset affiliate chuẩn MXD: AccessTrade (sub1=<b>store</b>, sub2=<b>xaydung</b>, sub3=<b>mxd210</b>, sub4=<b>YYYYMMDD</b>). Có thể chọn Shopee Affiliate tuỳ network.
    Dù xuất JSON dùng affiliate hay origin, khối <code>&lt;a class="product-meta"&gt;</code> vẫn kèm <code>data-merchant</code> và sub* để <span class="kbd">mxd-affiliate.js</span> có thể theo dõi click.
  </p>
</body>
</html>
